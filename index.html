<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piattaforma CSIRT - Gestione Sicurezza Aziendale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    .hidden {
      display: none;
    }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .status-aperto {
      background-color: #fee2e2;
      color: #991b1b;
    }
    .status-in-corso {
      background-color: #fef3c7;
      color: #92400e;
    }
    .status-risolto {
      background-color: #d1fae5;
      color: #065f46;
    }
    .severity-critical {
      background-color: #fecaca;
      color: #991b1b;
    }
    .severity-high {
      background-color: #fed7aa;
      color: #9a3412;
    }
    .severity-medium {
      background-color: #fef08a;
      color: #854d0e;
    }
    .severity-low {
      background-color: #bfdbfe;
      color: #1e40af;
    }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50">
  <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
      <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
     </div>
     <h1 class="text-3xl font-bold text-gray-800">Piattaforma CSIRT</h1>
     <p class="text-gray-600 mt-2">Gestione Sicurezza e Compliance NIS2</p>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-6">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
      <input type="email" id="login-email" placeholder="inserisci@email.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
      <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Profilo</label>
      <select id="login-role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
       <option value="">Seleziona il tuo ruolo</option>
       <option value="admin">üë§ Amministratore</option>
       <option value="csirt">üõ°Ô∏è Consulente/Referente CSIRT</option>
       <option value="azienda">üè¢ Referente Aziendale</option>
      </select>
     </div>
     <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"> Accedi alla Piattaforma </button>
    </form>
    <div class="mt-6 pt-6 border-t border-gray-200">
     <p class="text-center text-sm text-gray-600">Demo - Credenziali di test (Utenti da creare in Supabase Auth):</p>
     <div class="mt-2 space-y-1 text-xs text-gray-500">
      <p>üë§ Admin: admin@csirt.it / admin123</p>
      <p>üõ°Ô∏è CSIRT: csirt@hub.it / csirt123</p>
      <p>üè¢ Azienda: azienda@test.it / azienda123</p>
     </div>
    </div>
   </div>
  </div>
  <div id="device-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-xl">
     <div class="flex items-center justify-between">
      <h3 id="modal-title" class="text-2xl font-bold">‚ûï Aggiungi Nuovo Dispositivo</h3>
      <button onclick="closeDeviceModal()" class="text-white hover:bg-white/20 rounded-lg p-2">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg>
      </button>
     </div>
    </div>
    <form id="device-form" onsubmit="saveDevice(event)" class="p-6 space-y-4">
     <input type="hidden" id="device-id">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Tipo Dispositivo *</label>
       <select id="device-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
        <option value="">Seleziona tipo</option>
        <option value="switch">üîÄ Switch</option>
        <option value="router">üåê Router</option>
        <option value="firewall">üî• Firewall</option>
        <option value="ap">üì° Access Point</option>
       </select>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Nome Dispositivo *</label>
       <input type="text" id="device-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Core Switch" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Vendor/Marca *</label>
       <input type="text" id="device-vendor" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Cisco, Fortinet" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Modello *</label>
       <input type="text" id="device-model" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Catalyst 9300" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo IP *</label>
       <input type="text" id="device-ip" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 192.168.1.1" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo MAC</label>
       <input type="text" id="device-mac" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 00:1A:2B:3C:4D:5E">
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Versione Firmware</label>
       <input type="text" id="device-firmware" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 17.9.3">
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Stato *</label>
       <select id="device-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
        <option value="online">üü¢ Online</option>
        <option value="offline">üî¥ Offline</option>
        <option value="maintenance">üü° Manutenzione</option>
       </select>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Numero Porte (per Switch/Router)</label>
       <input type="number" id="device-ports" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 48" min="0">
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">Localit√†/Rack</label>
       <input type="text" id="device-location" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Server Room - Rack A3">
      </div>
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
      <textarea id="device-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Informazioni aggiuntive..."></textarea>
     </div>
     <div class="flex space-x-3 pt-4">
      <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg"> üíæ Salva Dispositivo </button>
      <button type="button" onclick="closeDeviceModal()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> Annulla </button>
     </div>
    </form>
   </div>
  </div>
  <div id="main-app" class="hidden">
   <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
       <svg class="w-10 h-10" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
       </svg>
       <div>
        <h1 class="text-2xl font-bold">Piattaforma CSIRT</h1>
        <p class="text-blue-100 text-sm">Sistema di Gestione Sicurezza e Compliance NIS2</p>
       </div>
      </div>
      <div class="flex items-center space-x-4">
       <div class="text-right">
        <p class="text-sm font-medium" id="user-name">Admin User</p>
        <p class="text-xs text-blue-100" id="user-role">Amministratore</p>
       </div>
       <button onclick="logout()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        <span>Esci</span>
       </button>
      </div>
     </div>
    </div>
   </header>
   <div class="flex" style="height: calc(100% - 80px);">
    <aside class="w-64 bg-white shadow-lg overflow-y-auto">
     <nav class="p-4 space-y-2" id="sidebar-nav">
      <button onclick="showSection('dashboard')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
       </svg>
       <span>Dashboard</span>
      </button>
      <button onclick="showSection('companies')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg>
       <span>Aziende</span>
      </button>
      <button onclick="showSection('incidents')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg>
       <span>Incidenti</span>
      </button>
      <button onclick="showSection('notifications')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
       </svg>
       <span>Notifiche ACN</span>
      </button>
     </nav>
    </aside>
    <main class="flex-1 overflow-y-auto p-8" style="height: 100%;">
     <section id="dashboard-section" class="section-content">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Generale</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Aziende Monitorate</p>
          <p id="total-companies" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-blue-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Incidenti Aperti</p>
          <p id="open-incidents" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-red-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Notifiche Pending</p>
          <p id="pending-notifications" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-yellow-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Compliance Score</p>
          <p id="compliance-score" class="text-3xl font-bold text-gray-800 mt-2">0%</p>
         </div>
         <div class="bg-green-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4">Attivit√† Recenti</h3>
       <div id="recent-activity" class="space-y-3">
        <p class="text-gray-500 text-center py-8">Nessuna attivit√† recente</p>
       </div>
      </div>
      <div id="csirt-dashboard-cards" class="hidden">
       <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div onclick="showSection('incidents')" class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl shadow-md p-6 border-l-4 border-red-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-red-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">üö® Registro Incidenti</h3>
         <p class="text-gray-600 text-sm">Gestisci e registra incidenti di sicurezza conformi NIS2</p>
         <div class="mt-4 text-sm font-medium text-red-700"> Clicca per gestire ‚Üí </div>
        </div>
        <div onclick="showSection('designation-detail')" class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-md p-6 border-l-4 border-purple-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-purple-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">üìã Designazione Referente CSIRT</h3>
         <p class="text-gray-600 text-sm">Gestisci i dati del referente CSIRT, sostituti e contatto ACN</p>
         <div class="mt-4 text-sm font-medium text-purple-700"> Clicca per compilare ‚Üí </div>
        </div>
        <div onclick="showSection('network')" class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-md p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-green-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">üåê Configurazione Rete Aziendale</h3>
         <p class="text-gray-600 text-sm">Definisci topologia, sicurezza perimetrale e connettivit√†</p>
         <div class="mt-4 text-sm font-medium text-green-700"> Clicca per configurare ‚Üí </div>
        </div>
       </div>
      </div>
     </section>
     <section id="incidents-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">üö® Registro Incidenti di Sicurezza</h2>
       <p class="text-gray-600 mb-6">Documenta e traccia tutti gli incidenti secondo i requisiti NIS2</p>
       <div class="bg-white rounded-t-xl shadow-md border-b border-gray-200">
        <div class="flex space-x-1 p-2">
         <button onclick="switchIncidentTab('new')" class="incident-tab px-6 py-3 rounded-lg font-medium bg-red-100 text-red-700"> ‚ûï Nuovo Incidente </button>
         <button onclick="switchIncidentTab('list')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üìã Lista Incidenti </button>
         <button onclick="switchIncidentTab('stats')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üìä Statistiche </button>
        </div>
       </div>
       <div class="bg-white rounded-b-xl shadow-md p-8">
        <div id="incident-new-tab" class="incident-tab-content">
         <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Registra Nuovo Incidente</h3>
         <form class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Titolo Incidente</label>
            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Attacco ransomware">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Data Rilevamento</label>
            <input type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Severit√†</label>
            <select class="w-full px-4 py-2 border border-gray-300 rounded-lg">
             <option>üî¥ Critica</option>
             <option>üü† Alta</option>
             <option>üü° Media</option>
             <option>üîµ Bassa</option>
            </select>
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Stato</label>
            <select class="w-full px-4 py-2 border border-gray-300 rounded-lg">
             <option>üî¥ Aperto</option>
             <option>üü° In Corso</option>
             <option>üü¢ Risolto</option>
            </select>
           </div>
          </div>
          <div>
           <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
           <textarea rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Dettagli dell'incidente..."></textarea>
          </div>
          <button type="submit" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg"> üíæ Salva Incidente </button>
         </form>
        </div>
        <div id="incident-list-tab" class="incident-tab-content hidden">
         <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Tutti gli Incidenti</h3>
         <div class="space-y-3">
          <p class="text-gray-500 text-center py-8">Nessun incidente registrato</p>
         </div>
        </div>
        <div id="incident-stats-tab" class="incident-tab-content hidden">
         <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Statistiche Incidenti</h3>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
           <p class="text-sm text-gray-600">Incidenti Critici</p>
           <p class="text-3xl font-bold text-red-600">0</p>
          </div>
          <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
           <p class="text-sm text-gray-600">In Gestione</p>
           <p class="text-3xl font-bold text-yellow-600">0</p>
          </div>
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
           <p class="text-sm text-gray-600">Risolti</p>
           <p class="text-3xl font-bold text-green-600">0</p>
          </div>
         </div>
        </div>
       </div>
      </div>
     </section>
     <section id="designation-detail-section" class="section-content hidden">
      <div class="max-w-5xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">üìã Designazione Referente CSIRT</h2>
       <p class="text-gray-600 mb-6">Compila i dati del referente CSIRT, sostituti e contatto ACN secondo normativa NIS2</p>
       <div class="bg-white rounded-t-xl shadow-md border-b border-gray-200">
        <div class="flex space-x-1 p-2">
         <button onclick="switchDesignationTab('referente')" class="designation-tab px-6 py-3 rounded-lg font-medium bg-purple-100 text-purple-700"> üë§ Referente CSIRT </button>
         <button onclick="switchDesignationTab('acn')" class="designation-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üèõÔ∏è Contatto ACN </button>
         <button onclick="switchDesignationTab('sostituti')" class="designation-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üë• Sostituti </button>
        </div>
       </div>
       <div class="bg-white rounded-b-xl shadow-md p-8">
        <div id="designation-referente-tab" class="designation-tab-content">
         <h3 class="text-lg font-bold text-gray-800 mb-4">üë§ Dati Referente CSIRT Principale</h3>
         <form class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Nome e Cognome</label>
            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Mario Rossi">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label>
            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. RSSMRA80A01H501Z">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. mario.rossi@azienda.it">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
            <input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 333 1234567">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ruolo Aziendale</label>
            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Responsabile IT">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Data Nomina</label>
            <input type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
          </div>
          <button type="submit" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg"> üíæ Salva Referente </button>
         </form>
        </div>
        <div id="designation-acn-tab" class="designation-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">üèõÔ∏è Dati Contatto ACN</h3>
         <form class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Luigi">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label>
            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Verdi">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Ufficiale</label>
            <input type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. luigi.verdi@acn.gov.it">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
            <input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 06 1234567">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">PEC</label>
            <input type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. acn@pec.gov.it">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ufficio di Riferimento</label>
            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Dipartimento Cyber">
           </div>
          </div>
          <button type="submit" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg"> üíæ Salva Contatto ACN </button>
         </form>
        </div>
        <div id="designation-sostituti-tab" class="designation-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-6">üë• Sostituti del Referente CSIRT</h3>
         <div class="mb-8 p-6 bg-gray-50 rounded-lg">
          <h4 class="font-semibold text-gray-800 mb-4">Sostituto 1</h4>
          <form class="space-y-4">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
             <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Anna">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label>
             <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Bianchi">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
             <input type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. anna.bianchi@azienda.it">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
             <input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 333 9876543">
            </div>
           </div>
          </form>
         </div>
         <div class="p-6 bg-gray-50 rounded-lg">
          <h4 class="font-semibold text-gray-800 mb-4">Sostituto 2 (Opzionale)</h4>
          <form class="space-y-4">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
             <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Paolo">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label>
             <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Verdi">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
             <input type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. paolo.verdi@azienda.it">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
             <input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 333 5556677">
            </div>
           </div>
          </form>
         </div>
         <button type="submit" class="mt-6 px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg"> üíæ Salva Sostituti </button>
        </div>
       </div>
      </div>
     </section>
     <section id="network-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">üåê Configurazione Rete Aziendale</h2>
       <p class="text-gray-600 mb-6">Definisci la topologia, sicurezza perimetrale e connettivit√† della rete</p>
       <div class="bg-white rounded-t-xl shadow-md border-b border-gray-200">
        <div class="flex space-x-1 p-2">
         <button onclick="switchNetworkTab('topology')" class="network-tab px-6 py-3 rounded-lg font-medium bg-green-100 text-green-700"> üåê Topologia </button>
         <button onclick="switchNetworkTab('security')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üîí Sicurezza </button>
         <button onclick="switchNetworkTab('connectivity')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üì° Connettivit√† </button>
         <button onclick="switchNetworkTab('diagram')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üìä Diagramma Rete </button>
         <button onclick="switchNetworkTab('devices')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> üñ•Ô∏è Dispositivi </button>
        </div>
       </div>
       <div class="bg-white rounded-b-xl shadow-md p-8">
        <div id="network-topology-tab" class="network-tab-content">
         <h3 class="text-lg font-bold text-gray-800 mb-4">üåê Topologia di Rete</h3>
         <form id="topology-form" onsubmit="saveTopology(event)" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo Topologia</label>
            <select id="topology-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
             <option value="stella">‚≠ê Stella</option>
             <option value="mesh">üï∏Ô∏è Mesh</option>
             <option value="ibrida">üîÄ Ibrida</option>
             <option value="gerarchica">üìä Gerarchica</option>
            </select>
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Dimensione Rete</label>
            <select id="network-size" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
             <option value="piccola">Piccola (&lt; 50 dispositivi)</option>
             <option value="media">Media (50-200 dispositivi)</option>
             <option value="grande">Grande (&gt; 200 dispositivi)</option>
            </select>
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Numero Subnet</label>
            <input id="subnet-count" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 5" min="1">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Numero VLAN</label>
            <input id="vlan-count" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 3" min="1">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Range IP Principale</label>
            <input id="ip-range" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 192.168.1.0/24">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Gateway Predefinito</label>
            <input id="gateway" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 192.168.1.1">
           </div>
          </div>
          <div>
           <label class="block text-sm font-medium text-gray-700 mb-2">Note sulla Topologia</label>
           <textarea id="topology-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Descrivi l'architettura di rete..."></textarea>
          </div>
          <button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"> üíæ Salva Topologia </button>
         </form>
        </div>
        <div id="network-security-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">üîí Sicurezza Perimetrale</h3>
         <form id="security-form" onsubmit="saveSecurity(event)" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo Firewall</label>
            <select id="firewall-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
             <option value="ngfw">üî• NGFW (Next-Gen)</option>
             <option value="stateful">üìä Stateful</option>
             <option value="utm">üõ°Ô∏è UTM</option>
             <option value="cloud">‚òÅÔ∏è Cloud-based</option>
            </select>
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Vendor Firewall</label>
            <input id="firewall-vendor" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Palo Alto, Fortinet, Cisco">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Versione Firmware</label>
            <input id="firewall-version" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 10.2.3">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Data Ultimo Aggiornamento</label>
            <input id="firewall-update" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg">
            <input id="has-ids" type="checkbox" class="w-5 h-5">
            <label class="text-sm font-medium text-gray-700">IDS/IPS Attivo</label>
           </div>
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg">
            <input id="has-waf" type="checkbox" class="w-5 h-5">
            <label class="text-sm font-medium text-gray-700">WAF (Web Application Firewall)</label>
           </div>
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg">
            <input id="has-antivirus" type="checkbox" class="w-5 h-5">
            <label class="text-sm font-medium text-gray-700">Antivirus Gateway</label>
           </div>
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg">
            <input id="has-ddos" type="checkbox" class="w-5 h-5">
            <label class="text-sm font-medium text-gray-700">DDoS Protection</label>
           </div>
          </div>
          <button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"> üíæ Salva Sicurezza </button>
         </form>
        </div>
        <div id="network-connectivity-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">üì° Connettivit√† Internet e WAN</h3>
         <form id="connectivity-form" onsubmit="saveConnectivity(event)" class="space-y-6">
          <div class="p-4 bg-blue-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">ISP Primario</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Provider</label>
             <input id="isp-primary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. TIM, Vodafone">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Banda Garantita</label>
             <input id="bandwidth-primary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 1 Gbps">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Tipo Connessione</label>
             <select id="connection-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              <option value="fibra">Fibra Ottica</option>
              <option value="adsl">ADSL/VDSL</option>
              <option value="wireless">Wireless</option>
              <option value="lease">Lease Line</option>
             </select>
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">IP Pubblico</label>
             <input id="public-ip" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 203.0.113.1">
            </div>
           </div>
          </div>
          <div class="p-4 bg-orange-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">ISP Secondario (Backup)</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Provider</label>
             <input id="isp-secondary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Fastweb, WindTre">
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Banda Disponibile</label>
             <input id="bandwidth-secondary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 500 Mbps">
            </div>
           </div>
          </div>
          <div class="p-4 bg-purple-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">Configurazione VPN</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex items-center space-x-3">
             <input id="has-vpn" type="checkbox" class="w-5 h-5">
             <label class="text-sm font-medium text-gray-700">VPN Aziendale Configurata</label>
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Protocollo VPN</label>
             <select id="vpn-protocol" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              <option value="ipsec">IPSec</option>
              <option value="openvpn">OpenVPN</option>
              <option value="wireguard">WireGuard</option>
              <option value="ssl">SSL VPN</option>
             </select>
            </div>
            <div>
             <label class="block text-sm font-medium text-gray-700 mb-2">Numero Utenti VPN</label>
             <input id="vpn-users" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 50" min="0">
            </div>
           </div>
          </div>
          <button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"> üíæ Salva Connettivit√† </button>
         </form>
        </div>
        <div id="network-diagram-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Diagramma Visuale della Rete</h3>
         <div id="network-diagram-container" class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-8 border-2 border-dashed border-gray-300">
          <div class="text-center text-gray-500 py-12">
           <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg>
           <p class="text-lg font-medium">Configura prima la tua rete</p>
           <p class="text-sm mt-2">Compila i dati nei tab Topologia, Sicurezza e Connettivit√† per generare il diagramma automaticamente</p>
          </div>
         </div>
         <div id="network-legend" class="hidden mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
          </div>
         <div class="mt-4 text-center text-sm text-gray-500"> üí° <strong>Tip:</strong> Il diagramma si aggiorna automaticamente quando salvi le configurazioni </div>
        </div>
        <div id="network-devices-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">üñ•Ô∏è Inventario Dispositivi di Rete</h3>
         <div class="mb-4 flex justify-between items-center">
          <div class="flex space-x-2">
           <button onclick="filterDevices('all')" class="device-filter px-4 py-2 rounded-lg bg-green-100 text-green-700 font-medium"> Tutti </button>
           <button onclick="filterDevices('switch')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Switch </button>
           <button onclick="filterDevices('router')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Router </button>
           <button onclick="filterDevices('firewall')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Firewall </button>
           <button onclick="filterDevices('ap')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Access Point </button>
          </div>
          <button onclick="showAddDeviceModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium"> ‚ûï Aggiungi Dispositivo </button>
         </div>
         <div id="devices-list" class="space-y-3">
          <p class="text-gray-500 text-center py-8">Nessun dispositivo registrato. Clicca "Aggiungi Dispositivo" per iniziare.</p>
         </div>
         <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-start space-x-3">
           <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>
           <div>
            <h4 class="font-semibold text-blue-900 mb-1">üìù Gestione Inventario</h4>
            <p class="text-sm text-blue-800">Mantieni aggiornato l'inventario di tutti i dispositivi di rete. Include informazioni su marca, modello, versione firmware, indirizzo IP/MAC e stato operativo. Questa documentazione √® fondamentale per la conformit√† NIS2.</p>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div>
  </div>
  <script>
    // =================================================================
    // === CONFIGURAZIONE SUPABASE - INSERIRE LE PROPRIE CHIAVI QUI ===
    // =================================================================
    const SUPABASE_URL = 'https://gkoqpayaddyzmgfnripx.supabase.co'; // es: https://abcde12345.supabase.co
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdrb3FwYXlhZGR5em1nZm5yaXB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNTU4NzUsImV4cCI6MjA3OTgzMTg3NX0.4fYTxWxxxcbMzdP7-Xu2SGfv0TEqFk67G7pJ6K-8ayg'; // es: eyJhbGciOiJIUzI1NiI...

    // === GLOBAL STATE ===
    let supabase = null;
    let currentUser = null;
    let currentDeviceFilter = 'all';

    // Inizializza l'istanza Supabase
    if (SUPABASE_URL !== 'INSERISCI_IL_TUO_PROJECT_URL') {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('üîó Supabase inizializzato con successo!');
    } else {
      console.error('‚ùå ERRORE: Inserisci le tue credenziali Supabase.');
    }

    // Nota: I DEMO_USERS non sono pi√π usati per l'autenticazione,
    // ma mantengono i dati del ruolo e nome per l'interfaccia.
    // Gli utenti devono essere creati nel pannello Auth di Supabase!
    const DEMO_USERS_INFO = [
      { email: 'admin@csirt.it', role: 'admin', name: 'Admin Sistema', company: null },
      { email: 'csirt@hub.it', role: 'csirt', name: 'Marco Rossi', company: null },
      { email: 'azienda@test.it', role: 'azienda', name: 'Giuseppe Verdi', company: 'Azienda Test SRL' }
    ];

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
      // Verifica la sessione Supabase esistente
      checkExistingSession();
    });


    // =================================================================
    // === AUTENTICAZIONE (USANDO SUPABASE AUTH) ===
    // =================================================================

    async function handleLogin(event) {
      event.preventDefault();

      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const role = document.getElementById('login-role').value;

      if (!supabase) {
        showErrorMessage('Configurazione Supabase mancante.', 'Inserisci le credenziali nel codice.');
        return;
      }
      
      try {
        // Tentativo di login con Supabase
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password,
        });

        if (error) {
          throw error;
        }

        // Dopo il login riuscito, recupera i metadati dell'utente dalla lista demo 
        // per simulare i ruoli (in produzione dovresti usare tabelle profile)
        const userMetadata = DEMO_USERS_INFO.find(u => u.email === email && u.role === role);

        if (!userMetadata) {
          // Se l'email esiste ma il ruolo √® sbagliato, forziamo il logout
          await supabase.auth.signOut();
          showErrorMessage('Accesso non autorizzato', 'La combinazione Email/Ruolo non √® corretta. Prova: csirt@hub.it / csirt123 / Consulente CSIRT');
          return;
        }

        currentUser = {
          id: data.user.id,
          email: data.user.email,
          role: userMetadata.role,
          name: userMetadata.name,
          company: userMetadata.company
        };

        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        console.log('‚úÖ Login Supabase riuscito!', currentUser);
        showMainApp();

      } catch (e) {
        console.error('‚ùå Login fallito:', e);
        showErrorMessage('Credenziali non valide', 'Email o Password errata. Verifica anche di aver creato l\'utente nel pannello Auth di Supabase.');
      }
    }

    async function checkExistingSession() {
      if (!supabase) return;

      const { data: { session }, error } = await supabase.auth.getSession();

      if (session) {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
          currentUser = JSON.parse(savedUser);
          // Ricarichiamo i dati di sessione reali da Supabase
          currentUser.id = session.user.id;
          currentUser.email = session.user.email;
          showMainApp();
        } else {
          // Se la sessione Supabase esiste, ma non abbiamo i metadati locali
          await supabase.auth.signOut();
        }
      }
    }

    async function logout() {
      if (supabase) {
        await supabase.auth.signOut();
      }
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-form').reset();
    }

    function showErrorMessage(title, details) {
      const existingError = document.querySelector('#login-error-message');
      if (existingError) existingError.remove();

      const form = document.getElementById('login-form');
      const statusDiv = document.createElement('div');
      statusDiv.id = 'login-error-message';
      statusDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm';
      statusDiv.innerHTML = `
          <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div>
              <strong class="font-semibold">‚ùå ${title}</strong>
              <div class="mt-2 text-xs">
                 ${details}
              </div>
            </div>
          </div>
        `;
      form.appendChild(statusDiv);
      setTimeout(() => statusDiv.remove(), 6000);
    }

    // === UTILITY, NAVIGATION & DISPLAY (non modificate, usano i dati Supabase) ===
    
    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');

      const roleLabels = {
        'admin': 'Amministratore',
        'csirt': 'Consulente CSIRT',
        'azienda': 'Referente Aziendale'
      };
      
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('user-role').textContent = roleLabels[currentUser.role];

      filterSidebarByRole();
      loadDashboardData();
      loadNetworkData();
      loadDevices(); // <-- Chiama la nuova funzione Supabase
      
      if (currentUser.role === 'csirt') {
        document.getElementById('csirt-dashboard-cards').classList.remove('hidden');
      }
    }

    function filterSidebarByRole() {
      const navItems = document.querySelectorAll('.nav-item[data-role]');
      navItems.forEach(item => {
        const allowedRoles = item.getAttribute('data-role').split(',');
        if (!allowedRoles.includes(currentUser.role)) {
          item.style.display = 'none';
        } else {
          item.style.display = 'flex';
        }
      });
    }

    function showSection(sectionName) {
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
      });

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
      });

      const section = document.getElementById(sectionName + '-section');
      if (section) {
        section.classList.remove('hidden');
      }

      if (event && event.target) {
        event.target.closest('.nav-item').classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
      }
    }

    function switchIncidentTab(tabName) {
      document.querySelectorAll('.incident-tab-content').forEach(content => {
        content.classList.add('hidden');
      });

      document.querySelectorAll('.incident-tab').forEach(btn => {
        btn.classList.remove('bg-red-100', 'text-red-700');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });

      document.getElementById('incident-' + tabName + '-tab').classList.remove('hidden');

      event.target.classList.add('bg-red-100', 'text-red-700');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
    }

    function switchDesignationTab(tabName) {
      document.querySelectorAll('.designation-tab-content').forEach(content => {
        content.classList.add('hidden');
      });

      document.querySelectorAll('.designation-tab').forEach(btn => {
        btn.classList.remove('bg-purple-100', 'text-purple-700');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });

      document.getElementById('designation-' + tabName + '-tab').classList.remove('hidden');

      event.target.classList.add('bg-purple-100', 'text-purple-700');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
    }

    function switchNetworkTab(tabName) {
      document.querySelectorAll('.network-tab-content').forEach(content => {
        content.classList.add('hidden');
      });

      document.querySelectorAll('.network-tab').forEach(btn => {
        btn.classList.remove('bg-green-100', 'text-green-700');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });

      document.getElementById('network-' + tabName + '-tab').classList.remove('hidden');

      event.target.classList.add('bg-green-100', 'text-green-700');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
    }

    // === GESTIONE DISPOSITIVI (CRUD SUPABASE) ===

    function showAddDeviceModal() {
      document.getElementById('device-modal').classList.remove('hidden');
      document.getElementById('modal-title').textContent = '‚ûï Aggiungi Nuovo Dispositivo';
      document.getElementById('device-form').reset();
      document.getElementById('device-id').value = '';
    }

    function closeDeviceModal() {
      document.getElementById('device-modal').classList.add('hidden');
      document.getElementById('device-form').reset();
    }

    async function saveDevice(event) {
      event.preventDefault();

      const deviceId = document.getElementById('device-id').value;
      
      const deviceData = {
        type: document.getElementById('device-type').value,
        name: document.getElementById('device-name').value,
        vendor: document.getElementById('device-vendor').value,
        model: document.getElementById('device-model').value,
        ip: document.getElementById('device-ip').value,
        mac: document.getElementById('device-mac').value,
        firmware: document.getElementById('device-firmware').value,
        status: document.getElementById('device-status').value,
        ports: parseInt(document.getElementById('device-ports').value) || 0,
        location: document.getElementById('device-location').value,
        notes: document.getElementById('device-notes').value,
        // user_id: currentUser.id, // Aggiungere se si implementa il filtraggio RLS per utente
      };

      let operation;
      let error;
      
      if (deviceId) {
        // Operazione di UPDATE
        operation = await supabase
          .from('devices')
          .update(deviceData)
          .eq('id', deviceId)
          .select();
          
        error = operation.error;
      } else {
        // Operazione di INSERT (Aggiungi)
        const newDeviceData = {
          ...deviceData,
          id: Date.now().toString(), // Generiamo un ID client-side semplice per la demo
        };
        
        operation = await supabase
          .from('devices')
          .insert([newDeviceData])
          .select();
          
        error = operation.error;
      }

      if (error) {
        console.error('‚ùå Errore nel salvataggio del dispositivo:', error);
        showErrorMessage('Errore DB', `Impossibile salvare il dispositivo: ${error.message}`);
        return;
      }

      showSuccessMessage(`‚úÖ Dispositivo ${deviceId ? 'aggiornato' : 'aggiunto'} con successo!`);
      closeDeviceModal();
      loadDevices(); // Ricarica la lista
    }

    async function loadDevices() {
      if (!supabase) return;
      
      // Carica i dispositivi dal DB
      const { data: devices, error } = await supabase
        .from('devices')
        .select('*')
        .order('name', { ascending: true }); 

      if (error) {
        console.error('‚ùå Errore nel caricamento dei dispositivi:', error);
        document.getElementById('devices-list').innerHTML = `<p class="text-red-600 text-center py-8">Errore di connessione al database: ${error.message}</p>`;
        return;
      }
      
      // Usa la funzione di visualizzazione esistente
      displayDevices(devices || []);
    }

    function filterDevices(filterType) {
      currentDeviceFilter = filterType;

      document.querySelectorAll('.device-filter').forEach(btn => {
        btn.classList.remove('bg-green-100', 'text-green-700', 'font-medium');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });

      event.target.classList.add('bg-green-100', 'text-green-700', 'font-medium');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');

      // Ricarica la lista con il filtro
      loadDevices(); // Nota: questa logica di filtro √® da ottimizzare
    }

    function displayDevices(devices) {
      const container = document.getElementById('devices-list');
      
      // Applica il filtro UI ai dati
      const filteredDevices = currentDeviceFilter === 'all' 
        ? devices 
        : devices.filter(d => d.type === currentDeviceFilter);

      if (filteredDevices.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun dispositivo trovato per questo filtro.</p>';
        return;
      }

      const deviceIcons = {
        'switch': 'üîÄ',
        'router': 'üåê',
        'firewall': 'üî•',
        'ap': 'üì°'
      };

      const deviceColors = {
        'switch': 'blue',
        'router': 'orange',
        'firewall': 'red',
        'ap': 'purple'
      };

      const statusColors = {
        'online': 'green',
        'offline': 'red',
        'maintenance': 'yellow'
      };

      const statusLabels = {
        'online': 'üü¢ Online',
        'offline': 'üî¥ Offline',
        'maintenance': 'üü° Manutenzione'
      };

      container.innerHTML = filteredDevices.map(device => {
        const color = deviceColors[device.type] || 'gray';
        const icon = deviceIcons[device.type] || 'üñ•Ô∏è';
        const statusColor = statusColors[device.status] || 'gray';
        const statusLabel = statusLabels[device.status] || device.status;

        return `
          <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-${color}-500">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4 flex-1">
                <div class="text-3xl">${icon}</div>
                <div class="flex-1">
                  <h4 class="font-bold text-gray-800">${device.name} - ${device.vendor} ${device.model}</h4>
                  <p class="text-sm text-gray-600">ID: ${device.id} | IP: ${device.ip}${device.mac ? ' | MAC: ' + device.mac : ''}</p>
                  <div class="flex space-x-2 mt-1 flex-wrap">
                    <span class="text-xs bg-${statusColor}-100 text-${statusColor}-700 px-2 py-1 rounded">${statusLabel}</span>
                    ${device.firmware ? `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">FW: ${device.firmware}</span>` : ''}
                    ${device.ports ? `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${device.ports} Porte</span>` : ''}
                    ${device.location ? `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">üìç ${device.location}</span>` : ''}
                  </div>
                </div>
              </div>
              <div class="flex space-x-2 ml-4">
                <button onclick="editDevice('${device.id}')" class="p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button onclick="deleteDevice('${device.id}')" class="p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </div>
            ${device.notes ? `<p class="text-sm text-gray-500 mt-2 pl-16">üìù ${device.notes}</p>` : ''}
          </div>
        `;
      }).join('');
    }

    async function editDevice(deviceId) {
      if (!supabase) return;

      // Recupera il dispositivo specifico dal DB
      const { data: device, error } = await supabase
        .from('devices')
        .select('*')
        .eq('id', deviceId)
        .single();
        
      if (error || !device) {
        console.error('Errore nel recupero del dispositivo:', error);
        showErrorMessage('Errore DB', 'Dispositivo non trovato.');
        return;
      }

      document.getElementById('device-modal').classList.remove('hidden');
      document.getElementById('modal-title').textContent = '‚úèÔ∏è Modifica Dispositivo';

      document.getElementById('device-id').value = device.id;
      document.getElementById('device-type').value = device.type;
      document.getElementById('device-name').value = device.name;
      document.getElementById('device-vendor').value = device.vendor;
      document.getElementById('device-model').value = device.model;
      document.getElementById('device-ip').value = device.ip;
      document.getElementById('device-mac').value = device.mac || '';
      document.getElementById('device-firmware').value = device.firmware || '';
      document.getElementById('device-status').value = device.status;
      document.getElementById('device-ports').value = device.ports || '';
      document.getElementById('device-location').value = device.location || '';
      document.getElementById('device-notes').value = device.notes || '';
    }

    function deleteDevice(deviceId) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md">
          <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
              <svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-gray-800 mb-2">Conferma Eliminazione</h3>
              <p class="text-gray-600 mb-6">Sei sicuro di voler eliminare questo dispositivo? L'operazione non pu√≤ essere annullata.</p>
              <div class="flex space-x-3">
                <button onclick="confirmDeleteDevice('${deviceId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg">
                  Elimina
                </button>
                <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg">
                  Annulla
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(confirmDiv);
    }

    async function confirmDeleteDevice(deviceId) {
      if (!supabase) return;
      
      const { error } = await supabase
        .from('devices')
        .delete()
        .eq('id', deviceId);

      document.querySelector('.modal-overlay').remove();
      
      if (error) {
        console.error('Errore durante l\'eliminazione:', error);
        showErrorMessage('Errore DB', `Impossibile eliminare il dispositivo: ${error.message}`);
        return;
      }

      showSuccessMessage('‚úÖ Dispositivo eliminato con successo!');
      loadDevices();
    }

    // === NETWORK CONFIGURATION MANAGEMENT (ancora su localStorage) ===
    
    function saveTopology(event) {
      event.preventDefault();

      const topologyData = {
        type: document.getElementById('topology-type').value,
        size: document.getElementById('network-size').value,
        subnetCount: document.getElementById('subnet-count').value,
        vlanCount: document.getElementById('vlan-count').value,
        ipRange: document.getElementById('ip-range').value,
        gateway: document.getElementById('gateway').value,
        notes: document.getElementById('topology-notes').value
      };

      localStorage.setItem('networkTopology', JSON.stringify(topologyData));

      showSuccessMessage('‚úÖ Topologia salvata con successo!');
      generateNetworkDiagram();
    }

    function saveSecurity(event) {
      event.preventDefault();

      const securityData = {
        firewallType: document.getElementById('firewall-type').value,
        firewallVendor: document.getElementById('firewall-vendor').value,
        firewallVersion: document.getElementById('firewall-version').value,
        lastUpdate: document.getElementById('firewall-update').value,
        hasIDS: document.getElementById('has-ids').checked,
        hasWAF: document.getElementById('has-waf').checked,
        hasAntivirus: document.getElementById('has-antivirus').checked,
        hasDDoS: document.getElementById('has-ddos').checked
      };

      localStorage.setItem('networkSecurity', JSON.stringify(securityData));

      showSuccessMessage('‚úÖ Configurazione sicurezza salvata!');
      generateNetworkDiagram();
    }

    function saveConnectivity(event) {
      event.preventDefault();

      const connectivityData = {
        ispPrimary: document.getElementById('isp-primary').value,
        bandwidthPrimary: document.getElementById('bandwidth-primary').value,
        connectionType: document.getElementById('connection-type').value,
        publicIP: document.getElementById('public-ip').value,
        ispSecondary: document.getElementById('isp-secondary').value,
        bandwidthSecondary: document.getElementById('bandwidth-secondary').value,
        hasVPN: document.getElementById('has-vpn').checked,
        vpnProtocol: document.getElementById('vpn-protocol').value,
        vpnUsers: document.getElementById('vpn-users').value
      };

      localStorage.setItem('networkConnectivity', JSON.stringify(connectivityData));

      showSuccessMessage('‚úÖ Connettivit√† salvata con successo!');
      generateNetworkDiagram();
    }

    function showSuccessMessage(message) {
      const existingMsg = document.querySelector('.success-toast');
      if (existingMsg) existingMsg.remove();

      const toast = document.createElement('div');
      toast.className = 'success-toast fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    function generateNetworkDiagram() {
      const topology = JSON.parse(localStorage.getItem('networkTopology') || '{}');
      const security = JSON.parse(localStorage.getItem('networkSecurity') || '{}');
      const connectivity = JSON.parse(localStorage.getItem('networkConnectivity') || '{}');

      if (!topology.type || !topology.vlanCount) {
        return;
      }

      const container = document.getElementById('network-diagram-container');
      const vlanCount = parseInt(topology.vlanCount) || 3;
      const hasFirewall = security.firewallType ? true : false;
      const hasBackupISP = connectivity.ispSecondary ? true : false;

      const vlanColors = [
        { fill: '#8b5cf6', stroke: '#7c3aed', name: 'Management' },
        { fill: '#f59e0b', stroke: '#d97706', name: 'Production' },
        { fill: '#06b6d4', stroke: '#0891b2', name: 'Guest' },
        { fill: '#ec4899', stroke: '#db2777', name: 'DMZ' },
        { fill: '#10b981', stroke: '#059669', name: 'IoT' }
      ];

      const baseIP = topology.ipRange ? topology.ipRange.split('.').slice(0, 3).join('.') : '192.168';

      const spacing = 800 / (vlanCount + 1);
      let svgContent = `<svg viewBox="0 0 800 550" class="w-full" style="max-height: 550px;">`;

      svgContent += `
        <g transform="translate(400, 30)">
          <ellipse cx="0" cy="0" rx="60" ry="35" fill="#3b82f6" opacity="0.2" stroke="#3b82f6" stroke-width="2"/>
          <text x="0" y="5" text-anchor="middle" font-size="14" fill="#1e40af" font-weight="bold">‚òÅÔ∏è Internet</text>
          <text x="0" y="20" text-anchor="middle" font-size="9" fill="#2563eb">${connectivity.ispPrimary || 'ISP'}</text>
        </g>
      `;

      if (hasBackupISP) {
        svgContent += `
          <g transform="translate(580, 30)">
            <ellipse cx="0" cy="0" rx="50" ry="30" fill="#f97316" opacity="0.2" stroke="#f97316" stroke-width="2"/>
            <text x="0" y="5" text-anchor="middle" font-size="11" fill="#c2410c" font-weight="bold">‚òÅÔ∏è Backup</text>
            <text x="0" y="18" text-anchor="middle" font-size="8" fill="#ea580c">${connectivity.ispSecondary}</text>
          </g>
          <line x1="530" y1="50" x2="460" y2="95" stroke="#f97316" stroke-width="2" stroke-dasharray="3,3"/>
        `;
      }

      svgContent += `<line x1="400" y1="65" x2="400" y2="95" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5"/>`;

      if (hasFirewall) {
        const firewallLabel = security.firewallVendor || 'Firewall';
        svgContent += `
          <g transform="translate(400, 120)">
            <rect x="-45" y="-28" width="90" height="56" rx="5" fill="#ef4444" opacity="0.2" stroke="#dc2626" stroke-width="2"/>
            <text x="0" y="0" text-anchor="middle" font-size="12" fill="#991b1b" font-weight="bold">üî• ${firewallLabel}</text>
            <text x="0" y="15" text-anchor="middle" font-size="8" fill="#b91c1c">${security.firewallType?.toUpperCase() || ''}</text>
          </g>
          <line x1="400" y1="148" x2="400" y2="190" stroke="#64748b" stroke-width="2"/>
        `;
      } else {
        svgContent += `<line x1="400" y1="95" x2="400" y2="190" stroke="#64748b" stroke-width="2"/>`;
      }

      svgContent += `
        <g transform="translate(400, 220)">
          <rect x="-55" y="-28" width="110" height="56" rx="5" fill="#10b981" opacity="0.2" stroke="#059669" stroke-width="2"/>
          <text x="0" y="0" text-anchor="middle" font-size="12" fill="#065f46" font-weight="bold">üîÄ Core Switch</text>
          <text x="0" y="15" text-anchor="middle" font-size="8" fill="#047857">${topology.type?.toUpperCase() || ''}</text>
        </g>
      `;

      const legendItems = [];
      for (let i = 0; i < vlanCount && i < 5; i++) {
        const x = 100 + spacing * i; 
        const color = vlanColors[i];
        const vlanId = (i + 1) * 10;
        const ipSubnet = `${baseIP}.${vlanId}.0/24`;

        svgContent += `<line x1="400" y1="248" x2="${x}" y2="330" stroke="#64748b" stroke-width="2"/>`;

        svgContent += `
          <g transform="translate(${x}, 365)">
            <rect x="-75" y="-30" width="150" height="60" rx="8" fill="${color.fill}" opacity="0.15" stroke="${color.stroke}" stroke-width="2"/>
            <text x="0" y="-8" text-anchor="middle" font-size="11" fill="${color.stroke}" font-weight="bold">VLAN ${vlanId}</text>
            <text x="0" y="8" text-anchor="middle" font-size="10" fill="${color.stroke}">${color.name}</text>
            <text x="0" y="22" text-anchor="middle" font-size="8" fill="${color.stroke}">${ipSubnet}</text>
          </g>
        `;

        const icons = i === 0 ? 'üñ•Ô∏è üñ•Ô∏è üñ•Ô∏è' : i === 1 ? 'üíª üíª üñ®Ô∏è' : i === 2 ? 'üì± üì± üåê' : i === 3 ? 'üåê üîí üì°' : 'üè≠ üè≠ üìü';
        svgContent += `<text x="${x}" y="445" text-anchor="middle" font-size="18">${icons}</text>`;

        legendItems.push({ color: color.fill, name: `VLAN ${color.name}`, subnet: ipSubnet });
      }

      if (connectivity.hasVPN) {
        svgContent += `
          <g transform="translate(100, 220)">
            <rect x="-40" y="-20" width="80" height="40" rx="5" fill="#a855f7" opacity="0.2" stroke="#9333ea" stroke-width="2"/>
            <text x="0" y="5" text-anchor="middle" font-size="10" fill="#7e22ce" font-weight="bold">üîê VPN</text>
            <text x="0" y="18" text-anchor="middle" font-size="7" fill="#9333ea">${connectivity.vpnProtocol?.toUpperCase()}</text>
          </g>
          <line x1="140" y1="220" x2="345" y2="220" stroke="#9333ea" stroke-width="2" stroke-dasharray="4,4"/>
        `;
      }

      svgContent += `</svg>`;

      container.innerHTML = svgContent;
      // ... (Resto della logica per la Legenda)
      const legend = document.getElementById('network-legend');
      legend.classList.remove('hidden');
      legend.innerHTML = legendItems.map(item => `
        <div class="bg-white p-3 rounded-lg shadow-sm border-l-4" style="border-color: ${item.color}">
          <div class="flex items-center space-x-2 mb-1">
            <div class="w-3 h-3 rounded" style="background-color: ${item.color}"></div>
            <span class="font-semibold text-sm">${item.name}</span>
          </div>
          <p class="text-xs text-gray-600">${item.subnet}</p>
        </div>
      `).join('');

      if (security.hasIDS || security.hasWAF) {
        const secFeatures = [];
        if (security.hasIDS) secFeatures.push('IDS/IPS');
        if (security.hasWAF) secFeatures.push('WAF');
        if (security.hasDDoS) secFeatures.push('DDoS Protection');

        legend.innerHTML += `
          <div class="bg-red-50 p-3 rounded-lg shadow-sm border-l-4 border-red-500">
            <div class="flex items-center space-x-2 mb-1">
              <span class="font-semibold text-sm">üõ°Ô∏è Protezioni Attive</span>
            </div>
            <p class="text-xs text-gray-600">${secFeatures.join(', ')}</p>
          </div>
        `;
      }
    }

    function loadNetworkData() {
      // Questa funzione continua a caricare da localStorage per coerenza.
      // In un passo successivo, dovremo migrare anche queste configurazioni a Supabase.
      const topology = JSON.parse(localStorage.getItem('networkTopology') || '{}');
      const security = JSON.parse(localStorage.getItem('networkSecurity') || '{}');
      const connectivity = JSON.parse(localStorage.getItem('networkConnectivity') || '{}');

      if (topology.type) {
        document.getElementById('topology-type').value = topology.type;
        document.getElementById('network-size').value = topology.size || '';
        document.getElementById('subnet-count').value = topology.subnetCount || '';
        document.getElementById('vlan-count').value = topology.vlanCount || '';
        document.getElementById('ip-range').value = topology.ipRange || '';
        document.getElementById('gateway').value = topology.gateway || '';
        document.getElementById('topology-notes').value = topology.notes || '';
      }

      if (security.firewallType) {
        document.getElementById('firewall-type').value = security.firewallType;
        document.getElementById('firewall-vendor').value = security.firewallVendor || '';
        document.getElementById('firewall-version').value = security.firewallVersion || '';
        document.getElementById('firewall-update').value = security.lastUpdate || '';
        document.getElementById('has-ids').checked = security.hasIDS || false;
        document.getElementById('has-waf').checked = security.hasWAF || false;
        document.getElementById('has-antivirus').checked = security.hasAntivirus || false;
        document.getElementById('has-ddos').checked = security.hasDDoS || false;
      }

      if (connectivity.ispPrimary) {
        document.getElementById('isp-primary').value = connectivity.ispPrimary;
        document.getElementById('bandwidth-primary').value = connectivity.bandwidthPrimary || '';
        document.getElementById('connection-type').value = connectivity.connectionType || 'fibra';
        document.getElementById('public-ip').value = connectivity.publicIP || '';
        document.getElementById('isp-secondary').value = connectivity.ispSecondary || '';
        document.getElementById('bandwidth-secondary').value = connectivity.bandwidthSecondary || '';
        document.getElementById('has-vpn').checked = connectivity.hasVPN || false;
        document.getElementById('vpn-protocol').value = connectivity.vpnProtocol || 'ipsec';
        document.getElementById('vpn-users').value = connectivity.vpnUsers || '';
      }

      generateNetworkDiagram();
    }

    function loadDashboardData() {
      // Logica del dashboard per ora rimane su dati mock/localStorage in attesa della migrazione completa
      const companies = JSON.parse(localStorage.getItem('companies') || '[]');
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');

      document.getElementById('total-companies').textContent = companies.length;

      const openIncidents = incidents.filter(i => i.status === 'aperto' || i.status === 'in-corso');
      document.getElementById('open-incidents').textContent = openIncidents.length;

      const pendingNotifications = notifications.filter(n => n.status === 'pending');
      document.getElementById('pending-notifications').textContent = pendingNotifications.length;

      const complianceScore = companies.length > 0 ? 85 : 0;
      document.getElementById('compliance-score').textContent = complianceScore + '%';

      loadRecentActivity();
    }

    function loadRecentActivity() {
      const activityContainer = document.getElementById('recent-activity');
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');

      if (incidents.length === 0) {
        activityContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nessuna attivit√† recente</p>';
        return;
      }

      const recentIncidents = incidents.slice(-5).reverse();

      activityContainer.innerHTML = recentIncidents.map(inc => `
        <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-medium text-gray-800">${inc.title}</p>
            <p class="text-sm text-gray-500">${inc.company} - ${new Date(inc.detectionDate).toLocaleDateString('it-IT')}</p>
          </div>
          <span class="status-badge status-${inc.status}">${inc.status.toUpperCase()}</span>
        </div>
      `).join('');
    }
  </script>
 </body>
</html>
