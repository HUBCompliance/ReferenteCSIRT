<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piattaforma CSIRT</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: #f1f5f9;
      color: #1e293b;
      width: 100%;
      height: 100%;
    }

    html {
      height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      background: #1e293b;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.5rem;
      background: #0f172a;
      border-bottom: 1px solid #334155;
    }

    .sidebar-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: #60a5fa;
    }

    .sidebar-nav {
      flex: 1;
      padding: 1rem 0;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.875rem 1.5rem;
      color: #cbd5e1;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      gap: 0.75rem;
    }

    .nav-item:hover {
      background: #334155;
      color: #ffffff;
    }

    .nav-item.active {
      background: #1e40af;
      color: #ffffff;
      border-left-color: #60a5fa;
    }

    .nav-item.hidden {
      display: none;
    }

    .nav-icon {
      font-size: 1.25rem;
      width: 24px;
      text-align: center;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #f1f5f9;
    }

    .top-bar {
      background: #ffffff;
      padding: 1.25rem 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #64748b;
      font-size: 0.875rem;
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .stat-title {
      font-size: 0.875rem;
      color: #64748b;
      font-weight: 500;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .stat-change {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-change.positive {
      color: #10b981;
    }

    .stat-change.negative {
      color: #ef4444;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1e293b;
      margin: 0;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge.critical {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.high {
      background: #fed7aa;
      color: #9a3412;
    }

    .badge.medium {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.low {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.essenziale {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.importante {
      background: #fed7aa;
      color: #9a3412;
    }

    .badge.aperto, .badge.aperta {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.in-corso {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.risolto, .badge.chiusa {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.notificata-acn {
      background: #e0e7ff;
      color: #4338ca;
    }

    .badge.conforme {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.non-conforme {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.in-progress {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.admin {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.csirt {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.azienda {
      background: #d1fae5;
      color: #065f46;
    }

    .btn {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: #ffffff;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #475569;
    }

    .empty-state-description {
      font-size: 0.875rem;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      padding: 2rem;
    }

    .modal h3 {
      margin: 0 0 1.5rem 0;
      color: #1e293b;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #475569;
      font-size: 0.875rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: inherit;
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .form-actions .btn {
      flex: 1;
    }

    .company-card, .incident-card, .audit-card, .csirt-card, .user-card, .notification-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 1.25rem;
      transition: all 0.2s ease;
    }

    .company-card:hover, .incident-card:hover, .audit-card:hover, .csirt-card:hover, .user-card:hover, .notification-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .card-header-inline {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .company-logo, .card-icon {
      width: 60px;
      height: 60px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
    }

    .card-name, .incident-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }

    .card-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .detail-label {
      font-size: 0.75rem;
      color: #64748b;
      font-weight: 500;
    }

    .detail-value {
      font-size: 0.875rem;
      color: #1e293b;
      font-weight: 600;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .login-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem;
    }

    .login-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logout-btn {
      background: transparent;
      color: #cbd5e1;
      padding: 0.625rem 1rem;
      border: 1px solid #475569;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logout-btn:hover {
      background: #475569;
      color: #ffffff;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #1e293b;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 3000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: #f8fafc;
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: #475569;
      border-bottom: 2px solid #e2e8f0;
    }

    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.875rem;
    }

    .data-table tr:hover {
      background: #f8fafc;
    }

    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-container {
        grid-template-columns: 1fr;
      }
    }

    .tabs-container {
      margin-top: 1.5rem;
    }

    .tabs-header {
      display: flex;
      gap: 0.5rem;
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }

    .tab-button {
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #64748b;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      margin-bottom: -2px;
    }

    .tab-button:hover {
      color: #3b82f6;
      background: #f1f5f9;
    }

    .tab-button.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    .tabs-content {
      min-height: 300px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .multi-select-container {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
      background: #f8fafc;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .checkbox-item:hover {
      background: #e2e8f0;
    }

    .checkbox-item input[type="checkbox"] {
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -260px;
        height: 100%;
        z-index: 1000;
        transition: left 0.3s ease;
      }

      .sidebar.mobile-open {
        left: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .content-area {
        padding: 1rem;
      }

      .card-details {
        grid-template-columns: 1fr;
      }

      .tabs-header {
        overflow-x: auto;
      }

      .tab-button {
        font-size: 0.8125rem;
        padding: 0.625rem 1rem;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Setup Screen (for first-time users) -->
  <div id="setup-screen" class="login-container">
   <div class="login-card" style="max-width: 550px;">
    <div class="login-header">
     <div style="font-size: 3rem; margin-bottom: 1rem;">
      üîß
     </div>
     <h1 style="margin: 0 0 0.5rem 0; font-size: 1.75rem; color: #1e293b;">Configurazione Iniziale</h1>
     <p style="margin: 0; color: #64748b; font-size: 0.9375rem;">Crea il primo utente amministratore</p>
    </div>
    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
     <p style="margin: 0; font-size: 0.875rem; color: #92400e;">‚ö†Ô∏è Nessun utente trovato nel sistema. Crea il primo amministratore per iniziare.</p>
    </div>
    <form id="setup-form" onsubmit="return false;">
     <div class="form-group"><label class="form-label" for="setup-name">Nome Completo *</label> <input type="text" id="setup-name" class="form-input" required placeholder="Mario Rossi">
     </div>
     <div class="form-group"><label class="form-label" for="setup-email">Email *</label> <input type="email" id="setup-email" class="form-input" required placeholder="admin@esempio.com">
     </div>
     <div class="form-group"><label class="form-label" for="setup-password">Password *</label> <input type="password" id="setup-password" class="form-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
      <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
       Minimo 6 caratteri
      </div>
     </div>
     <div class="form-group"><label class="form-label" for="setup-password-confirm">Conferma Password *</label> <input type="password" id="setup-password-confirm" class="form-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
     </div><button type="button" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 1rem;" onclick="createInitialAdmin()" id="setup-submit-btn"> ÔøΩÔøΩÔøΩÔøΩ Crea Amministratore </button>
    </form>
    <div style="background: #e0e7ff; border-left: 4px solid #4338ca; padding: 1rem; border-radius: 6px; margin-top: 1.5rem;">
     <p style="margin: 0; font-size: 0.875rem; color: #4338ca;">üí° Questo utente avr√† accesso completo a tutte le funzionalit√† della piattaforma.</p>
    </div>
   </div>
  </div><!-- Login Screen -->
  <div id="login-screen" class="login-container" style="display: none;">
   <div class="login-card">
    <div class="login-header">
     <div style="font-size: 3rem; margin-bottom: 1rem;">
      ÔøΩÔøΩÔøΩÔøΩÔ∏è
     </div>
     <h1 style="margin: 0 0 0.5rem 0; font-size: 1.75rem; color: #1e293b;">Piattaforma CSIRT</h1>
     <p style="margin: 0; color: #64748b; font-size: 0.9375rem;">Security &amp; Incident Management Portal</p>
    </div>
    <form id="login-form" onsubmit="return false;">
     <div class="form-group"><label class="form-label" for="login-email">Email</label> <input type="email" id="login-email" class="form-input" required placeholder="email@esempio.com">
     </div>
     <div class="form-group"><label class="form-label" for="login-password">Password</label> <input type="password" id="login-password" class="form-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
     </div><button type="button" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 1rem;" onclick="performLogin()"> Accedi </button>
    </form>
   </div>
  </div>
  <div class="app-container" id="main-app" style="display: none;"><!-- Sidebar -->
   <aside class="sidebar">
    <div class="sidebar-header">
     <h1>Piattaforma CSIRT</h1>
    </div>
    <nav class="sidebar-nav">
     <div class="nav-item active" data-page="dashboard"><span class="nav-icon">üìä</span> <span>Dashboard</span>
     </div>
     <div class="nav-item" data-page="companies" data-roles="admin,csirt"><span class="nav-icon">üè¢</span> <span>Gestione Aziende</span>
     </div>
     <div class="nav-item" data-page="incidents"><span class="nav-icon">üö®</span> <span>Registro Incidenti</span>
     </div>
     <div class="nav-item" data-page="notifications" data-roles="admin,csirt"><span class="nav-icon">üìã</span> <span>Registro Notifiche</span>
     </div>
     <div class="nav-item" data-page="audit" data-roles="admin,azienda"><span class="nav-icon">üîç</span> <span>Audit NIS2</span>
     </div>
     <div class="nav-item" data-page="csirt" data-roles="admin,csirt"><span class="nav-icon">üë®‚Äçüíº</span> <span>Referenti CSIRT</span>
     </div>
     <div class="nav-item" data-page="users" data-roles="admin"><span class="nav-icon">üë•</span> <span>Gestione Utenti</span>
     </div>
    </nav>
   </aside><!-- Main Content -->
   <main class="main-content">
    <div class="top-bar">
     <h2 id="page-title">Dashboard</h2>
     <div class="user-info">
      <div style="display: flex; align-items: center; gap: 0.75rem; margin-right: 1rem;"><span id="user-icon">üë§</span>
       <div style="display: flex; flex-direction: column; align-items: flex-end;"><span id="current-user-name" style="font-weight: 600; color: #1e293b;">Utente</span> <span id="current-user-role" class="badge" style="margin-top: 0.25rem;">User</span>
       </div>
      </div><button class="logout-btn" onclick="logout()"> <span>ÔøΩÔøΩÔøΩ</span> <span>Esci</span> </button>
     </div>
    </div>
    <div class="content-area"><!-- Dashboard Page -->
     <section class="page-section active" id="dashboard-page">
      <div class="stats-grid">
       <div class="stat-card">
        <div class="stat-header">
         <div class="stat-title">
          Aziende Gestite
         </div>
         <div class="stat-icon" style="background: #d1fae5; color: #059669;">
          üè¢
         </div>
        </div>
        <div class="stat-value" id="stat-companies">
         0
        </div>
        <div class="stat-change positive"><span>Totale clienti</span>
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-header">
         <div class="stat-title">
          Incidenti Aperti
         </div>
         <div class="stat-icon" style="background: #fef3c7; color: #f59e0b;">
          üö®
         </div>
        </div>
        <div class="stat-value" id="stat-incidents">
         0
        </div>
        <div class="stat-change"><span>In gestione</span>
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-header">
         <div class="stat-title">
          Notifiche Aperte
         </div>
         <div class="stat-icon" style="background: #e0e7ff; color: #4338ca;">
          üìã
         </div>
        </div>
        <div class="stat-value" id="stat-notifications">
         0
        </div>
        <div class="stat-change"><span>Da gestire</span>
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-header">
         <div class="stat-title">
          Audit NIS2
         </div>
         <div class="stat-icon" style="background: #dbeafe; color: #3b82f6;">
          üîç
         </div>
        </div>
        <div class="stat-value" id="stat-audits">
         0
        </div>
        <div class="stat-change"><span>Totale audit</span>
        </div>
       </div>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üì¶ Pubblicazione Progetto</h3>
       </div>
       <div style="padding: 1.5rem;">
        <div style="background: #e0e7ff; border-left: 4px solid #4338ca; padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
         <h4 style="margin: 0 0 0.75rem 0; color: #4338ca; font-size: 1rem;">üöÄ Passi per pubblicare su GitHub e Supabase</h4>
         <ol style="margin: 0; padding-left: 1.25rem; color: #4338ca; font-size: 0.9375rem; line-height: 1.8;">
          <li><strong>GitHub</strong> - Crea un nuovo repository e carica questo file HTML</li>
          <li><strong>Supabase</strong> - Crea un progetto gratuito su <a href="https://supabase.com" target="_blank" rel="noopener noreferrer" style="color: #4338ca; text-decoration: underline;">supabase.com</a></li>
          <li><strong>Database</strong> - Crea le tabelle necessarie nel database Supabase</li>
          <li><strong>Connessione</strong> - Sostituisci localStorage con chiamate API Supabase</li>
          <li><strong>Deploy</strong> - Pubblica su GitHub Pages o Vercel per hosting gratuito</li>
         </ol>
        </div>
        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
         <h4 style="margin: 0 0 0.75rem 0; color: #92400e; font-size: 1rem;">üíæ Struttura Database Supabase</h4>
         <p style="margin: 0 0 0.75rem 0; color: #92400e; font-size: 0.875rem;">Crea le seguenti tabelle nel tuo progetto Supabase:</p>
         <ul style="margin: 0; padding-left: 1.25rem; color: #92400e; font-size: 0.875rem; line-height: 1.8;">
          <li><code>users</code> - Gestione utenti e autenticazione</li>
          <li><code>companies</code> - Anagrafica aziende clienti</li>
          <li><code>incidents</code> - Registro incidenti di sicurezza</li>
          <li><code>notifications</code> - Notifiche ACN</li>
          <li><code>audits</code> - Audit NIS2</li>
          <li><code>csirt_profiles</code> - Profili referenti CSIRT</li>
          <li><code>network_configs</code> - Configurazioni di rete</li>
         </ul>
        </div>
        <div style="background: #d1fae5; border-left: 4px solid #059669; padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
         <h4 style="margin: 0 0 0.75rem 0; color: #065f46; font-size: 1rem;">‚ú® Funzionalit√† Attuali</h4>
         <p style="margin: 0; color: #065f46; font-size: 0.875rem; line-height: 1.8;">Il progetto attualmente utilizza <strong>localStorage</strong> per la persistenza dei dati. Tutti i dati sono salvati localmente nel browser e funzionano offline. Per una soluzione multi-utente in produzione, integra <strong>Supabase</strong> come database backend.</p>
        </div>
        <div style="background: #e0e7ff; border-left: 4px solid #4338ca; padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
         <h4 style="margin: 0 0 0.75rem 0; color: #4338ca; font-size: 1rem;">üîß Configurazione Supabase - Script SQL</h4>
         <p style="margin: 0 0 1rem 0; color: #4338ca; font-size: 0.875rem;">Copia questi script SQL nel <strong>SQL Editor</strong> di Supabase per creare automaticamente tutte le tabelle:</p>
         <div style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.8125rem; overflow-x: auto; max-height: 400px; overflow-y: auto; margin-bottom: 0.75rem;">
          <pre style="margin: 0; white-space: pre-wrap;">-- =============================================
-- PIATTAFORMA CSIRT - DATABASE SCHEMA
-- =============================================

-- 1. TABELLA USERS
CREATE TABLE users (
  user_id TEXT PRIMARY KEY,
  user_name TEXT NOT NULL,
  user_email TEXT UNIQUE NOT NULL,
  user_password TEXT NOT NULL,
  user_role TEXT NOT NULL CHECK (user_role IN ('admin', 'csirt', 'azienda')),
  user_company TEXT,
  user_assigned_companies TEXT,
  date TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(user_email);
CREATE INDEX idx_users_role ON users(user_role);

-- 2. TABELLA COMPANIES
CREATE TABLE companies (
  company_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  company_vat TEXT,
  company_address TEXT,
  company_contact TEXT NOT NULL,
  company_phone TEXT,
  company_email TEXT NOT NULL,
  company_csirt TEXT,
  company_logo TEXT,
  date TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_companies_name ON companies(company_name);
CREATE INDEX idx_companies_csirt ON companies(company_csirt);

-- 3. TABELLA INCIDENTS
CREATE TABLE incidents (
  incident_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  incident_title TEXT NOT NULL,
  incident_severity TEXT NOT NULL CHECK (incident_severity IN ('critical', 'high', 'medium', 'low')),
  incident_status TEXT NOT NULL CHECK (incident_status IN ('aperto', 'in-corso', 'risolto')),
  incident_description TEXT NOT NULL,
  incident_date TIMESTAMPTZ NOT NULL,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (company_name) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_incidents_company ON incidents(company_name);
CREATE INDEX idx_incidents_status ON incidents(incident_status);
CREATE INDEX idx_incidents_date ON incidents(incident_date DESC);

-- 4. TABELLA NOTIFICATIONS
CREATE TABLE notifications (
  notification_id TEXT PRIMARY KEY,
  notification_company TEXT NOT NULL,
  notification_title TEXT NOT NULL,
  notification_date TIMESTAMPTZ NOT NULL,
  notification_description TEXT NOT NULL,
  notification_status TEXT NOT NULL CHECK (notification_status IN ('aperta', 'notificata-acn', 'chiusa')),
  notification_risk TEXT NOT NULL,
  notification_actions TEXT NOT NULL,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (notification_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_notifications_company ON notifications(notification_company);
CREATE INDEX idx_notifications_status ON notifications(notification_status);
CREATE INDEX idx_notifications_date ON notifications(notification_date DESC);

-- 5. TABELLA AUDITS
CREATE TABLE audits (
  audit_id TEXT PRIMARY KEY,
  audit_company TEXT NOT NULL,
  audit_score INTEGER NOT NULL CHECK (audit_score &gt;= 0 AND audit_score &lt;= 100),
  audit_status TEXT NOT NULL CHECK (audit_status IN ('conforme', 'non-conforme', 'in-progress')),
  audit_notes TEXT NOT NULL,
  audit_date TIMESTAMPTZ NOT NULL,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (audit_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_audits_company ON audits(audit_company);
CREATE INDEX idx_audits_status ON audits(audit_status);
CREATE INDEX idx_audits_date ON audits(audit_date DESC);

-- 6. TABELLA CSIRT_PROFILES
CREATE TABLE csirt_profiles (
  csirt_id TEXT PRIMARY KEY,
  csirt_company TEXT NOT NULL,
  csirt_name TEXT NOT NULL,
  csirt_role TEXT NOT NULL,
  csirt_email TEXT NOT NULL,
  csirt_phone TEXT NOT NULL,
  csirt_acn_name TEXT NOT NULL,
  csirt_acn_email TEXT NOT NULL,
  csirt_substitute1 TEXT NOT NULL,
  csirt_substitute1_email TEXT NOT NULL,
  csirt_substitute2 TEXT NOT NULL,
  csirt_substitute2_email TEXT NOT NULL,
  csirt_external_reason TEXT,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (csirt_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_csirt_company ON csirt_profiles(csirt_company);
CREATE INDEX idx_csirt_email ON csirt_profiles(csirt_email);

-- 7. TABELLA NETWORK_CONFIGS
CREATE TABLE network_configs (
  network_id TEXT PRIMARY KEY,
  network_company TEXT NOT NULL,
  network_topology TEXT NOT NULL CHECK (network_topology IN ('star', 'mesh', 'ring', 'bus', 'hybrid')),
  network_devices INTEGER NOT NULL,
  network_servers INTEGER NOT NULL,
  network_workstations INTEGER NOT NULL,
  network_firewall TEXT,
  network_router TEXT,
  network_vpn TEXT CHECK (network_vpn IN ('site-to-site', 'remote-access', 'both', '')),
  network_wan TEXT NOT NULL,
  network_vlan TEXT,
  network_monitoring TEXT,
  network_backup TEXT,
  network_notes TEXT,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (network_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_network_company ON network_configs(network_company);

-- =============================================
-- ROW LEVEL SECURITY (RLS) - OPZIONALE
-- =============================================
-- Decommentare per abilitare la sicurezza a livello di riga

-- ALTER TABLE users ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE companies ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE incidents ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE audits ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE csirt_profiles ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE network_configs ENABLE ROW LEVEL SECURITY;

-- =============================================
-- COMPLETATO! ‚úÖ
-- =============================================</pre>
         </div><button class="btn btn-primary" onclick="copyToClipboard()" style="width: 100%; justify-content: center; margin-top: 0.5rem;"> <span>üìã</span> <span>Copia Script SQL</span> </button>
        </div>
        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1.25rem; border-radius: 8px;">
         <h4 style="margin: 0 0 0.75rem 0; color: #92400e; font-size: 1rem;">üìñ Guida Rapida Supabase</h4>
         <ol style="margin: 0; padding-left: 1.25rem; color: #92400e; font-size: 0.875rem; line-height: 1.8;">
          <li>Vai su <a href="https://supabase.com" target="_blank" rel="noopener noreferrer" style="color: #92400e; text-decoration: underline;">supabase.com</a> e crea un account gratuito</li>
          <li>Crea un nuovo progetto (scegli una region vicina)</li>
          <li>Vai su <strong>SQL Editor</strong> nel menu laterale</li>
          <li>Crea una nuova query e incolla lo script SQL sopra</li>
          <li>Clicca <strong>Run</strong> per creare tutte le tabelle</li>
          <li>Vai su <strong>Settings ‚Üí API</strong> e copia la <strong>URL</strong> e <strong>anon public key</strong></li>
          <li>Integra le API Supabase nel codice JavaScript sostituendo localStorage</li>
         </ol>
        </div>
       </div>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Benvenuto nella piattaforma CSIRT</h3>
       </div>
       <div id="dashboard-welcome" class="empty-state">
        <div class="empty-state-icon">
         üõ°Ô∏è
        </div>
        <div class="empty-state-title">
         Piattaforma Security &amp; Incident Management
        </div>
        <div class="empty-state-description">
         Gestisci aziende, incidenti, notifiche ACN, audit NIS2 e referenti CSIRT
        </div>
       </div>
      </div><!-- Dashboard CSIRT Tools (visible only for CSIRT role) -->
      <div id="csirt-dashboard-tools" style="display: none;"><!-- Le Mie Aziende -->
       <div class="card">
        <div class="card-header">
         <h3 class="card-title">üè¢ Le Mie Aziende Assegnate</h3>
        </div>
        <div id="csirt-assigned-companies" style="margin-top: 1rem;"><!-- Populated by renderCsirtAssignedCompanies() -->
        </div>
       </div><!-- Modulo Designazione Referente -->
       <div class="card">
        <div class="card-header">
         <h3 class="card-title">üìã Modulo Designazione Referente</h3><button class="btn btn-primary" onclick="generateDesignationModule()"> <span>üìÑ</span> <span>Genera Modulo</span> </button>
        </div>
        <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; margin-top: 1rem;">
         <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Genera il modulo ufficiale di designazione del referente CSIRT per l'azienda selezionata. Il documento includer√† tutti i dati necessari per la comunicazione formale.</p>
        </div>
       </div><!-- Registro Notifiche Rapido -->
       <div class="card">
        <div class="card-header">
         <h3 class="card-title">üìã Registro Notifiche Rapido</h3><button class="btn btn-primary" onclick="showAddNotificationModal()"> <span>+</span> <span>Nuova Notifica</span> </button>
        </div>
        <div id="dashboard-notifications-list"><!-- Populated by renderDashboardNotifications() -->
        </div>
       </div><!-- Grafico Stato Notifiche -->
       <div class="card">
        <div class="card-header">
         <h3 class="card-title">üìä Riepilogo Stato Notifiche</h3>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
         <div style="background: #fef3c7; padding: 1.5rem; border-radius: 10px; text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: #92400e;" id="chart-aperte">
           0
          </div>
          <div style="font-size: 0.875rem; color: #92400e; font-weight: 600; margin-top: 0.5rem;">
           Aperte
          </div>
         </div>
         <div style="background: #e0e7ff; padding: 1.5rem; border-radius: 10px; text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: #4338ca;" id="chart-notificate">
           0
          </div>
          <div style="font-size: 0.875rem; color: #4338ca; font-weight: 600; margin-top: 0.5rem;">
           Notificate ACN
          </div>
         </div>
         <div style="background: #d1fae5; padding: 1.5rem; border-radius: 10px; text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: #065f46;" id="chart-chiuse">
           0
          </div>
          <div style="font-size: 0.875rem; color: #065f46; font-weight: 600; margin-top: 0.5rem;">
           Chiuse
          </div>
         </div>
        </div>
        <div style="margin-top: 1.5rem;">
         <canvas id="notifications-chart" style="max-height: 250px;"></canvas>
        </div>
       </div><!-- Configurazione Rete -->
       <div class="card">
        <div class="card-header">
         <h3 class="card-title">üåê Configurazione della Rete</h3><button class="btn btn-primary" onclick="showNetworkConfigModal()"> <span>‚öôÔ∏è</span> <span>Configura Rete</span> </button>
        </div>
        <div id="network-config-display">
         <div class="empty-state" style="padding: 2rem;">
          <div class="empty-state-icon">
           üåê
          </div>
          <div class="empty-state-title">
           Nessuna configurazione di rete
          </div>
          <div class="empty-state-description">
           Configura la topologia di rete per le aziende
          </div>
         </div>
        </div>
       </div>
      </div>
     </section><!-- Companies Page -->
     <section class="page-section" id="companies-page">
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üè¢ Gestione Aziende</h3><button class="btn btn-primary" onclick="showAddCompanyModal()" id="add-company-btn"> <span>+</span> <span>Aggiungi Azienda</span> </button>
       </div>
      </div>
      <div class="card">
       <div class="table-container">
        <table class="data-table" id="companies-table">
         <thead>
          <tr>
           <th>Denominazione</th>
           <th>P.IVA</th>
           <th>Indirizzo</th>
           <th>Referente</th>
           <th>Telefono</th>
           <th>Email</th>
           <th>Consulente CSIRT</th>
           <th>Azioni</th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td colspan="8">
            <div class="empty-state">
             <div class="empty-state-icon">
              üè¢
             </div>
             <div class="empty-state-title">
              Nessuna azienda registrata
             </div>
             <div class="empty-state-description">
              Aggiungi la prima azienda cliente
             </div>
            </div></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- Incidents Page -->
     <section class="page-section" id="incidents-page">
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üö® Registro Incidenti</h3><button class="btn btn-primary" onclick="showAddIncidentModal()" id="add-incident-btn"> <span>+</span> <span>Registra Incidente</span> </button>
       </div>
      </div>
      <div id="incidents-grid" class="grid-container">
       <div class="empty-state">
        <div class="empty-state-icon">
         üö®
        </div>
        <div class="empty-state-title">
         Nessun incidente registrato
        </div>
        <div class="empty-state-description">
         Registra il primo incidente di sicurezza
        </div>
       </div>
      </div>
     </section><!-- Notifications Page -->
     <section class="page-section" id="notifications-page">
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üìã Registro Notifiche ACN</h3><button class="btn btn-primary" onclick="showAddNotificationModal()" id="add-notification-btn"> <span>+</span> <span>Nuova Notifica</span> </button>
       </div>
      </div>
      <div id="notifications-grid" class="grid-container">
       <div class="empty-state">
        <div class="empty-state-icon">
         üìã
        </div>
        <div class="empty-state-title">
         Nessuna notifica registrata
        </div>
        <div class="empty-state-description">
         Crea la prima notifica ACN
        </div>
       </div>
      </div>
     </section><!-- Audit Page -->
     <section class="page-section" id="audit-page">
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üîç Audit NIS2</h3><button class="btn btn-primary" onclick="showAddAuditModal()" id="add-audit-btn"> <span>+</span> <span>Nuovo Audit</span> </button>
       </div>
      </div>
      <div class="card">
       <div class="table-container">
        <table class="data-table" id="audits-table">
         <thead>
          <tr>
           <th>Azienda</th>
           <th>Data</th>
           <th>Punteggio</th>
           <th>Stato</th>
           <th>Note</th>
           <th>Azioni</th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td colspan="6">
            <div class="empty-state">
             <div class="empty-state-icon">
              üîç
             </div>
             <div class="empty-state-title">
              Nessun audit disponibile
             </div>
             <div class="empty-state-description">
              Crea il primo audit NIS2
             </div>
            </div></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- CSIRT Page -->
     <section class="page-section" id="csirt-page">
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üë®‚Äçüíº Profili CSIRT</h3><button class="btn btn-primary" onclick="showAddCsirtModal()" id="add-csirt-btn"> <span>+</span> <span>Aggiungi Profilo CSIRT</span> </button>
       </div>
      </div>
      <div id="csirt-grid" class="grid-container">
       <div class="empty-state">
        <div class="empty-state-icon">
         üë®‚Äçüíº
        </div>
        <div class="empty-state-title">
         Nessun profilo CSIRT
        </div>
        <div class="empty-state-description">
         Crea il primo profilo CSIRT per un'azienda
        </div>
       </div>
      </div>
     </section><!-- Users Page -->
     <section class="page-section" id="users-page">
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üë• Gestione Utenti</h3><button class="btn btn-primary" onclick="showAddUserModal()"> <span>+</span> <span>Aggiungi Utente</span> </button>
       </div>
      </div>
      <div class="card">
       <div class="table-container">
        <table class="data-table" id="users-table">
         <thead>
          <tr>
           <th>Nome</th>
           <th>Email</th>
           <th>Ruolo</th>
           <th>Azienda/Assegnazioni</th>
           <th>Azioni</th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td colspan="5">
            <div class="empty-state">
             <div class="empty-state-icon">
              ÔøΩÔøΩÔøΩ
             </div>
             <div class="empty-state-title">
              Nessun utente registrato
             </div>
             <div class="empty-state-description">
              Aggiungi il primo utente
             </div>
            </div></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
    </div>
   </main>
  </div><!-- Add Notification Modal -->
  <div id="add-notification-modal" class="modal">
   <div class="modal-content">
    <h3>üìã Nuova Notifica ACN</h3>
    <form id="add-notification-form">
     <div class="form-group"><label class="form-label" for="notification-company">Azienda *</label> <select id="notification-company" class="form-select" required> <option value="">Seleziona azienda</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="notification-title">Titolo Incidente *</label> <input type="text" id="notification-title" class="form-input" required placeholder="es. Violazione dati clienti">
     </div>
     <div class="form-group"><label class="form-label" for="notification-datetime">Data e Ora Incidente *</label> <input type="datetime-local" id="notification-datetime" class="form-input" required>
     </div>
     <div class="form-group"><label class="form-label" for="notification-description">Descrizione Danno/Impatto *</label> <textarea id="notification-description" class="form-textarea" required placeholder="Descrivi l'impatto e i danni causati dall'incidente..." style="min-height: 120px;"></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="notification-status">Stato *</label> <select id="notification-status" class="form-select" required> <option value="">Seleziona stato</option> <option value="aperta">Aperta</option> <option value="notificata-acn">Notificata ACN</option> <option value="chiusa">Chiusa</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="notification-risk">Valutazione Rischio e Danno *</label> <textarea id="notification-risk" class="form-textarea" required placeholder="Valutazione del rischio e dell'entit√† del danno..." style="min-height: 100px;"></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="notification-actions">Azioni Correttive Adottate *</label> <textarea id="notification-actions" class="form-textarea" required placeholder="Descrivi le azioni correttive e preventive adottate..." style="min-height: 100px;"></textarea>
     </div>
     <div class="form-actions"><button type="submit" class="btn btn-primary">Salva Notifica</button> <button type="button" class="btn btn-secondary" onclick="hideModal('add-notification-modal')">Annulla</button>
     </div>
    </form>
   </div>
  </div><!-- Add User Modal -->
  <div id="add-user-modal" class="modal">
   <div class="modal-content">
    <h3>‚ûï Aggiungi Nuovo Utente</h3>
    <form id="add-user-form">
     <div class="form-group"><label class="form-label" for="user-name">Nome Completo *</label> <input type="text" id="user-name" class="form-input" required placeholder="Mario Rossi">
     </div>
     <div class="form-group"><label class="form-label" for="user-email">Email *</label> <input type="email" id="user-email" class="form-input" required placeholder="mario.rossi@esempio.com">
     </div>
     <div class="form-group"><label class="form-label" for="user-password">Password *</label> <input type="password" id="user-password" class="form-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
     </div>
     <div class="form-group"><label class="form-label" for="user-role">Ruolo *</label> <select id="user-role" class="form-select" required onchange="handleRoleChange()"> <option value="">Seleziona ruolo</option> <option value="admin">Amministratore</option> <option value="csirt">Consulente CSIRT</option> <option value="azienda">Referente Aziendale</option> </select>
     </div>
     <div class="form-group" id="user-company-group" style="display: none;"><label class="form-label" for="user-company">Azienda *</label> <select id="user-company" class="form-select"> <option value="">Seleziona azienda</option> </select>
     </div>
     <div class="form-group" id="user-assigned-companies-group" style="display: none;"><label class="form-label">Aziende Assegnate (opzionale)</label>
      <div id="user-assigned-companies" class="multi-select-container"><!-- Populated dynamically -->
      </div>
      <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">
       üí° Le aziende possono essere assegnate anche successivamente
      </div>
     </div>
     <div class="form-actions"><button type="submit" class="btn btn-primary">Salva Utente</button> <button type="button" class="btn btn-secondary" onclick="hideModal('add-user-modal')">Annulla</button>
     </div>
    </form>
   </div>
  </div><!-- Add Company Modal -->
  <div id="add-company-modal" class="modal">
   <div class="modal-content" style="max-width: 800px;">
    <h3>‚ûï Aggiungi Nuova Azienda</h3><!-- Tabs -->
    <div class="tabs-container">
     <div class="tabs-header"><button class="tab-button active" data-tab="company-info" type="button">üè¢ Dati Azienda</button> <button class="tab-button" data-tab="company-contact" type="button">üë§ Referente Aziendale</button> <button class="tab-button" data-tab="company-csirt" type="button">üîß CSIRT Assegnato</button>
     </div>
     <form id="add-company-form">
      <div class="tabs-content"><!-- Tab 1: Dati Azienda -->
       <div class="tab-panel active" data-tab="company-info">
        <div class="form-group"><label class="form-label" for="company-logo">Logo Azienda</label> <input type="file" id="company-logo" class="form-input" accept="image/*" onchange="previewLogo(event)">
         <div style="margin-top: 0.75rem; display: flex; align-items: center; gap: 1rem;">
          <div id="logo-preview" style="width: 80px; height: 80px; border: 2px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #f8fafc; overflow: hidden;"><span style="color: #94a3b8; font-size: 0.75rem;">Nessun logo</span>
          </div><button type="button" class="btn btn-secondary" style="font-size: 0.8125rem; padding: 0.5rem 0.875rem;" onclick="clearLogo()">üóëÔ∏è Rimuovi Logo</button>
         </div>
        </div>
        <div class="form-group"><label class="form-label" for="company-name">Denominazione Sociale *</label> <input type="text" id="company-name" class="form-input" required placeholder="es. Acme S.r.l.">
        </div>
        <div class="form-group"><label class="form-label" for="company-vat">Partita IVA *</label> <input type="text" id="company-vat" class="form-input" required placeholder="es. 12345678901">
        </div>
        <div class="form-group"><label class="form-label" for="company-address">Indirizzo *</label> <input type="text" id="company-address" class="form-input" required placeholder="es. Via Roma 123, 00100 Roma">
        </div>
       </div><!-- Tab 2: Referente Aziendale -->
       <div class="tab-panel" data-tab="company-contact">
        <div class="form-group"><label class="form-label" for="company-contact">Referente Aziendale *</label> <input type="text" id="company-contact" class="form-input" required placeholder="Mario Rossi">
        </div>
        <div class="form-group"><label class="form-label" for="company-phone">Telefono Referente *</label> <input type="tel" id="company-phone" class="form-input" required placeholder="+39 123 456 7890">
        </div>
        <div class="form-group"><label class="form-label" for="company-email">Email Referente *</label> <input type="email" id="company-email" class="form-input" required placeholder="mario.rossi@acme.com">
        </div>
       </div><!-- Tab 3: CSIRT Assegnato -->
       <div class="tab-panel" data-tab="company-csirt">
        <div class="form-group"><label class="form-label" for="company-csirt">CSIRT Assegnato</label> <select id="company-csirt" class="form-select"> <option value="">Seleziona profilo CSIRT (opzionale)</option> </select>
        </div>
        <div style="background: #e0e7ff; border-left: 4px solid #4338ca; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
         <p style="margin: 0; font-size: 0.875rem; color: #4338ca;">ÔøΩÔøΩÔøΩ Il profilo CSIRT assegnato gestirÔøΩÔøΩÔøΩÔøΩ gli incidenti, le notifiche e gli audit per questa azienda.</p>
        </div>
       </div>
      </div>
      <div class="form-actions"><button type="submit" class="btn btn-primary">Salva Azienda</button> <button type="button" class="btn btn-secondary" onclick="hideModal('add-company-modal')">Annulla</button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Add Incident Modal -->
  <div id="add-incident-modal" class="modal">
   <div class="modal-content">
    <h3>üö® Registra Nuovo Incidente</h3>
    <form id="add-incident-form">
     <div class="form-group"><label class="form-label" for="incident-company">Azienda *</label> <select id="incident-company" class="form-select" required> <option value="">Seleziona azienda</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="incident-title">Titolo Incidente *</label> <input type="text" id="incident-title" class="form-input" required placeholder="es. Tentativo di accesso non autorizzato">
     </div>
     <div class="form-group"><label class="form-label" for="incident-severity">Gravit√† *</label> <select id="incident-severity" class="form-select" required> <option value="">Seleziona gravit√†</option> <option value="critical">Critica</option> <option value="high">Alta</option> <option value="medium">Media</option> <option value="low">Bassa</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="incident-status">Stato *</label> <select id="incident-status" class="form-select" required> <option value="aperto">Aperto</option> <option value="in-corso">In Corso</option> <option value="risolto">Risolto</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="incident-description">Descrizione *</label> <textarea id="incident-description" class="form-textarea" required placeholder="Descrivi l'incidente..."></textarea>
     </div>
     <div class="form-actions"><button type="submit" class="btn btn-primary">Registra Incidente</button> <button type="button" class="btn btn-secondary" onclick="hideModal('add-incident-modal')">Annulla</button>
     </div>
    </form>
   </div>
  </div><!-- Add Audit Modal -->
  <div id="add-audit-modal" class="modal">
   <div class="modal-content">
    <h3>ÔøΩÔøΩ Nuovo Audit NIS2</h3>
    <form id="add-audit-form">
     <div class="form-group"><label class="form-label" for="audit-company">Azienda *</label> <select id="audit-company" class="form-select" required> <option value="">Seleziona azienda</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="audit-score">Punteggio (0-100) *</label> <input type="number" id="audit-score" class="form-input" required min="0" max="100" placeholder="es. 85">
     </div>
     <div class="form-group"><label class="form-label" for="audit-status">Stato Conformit√† *</label> <select id="audit-status" class="form-select" required> <option value="">Seleziona stato</option> <option value="conforme">Conforme</option> <option value="non-conforme">Non Conforme</option> <option value="in-progress">In Progress</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="audit-notes">Note Audit *</label> <textarea id="audit-notes" class="form-textarea" required placeholder="Note e raccomandazioni..."></textarea>
     </div>
     <div class="form-actions"><button type="submit" class="btn btn-primary">Salva Audit</button> <button type="button" class="btn btn-secondary" onclick="hideModal('add-audit-modal')">Annulla</button>
     </div>
    </form>
   </div>
  </div><!-- Add CSIRT Modal -->
  <div id="add-csirt-modal" class="modal">
   <div class="modal-content" style="max-width: 800px;">
    <h3>üë®‚Äçüíº Aggiungi Profilo CSIRT</h3><!-- Tabs -->
    <div class="tabs-container">
     <div class="tabs-header"><button class="tab-button active" data-tab="general" type="button">üìã Dati Generali</button> <button class="tab-button" data-tab="acn" type="button">üèõÔ∏è Contatto ACN</button> <button class="tab-button" data-tab="substitutes" type="button">üë• Sostituti</button> <button class="tab-button" data-tab="notes" type="button">üìù Note</button>
     </div>
     <form id="add-csirt-form">
      <div class="tabs-content"><!-- Tab 1: Dati Generali -->
       <div class="tab-panel active" data-tab="general">
        <div class="form-group"><label class="form-label" for="csirt-company">Azienda *</label> <select id="csirt-company" class="form-select" required> <option value="">Seleziona azienda</option> </select>
        </div>
        <div class="form-group"><label class="form-label" for="csirt-name">Nome Completo *</label> <input type="text" id="csirt-name" class="form-input" required placeholder="es. Mario Rossi">
        </div>
        <div class="form-group"><label class="form-label" for="csirt-role">Ruolo *</label> <input type="text" id="csirt-role" class="form-input" required placeholder="es. CISO">
        </div>
        <div class="form-group"><label class="form-label" for="csirt-email">Email *</label> <input type="email" id="csirt-email" class="form-input" required placeholder="mario.rossi@acme.com">
        </div>
        <div class="form-group"><label class="form-label" for="csirt-phone">Telefono *</label> <input type="tel" id="csirt-phone" class="form-input" required placeholder="+39 123 456 7890">
        </div>
       </div><!-- Tab 2: Contatto ACN -->
       <div class="tab-panel" data-tab="acn">
        <div class="form-group"><label class="form-label" for="csirt-acn-name">Nome e Cognome Punto di Contatto ACN *</label> <input type="text" id="csirt-acn-name" class="form-input" required placeholder="es. Giulia Bianchi">
        </div>
        <div class="form-group"><label class="form-label" for="csirt-acn-email">Email Punto di Contatto ACN *</label> <input type="email" id="csirt-acn-email" class="form-input" required placeholder="giulia.bianchi@acn.gov.it">
        </div>
       </div><!-- Tab 3: Sostituti -->
       <div class="tab-panel" data-tab="substitutes">
        <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 1rem;">1¬∞ Sostituto</h4>
        <div class="form-group"><label class="form-label" for="csirt-substitute1">Nome e Cognome 1¬∞ Sostituto *</label> <input type="text" id="csirt-substitute1" class="form-input" required placeholder="es. Luca Verdi">
        </div>
        <div class="form-group"><label class="form-label" for="csirt-substitute1-email">Email 1¬∞ Sostituto *</label> <input type="email" id="csirt-substitute1-email" class="form-input" required placeholder="luca.verdi@acme.com">
        </div>
        <div style="border-top: 1px solid #e2e8f0; margin: 1.5rem 0;"></div>
        <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 1rem;">2¬∞ Sostituto</h4>
        <div class="form-group"><label class="form-label" for="csirt-substitute2">Nome e Cognome 2¬∞ Sostituto *</label> <input type="text" id="csirt-substitute2" class="form-input" required placeholder="es. Anna Neri">
        </div>
        <div class="form-group"><label class="form-label" for="csirt-substitute2-email">Email 2¬∞ Sostituto *</label> <input type="email" id="csirt-substitute2-email" class="form-input" required placeholder="anna.neri@acme.com">
        </div>
       </div><!-- Tab 4: Note -->
       <div class="tab-panel" data-tab="notes">
        <div class="form-group"><label class="form-label" for="csirt-external-reason">Motivazione Scelta Esterna</label> <textarea id="csirt-external-reason" class="form-textarea" placeholder="Motivazioni per eventuale scelta di un referente esterno..." style="min-height: 200px;"></textarea>
        </div>
       </div>
      </div>
      <div class="form-actions"><button type="submit" class="btn btn-primary">Salva Profilo</button> <button type="button" class="btn btn-secondary" onclick="hideModal('add-csirt-modal')">Annulla</button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Network Config Modal -->
  <div id="network-config-modal" class="modal">
   <div class="modal-content" style="max-width: 900px;">
    <h3>üåê Configurazione della Rete</h3>
    <form id="network-config-form">
     <div class="form-group"><label class="form-label" for="network-company">Azienda *</label> <select id="network-company" class="form-select" required> <option value="">Seleziona azienda</option> </select>
     </div>
     <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
      <div class="form-group"><label class="form-label" for="network-topology">Topologia di Rete *</label> <select id="network-topology" class="form-select" required> <option value="">Seleziona topologia</option> <option value="star">Stella (Star)</option> <option value="mesh">Maglia (Mesh)</option> <option value="ring">Anello (Ring)</option> <option value="bus">Bus</option> <option value="hybrid">Ibrida</option> </select>
      </div>
      <div class="form-group"><label class="form-label" for="network-devices">Numero Dispositivi *</label> <input type="number" id="network-devices" class="form-input" required min="1" placeholder="es. 50">
      </div>
     </div>
     <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
      <div class="form-group"><label class="form-label" for="network-servers">Server *</label> <input type="number" id="network-servers" class="form-input" required min="0" placeholder="es. 5">
      </div>
      <div class="form-group"><label class="form-label" for="network-workstations">Workstation *</label> <input type="number" id="network-workstations" class="form-input" required min="0" placeholder="es. 40">
      </div>
     </div>
     <div class="form-group"><label class="form-label" for="network-firewall">Firewall Installati</label> <input type="text" id="network-firewall" class="form-input" placeholder="es. Fortigate 100F, Cisco ASA">
     </div>
     <div class="form-group"><label class="form-label" for="network-router">Router/Switch Principali</label> <input type="text" id="network-router" class="form-input" placeholder="es. Cisco Catalyst 3850">
     </div>
     <div class="form-group"><label class="form-label" for="network-vpn">Connessioni VPN</label> <select id="network-vpn" class="form-select"> <option value="">Nessuna</option> <option value="site-to-site">Site-to-Site</option> <option value="remote-access">Remote Access</option> <option value="both">Entrambe</option> </select>
     </div>
     <div class="form-group"><label class="form-label" for="network-wan">Connettivit√† WAN *</label> <input type="text" id="network-wan" class="form-input" required placeholder="es. Fibra 1Gbps, MPLS">
     </div>
     <div class="form-group"><label class="form-label" for="network-vlan">VLAN Configurate</label> <textarea id="network-vlan" class="form-textarea" placeholder="es. VLAN 10: Management, VLAN 20: Produzione, VLAN 30: Guest" style="min-height: 80px;"></textarea>
     </div>
     <div class="form-group"><label class="form-label" for="network-monitoring">Sistemi di Monitoring</label> <input type="text" id="network-monitoring" class="form-input" placeholder="es. Zabbix, Nagios, PRTG">
     </div>
     <div class="form-group"><label class="form-label" for="network-backup">Soluzione di Backup</label> <input type="text" id="network-backup" class="form-input" placeholder="es. Veeam, Acronis">
     </div>
     <div class="form-group"><label class="form-label" for="network-notes">Note Aggiuntive</label> <textarea id="network-notes" class="form-textarea" placeholder="Informazioni aggiuntive sulla configurazione di rete..." style="min-height: 100px;"></textarea>
     </div>
     <div class="form-actions"><button type="submit" class="btn btn-primary">Salva Configurazione</button> <button type="button" class="btn btn-secondary" onclick="hideModal('network-config-modal')">Annulla</button>
     </div>
    </form>
   </div>
  </div><!-- Designation Module Modal -->
  <div id="designation-modal" class="modal">
   <div class="modal-content" style="max-width: 600px;">
    <h3>üìÑ Genera Modulo Designazione</h3>
    <form id="designation-form">
     <div class="form-group"><label class="form-label" for="designation-company">Seleziona Azienda *</label> <select id="designation-company" class="form-select" required> <option value="">Seleziona azienda</option> </select>
     </div>
     <div style="background: #e0e7ff; border-left: 4px solid #4338ca; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
      <p style="margin: 0; font-size: 0.875rem; color: #4338ca;">üí° Il modulo includer√† automaticamente tutti i dati del referente CSIRT registrato per l'azienda selezionata.</p>
     </div>
     <div class="form-actions"><button type="submit" class="btn btn-primary"> <span>üìÑ</span> <span>Genera Documento</span> </button> <button type="button" class="btn btn-secondary" onclick="hideModal('designation-modal')">Annulla</button>
     </div>
    </form>
   </div>
  </div><!-- Delete Modal -->
  <div id="delete-modal" class="modal">
   <div class="modal-content" style="max-width: 500px;">
    <div style="text-align: center; margin-bottom: 1.5rem;">
     <div style="font-size: 3rem; margin-bottom: 0.5rem;">
      ‚ö†Ô∏è
     </div>
     <h3 style="margin: 0 0 0.5rem 0; color: #dc2626;">Conferma Eliminazione</h3>
     <p style="color: #64748b; font-size: 0.9375rem;">Sei sicuro di voler eliminare questo elemento?</p>
    </div>
    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
     <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;" id="delete-item-name"></div>
     <div style="font-size: 0.875rem; color: #64748b;" id="delete-item-details"></div>
    </div>
    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
     <p style="margin: 0; font-size: 0.875rem; color: #92400e;">‚ö†Ô∏è <strong>Attenzione:</strong> Questa azione √® irreversibile.</p>
    </div>
    <div style="display: flex; gap: 1rem;"><button class="btn" style="flex: 1; background: #dc2626; color: white;" onclick="confirmDelete()"> üóëÔ∏è Elimina </button> <button class="btn btn-secondary" style="flex: 1;" onclick="hideModal('delete-modal')"> Annulla </button>
    </div>
   </div>
  </div>
  <script>
    // In-memory storage (ready for Supabase migration)
    let allUsers = [];
    let allCompanies = [];
    let allIncidents = [];
    let allAudits = [];
    let allCsirt = [];
    let allNotifications = [];
    let allNetworkConfigs = [];
    let currentUser = null;
    let itemToDelete = null;

    // Initialize app
    function initializeApp() {
      // Check if there are users in localStorage
      const storedUsers = localStorage.getItem('csirt_users');
      if (storedUsers) {
        allUsers = JSON.parse(storedUsers);
      }

      // Load all data from localStorage
      loadAllDataFromStorage();

      // Show appropriate screen
      if (allUsers.length === 0) {
        showSetupScreen();
      } else {
        showLoginScreen();
      }
    }

    function loadAllDataFromStorage() {
      const storedCompanies = localStorage.getItem('csirt_companies');
      if (storedCompanies) allCompanies = JSON.parse(storedCompanies);

      const storedIncidents = localStorage.getItem('csirt_incidents');
      if (storedIncidents) allIncidents = JSON.parse(storedIncidents);

      const storedNotifications = localStorage.getItem('csirt_notifications');
      if (storedNotifications) allNotifications = JSON.parse(storedNotifications);

      const storedAudits = localStorage.getItem('csirt_audits');
      if (storedAudits) allAudits = JSON.parse(storedAudits);

      const storedCsirt = localStorage.getItem('csirt_csirt');
      if (storedCsirt) allCsirt = JSON.parse(storedCsirt);

      const storedNetworkConfigs = localStorage.getItem('csirt_network_configs');
      if (storedNetworkConfigs) allNetworkConfigs = JSON.parse(storedNetworkConfigs);
    }

    function saveToStorage(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function showSetupScreen() {
      document.getElementById('setup-screen').style.display = 'flex';
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'none';
    }

    function showLoginScreen() {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
    }

    // Initial Admin Setup
    function createInitialAdmin() {
      const name = document.getElementById('setup-name').value.trim();
      const email = document.getElementById('setup-email').value.trim();
      const password = document.getElementById('setup-password').value.trim();
      const passwordConfirm = document.getElementById('setup-password-confirm').value.trim();

      if (!name || !email || !password || !passwordConfirm) {
        showToast('ÔøΩÔøΩÔøΩ Compila tutti i campi', 'error');
        return;
      }

      if (password !== passwordConfirm) {
        showToast('‚ùå Le password non corrispondono', 'error');
        return;
      }

      if (password.length < 6) {
        showToast('‚ùå La password deve essere almeno 6 caratteri', 'error');
        return;
      }

      const newAdmin = {
        user_id: Date.now().toString(),
        user_name: name,
        user_email: email,
        user_password: password,
        user_role: 'admin',
        user_company: '',
        user_assigned_companies: '',
        date: new Date().toISOString()
      };

      allUsers.push(newAdmin);
      saveToStorage('csirt_users', allUsers);

      showToast('‚úÖ Amministratore creato! Effettua il login', 'success');
      
      setTimeout(() => {
        showLoginScreen();
        document.getElementById('login-email').value = email;
        document.getElementById('login-password').value = password;
      }, 1500);
    }

    // Login
    function performLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();

      if (!email || !password) {
        showToast('‚ùå Inserisci email e password', 'error');
        return;
      }

      const user = allUsers.find(u => 
        u.user_email === email && u.user_password === password
      );

      if (user) {
        currentUser = user;
        showMainApp();
      } else {
        showToast('‚ùå Credenziali non valide', 'error');
      }
    }

    function showMainApp() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'flex';
      
      if (currentUser) {
        document.getElementById('current-user-name').textContent = currentUser.user_name || 'Utente';
        
        const roleDisplay = {
          'admin': 'üëë Amministratore',
          'csirt': 'üîß Consulente CSIRT',
          'azienda': 'üè¢ Referente Aziendale'
        };
        
        const roleBadge = document.getElementById('current-user-role');
        roleBadge.textContent = roleDisplay[currentUser.user_role] || 'User';
        roleBadge.className = `badge ${currentUser.user_role}`;

        const icon = {
          'admin': 'üëë',
          'csirt': 'üîß',
          'azienda': 'üè¢'
        };
        document.getElementById('user-icon').textContent = icon[currentUser.user_role] || 'üë§';

        applyRolePermissions();
      }
      
      updateStats();
      renderAllData();
      updateDashboardVisibility();
      navigateToPage('dashboard');
    }

    function renderCsirtAssignedCompanies() {
      const container = document.getElementById('csirt-assigned-companies');
      
      if (!currentUser) return;

      let assignedCompanies = [];
      
      if (currentUser.user_role === 'admin') {
        assignedCompanies = allCompanies;
      } else if (currentUser.user_role === 'csirt') {
        const csirtName = currentUser.user_name;
        assignedCompanies = allCompanies.filter(company => company.company_csirt === csirtName);
      }

      if (assignedCompanies.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon" style="font-size: 2rem;">üè¢</div>
            <div class="empty-state-title">Nessuna azienda assegnata</div>
            <div class="empty-state-description">Le aziende di cui sei referente CSIRT appariranno qui</div>
          </div>
        `;
        return;
      }

      const companiesHTML = assignedCompanies.map(company => {
        const logoHTML = company.company_logo ? 
          `<img src="${company.company_logo}" style="width: 60px; height: 60px; object-fit: contain; border: 2px solid #e2e8f0; border-radius: 12px; background: white;">` :
          `<div style="width: 60px; height: 60px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üè¢</div>`;
        
        const incidentsCount = allIncidents.filter(i => i.company_name === company.company_name).length;
        const notificationsCount = allNotifications.filter(n => n.notification_company === company.company_name).length;
        const auditsCount = allAudits.filter(a => a.audit_company === company.company_name).length;

        return `
          <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
            <div style="display: flex; gap: 1rem; align-items: start;">
              ${logoHTML}
              <div style="flex: 1;">
                <div style="font-size: 1.125rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem;">${company.company_name}</div>
                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.75rem;">${company.company_vat}</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                  <div>
                    <div style="font-size: 0.75rem; color: #64748b;">Incidenti</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">${incidentsCount}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: #64748b;">Notifiche</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">${notificationsCount}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: #64748b;">Audit</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">${auditsCount}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = companiesHTML;
    }

    function updateDashboardVisibility() {
      if (!currentUser) return;

      const csirtTools = document.getElementById('csirt-dashboard-tools');
      
      if (currentUser.user_role === 'csirt') {
        csirtTools.style.display = 'block';
        renderCsirtAssignedCompanies();
        renderDashboardNotifications();
        updateNotificationsChart();
        renderNetworkConfigs();
      } else if (currentUser.user_role === 'admin') {
        csirtTools.style.display = 'block';
        renderCsirtAssignedCompanies();
        renderDashboardNotifications();
        updateNotificationsChart();
        renderNetworkConfigs();
      } else {
        csirtTools.style.display = 'none';
      }
    }

    function applyRolePermissions() {
      if (!currentUser) return;

      const role = currentUser.user_role;

      // Show/hide menu items
      document.querySelectorAll('.nav-item[data-roles]').forEach(item => {
        const allowedRoles = item.getAttribute('data-roles').split(',');
        if (allowedRoles.includes(role)) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });

      // Show/hide action buttons based on role
      const addCompanyBtn = document.getElementById('add-company-btn');
      const addCsirtBtn = document.getElementById('add-csirt-btn');
      const addNotificationBtn = document.getElementById('add-notification-btn');

      if (role === 'azienda') {
        if (addCompanyBtn) addCompanyBtn.style.display = 'none';
        if (addCsirtBtn) addCsirtBtn.style.display = 'none';
        if (addNotificationBtn) addNotificationBtn.style.display = 'none';
      }
    }

    function logout() {
      currentUser = null;
      showLoginScreen();
      document.getElementById('login-form').reset();
      navigateToPage('dashboard');
    }

    // Navigation
    function navigateToPage(pageName) {
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      document.getElementById(`${pageName}-page`).classList.add('active');
      const navItem = document.querySelector(`[data-page="${pageName}"]`);
      if (navItem) navItem.classList.add('active');

      const titles = {
        dashboard: 'Dashboard',
        companies: 'Gestione Aziende',
        incidents: 'Registro Incidenti',
        notifications: 'Registro Notifiche ACN',
        audit: 'Audit NIS2',
        csirt: 'Profili CSIRT',
        users: 'Gestione Utenti'
      };

      document.getElementById('page-title').textContent = titles[pageName] || 'Dashboard';
    }

    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', function() {
        if (this.classList.contains('hidden')) return;
        const page = this.getAttribute('data-page');
        navigateToPage(page);
      });
    });

    // Modal Functions
    function showAddNotificationModal() {
      populateCompanySelects();
      document.getElementById('add-notification-modal').style.display = 'flex';
      document.getElementById('add-notification-form').reset();
      document.getElementById('add-notification-form').dataset.mode = 'add';
      document.getElementById('add-notification-form').dataset.notificationId = '';
      document.querySelector('#add-notification-modal h3').textContent = 'üìã Nuova Notifica ACN';
      
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('notification-datetime').value = now.toISOString().slice(0, 16);
    }

    function showAddUserModal() {
      populateCompanySelects();
      populateAssignedCompaniesCheckboxes();
      document.getElementById('add-user-modal').style.display = 'flex';
      document.getElementById('add-user-form').reset();
      document.getElementById('add-user-form').dataset.mode = 'add';
      document.getElementById('add-user-form').dataset.userId = '';
      document.querySelector('#add-user-modal h3').textContent = '‚ûï Aggiungi Nuovo Utente';
      document.getElementById('user-company-group').style.display = 'none';
      document.getElementById('user-assigned-companies-group').style.display = 'none';
    }

    function showEditUserModal(user) {
      populateCompanySelects();
      populateAssignedCompaniesCheckboxes();
      document.getElementById('add-user-modal').style.display = 'flex';
      document.getElementById('add-user-form').dataset.mode = 'edit';
      document.getElementById('add-user-form').dataset.userId = user.user_id;
      document.querySelector('#add-user-modal h3').textContent = '‚úèÔ∏è Modifica Utente';
      
      document.getElementById('user-name').value = user.user_name;
      document.getElementById('user-email').value = user.user_email;
      document.getElementById('user-password').value = user.user_password;
      document.getElementById('user-role').value = user.user_role;
      
      handleRoleChange();
      
      if (user.user_role === 'azienda' && user.user_company) {
        document.getElementById('user-company').value = user.user_company;
      }
      
      if (user.user_role === 'csirt' && user.user_assigned_companies) {
        const assignedCompanies = user.user_assigned_companies.split(',').map(c => c.trim());
        document.querySelectorAll('#user-assigned-companies input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = assignedCompanies.includes(checkbox.value);
        });
      }
    }

    function handleRoleChange() {
      const role = document.getElementById('user-role').value;
      const companyGroup = document.getElementById('user-company-group');
      const assignedCompaniesGroup = document.getElementById('user-assigned-companies-group');

      companyGroup.style.display = 'none';
      assignedCompaniesGroup.style.display = 'none';

      if (role === 'azienda') {
        companyGroup.style.display = 'block';
        document.getElementById('user-company').required = true;
      } else if (role === 'csirt') {
        assignedCompaniesGroup.style.display = 'block';
      }
    }

    function populateAssignedCompaniesCheckboxes() {
      const container = document.getElementById('user-assigned-companies');
      container.innerHTML = '';

      if (allCompanies.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #64748b; font-size: 0.875rem;">Nessuna azienda disponibile</div>';
        return;
      }

      allCompanies.forEach(company => {
        const checkboxItem = document.createElement('div');
        checkboxItem.className = 'checkbox-item';
        checkboxItem.innerHTML = `
          <input type="checkbox" id="company-${company.company_id}" value="${company.company_name}">
          <label for="company-${company.company_id}" style="cursor: pointer; flex: 1;">${company.company_name}</label>
        `;
        container.appendChild(checkboxItem);
      });
    }

    function previewLogo(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('logo-preview');
          preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;">`;
          document.getElementById('add-company-form').dataset.logoData = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    function clearLogo() {
      document.getElementById('company-logo').value = '';
      document.getElementById('logo-preview').innerHTML = '<span style="color: #94a3b8; font-size: 0.75rem;">Nessun logo</span>';
      delete document.getElementById('add-company-form').dataset.logoData;
    }

    function showAddCompanyModal() {
      populateCsirtConsultantsSelect();
      document.getElementById('add-company-modal').style.display = 'flex';
      document.getElementById('add-company-form').reset();
      document.getElementById('add-company-form').dataset.mode = 'add';
      document.getElementById('add-company-form').dataset.companyId = '';
      document.querySelector('#add-company-modal h3').textContent = '‚ûï Aggiungi Nuova Azienda';
      clearLogo();
    }

    function showEditCompanyModal(company) {
      populateCsirtConsultantsSelect();
      document.getElementById('add-company-modal').style.display = 'flex';
      document.getElementById('add-company-form').dataset.mode = 'edit';
      document.getElementById('add-company-form').dataset.companyId = company.company_id;
      document.querySelector('#add-company-modal h3').textContent = '‚úèÔ∏è Modifica Azienda';
      
      document.getElementById('company-name').value = company.company_name;
      document.getElementById('company-vat').value = company.company_vat;
      document.getElementById('company-address').value = company.company_address;
      document.getElementById('company-contact').value = company.company_contact;
      document.getElementById('company-phone').value = company.company_phone;
      document.getElementById('company-email').value = company.company_email;
      document.getElementById('company-csirt').value = company.company_csirt || '';
      
      if (company.company_logo) {
        const preview = document.getElementById('logo-preview');
        preview.innerHTML = `<img src="${company.company_logo}" style="width: 100%; height: 100%; object-fit: contain;">`;
        document.getElementById('add-company-form').dataset.logoData = company.company_logo;
      } else {
        clearLogo();
      }
    }

    function populateCsirtConsultantsSelect() {
      const select = document.getElementById('company-csirt');
      if (!select) return;

      select.innerHTML = '<option value="">Seleziona consulente CSIRT</option>';

      const csirtUsers = allUsers.filter(user => user.user_role === 'csirt' || user.user_role === 'admin');
      
      csirtUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.user_name;
        option.textContent = `${user.user_name} (${user.user_email})`;
        select.appendChild(option);
      });
    }

    function showAddIncidentModal() {
      populateCompanySelects();
      document.getElementById('add-incident-modal').style.display = 'flex';
      document.getElementById('add-incident-form').reset();
      document.getElementById('add-incident-form').dataset.mode = 'add';
      document.getElementById('add-incident-form').dataset.incidentId = '';
      document.querySelector('#add-incident-modal h3').textContent = 'ÔøΩÔøΩ Registra Nuovo Incidente';
    }

    function showEditIncidentModal(incident) {
      populateCompanySelects();
      document.getElementById('add-incident-modal').style.display = 'flex';
      document.getElementById('add-incident-form').dataset.mode = 'edit';
      document.getElementById('add-incident-form').dataset.incidentId = incident.incident_id;
      document.querySelector('#add-incident-modal h3').textContent = '‚úèÔ∏è Modifica Incidente';
      
      document.getElementById('incident-company').value = incident.company_name;
      document.getElementById('incident-title').value = incident.incident_title;
      document.getElementById('incident-severity').value = incident.incident_severity;
      document.getElementById('incident-status').value = incident.incident_status;
      document.getElementById('incident-description').value = incident.incident_description;
    }

    function showAddAuditModal() {
      populateCompanySelects();
      document.getElementById('add-audit-modal').style.display = 'flex';
      document.getElementById('add-audit-form').reset();
      document.getElementById('add-audit-form').dataset.mode = 'add';
      document.getElementById('add-audit-form').dataset.auditId = '';
      document.querySelector('#add-audit-modal h3').textContent = 'üîç Nuovo Audit NIS2';
    }

    function showEditAuditModal(audit) {
      populateCompanySelects();
      document.getElementById('add-audit-modal').style.display = 'flex';
      document.getElementById('add-audit-form').dataset.mode = 'edit';
      document.getElementById('add-audit-form').dataset.auditId = audit.audit_id;
      document.querySelector('#add-audit-modal h3').textContent = '‚úèÔ∏è Modifica Audit';
      
      document.getElementById('audit-company').value = audit.audit_company;
      document.getElementById('audit-score').value = audit.audit_score;
      document.getElementById('audit-status').value = audit.audit_status;
      document.getElementById('audit-notes').value = audit.audit_notes;
    }

    function showAddCsirtModal() {
      populateCompanySelects();
      document.getElementById('add-csirt-modal').style.display = 'flex';
      document.getElementById('add-csirt-form').reset();
      document.getElementById('add-csirt-form').dataset.mode = 'add';
      document.getElementById('add-csirt-form').dataset.csirtId = '';
      document.querySelector('#add-csirt-modal h3').textContent = 'üë®‚Äçüíº Aggiungi Profilo CSIRT';
    }

    function showEditCsirtModal(csirt) {
      populateCompanySelects();
      document.getElementById('add-csirt-modal').style.display = 'flex';
      document.getElementById('add-csirt-form').dataset.mode = 'edit';
      document.getElementById('add-csirt-form').dataset.csirtId = csirt.csirt_id;
      document.querySelector('#add-csirt-modal h3').textContent = '‚úèÔ∏è Modifica Profilo CSIRT';
      
      document.getElementById('csirt-company').value = csirt.csirt_company;
      document.getElementById('csirt-name').value = csirt.csirt_name;
      document.getElementById('csirt-role').value = csirt.csirt_role;
      document.getElementById('csirt-email').value = csirt.csirt_email;
      document.getElementById('csirt-phone').value = csirt.csirt_phone;
      document.getElementById('csirt-acn-name').value = csirt.csirt_acn_name;
      document.getElementById('csirt-acn-email').value = csirt.csirt_acn_email;
      document.getElementById('csirt-substitute1').value = csirt.csirt_substitute1;
      document.getElementById('csirt-substitute1-email').value = csirt.csirt_substitute1_email;
      document.getElementById('csirt-substitute2').value = csirt.csirt_substitute2;
      document.getElementById('csirt-substitute2-email').value = csirt.csirt_substitute2_email;
      document.getElementById('csirt-external-reason').value = csirt.csirt_external_reason || '';
    }

    function showEditNotificationModal(notification) {
      populateCompanySelects();
      document.getElementById('add-notification-modal').style.display = 'flex';
      document.getElementById('add-notification-form').dataset.mode = 'edit';
      document.getElementById('add-notification-form').dataset.notificationId = notification.notification_id;
      document.querySelector('#add-notification-modal h3').textContent = '‚úèÔ∏è Modifica Notifica ACN';
      
      document.getElementById('notification-company').value = notification.notification_company;
      document.getElementById('notification-title').value = notification.notification_title;
      
      const date = new Date(notification.notification_date);
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      document.getElementById('notification-datetime').value = date.toISOString().slice(0, 16);
      
      document.getElementById('notification-description').value = notification.notification_description;
      document.getElementById('notification-status').value = notification.notification_status;
      document.getElementById('notification-risk').value = notification.notification_risk;
      document.getElementById('notification-actions').value = notification.notification_actions;
    }

    function hideModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function populateCompanySelects() {
      const selects = ['incident-company', 'audit-company', 'csirt-company', 'user-company', 'notification-company', 'network-company'];
      
      let companies = getFilteredCompanies();

      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '<option value="">Seleziona azienda</option>';
          companies.forEach(company => {
            const option = document.createElement('option');
            option.value = company.company_name;
            option.textContent = company.company_name;
            select.appendChild(option);
          });
        }
      });
    }

    function getFilteredCompanies() {
      if (!currentUser) return allCompanies;

      if (currentUser.user_role === 'admin') {
        return allCompanies;
      } else if (currentUser.user_role === 'csirt') {
        const assignedCompanies = currentUser.user_assigned_companies ? 
          currentUser.user_assigned_companies.split(',').map(c => c.trim()) : [];
        return allCompanies.filter(company => assignedCompanies.includes(company.company_name));
      } else if (currentUser.user_role === 'azienda') {
        return allCompanies.filter(company => company.company_name === currentUser.user_company);
      }

      return allCompanies;
    }

    function showDeleteModal(item, type) {
      itemToDelete = { item, type };
      document.getElementById('delete-modal').style.display = 'flex';
      
      let name = '';
      let details = '';
      
      if (type === 'company') {
        name = item.company_name;
        details = `${item.company_sector} ÔøΩÔøΩ ${item.company_employees} dipendenti`;
      } else if (type === 'incident') {
        name = item.incident_title;
        details = `${item.company_name} ‚Ä¢ ${item.incident_severity}`;
      } else if (type === 'notification') {
        name = item.notification_title;
        details = `${item.notification_company} ‚Ä¢ ${item.notification_status}`;
      } else if (type === 'audit') {
        name = `Audit ${item.audit_company}`;
        details = `Score: ${item.audit_score} ‚Ä¢ ${item.audit_status}`;
      } else if (type === 'csirt') {
        name = item.csirt_name;
        details = `${item.csirt_role} ‚Ä¢ ${item.csirt_company}`;
      } else if (type === 'user') {
        name = item.user_name;
        details = `${item.user_email} ‚Ä¢ ${item.user_role}`;
      } else if (type === 'network') {
        name = `Configurazione di rete ${item.network_company}`;
        details = `${item.network_topology} ‚Ä¢ ${item.network_devices} dispositivi`;
      }
      
      document.getElementById('delete-item-name').textContent = name;
      document.getElementById('delete-item-details').textContent = details;
    }

    function confirmDelete() {
      if (!itemToDelete) return;

      const { item, type } = itemToDelete;

      if (type === 'company') {
        allCompanies = allCompanies.filter(c => c.company_id !== item.company_id);
        saveToStorage('csirt_companies', allCompanies);
      } else if (type === 'incident') {
        allIncidents = allIncidents.filter(i => i.incident_id !== item.incident_id);
        saveToStorage('csirt_incidents', allIncidents);
      } else if (type === 'notification') {
        allNotifications = allNotifications.filter(n => n.notification_id !== item.notification_id);
        saveToStorage('csirt_notifications', allNotifications);
      } else if (type === 'audit') {
        allAudits = allAudits.filter(a => a.audit_id !== item.audit_id);
        saveToStorage('csirt_audits', allAudits);
      } else if (type === 'csirt') {
        allCsirt = allCsirt.filter(c => c.csirt_id !== item.csirt_id);
        saveToStorage('csirt_csirt', allCsirt);
      } else if (type === 'user') {
        allUsers = allUsers.filter(u => u.user_id !== item.user_id);
        saveToStorage('csirt_users', allUsers);
      } else if (type === 'network') {
        allNetworkConfigs = allNetworkConfigs.filter(n => n.network_id !== item.network_id);
        saveToStorage('csirt_network_configs', allNetworkConfigs);
      }

      hideModal('delete-modal');
      showToast('‚úÖ Elemento eliminato con successo', 'success');
      itemToDelete = null;

      renderAllData();
      updateStats();
      renderNetworkConfigs();
      updateDashboardVisibility();
    }

    function canDelete(item, type) {
      if (!currentUser) return false;
      
      if (currentUser.user_role === 'admin') return true;
      
      if (currentUser.user_role === 'csirt') {
        const assignedCompanies = currentUser.user_assigned_companies ? 
          currentUser.user_assigned_companies.split(',').map(c => c.trim()) : [];
        
        if (type === 'company') return assignedCompanies.includes(item.company_name);
        if (type === 'incident') return assignedCompanies.includes(item.company_name);
        if (type === 'notification') return assignedCompanies.includes(item.notification_company);
        if (type === 'audit') return assignedCompanies.includes(item.audit_company);
        if (type === 'csirt') return assignedCompanies.includes(item.csirt_company);
      }
      
      if (currentUser.user_role === 'azienda') {
        if (type === 'incident') return item.company_name === currentUser.user_company;
        return false;
      }
      
      return false;
    }

    // Form Submissions
    document.getElementById('add-notification-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const mode = this.dataset.mode || 'add';
      const notificationId = this.dataset.notificationId;

      const notificationData = {
        notification_id: mode === 'edit' ? notificationId : Date.now().toString(),
        notification_company: document.getElementById('notification-company').value,
        notification_title: document.getElementById('notification-title').value,
        notification_date: new Date(document.getElementById('notification-datetime').value).toISOString(),
        notification_description: document.getElementById('notification-description').value,
        notification_status: document.getElementById('notification-status').value,
        notification_risk: document.getElementById('notification-risk').value,
        notification_actions: document.getElementById('notification-actions').value,
        date: mode === 'edit' ? (allNotifications.find(n => n.notification_id === notificationId)?.date || new Date().toISOString()) : new Date().toISOString()
      };

      if (mode === 'edit') {
        const index = allNotifications.findIndex(n => n.notification_id === notificationId);
        if (index !== -1) {
          allNotifications[index] = notificationData;
        }
      } else {
        allNotifications.push(notificationData);
      }

      saveToStorage('csirt_notifications', allNotifications);

      hideModal('add-notification-modal');
      showToast(mode === 'edit' ? '‚úÖ Notifica modificata con successo' : '‚úÖ Notifica registrata con successo', 'success');
      renderAllData();
      updateStats();
    });

    document.getElementById('add-user-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const mode = this.dataset.mode;
      const userId = this.dataset.userId;
      const role = document.getElementById('user-role').value;
      let assignedCompanies = '';
      
      if (role === 'csirt') {
        const checkboxes = document.querySelectorAll('#user-assigned-companies input[type="checkbox"]:checked');
        assignedCompanies = Array.from(checkboxes).map(cb => cb.value).join(',');
      }

      const userData = {
        user_id: mode === 'edit' ? userId : Date.now().toString(),
        user_name: document.getElementById('user-name').value,
        user_email: document.getElementById('user-email').value,
        user_password: document.getElementById('user-password').value,
        user_role: role,
        user_company: role === 'azienda' ? document.getElementById('user-company').value : '',
        user_assigned_companies: role === 'csirt' ? assignedCompanies : '',
        date: mode === 'edit' ? (allUsers.find(u => u.user_id === userId)?.date || new Date().toISOString()) : new Date().toISOString()
      };

      if (mode === 'edit') {
        const index = allUsers.findIndex(u => u.user_id === userId);
        if (index !== -1) {
          allUsers[index] = userData;
        }
      } else {
        allUsers.push(userData);
      }

      saveToStorage('csirt_users', allUsers);

      hideModal('add-user-modal');
      showToast(mode === 'edit' ? '‚úÖ Utente modificato con successo' : '‚úÖ Utente aggiunto con successo', 'success');
      renderAllData();
    });

    document.getElementById('add-company-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const mode = this.dataset.mode;
      const companyId = this.dataset.companyId;

      const companyData = {
        company_id: mode === 'edit' ? companyId : Date.now().toString(),
        company_name: document.getElementById('company-name').value,
        company_vat: document.getElementById('company-vat').value,
        company_address: document.getElementById('company-address').value,
        company_contact: document.getElementById('company-contact').value,
        company_phone: document.getElementById('company-phone').value,
        company_email: document.getElementById('company-email').value,
        company_csirt: document.getElementById('company-csirt').value,
        company_logo: this.dataset.logoData || '',
        date: mode === 'edit' ? (allCompanies.find(c => c.company_id === companyId)?.date || new Date().toISOString()) : new Date().toISOString()
      };

      if (mode === 'edit') {
        const index = allCompanies.findIndex(c => c.company_id === companyId);
        if (index !== -1) {
          allCompanies[index] = companyData;
        }
      } else {
        allCompanies.push(companyData);
      }

      saveToStorage('csirt_companies', allCompanies);

      hideModal('add-company-modal');
      showToast(mode === 'edit' ? '‚úÖ Azienda modificata con successo' : '‚úÖ Azienda aggiunta con successo', 'success');
      renderAllData();
      updateStats();
      updateDashboardVisibility();
    });

    document.getElementById('add-incident-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const mode = this.dataset.mode;
      const incidentId = this.dataset.incidentId;

      const incidentData = {
        incident_id: mode === 'edit' ? incidentId : Date.now().toString(),
        company_name: document.getElementById('incident-company').value,
        incident_title: document.getElementById('incident-title').value,
        incident_severity: document.getElementById('incident-severity').value,
        incident_status: document.getElementById('incident-status').value,
        incident_description: document.getElementById('incident-description').value,
        incident_date: mode === 'edit' ? (allIncidents.find(i => i.incident_id === incidentId)?.incident_date || new Date().toISOString()) : new Date().toISOString(),
        date: mode === 'edit' ? (allIncidents.find(i => i.incident_id === incidentId)?.date || new Date().toISOString()) : new Date().toISOString()
      };

      if (mode === 'edit') {
        const index = allIncidents.findIndex(i => i.incident_id === incidentId);
        if (index !== -1) {
          allIncidents[index] = incidentData;
        }
      } else {
        allIncidents.push(incidentData);
      }

      saveToStorage('csirt_incidents', allIncidents);

      hideModal('add-incident-modal');
      showToast(mode === 'edit' ? '‚úÖ Incidente modificato con successo' : '‚úÖ Incidente registrato con successo', 'success');
      renderAllData();
      updateStats();
    });

    document.getElementById('add-audit-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const mode = this.dataset.mode;
      const auditId = this.dataset.auditId;

      const auditData = {
        audit_id: mode === 'edit' ? auditId : Date.now().toString(),
        audit_company: document.getElementById('audit-company').value,
        audit_score: parseInt(document.getElementById('audit-score').value),
        audit_status: document.getElementById('audit-status').value,
        audit_notes: document.getElementById('audit-notes').value,
        audit_date: mode === 'edit' ? (allAudits.find(a => a.audit_id === auditId)?.audit_date || new Date().toISOString()) : new Date().toISOString(),
        date: mode === 'edit' ? (allAudits.find(a => a.audit_id === auditId)?.date || new Date().toISOString()) : new Date().toISOString()
      };

      if (mode === 'edit') {
        const index = allAudits.findIndex(a => a.audit_id === auditId);
        if (index !== -1) {
          allAudits[index] = auditData;
        }
      } else {
        allAudits.push(auditData);
      }

      saveToStorage('csirt_audits', allAudits);

      hideModal('add-audit-modal');
      showToast(mode === 'edit' ? '‚úÖ Audit modificato con successo' : '‚úÖ Audit creato con successo', 'success');
      renderAllData();
      updateStats();
    });

    // Network Config Form
    document.getElementById('network-config-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const mode = this.dataset.mode || 'add';
      const configId = this.dataset.configId;

      const networkData = {
        network_id: mode === 'edit' ? configId : Date.now().toString(),
        network_company: document.getElementById('network-company').value,
        network_topology: document.getElementById('network-topology').value,
        network_devices: parseInt(document.getElementById('network-devices').value),
        network_servers: parseInt(document.getElementById('network-servers').value),
        network_workstations: parseInt(document.getElementById('network-workstations').value),
        network_firewall: document.getElementById('network-firewall').value,
        network_router: document.getElementById('network-router').value,
        network_vpn: document.getElementById('network-vpn').value,
        network_wan: document.getElementById('network-wan').value,
        network_vlan: document.getElementById('network-vlan').value,
        network_monitoring: document.getElementById('network-monitoring').value,
        network_backup: document.getElementById('network-backup').value,
        network_notes: document.getElementById('network-notes').value,
        date: mode === 'edit' ? (allNetworkConfigs.find(n => n.network_id === configId)?.date || new Date().toISOString()) : new Date().toISOString()
      };

      if (mode === 'edit') {
        const index = allNetworkConfigs.findIndex(n => n.network_id === configId);
        if (index !== -1) {
          allNetworkConfigs[index] = networkData;
        }
      } else {
        allNetworkConfigs.push(networkData);
      }

      saveToStorage('csirt_network_configs', allNetworkConfigs);

      hideModal('network-config-modal');
      showToast(mode === 'edit' ? '‚úÖ Configurazione modificata con successo' : '‚úÖ Configurazione salvata con successo', 'success');
      renderNetworkConfigs();
    });

    // Designation Form
    document.getElementById('designation-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const companyName = document.getElementById('designation-company').value;
      const company = allCompanies.find(c => c.company_name === companyName);
      const csirt = allCsirt.find(c => c.csirt_company === companyName);

      if (!company || !csirt) {
        showToast('‚ùå Dati azienda o referente non trovati', 'error');
        return;
      }

      // Generate designation document content
      const docContent = `
=================================================
    MODULO DI DESIGNAZIONE REFERENTE CSIRT
=================================================

DATI AZIENDA:
Denominazione: ${company.company_name}
P.IVA: ${company.company_vat}
Indirizzo: ${company.company_address}
Referente Aziendale: ${company.company_contact}
Email: ${company.company_email}
Telefono: ${company.company_phone}

=================================================

REFERENTE CSIRT DESIGNATO:
Nome e Cognome: ${csirt.csirt_name}
Ruolo: ${csirt.csirt_role}
Email: ${csirt.csirt_email}
Telefono: ${csirt.csirt_phone}

PUNTO DI CONTATTO ACN:
Nome e Cognome: ${csirt.csirt_acn_name}
Email: ${csirt.csirt_acn_email}

SOSTITUTI:
1¬∞ Sostituto: ${csirt.csirt_substitute1}
   Email: ${csirt.csirt_substitute1_email}

2¬∞ Sostituto: ${csirt.csirt_substitute2}
   Email: ${csirt.csirt_substitute2_email}

${csirt.csirt_external_reason ? `\nMOTIVAZIONE SCELTA ESTERNA:\n${csirt.csirt_external_reason}\n` : ''}
=================================================

Data di emissione: ${new Date().toLocaleDateString('it-IT')}

Firma del Legale Rappresentante

_____________________________
      `;

      // Create downloadable text file
      const blob = new Blob([docContent], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Modulo_Designazione_${company.company_name.replace(/\s+/g, '_')}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      hideModal('designation-modal');
      showToast('‚úÖ Modulo generato e scaricato con successo', 'success');
    });

    document.getElementById('add-csirt-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const mode = this.dataset.mode;
      const csirtId = this.dataset.csirtId;

      const csirtData = {
        csirt_id: mode === 'edit' ? csirtId : Date.now().toString(),
        csirt_company: document.getElementById('csirt-company').value,
        csirt_name: document.getElementById('csirt-name').value,
        csirt_role: document.getElementById('csirt-role').value,
        csirt_email: document.getElementById('csirt-email').value,
        csirt_phone: document.getElementById('csirt-phone').value,
        csirt_acn_name: document.getElementById('csirt-acn-name').value,
        csirt_acn_email: document.getElementById('csirt-acn-email').value,
        csirt_substitute1: document.getElementById('csirt-substitute1').value,
        csirt_substitute1_email: document.getElementById('csirt-substitute1-email').value,
        csirt_substitute2: document.getElementById('csirt-substitute2').value,
        csirt_substitute2_email: document.getElementById('csirt-substitute2-email').value,
        csirt_external_reason: document.getElementById('csirt-external-reason').value,
        date: mode === 'edit' ? (allCsirt.find(c => c.csirt_id === csirtId)?.date || new Date().toISOString()) : new Date().toISOString()
      };

      if (mode === 'edit') {
        const index = allCsirt.findIndex(c => c.csirt_id === csirtId);
        if (index !== -1) {
          allCsirt[index] = csirtData;
        }
      } else {
        allCsirt.push(csirtData);
      }

      saveToStorage('csirt_csirt', allCsirt);

      hideModal('add-csirt-modal');
      showToast(mode === 'edit' ? '‚úÖ Profilo CSIRT modificato con successo' : '‚úÖ Profilo CSIRT aggiunto con successo', 'success');
      renderAllData();
    });

    // Render Functions
    function renderAllData() {
      renderUsers();
      renderCompanies();
      renderIncidents();
      renderNotifications();
      renderAudits();
      renderCsirt();
    }

    function renderNotifications() {
      const grid = document.getElementById('notifications-grid');
      const filteredNotifications = getFilteredData(allNotifications, 'notification');

      if (filteredNotifications.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-title">Nessuna notifica registrata</div>
            <div class="empty-state-description">Crea la prima notifica ACN</div>
          </div>
        `;
        return;
      }

      const notificationsHTML = filteredNotifications.map(notification => {
        const date = new Date(notification.notification_date);
        const formattedDate = date.toLocaleDateString('it-IT');
        const formattedTime = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        const canDeleteItem = canDelete(notification, 'notification');
        
        return `
        <div class="notification-card">
          <div class="card-header-inline">
            <div style="flex: 1;">
              <div class="incident-title">${notification.notification_title}</div>
              <div style="margin-top: 0.5rem;">
                <span class="badge ${notification.notification_status}">${notification.notification_status.replace('-', ' ')}</span>
              </div>
            </div>
            ${canDeleteItem ? `
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn" style="padding: 0.5rem 0.75rem; font-size: 0.8125rem; background: #dbeafe; color: #1e40af;" onclick='showEditNotificationModal(${JSON.stringify(notification).replace(/'/g, "&apos;")})' title="Modifica">
                ‚úèÔ∏è
              </button>
              <button class="btn" style="padding: 0.5rem 0.75rem; font-size: 0.8125rem; background: #fee2e2; color: #991b1b;" onclick='showDeleteModal(${JSON.stringify(notification).replace(/'/g, "&apos;")}, "notification")' title="Elimina">
                üóëÔ∏è
              </button>
            </div>
            ` : ''}
          </div>
          <div class="card-details">
            <div class="detail-item">
              <span class="detail-label">Azienda</span>
              <span class="detail-value">${notification.notification_company}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Data e Ora</span>
              <span class="detail-value">${formattedDate} ${formattedTime}</span>
            </div>
            <div class="detail-item" style="grid-column: 1 / -1;">
              <span class="detail-label">Descrizione Danno/Impatto</span>
              <span class="detail-value" style="font-size: 0.8125rem; white-space: pre-wrap;">${notification.notification_description}</span>
            </div>
            <div class="detail-item" style="grid-column: 1 / -1;">
              <span class="detail-label">Valutazione Rischio e Danno</span>
              <span class="detail-value" style="font-size: 0.8125rem; white-space: pre-wrap;">${notification.notification_risk}</span>
            </div>
            <div class="detail-item" style="grid-column: 1 / -1;">
              <span class="detail-label">Azioni Correttive Adottate</span>
              <span class="detail-value" style="font-size: 0.8125rem; white-space: pre-wrap;">${notification.notification_actions}</span>
            </div>
          </div>
        </div>
      `;
      }).join('');
      
      grid.innerHTML = notificationsHTML;
    }

    function renderUsers() {
      const tbody = document.getElementById('users-table').querySelector('tbody');

      if (allUsers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <div class="empty-state-title">Nessun utente registrato</div>
                <div class="empty-state-description">Aggiungi il primo utente</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      const roleIcons = {
        'admin': 'üëë',
        'csirt': 'üîß',
        'azienda': 'üè¢'
      };

      const roleNames = {
        'admin': 'Amministratore',
        'csirt': 'Consulente CSIRT',
        'azienda': 'Referente Aziendale'
      };

      const usersHTML = allUsers.map(user => {
        let companyInfo = '-';
        if (user.user_company) {
          companyInfo = user.user_company;
        } else if (user.user_assigned_companies) {
          companyInfo = user.user_assigned_companies;
        }

        return `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.25rem;">${roleIcons[user.user_role] || 'üë§'}</span>
                <strong>${user.user_name}</strong>
              </div>
            </td>
            <td>${user.user_email}</td>
            <td><span class="badge ${user.user_role}">${roleNames[user.user_role] || user.user_role}</span></td>
            <td style="max-width: 300px; font-size: 0.8125rem;">${companyInfo}</td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #dbeafe; color: #1e40af;" onclick='showEditUserModal(${JSON.stringify(user).replace(/'/g, "&apos;")})' title="Modifica">
                  ‚úèÔ∏è
                </button>
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #fee2e2; color: #991b1b;" onclick='showDeleteModal(${JSON.stringify(user).replace(/'/g, "&apos;")}, "user")' title="Elimina">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = usersHTML;
    }

    function renderCompanies() {
      const tbody = document.getElementById('companies-table').querySelector('tbody');
      const filteredCompanies = getFilteredData(allCompanies, 'company');

      if (filteredCompanies.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-state-icon">ÔøΩÔøΩÔøΩ</div>
                <div class="empty-state-title">Nessuna azienda registrata</div>
                <div class="empty-state-description">Aggiungi la prima azienda cliente</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      const companiesHTML = filteredCompanies.map(company => {
        const canDeleteItem = canDelete(company, 'company');
        const logoHTML = company.company_logo ? 
          `<img src="${company.company_logo}" style="width: 40px; height: 40px; object-fit: contain; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">` :
          `<span style="font-size: 1.25rem;">üè¢</span>`;
        
        return `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                ${logoHTML}
                <strong>${company.company_name}</strong>
              </div>
            </td>
            <td style="font-size: 0.8125rem;">${company.company_vat || '-'}</td>
            <td style="font-size: 0.8125rem; max-width: 200px;">${company.company_address || '-'}</td>
            <td>${company.company_contact}</td>
            <td style="font-size: 0.8125rem;">${company.company_phone || '-'}</td>
            <td style="font-size: 0.8125rem;">${company.company_email}</td>
            <td style="font-size: 0.8125rem;">${company.company_csirt || '-'}</td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                ${canDeleteItem ? `
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #dbeafe; color: #1e40af;" onclick='showEditCompanyModal(${JSON.stringify(company).replace(/'/g, "&apos;")})' title="Modifica">
                  ‚úèÔ∏è
                </button>
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #fee2e2; color: #991b1b;" onclick='showDeleteModal(${JSON.stringify(company).replace(/'/g, "&apos;")}, "company")' title="Elimina">
                  üóëÔ∏è
                </button>
                ` : '-'}
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = companiesHTML;
    }

    function renderIncidents() {
      const grid = document.getElementById('incidents-grid');
      const filteredIncidents = getFilteredData(allIncidents, 'incident');

      if (filteredIncidents.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üö®</div>
            <div class="empty-state-title">Nessun incidente registrato</div>
            <div class="empty-state-description">Registra il primo incidente di sicurezza</div>
          </div>
        `;
        return;
      }

      const incidentsHTML = filteredIncidents.map(incident => {
        const date = new Date(incident.incident_date);
        const formattedDate = date.toLocaleDateString('it-IT');
        const canDeleteItem = canDelete(incident, 'incident');
        
        return `
        <div class="incident-card">
          <div class="card-header-inline">
            <div style="flex: 1;">
              <div class="incident-title">${incident.incident_title}</div>
              <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                <span class="badge ${incident.incident_severity}">${incident.incident_severity.charAt(0).toUpperCase() + incident.incident_severity.slice(1)}</span>
                <span class="badge ${incident.incident_status}">${incident.incident_status}</span>
              </div>
            </div>
            ${canDeleteItem ? `
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn" style="padding: 0.5rem 0.75rem; font-size: 0.8125rem; background: #dbeafe; color: #1e40af;" onclick='showEditIncidentModal(${JSON.stringify(incident).replace(/'/g, "&apos;")})' title="Modifica">
                ‚úèÔ∏è
              </button>
              <button class="btn" style="padding: 0.5rem 0.75rem; font-size: 0.8125rem; background: #fee2e2; color: #991b1b;" onclick='showDeleteModal(${JSON.stringify(incident).replace(/'/g, "&apos;")}, "incident")' title="Elimina">
                üóëÔ∏è
              </button>
            </div>
            ` : ''}
          </div>
          <div class="card-details">
            <div class="detail-item">
              <span class="detail-label">Azienda</span>
              <span class="detail-value">${incident.company_name}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Data</span>
              <span class="detail-value">${formattedDate}</span>
            </div>
            <div class="detail-item" style="grid-column: 1 / -1;">
              <span class="detail-label">Descrizione</span>
              <span class="detail-value" style="font-size: 0.8125rem;">${incident.incident_description}</span>
            </div>
          </div>
        </div>
      `;
      }).join('');
      
      grid.innerHTML = incidentsHTML;
    }

    function renderAudits() {
      const tbody = document.getElementById('audits-table').querySelector('tbody');
      const filteredAudits = getFilteredData(allAudits, 'audit');

      if (filteredAudits.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <div class="empty-state-title">Nessun audit disponibile</div>
                <div class="empty-state-description">Crea il primo audit NIS2</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      const auditsHTML = filteredAudits.map(audit => {
        const date = new Date(audit.audit_date);
        const formattedDate = date.toLocaleDateString('it-IT');
        const canDeleteItem = canDelete(audit, 'audit');
        
        return `
          <tr>
            <td><strong>${audit.audit_company}</strong></td>
            <td>${formattedDate}</td>
            <td><strong>${audit.audit_score}/100</strong></td>
            <td><span class="badge ${audit.audit_status}">${audit.audit_status.replace('-', ' ')}</span></td>
            <td style="max-width: 300px;">${audit.audit_notes}</td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                ${canDeleteItem ? `
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #dbeafe; color: #1e40af;" onclick='showEditAuditModal(${JSON.stringify(audit).replace(/'/g, "&apos;")})' title="Modifica">
                  ‚úèÔ∏è
                </button>
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #fee2e2; color: #991b1b;" onclick='showDeleteModal(${JSON.stringify(audit).replace(/'/g, "&apos;")}, "audit")' title="Elimina">
                  üóëÔ∏è
                </button>
                ` : '-'}
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = auditsHTML;
    }

    function renderCsirt() {
      const grid = document.getElementById('csirt-grid');
      
      // Get all CSIRT users (admin and csirt roles)
      const csirtUsers = allUsers.filter(u => u.user_role === 'csirt' || u.user_role === 'admin');
      
      let csirtData = [];
      
      // Create cards for each CSIRT user showing their assigned companies
      csirtUsers.forEach(user => {
        const companiesAssigned = allCompanies.filter(c => c.company_csirt === user.user_name);
        
        csirtData.push({
          user_id: user.user_id,
          csirt_name: user.user_name,
          csirt_email: user.user_email,
          csirt_role: user.user_role === 'admin' ? 'Amministratore' : 'Consulente CSIRT',
          companies: companiesAssigned,
          isFromUsers: true
        });
      });
      
      // Add manually created CSIRT referents (company-specific referents)
      const filteredCsirt = getFilteredData(allCsirt, 'csirt');
      filteredCsirt.forEach(csirt => {
        csirtData.push({
          ...csirt,
          companies: [],
          isFromUsers: false
        });
      });

      if (csirtData.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë®‚Äçüíº</div>
            <div class="empty-state-title">Nessun profilo CSIRT</div>
            <div class="empty-state-description">I profili CSIRT creati per le aziende appariranno qui</div>
          </div>
        `;
        return;
      }

      const csirtHTML = csirtData.map(csirt => {
        if (csirt.isFromUsers) {
          // Display CSIRT users with their assigned companies
          const companiesList = csirt.companies.length > 0 ? 
            csirt.companies.map(c => c.company_name).join(', ') : 
            'Nessuna azienda assegnata';
          
          const roleIcon = csirt.csirt_role === 'Amministratore' ? 'üëë' : 'üîß';
          
          return `
            <div class="csirt-card">
              <div class="card-header-inline">
                <div style="display: flex; gap: 1rem; align-items: start;">
                  <div class="card-icon">${roleIcon}</div>
                  <div style="flex: 1;">
                    <div class="card-name">${csirt.csirt_name}</div>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">${csirt.csirt_role}</div>
                  </div>
                </div>
              </div>
              <div class="card-details">
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <span class="detail-label">Email</span>
                  <span class="detail-value" style="font-size: 0.8125rem;">${csirt.csirt_email || '-'}</span>
                </div>
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <span class="detail-label">Aziende Assegnate (${csirt.companies.length})</span>
                  <span class="detail-value" style="font-size: 0.8125rem;">${companiesList}</span>
                </div>
              </div>
            </div>
          `;
        } else {
          // Display manually created CSIRT referents (company-specific)
          const canDeleteItem = canDelete(csirt, 'csirt');
          return `
            <div class="csirt-card">
              <div class="card-header-inline">
                <div style="display: flex; gap: 1rem; align-items: start;">
                  <div class="card-icon">üë®‚Äçüíº</div>
                  <div style="flex: 1;">
                    <div class="card-name">${csirt.csirt_name}</div>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">${csirt.csirt_role}</div>
                  </div>
                </div>
                ${canDeleteItem ? `
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn" style="padding: 0.5rem 0.75rem; font-size: 0.8125rem; background: #dbeafe; color: #1e40af;" onclick='showEditCsirtModal(${JSON.stringify(csirt).replace(/'/g, "&apos;")})' title="Modifica">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn" style="padding: 0.5rem 0.75rem; font-size: 0.8125rem; background: #fee2e2; color: #991b1b;" onclick='showDeleteModal(${JSON.stringify(csirt).replace(/'/g, "&apos;")}, "csirt")' title="Elimina">
                    üóëÔ∏è
                  </button>
                </div>
                ` : ''}
              </div>
              <div class="card-details">
                <div class="detail-item">
                  <span class="detail-label">Azienda Specifica</span>
                  <span class="detail-value">${csirt.csirt_company}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Telefono</span>
                  <span class="detail-value">${csirt.csirt_phone}</span>
                </div>
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <span class="detail-label">Email</span>
                  <span class="detail-value" style="font-size: 0.8125rem;">${csirt.csirt_email}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Punto Contatto ACN</span>
                  <span class="detail-value">${csirt.csirt_acn_name}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Email ACN</span>
                  <span class="detail-value" style="font-size: 0.8125rem;">${csirt.csirt_acn_email}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">1¬∞ Sostituto</span>
                  <span class="detail-value">${csirt.csirt_substitute1}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Email 1¬∞ Sostituto</span>
                  <span class="detail-value" style="font-size: 0.8125rem;">${csirt.csirt_substitute1_email}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">2¬∞ Sostituto</span>
                  <span class="detail-value">${csirt.csirt_substitute2}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Email 2¬∞ Sostituto</span>
                  <span class="detail-value" style="font-size: 0.8125rem;">${csirt.csirt_substitute2_email}</span>
                </div>
                ${csirt.csirt_external_reason ? `
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <span class="detail-label">Motivazione Scelta Esterna</span>
                  <span class="detail-value" style="font-size: 0.8125rem;">${csirt.csirt_external_reason}</span>
                </div>
                ` : ''}
              </div>
            </div>
          `;
        }
      }).join('');
      
      grid.innerHTML = csirtHTML;
    }

    function getFilteredData(data, type) {
      if (!currentUser) return data;

      if (currentUser.user_role === 'admin') {
        return data;
      }

      if (currentUser.user_role === 'csirt') {
        const assignedCompanies = currentUser.user_assigned_companies ? 
          currentUser.user_assigned_companies.split(',').map(c => c.trim()) : [];
        
        if (type === 'company') {
          return data.filter(item => assignedCompanies.includes(item.company_name));
        } else if (type === 'incident') {
          return data.filter(item => assignedCompanies.includes(item.company_name));
        } else if (type === 'notification') {
          return data.filter(item => assignedCompanies.includes(item.notification_company));
        } else if (type === 'audit') {
          return data.filter(item => assignedCompanies.includes(item.audit_company));
        } else if (type === 'csirt') {
          return data.filter(item => assignedCompanies.includes(item.csirt_company));
        } else if (type === 'network') {
          return data.filter(item => assignedCompanies.includes(item.network_company));
        }
      }

      if (currentUser.user_role === 'azienda') {
        const userCompany = currentUser.user_company;
        
        if (type === 'company') {
          return data.filter(item => item.company_name === userCompany);
        } else if (type === 'incident') {
          return data.filter(item => item.company_name === userCompany);
        } else if (type === 'notification') {
          return data.filter(item => item.notification_company === userCompany);
        } else if (type === 'audit') {
          return data.filter(item => item.audit_company === userCompany);
        } else if (type === 'csirt') {
          return data.filter(item => item.csirt_company === userCompany);
        } else if (type === 'network') {
          return data.filter(item => item.network_company === userCompany);
        }
      }

      return data;
    }

    function renderDashboardNotifications() {
      const container = document.getElementById('dashboard-notifications-list');
      const filteredNotifications = getFilteredData(allNotifications, 'notification');
      
      const recentNotifications = filteredNotifications
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);

      if (recentNotifications.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon" style="font-size: 2rem;">üìã</div>
            <div class="empty-state-title">Nessuna notifica</div>
            <div class="empty-state-description">Le notifiche registrate appariranno qui</div>
          </div>
        `;
        return;
      }

      const notificationsHTML = recentNotifications.map(notification => {
        const date = new Date(notification.notification_date);
        const formattedDate = date.toLocaleDateString('it-IT');
        
        return `
          <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">${notification.notification_title}</div>
              <div style="font-size: 0.8125rem; color: #64748b;">${notification.notification_company} ‚Ä¢ ${formattedDate}</div>
            </div>
            <span class="badge ${notification.notification_status}">${notification.notification_status.replace('-', ' ')}</span>
          </div>
        `;
      }).join('');

      container.innerHTML = notificationsHTML;
    }

    function updateNotificationsChart() {
      const filteredNotifications = getFilteredData(allNotifications, 'notification');
      
      const aperte = filteredNotifications.filter(n => n.notification_status === 'aperta').length;
      const notificate = filteredNotifications.filter(n => n.notification_status === 'notificata-acn').length;
      const chiuse = filteredNotifications.filter(n => n.notification_status === 'chiusa').length;

      document.getElementById('chart-aperte').textContent = aperte;
      document.getElementById('chart-notificate').textContent = notificate;
      document.getElementById('chart-chiuse').textContent = chiuse;
    }

    function renderNetworkConfigs() {
      const container = document.getElementById('network-config-display');
      const filteredConfigs = getFilteredData(allNetworkConfigs, 'network');

      if (filteredConfigs.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 2rem;">
            <div class="empty-state-icon">ÔøΩÔøΩ</div>
            <div class="empty-state-title">Nessuna configurazione di rete</div>
            <div class="empty-state-description">Configura la topologia di rete per le aziende</div>
          </div>
        `;
        return;
      }

      const configsHTML = filteredConfigs.map(config => {
        const topologyNames = {
          'star': 'Stella (Star)',
          'mesh': 'Maglia (Mesh)',
          'ring': 'Anello (Ring)',
          'bus': 'Bus',
          'hybrid': 'Ibrida'
        };

        const vpnNames = {
          'site-to-site': 'Site-to-Site',
          'remote-access': 'Remote Access',
          'both': 'Entrambe'
        };

        return `
          <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <div>
                <div style="font-weight: 700; font-size: 1.125rem; color: #1e293b; margin-bottom: 0.25rem;">${config.network_company}</div>
                <div style="font-size: 0.875rem; color: #64748b;">Topologia: ${topologyNames[config.network_topology]}</div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #dbeafe; color: #1e40af;" onclick='showEditNetworkConfigModal(${JSON.stringify(config).replace(/'/g, "&apos;")})' title="Modifica">
                  ‚úèÔ∏è
                </button>
                <button class="btn" style="padding: 0.4rem 0.6rem; font-size: 0.75rem; background: #fee2e2; color: #991b1b;" onclick='showDeleteModal(${JSON.stringify(config).replace(/'/g, "&apos;")}, "network")' title="Elimina">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
              <div>
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">Dispositivi Totali</div>
                <div style="font-weight: 600; color: #1e293b;">${config.network_devices}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">Server</div>
                <div style="font-weight: 600; color: #1e293b;">${config.network_servers}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">Workstation</div>
                <div style="font-weight: 600; color: #1e293b;">${config.network_workstations}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">Connettivit√† WAN</div>
                <div style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">${config.network_wan}</div>
              </div>
              ${config.network_firewall ? `
              <div style="grid-column: 1 / -1;">
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">Firewall</div>
                <div style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">${config.network_firewall}</div>
              </div>
              ` : ''}
              ${config.network_vpn ? `
              <div>
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">VPN</div>
                <div style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">${vpnNames[config.network_vpn] || config.network_vpn}</div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = configsHTML;
    }

    function showNetworkConfigModal() {
      populateCompanySelects();
      document.getElementById('network-config-modal').style.display = 'flex';
      document.getElementById('network-config-form').reset();
      document.getElementById('network-config-form').dataset.mode = 'add';
      document.getElementById('network-config-form').dataset.configId = '';
      document.querySelector('#network-config-modal h3').textContent = 'üåê Configurazione della Rete';
    }

    function showEditNetworkConfigModal(config) {
      populateCompanySelects();
      document.getElementById('network-config-modal').style.display = 'flex';
      document.getElementById('network-config-form').dataset.mode = 'edit';
      document.getElementById('network-config-form').dataset.configId = config.network_id;
      document.querySelector('#network-config-modal h3').textContent = '‚úèÔ∏è Modifica Configurazione Rete';
      
      document.getElementById('network-company').value = config.network_company;
      document.getElementById('network-topology').value = config.network_topology;
      document.getElementById('network-devices').value = config.network_devices;
      document.getElementById('network-servers').value = config.network_servers;
      document.getElementById('network-workstations').value = config.network_workstations;
      document.getElementById('network-firewall').value = config.network_firewall;
      document.getElementById('network-router').value = config.network_router;
      document.getElementById('network-vpn').value = config.network_vpn;
      document.getElementById('network-wan').value = config.network_wan;
      document.getElementById('network-vlan').value = config.network_vlan;
      document.getElementById('network-monitoring').value = config.network_monitoring;
      document.getElementById('network-backup').value = config.network_backup;
      document.getElementById('network-notes').value = config.network_notes;
    }

    function generateDesignationModule() {
      populateCompanySelects();
      const select = document.getElementById('designation-company');
      select.innerHTML = '<option value="">Seleziona azienda</option>';
      
      const companies = getFilteredCompanies();
      companies.forEach(company => {
        const option = document.createElement('option');
        option.value = company.company_name;
        option.textContent = company.company_name;
        select.appendChild(option);
      });

      document.getElementById('designation-modal').style.display = 'flex';
    }

    function updateStats() {
      const filteredCompanies = getFilteredData(allCompanies, 'company');
      const filteredIncidents = getFilteredData(allIncidents, 'incident');
      const filteredNotifications = getFilteredData(allNotifications, 'notification');
      const filteredAudits = getFilteredData(allAudits, 'audit');

      document.getElementById('stat-companies').textContent = filteredCompanies.length;
      document.getElementById('stat-incidents').textContent = filteredIncidents.filter(i => i.incident_status !== 'risolto').length;
      document.getElementById('stat-notifications').textContent = filteredNotifications.filter(n => n.notification_status !== 'chiusa').length;
      document.getElementById('stat-audits').textContent = filteredAudits.length;
    }

    function showToast(message, type) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      
      if (type === 'success') {
        toast.style.background = '#059669';
      } else if (type === 'error') {
        toast.style.background = '#dc2626';
      }
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Tab Navigation
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('tab-button')) {
        const targetTab = event.target.getAttribute('data-tab');
        const container = event.target.closest('.tabs-container');
        
        container.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        container.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        container.querySelector(`.tab-panel[data-tab="${targetTab}"]`).classList.add('active');
      }
    });

    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });

    // Login form enter key
    document.getElementById('login-email').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') performLogin();
    });
    document.getElementById('login-password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') performLogin();
    });

    // Copy SQL script to clipboard
    function copyToClipboard() {
      const sqlScript = `-- =============================================
-- PIATTAFORMA CSIRT - DATABASE SCHEMA
-- =============================================

-- 1. TABELLA USERS
CREATE TABLE users (
  user_id TEXT PRIMARY KEY,
  user_name TEXT NOT NULL,
  user_email TEXT UNIQUE NOT NULL,
  user_password TEXT NOT NULL,
  user_role TEXT NOT NULL CHECK (user_role IN ('admin', 'csirt', 'azienda')),
  user_company TEXT,
  user_assigned_companies TEXT,
  date TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(user_email);
CREATE INDEX idx_users_role ON users(user_role);

-- 2. TABELLA COMPANIES
CREATE TABLE companies (
  company_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  company_vat TEXT,
  company_address TEXT,
  company_contact TEXT NOT NULL,
  company_phone TEXT,
  company_email TEXT NOT NULL,
  company_csirt TEXT,
  company_logo TEXT,
  date TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_companies_name ON companies(company_name);
CREATE INDEX idx_companies_csirt ON companies(company_csirt);

-- 3. TABELLA INCIDENTS
CREATE TABLE incidents (
  incident_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  incident_title TEXT NOT NULL,
  incident_severity TEXT NOT NULL CHECK (incident_severity IN ('critical', 'high', 'medium', 'low')),
  incident_status TEXT NOT NULL CHECK (incident_status IN ('aperto', 'in-corso', 'risolto')),
  incident_description TEXT NOT NULL,
  incident_date TIMESTAMPTZ NOT NULL,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (company_name) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_incidents_company ON incidents(company_name);
CREATE INDEX idx_incidents_status ON incidents(incident_status);
CREATE INDEX idx_incidents_date ON incidents(incident_date DESC);

-- 4. TABELLA NOTIFICATIONS
CREATE TABLE notifications (
  notification_id TEXT PRIMARY KEY,
  notification_company TEXT NOT NULL,
  notification_title TEXT NOT NULL,
  notification_date TIMESTAMPTZ NOT NULL,
  notification_description TEXT NOT NULL,
  notification_status TEXT NOT NULL CHECK (notification_status IN ('aperta', 'notificata-acn', 'chiusa')),
  notification_risk TEXT NOT NULL,
  notification_actions TEXT NOT NULL,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (notification_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_notifications_company ON notifications(notification_company);
CREATE INDEX idx_notifications_status ON notifications(notification_status);
CREATE INDEX idx_notifications_date ON notifications(notification_date DESC);

-- 5. TABELLA AUDITS
CREATE TABLE audits (
  audit_id TEXT PRIMARY KEY,
  audit_company TEXT NOT NULL,
  audit_score INTEGER NOT NULL CHECK (audit_score >= 0 AND audit_score <= 100),
  audit_status TEXT NOT NULL CHECK (audit_status IN ('conforme', 'non-conforme', 'in-progress')),
  audit_notes TEXT NOT NULL,
  audit_date TIMESTAMPTZ NOT NULL,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (audit_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_audits_company ON audits(audit_company);
CREATE INDEX idx_audits_status ON audits(audit_status);
CREATE INDEX idx_audits_date ON audits(audit_date DESC);

-- 6. TABELLA CSIRT_PROFILES
CREATE TABLE csirt_profiles (
  csirt_id TEXT PRIMARY KEY,
  csirt_company TEXT NOT NULL,
  csirt_name TEXT NOT NULL,
  csirt_role TEXT NOT NULL,
  csirt_email TEXT NOT NULL,
  csirt_phone TEXT NOT NULL,
  csirt_acn_name TEXT NOT NULL,
  csirt_acn_email TEXT NOT NULL,
  csirt_substitute1 TEXT NOT NULL,
  csirt_substitute1_email TEXT NOT NULL,
  csirt_substitute2 TEXT NOT NULL,
  csirt_substitute2_email TEXT NOT NULL,
  csirt_external_reason TEXT,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (csirt_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_csirt_company ON csirt_profiles(csirt_company);
CREATE INDEX idx_csirt_email ON csirt_profiles(csirt_email);

-- 7. TABELLA NETWORK_CONFIGS
CREATE TABLE network_configs (
  network_id TEXT PRIMARY KEY,
  network_company TEXT NOT NULL,
  network_topology TEXT NOT NULL CHECK (network_topology IN ('star', 'mesh', 'ring', 'bus', 'hybrid')),
  network_devices INTEGER NOT NULL,
  network_servers INTEGER NOT NULL,
  network_workstations INTEGER NOT NULL,
  network_firewall TEXT,
  network_router TEXT,
  network_vpn TEXT CHECK (network_vpn IN ('site-to-site', 'remote-access', 'both', '')),
  network_wan TEXT NOT NULL,
  network_vlan TEXT,
  network_monitoring TEXT,
  network_backup TEXT,
  network_notes TEXT,
  date TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (network_company) REFERENCES companies(company_name) ON DELETE CASCADE
);

CREATE INDEX idx_network_company ON network_configs(network_company);

-- =============================================
-- ROW LEVEL SECURITY (RLS) - OPZIONALE
-- =============================================
-- Decommentare per abilitare la sicurezza a livello di riga

-- ALTER TABLE users ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE companies ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE incidents ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE audits ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE csirt_profiles ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE network_configs ENABLE ROW LEVEL SECURITY;

-- =============================================
-- COMPLETATO! ‚úÖ
-- =============================================`;

      navigator.clipboard.writeText(sqlScript).then(() => {
        showToast('‚úÖ Script SQL copiato negli appunti!', 'success');
      }).catch(() => {
        showToast('‚ùå Errore nella copia. Seleziona e copia manualmente.', 'error');
      });
    }

    // Initialize app on load
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a936897d469e898',t:'MTc2NDkzNjI5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
