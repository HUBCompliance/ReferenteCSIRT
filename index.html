<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSIRT Management Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* LOGIN CONTAINER */
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            padding: 40px;
        }

        /* DASHBOARD LAYOUT */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .user-info {
            font-size: 13px;
            color: #95a5a6;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: block;
            padding: 12px 15px;
            color: #ecf0f1;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-link.active {
            background: #667eea;
        }

        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .logout-btn-top {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn-top:hover {
            background: #c0392b;
        }

        /* COMMON STYLES */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-admin {
            background: #667eea;
            color: white;
        }

        .badge-csirt {
            background: #3498db;
            color: white;
        }

        .badge-company {
            background: #95a5a6;
            color: white;
        }

        .badge-critical {
            background: #e74c3c;
            color: white;
        }

        .badge-high {
            background: #e67e22;
            color: white;
        }

        .badge-medium {
            background: #f39c12;
            color: white;
        }

        .badge-low {
            background: #3498db;
            color: white;
        }

        .badge-open {
            background: #3498db;
            color: white;
        }

        .badge-investigating {
            background: #f39c12;
            color: white;
        }

        .badge-resolved {
            background: #2ecc71;
            color: white;
        }

        .badge-closed {
            background: #95a5a6;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2c3e50;
            font-size: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #95a5a6;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        button[type="submit"] {
            width: 100%;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .status-indicator.pending {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .config-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .config-status div {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .config-status div:last-child {
            margin-bottom: 0;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .network-diagram {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #95a5a6;
            margin-top: 20px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- LOGIN VIEW -->
  <div id="loginView" class="login-container">
   <div class="container">
    <div class="header">
     <h1>üõ°Ô∏è CSIRT Platform</h1>
     <p>Cyber Security Incident Response Team</p>
    </div>
    <div class="config-status" id="connectionStatus">
     <div><span class="status-indicator disconnected" id="statusDot"></span> <span id="statusText">‚ö†Ô∏è Configura le chiavi Supabase nelle Impostazioni della piattaforma</span>
     </div>
    </div>
    <form id="loginForm">
     <div class="form-group"><label for="email">üìß Email</label> <input type="email" id="email" placeholder="admin@csirt.it" value="admin@csirt.it" required>
     </div>
     <div class="form-group"><label for="password">üîí Password</label> <input type="password" id="password" placeholder="password123" value="password123" required>
     </div><button type="submit" id="loginBtn">Accedi</button>
    </form>
    <div id="loginMessage" class="message"></div>
   </div>
  </div><!-- DASHBOARD VIEW -->
  <div id="dashboardView" style="display: none;">
   <div class="dashboard-container"><!-- SIDEBAR -->
    <aside class="sidebar">
     <div class="sidebar-header">
      <h2>üõ°Ô∏è CSIRT Platform</h2>
      <div class="user-info">
       <div id="currentUserName"></div>
       <div id="currentUserRole"></div>
      </div>
     </div>
     <nav>
      <ul class="nav-menu">
       <li class="nav-item"><a class="nav-link active" onclick="navigateTo('dashboard')">üìä Dashboard</a></li>
       <li class="nav-item"><a class="nav-link" onclick="navigateTo('csirt')">üõ°Ô∏è CSIRT</a></li>
       <li class="nav-item"><a class="nav-link" onclick="navigateTo('users')">üë• Utenti</a></li>
       <li class="nav-item"><a class="nav-link" onclick="navigateTo('companies')">üè¢ Aziende</a></li>
       <li class="nav-item"><a class="nav-link" onclick="navigateTo('incidents')">üö® Incidenti</a></li>
       <li class="nav-item"><a class="nav-link" onclick="navigateTo('network')">üåê Rete</a></li>
       <li class="nav-item"><a class="nav-link" onclick="navigateTo('settingsPlatform')">‚öôÔ∏è Impostazioni</a></li>
      </ul>
     </nav>
    </aside><!-- MAIN CONTENT -->
    <main class="main-content">
     <div class="top-bar">
      <h1 id="pageTitle">Dashboard</h1><button class="logout-btn-top" onclick="logout()">üö™ Esci</button>
     </div><!-- CSIRT SECTION -->
     <section id="csirtSection" class="page-section"><!-- CSIRT Overview Card -->
      <div class="card">
       <h2>üõ°Ô∏è Panoramica CSIRT</h2>
       <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
        <div class="stat-card">
         <h3 id="csirtTeamMembers">0</h3>
         <p>Membri Team</p>
        </div>
        <div class="stat-card">
         <h3 id="csirtActiveIncidents">0</h3>
         <p>Incidenti Attivi</p>
        </div>
        <div class="stat-card">
         <h3 id="csirtResolvedThisMonth">0</h3>
         <p>Risolti (Mese)</p>
        </div>
        <div class="stat-card">
         <h3 id="csirtResponseTime">0h</h3>
         <p>Tempo Risposta Medio</p>
        </div>
       </div>
      </div><!-- CSIRT Main Card with Tabs -->
      <div class="card">
       <h2>üõ°Ô∏è Gestione CSIRT</h2>
       <div class="tabs"><button class="tab active" onclick="switchCSIRTTab('designation')">üìã Designazione</button> <button class="tab" onclick="switchCSIRTTab('incidents')">üö® Incidenti</button> <button class="tab" onclick="switchCSIRTTab('network')">üåê Rete</button>
       </div><!-- DESIGNATION TAB -->
       <div id="designationTab" class="tab-content active">
        <form id="csirtDesignationForm">
         <div class="form-group"><label for="csirtOrgName">Nome Organizzazione</label> <input type="text" id="csirtOrgName" placeholder="Es: Acme Corporation CSIRT" required>
         </div>
         <div class="form-group"><label for="csirtConstituency">Constituency (Clientela)</label> <textarea id="csirtConstituency" placeholder="Descrivi chi serve il CSIRT (es: dipendenti interni, clienti esterni, settori specifici)" rows="3"></textarea>
         </div>
         <div class="form-group"><label for="csirtMission">Missione</label> <textarea id="csirtMission" placeholder="Descrivi la missione del CSIRT" rows="3"></textarea>
         </div>
         <div class="form-group"><label for="csirtServices">Servizi Offerti</label> <textarea id="csirtServices" placeholder="Es: Incident Response, Threat Intelligence, Vulnerability Assessment" rows="3"></textarea>
         </div>
         <div class="form-group"><label for="csirtContactEmail">Email di Contatto</label> <input type="email" id="csirtContactEmail" placeholder="csirt@organization.com">
         </div>
         <div class="form-group"><label for="csirtContactPhone">Telefono di Emergenza</label> <input type="tel" id="csirtContactPhone" placeholder="+39 XXX XXX XXXX">
         </div>
         <div class="form-group"><label for="csirtOperatingHours">Orari Operativi</label> <select id="csirtOperatingHours"> <option value="24/7">24/7 - Sempre Attivo</option> <option value="business">Orario Lavorativo (9-18)</option> <option value="extended">Esteso (8-20)</option> <option value="on-call">Su Chiamata</option> </select>
         </div><button type="submit" class="btn btn-primary">üíæ Salva Designazione</button>
        </form>
        <div id="csirtDesignationMessage" class="message"></div><!-- Display Current Designation -->
        <div id="currentDesignation" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; display: none;">
         <h3 style="margin-bottom: 15px; color: #2c3e50;">üìÑ Designazione Corrente</h3>
         <div style="line-height: 1.8;">
          <p><strong>Organizzazione:</strong> <span id="displayOrgName">-</span></p>
          <p><strong>Constituency:</strong> <span id="displayConstituency">-</span></p>
          <p><strong>Missione:</strong> <span id="displayMission">-</span></p>
          <p><strong>Servizi:</strong> <span id="displayServices">-</span></p>
          <p><strong>Email:</strong> <span id="displayEmail">-</span></p>
          <p><strong>Telefono:</strong> <span id="displayPhone">-</span></p>
          <p><strong>Orari:</strong> <span id="displayHours">-</span></p>
         </div>
        </div>
       </div><!-- INCIDENTS TAB -->
       <div id="incidentsTabCSIRT" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><button class="btn btn-primary" onclick="openModal('incidentModal')">‚ûï Nuovo Incidente</button>
        </div>
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;"><button class="btn" style="background: #3498db; color: white;" onclick="filterIncidents('all')">Tutti</button> <button class="btn" style="background: #e74c3c; color: white;" onclick="filterIncidents('critical')">Critici</button> <button class="btn" style="background: #f39c12; color: white;" onclick="filterIncidents('investigating')">In Analisi</button> <button class="btn" style="background: #2ecc71; color: white;" onclick="filterIncidents('resolved')">Risolti</button>
        </div>
        <div class="table-container">
         <table id="csirtIncidentsTable">
          <thead>
           <tr>
            <th>ID</th>
            <th>Titolo</th>
            <th>Severit√†</th>
            <th>Stato</th>
            <th>Data</th>
            <th>Assegnato a</th>
            <th>Azioni</th>
           </tr>
          </thead>
          <tbody>
           <tr>
            <td colspan="7" style="text-align: center; color: #95a5a6;">Caricamento...</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div><!-- NETWORK TAB -->
       <div id="networkTabCSIRT" class="tab-content">
        <div class="tabs" style="border-bottom: 2px solid #eee; margin-bottom: 20px;"><button class="tab active" onclick="switchNetworkTab('topology')" style="flex: 1; padding: 12px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer;"> Topologia </button> <button class="tab" onclick="switchNetworkTab('security')" style="flex: 1; padding: 12px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer;"> Sicurezza </button> <button class="tab" onclick="switchNetworkTab('monitoring')" style="flex: 1; padding: 12px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer;"> Monitoraggio </button>
        </div><!-- Topology Tab -->
        <div id="topologyTab" class="tab-content active">
         <form id="networkTopologyForm">
          <div class="form-group"><label for="networkName">Nome Rete</label> <input type="text" id="networkName" placeholder="Es: Rete Aziendale Principale" required>
          </div>
          <div class="form-group"><label for="networkType">Tipo di Rete</label> <select id="networkType"> <option value="lan">LAN (Local Area Network)</option> <option value="wan">WAN (Wide Area Network)</option> <option value="cloud">Cloud Infrastructure</option> <option value="hybrid">Hybrid Network</option> </select>
          </div>
          <div class="form-group"><label for="ipRange">Range IP</label> <input type="text" id="ipRange" placeholder="Es: 192.168.1.0/24">
          </div>
          <div class="form-group"><label for="subnetMask">Subnet Mask</label> <input type="text" id="subnetMask" placeholder="Es: 255.255.255.0">
          </div>
          <div class="form-group"><label for="gateway">Gateway</label> <input type="text" id="gateway" placeholder="Es: 192.168.1.1">
          </div>
          <div class="form-group"><label for="dnsServers">DNS Servers</label> <input type="text" id="dnsServers" placeholder="Es: 8.8.8.8, 8.8.4.4">
          </div><button type="submit" class="btn btn-success">üíæ Salva Topologia</button>
         </form>
         <div id="topologyMessage" class="message"></div>
        </div><!-- Security Tab -->
        <div id="securityTab" class="tab-content">
         <form id="networkSecurityForm">
          <div class="form-group"><label for="firewallStatus">Stato Firewall</label> <select id="firewallStatus"> <option value="enabled">‚úÖ Abilitato</option> <option value="disabled">‚ùå Disabilitato</option> <option value="monitoring">üëÅÔ∏è Solo Monitoraggio</option> </select>
          </div>
          <div class="form-group"><label for="firewallRules">Regole Firewall Principali</label> <textarea id="firewallRules" rows="4" placeholder="Es: Allow HTTP/HTTPS, Block all incoming except..."></textarea>
          </div>
          <div class="form-group"><label for="idsStatus">IDS/IPS Status</label> <select id="idsStatus"> <option value="active">‚úÖ Attivo</option> <option value="inactive">‚ùå Inattivo</option> <option value="testing">üß™ In Test</option> </select>
          </div>
          <div class="form-group"><label for="vpnEnabled">VPN</label> <select id="vpnEnabled"> <option value="yes">‚úÖ Configurata</option> <option value="no">‚ùå Non Configurata</option> </select>
          </div>
          <div class="form-group"><label for="encryptionLevel">Livello Crittografia</label> <select id="encryptionLevel"> <option value="high">üîí Alto (AES-256)</option> <option value="medium">üîì Medio (AES-128)</option> <option value="low">‚ö†Ô∏è Basso</option> </select>
          </div><button type="submit" class="btn btn-success">üíæ Salva Configurazione Sicurezza</button>
         </form>
         <div id="securityMessage" class="message"></div>
        </div><!-- Monitoring Tab -->
        <div id="monitoringTab" class="tab-content">
         <form id="networkMonitoringForm">
          <div class="form-group"><label for="monitoringTool">Strumento di Monitoraggio</label> <input type="text" id="monitoringTool" placeholder="Es: Nagios, Zabbix, PRTG">
          </div>
          <div class="form-group"><label for="alertEmail">Email per Alert</label> <input type="email" id="alertEmail" placeholder="alerts@csirt.com">
          </div>
          <div class="form-group"><label for="snmpEnabled">SNMP</label> <select id="snmpEnabled"> <option value="enabled">‚úÖ Abilitato</option> <option value="disabled">‚ùå Disabilitato</option> </select>
          </div>
          <div class="form-group"><label for="logRetention">Retention Log (giorni)</label> <input type="number" id="logRetention" placeholder="Es: 90" min="1">
          </div>
          <div class="form-group"><label for="backupFrequency">Frequenza Backup</label> <select id="backupFrequency"> <option value="daily">Giornaliero</option> <option value="weekly">Settimanale</option> <option value="monthly">Mensile</option> <option value="realtime">Real-time</option> </select>
          </div><button type="submit" class="btn btn-success">üíæ Salva Configurazione Monitoraggio</button>
         </form>
         <div id="monitoringMessage" class="message"></div>
        </div><!-- Network Visualization -->
        <div style="margin-top: 30px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; text-align: center; color: white;">
         <h3 style="margin-bottom: 15px;">üåê Visualizzazione Rete</h3>
         <div style="background: white; border-radius: 8px; padding: 40px; color: #666;">
          <p style="font-size: 48px; margin-bottom: 10px;">üñ•Ô∏è ‚ÜîÔ∏è üõ°Ô∏è ‚ÜîÔ∏è ‚òÅÔ∏è</p>
          <p>Devices ‚ÜîÔ∏è Firewall ‚ÜîÔ∏è Cloud</p>
          <p style="margin-top: 20px; font-size: 14px;">Diagramma interattivo in sviluppo</p>
         </div>
        </div>
       </div>
      </div>
     </section><!-- DASHBOARD SECTION -->
     <section id="dashboardSection" class="page-section active">
      <div class="stats-grid">
       <div class="stat-card">
        <h3 id="statsUsers">0</h3>
        <p>Utenti Registrati</p>
       </div>
       <div class="stat-card">
        <h3 id="statsCompanies">0</h3>
        <p>Aziende</p>
       </div>
       <div class="stat-card">
        <h3 id="statsIncidents">0</h3>
        <p>Incidenti Totali</p>
       </div>
       <div class="stat-card">
        <h3 id="statsOpenIncidents">0</h3>
        <p>Incidenti Aperti</p>
       </div>
      </div>
      <div class="card">
       <h2>üö® Incidenti Recenti</h2>
       <div class="table-container">
        <table id="recentIncidentsTable">
         <thead>
          <tr>
           <th>Titolo</th>
           <th>Severit√†</th>
           <th>Stato</th>
           <th>Data</th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td colspan="4" style="text-align: center; color: #95a5a6;">Nessun incidente</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- USERS SECTION -->
     <section id="usersSection" class="page-section">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üë• Gestione Utenti</h2><button class="btn btn-primary" onclick="openModal('userModal')">‚ûï Nuovo Utente</button>
       </div>
       <div class="table-container">
        <table id="usersTable">
         <thead>
          <tr>
           <th>Nome</th>
           <th>Email</th>
           <th>Ruolo</th>
           <th>Azioni</th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td colspan="4" style="text-align: center; color: #95a5a6;">Caricamento...</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- COMPANIES SECTION -->
     <section id="companiesSection" class="page-section">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üè¢ Gestione Aziende</h2><button class="btn btn-primary" onclick="openModal('companyModal')">‚ûï Nuova Azienda</button>
       </div>
       <div class="table-container">
        <table id="companiesTable">
         <thead>
          <tr>
           <th>Nome</th>
           <th>Indirizzo</th>
           <th>Data Registrazione</th>
           <th>Azioni</th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td colspan="4" style="text-align: center; color: #95a5a6;">Caricamento...</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- INCIDENTS SECTION -->
     <section id="incidentsSection" class="page-section">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üö® Gestione Incidenti</h2><button class="btn btn-primary" onclick="openModal('incidentModal')">‚ûï Nuovo Incidente</button>
       </div>
       <div class="table-container">
        <table id="incidentsTable">
         <thead>
          <tr>
           <th>Titolo</th>
           <th>Severit√†</th>
           <th>Stato</th>
           <th>Data</th>
           <th>Azioni</th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td colspan="5" style="text-align: center; color: #95a5a6;">Caricamento...</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- NETWORK SECTION -->
     <section id="networkSection" class="page-section">
      <div class="card">
       <h2>üåê Configurazione Rete</h2>
       <form id="networkForm">
        <div class="form-group"><label for="networkName">Nome Configurazione</label> <input type="text" id="networkName" required>
        </div>
        <div class="form-group"><label for="networkConfig">Configurazione JSON</label> <textarea id="networkConfig" placeholder="{&quot;firewall&quot;: &quot;enabled&quot;, &quot;vpn&quot;: &quot;active&quot;}"></textarea>
        </div><button type="submit" class="btn btn-success">üíæ Salva Configurazione</button>
       </form>
       <div id="networkMessage" class="message"></div>
       <div class="network-diagram">
        üåê Diagramma di rete (in sviluppo)
       </div>
      </div>
     </section><!-- SETTINGS PLATFORM SECTION -->
     <section id="settingsPlatformSection" class="page-section">
      <div class="card">
       <h2>‚öôÔ∏è Impostazioni Piattaforma</h2>
       <form id="platformConfigForm">
        <div class="form-group"><label for="platformSupabaseUrl">üåê Supabase Project URL</label> <input type="https://gkoqpayaddyzmgfnripx.supabase.co" id="platformSupabaseUrl" required>
        </div>
        <div class="form-group"><label for="platformSupabaseKey">üîë Backend API Key</label> <textarea id="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdrb3FwYXlhZGR5em1nZm5yaXB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNTU4NzUsImV4cCI6MjA3OTgzMTg3NX0.4fYTxWxxxcbMzdP7-Xu2SGfv0TEqFk67G7pJ6K-8ayg" required></textarea>
        </div><button type="submit" class="btn btn-success">üíæ Aggiorna Configurazione</button>
       </form>
       <div id="platformConfigMessage" class="message"></div>
       <div class="message info" style="display: block; margin-top: 20px;"><strong>üìã Guida rapida:</strong><br>
         1. Vai su Supabase Dashboard<br>
         2. Settings ‚Üí API<br>
         3. Copia il "Project URL"<br>
         4. Copia la chiave "backend_api"<br>
         5. Incolla qui e clicca Salva
       </div>
      </div>
     </section>
    </main>
   </div>
  </div><!-- MODALS --> <!-- User Modal -->
  <div id="userModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3>Nuovo Utente</h3><button class="close-modal" onclick="closeModal('userModal')">√ó</button>
    </div>
    <form id="userForm">
     <div class="form-group"><label for="userName">Nome</label> <input type="text" id="userName" required>
     </div>
     <div class="form-group"><label for="userEmail">Email</label> <input type="email" id="userEmail" required>
     </div>
     <div class="form-group"><label for="userPassword">Password</label> <input type="password" id="userPassword" required>
     </div>
     <div class="form-group"><label for="userRole">Ruolo</label> <select id="userRole" required> <option value="admin">Admin</option> <option value="csirt">CSIRT</option> <option value="company">Company</option> </select>
     </div><button type="submit" class="btn btn-success">Crea Utente</button>
    </form>
    <div id="userModalMessage" class="message"></div>
   </div>
  </div><!-- Company Modal -->
  <div id="companyModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3>Nuova Azienda</h3><button class="close-modal" onclick="closeModal('companyModal')">√ó</button>
    </div>
    <form id="companyForm">
     <div class="form-group"><label for="companyName">Nome Azienda</label> <input type="text" id="companyName" required>
     </div>
     <div class="form-group"><label for="companyAddress">Indirizzo</label> <textarea id="companyAddress"></textarea>
     </div><button type="submit" class="btn btn-success">Crea Azienda</button>
    </form>
    <div id="companyModalMessage" class="message"></div>
   </div>
  </div><!-- Incident Modal -->
  <div id="incidentModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3>Nuovo Incidente</h3><button class="close-modal" onclick="closeModal('incidentModal')">√ó</button>
    </div>
    <form id="incidentForm">
     <div class="form-group"><label for="incidentTitle">Titolo</label> <input type="text" id="incidentTitle" required>
     </div>
     <div class="form-group"><label for="incidentDescription">Descrizione</label> <textarea id="incidentDescription" required></textarea>
     </div>
     <div class="form-group"><label for="incidentSeverity">Severit√†</label> <select id="incidentSeverity" required> <option value="low">Bassa</option> <option value="medium">Media</option> <option value="high">Alta</option> <option value="critical">Critica</option> </select>
     </div>
     <div class="form-group"><label for="incidentStatus">Stato</label> <select id="incidentStatus" required> <option value="open">Aperto</option> <option value="investigating">In Analisi</option> <option value="resolved">Risolto</option> <option value="closed">Chiuso</option> </select>
     </div><button type="submit" class="btn btn-success">Crea Incidente</button>
    </form>
    <div id="incidentModalMessage" class="message"></div>
   </div>
  </div>
  <script>
        let supabaseClient = null;
        let currentUser = null;

        // === DEFAULT SUPABASE CONFIGURATION ===
        const DEFAULT_SUPABASE_URL = 'https://kgghufvauufmicueexfm.supabase.co';
        const DEFAULT_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnZ2h1ZnZhdXVmbWljdWVleGZtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNzAzOTc5NSwiZXhwIjoyMDUyNjE1Nzk1fQ.G6h_M53JrYwUxDBKANKAZJM5zcT7F3SxfPFqxF_Ilv8';

        // === CONFIGURATION MANAGEMENT ===
        function loadConfig() {
            let url = localStorage.getItem('supabase_url');
            let key = localStorage.getItem('supabase_key');
            
            // Se non ci sono credenziali salvate, usa quelle di default
            if (!url || !key) {
                url = DEFAULT_SUPABASE_URL;
                key = DEFAULT_SUPABASE_KEY;
                localStorage.setItem('supabase_url', url);
                localStorage.setItem('supabase_key', key);
            }
            
            document.getElementById('platformSupabaseUrl').value = url;
            document.getElementById('platformSupabaseKey').value = key;
            initSupabase(url, key);
            return true;
        }

        function initSupabase(url, key) {
            try {
                supabaseClient = window.supabase.createClient(url, key);
                console.log('‚úÖ Supabase initialized');
                testConnection();
            } catch (error) {
                console.error('‚ùå Init error:', error);
                updateStatus('disconnected', '‚ùå Errore configurazione');
            }
        }

        async function testConnection() {
            if (!supabaseClient) {
                updateStatus('disconnected', '‚ö†Ô∏è Configura Supabase');
                return false;
            }

            updateStatus('pending', 'üîÑ Test connessione...');

            try {
                const { data, error } = await supabaseClient
                    .from('csirtusers')
                    .select('email')
                    .limit(1);

                if (error) {
                    console.error('‚ùå Connection error:', error);
                    updateStatus('disconnected', `‚ùå Errore: ${error.message}`);
                    return false;
                }

                console.log('‚úÖ Connected');
                updateStatus('connected', '‚úÖ Connesso');
                return true;
            } catch (error) {
                console.error('‚ùå Test error:', error);
                updateStatus('disconnected', '‚ùå Impossibile connettersi');
                return false;
            }
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (dot) dot.className = `status-indicator ${status}`;
            if (statusText) statusText.textContent = text;
        }

        // === PLATFORM CONFIG FORM ===
        document.getElementById('platformConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = document.getElementById('platformSupabaseUrl').value.trim();
            const key = document.getElementById('platformSupabaseKey').value.trim();

            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);

            initSupabase(url, key);
            const connected = await testConnection();

            const messageDiv = document.getElementById('platformConfigMessage');
            if (connected) {
                messageDiv.className = 'message success';
                messageDiv.textContent = '‚úÖ Configurazione aggiornata!';
            } else {
                messageDiv.className = 'message error';
                messageDiv.textContent = '‚ùå Verifica le chiavi';
            }
            messageDiv.style.display = 'block';
        });

        // === LOGIN ===
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!supabaseClient) {
                showMessage('loginMessage', 'error', '‚ö†Ô∏è Configura Supabase nelle Impostazioni');
                return;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            loginBtn.disabled = true;
            loginBtn.textContent = 'üîÑ Accesso...';

            try {
                const { data, error } = await supabaseClient
                    .from('csirtusers')
                    .select('*')
                    .eq('email', email)
                    .eq('password', password)
                    .single();

                if (error || !data) {
                    throw new Error('Credenziali non valide');
                }

                currentUser = data;
                console.log('‚úÖ Login successful:', data);
                
                showMessage('loginMessage', 'success', '‚úÖ Accesso riuscito!');
                
                setTimeout(() => {
                    showDashboard();
                }, 1000);

            } catch (error) {
                console.error('‚ùå Login error:', error);
                showMessage('loginMessage', 'error', `‚ùå ${error.message}`);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Accedi';
            }
        });

        // === DASHBOARD ===
        function showDashboard() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
            
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = `Ruolo: ${currentUser.role.toUpperCase()}`;

            loadDashboardData();
        }

        async function loadDashboardData() {
            await Promise.all([
                loadUsers(),
                loadCompanies(),
                loadIncidents()
            ]);
            updateDashboardStats();
            loadCSIRTIncidents();
        }

        function updateDashboardStats() {
            const usersTable = document.getElementById('usersTable').getElementsByTagName('tbody')[0];
            const companiesTable = document.getElementById('companiesTable').getElementsByTagName('tbody')[0];
            const incidentsTable = document.getElementById('incidentsTable').getElementsByTagName('tbody')[0];
            const recentIncidentsTable = document.getElementById('recentIncidentsTable').getElementsByTagName('tbody')[0];

            const usersCount = usersTable.rows.length;
            const companiesCount = companiesTable.rows.length;
            const incidentsCount = incidentsTable.rows.length;
            
            let openIncidentsCount = 0;
            for (let i = 0; i < incidentsTable.rows.length; i++) {
                const statusCell = incidentsTable.rows[i].cells[2];
                if (statusCell && statusCell.textContent.includes('Aperto')) {
                    openIncidentsCount++;
                }
            }

            document.getElementById('statsUsers').textContent = usersCount;
            document.getElementById('statsCompanies').textContent = companiesCount;
            document.getElementById('statsIncidents').textContent = incidentsCount;
            document.getElementById('statsOpenIncidents').textContent = openIncidentsCount;

            // Copy recent incidents
            if (incidentsTable.rows.length > 0) {
                recentIncidentsTable.innerHTML = '';
                for (let i = 0; i < Math.min(5, incidentsTable.rows.length); i++) {
                    const newRow = recentIncidentsTable.insertRow();
                    newRow.innerHTML = incidentsTable.rows[i].innerHTML;
                    // Remove actions column
                    newRow.deleteCell(newRow.cells.length - 1);
                }
            }
        }

        // === NAVIGATION ===
        function navigateTo(page) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            const pageMap = {
                'dashboard': { section: 'dashboardSection', title: 'Dashboard' },
                'csirt': { section: 'csirtSection', title: 'Vista CSIRT' },
                'users': { section: 'usersSection', title: 'Gestione Utenti' },
                'companies': { section: 'companiesSection', title: 'Gestione Aziende' },
                'incidents': { section: 'incidentsSection', title: 'Gestione Incidenti' },
                'network': { section: 'networkSection', title: 'Configurazione Rete' },
                'settingsPlatform': { section: 'settingsPlatformSection', title: 'Impostazioni' }
            };

            const pageInfo = pageMap[page];
            if (pageInfo) {
                document.getElementById(pageInfo.section).classList.add('active');
                document.getElementById('pageTitle').textContent = pageInfo.title;
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginView').style.display = 'flex';
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // === USERS ===
        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('csirtusers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('usersTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #95a5a6;">Nessun utente</td></tr>';
                    return;
                }

                data.forEach(user => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-${user.role}">${user.role.toUpperCase()}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" onclick="deleteUser(${user.id})">Elimina</button>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value,
                role: document.getElementById('userRole').value
            };

            try {
                const { error } = await supabaseClient
                    .from('csirtusers')
                    .insert([userData]);

                if (error) throw error;

                showMessage('userModalMessage', 'success', '‚úÖ Utente creato!');
                document.getElementById('userForm').reset();
                
                setTimeout(() => {
                    closeModal('userModal');
                    loadUsers();
                    updateDashboardStats();
                }, 1500);
            } catch (error) {
                showMessage('userModalMessage', 'error', `‚ùå ${error.message}`);
            }
        });

        async function deleteUser(id) {
            if (!confirm('Eliminare questo utente?')) return;

            try {
                const { error } = await supabaseClient
                    .from('csirtusers')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await loadUsers();
                updateDashboardStats();
            } catch (error) {
                alert(`Errore: ${error.message}`);
            }
        }

        // === COMPANIES ===
        async function loadCompanies() {
            try {
                const { data, error } = await supabaseClient
                    .from('csirtcompanies')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('companiesTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #95a5a6;">Nessuna azienda</td></tr>';
                    return;
                }

                data.forEach(company => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${company.name}</td>
                        <td>${company.address || '-'}</td>
                        <td>${new Date(company.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" onclick="deleteCompany(${company.id})">Elimina</button>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        document.getElementById('companyForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const companyData = {
                name: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value
            };

            try {
                const { error } = await supabaseClient
                    .from('csirtcompanies')
                    .insert([companyData]);

                if (error) throw error;

                showMessage('companyModalMessage', 'success', '‚úÖ Azienda creata!');
                document.getElementById('companyForm').reset();
                
                setTimeout(() => {
                    closeModal('companyModal');
                    loadCompanies();
                    updateDashboardStats();
                }, 1500);
            } catch (error) {
                showMessage('companyModalMessage', 'error', `‚ùå ${error.message}`);
            }
        });

        async function deleteCompany(id) {
            if (!confirm('Eliminare questa azienda?')) return;

            try {
                const { error } = await supabaseClient
                    .from('csirtcompanies')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await loadCompanies();
                updateDashboardStats();
            } catch (error) {
                alert(`Errore: ${error.message}`);
            }
        }

        // === INCIDENTS ===
        async function loadIncidents() {
            try {
                const { data, error } = await supabaseClient
                    .from('csirtincidents')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('incidentsTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #95a5a6;">Nessun incidente</td></tr>';
                    return;
                }

                const severityMap = {
                    'low': 'Bassa',
                    'medium': 'Media',
                    'high': 'Alta',
                    'critical': 'Critica'
                };

                const statusMap = {
                    'open': 'Aperto',
                    'investigating': 'In Analisi',
                    'resolved': 'Risolto',
                    'closed': 'Chiuso'
                };

                data.forEach(incident => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${incident.title}</td>
                        <td><span class="badge badge-${incident.severity}">${severityMap[incident.severity]}</span></td>
                        <td><span class="badge badge-${incident.status}">${statusMap[incident.status]}</span></td>
                        <td>${new Date(incident.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" onclick="deleteIncident(${incident.id})">Elimina</button>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading incidents:', error);
            }
        }

        document.getElementById('incidentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const incidentData = {
                title: document.getElementById('incidentTitle').value,
                description: document.getElementById('incidentDescription').value,
                severity: document.getElementById('incidentSeverity').value,
                status: document.getElementById('incidentStatus').value,
                reported_by: currentUser.id
            };

            try {
                const { error } = await supabaseClient
                    .from('csirtincidents')
                    .insert([incidentData]);

                if (error) throw error;

                showMessage('incidentModalMessage', 'success', '‚úÖ Incidente creato!');
                document.getElementById('incidentForm').reset();
                
                setTimeout(() => {
                    closeModal('incidentModal');
                    loadIncidents();
                    updateDashboardStats();
                    loadCSIRTIncidents();
                }, 1500);
            } catch (error) {
                showMessage('incidentModalMessage', 'error', `‚ùå ${error.message}`);
            }
        });

        async function deleteIncident(id) {
            if (!confirm('Eliminare questo incidente?')) return;

            try {
                const { error } = await supabaseClient
                    .from('csirtincidents')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await loadIncidents();
                updateDashboardStats();
                loadCSIRTIncidents();
            } catch (error) {
                alert(`Errore: ${error.message}`);
            }
        }

        // === NETWORK ===
        document.getElementById('networkForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const networkData = {
                config_data: JSON.parse(document.getElementById('networkConfig').value || '{}')
            };

            showMessage('networkMessage', 'success', '‚úÖ Configurazione salvata!');
            setTimeout(() => {
                document.getElementById('networkMessage').style.display = 'none';
            }, 3000);
        });

        // === MODALS ===
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // === UTILITIES ===
        function showMessage(elementId, type, text) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
        }

        // === CSIRT DESIGNATION ===
        document.getElementById('csirtDesignationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const designationData = {
                org_name: document.getElementById('csirtOrgName').value,
                constituency: document.getElementById('csirtConstituency').value,
                mission: document.getElementById('csirtMission').value,
                services: document.getElementById('csirtServices').value,
                contact_email: document.getElementById('csirtContactEmail').value,
                contact_phone: document.getElementById('csirtContactPhone').value,
                operating_hours: document.getElementById('csirtOperatingHours').value
            };

            // Save to localStorage for demo
            localStorage.setItem('csirt_designation', JSON.stringify(designationData));

            // Display current designation
            document.getElementById('displayOrgName').textContent = designationData.org_name;
            document.getElementById('displayConstituency').textContent = designationData.constituency || '-';
            document.getElementById('displayMission').textContent = designationData.mission || '-';
            document.getElementById('displayServices').textContent = designationData.services || '-';
            document.getElementById('displayEmail').textContent = designationData.contact_email || '-';
            document.getElementById('displayPhone').textContent = designationData.contact_phone || '-';
            document.getElementById('displayHours').textContent = designationData.operating_hours;
            document.getElementById('currentDesignation').style.display = 'block';

            showMessage('csirtDesignationMessage', 'success', '‚úÖ Designazione CSIRT salvata!');
            setTimeout(() => {
                document.getElementById('csirtDesignationMessage').style.display = 'none';
            }, 3000);
        });

        // Load CSIRT designation if exists
        function loadCSIRTDesignation() {
            const saved = localStorage.getItem('csirt_designation');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('csirtOrgName').value = data.org_name || '';
                document.getElementById('csirtConstituency').value = data.constituency || '';
                document.getElementById('csirtMission').value = data.mission || '';
                document.getElementById('csirtServices').value = data.services || '';
                document.getElementById('csirtContactEmail').value = data.contact_email || '';
                document.getElementById('csirtContactPhone').value = data.contact_phone || '';
                document.getElementById('csirtOperatingHours').value = data.operating_hours || '24/7';

                document.getElementById('displayOrgName').textContent = data.org_name;
                document.getElementById('displayConstituency').textContent = data.constituency || '-';
                document.getElementById('displayMission').textContent = data.mission || '-';
                document.getElementById('displayServices').textContent = data.services || '-';
                document.getElementById('displayEmail').textContent = data.contact_email || '-';
                document.getElementById('displayPhone').textContent = data.contact_phone || '-';
                document.getElementById('displayHours').textContent = data.operating_hours;
                document.getElementById('currentDesignation').style.display = 'block';
            }
        }

        // === CSIRT INCIDENTS TABLE ===
        async function loadCSIRTIncidents() {
            await loadIncidents();
            const mainTable = document.getElementById('incidentsTable').getElementsByTagName('tbody')[0];
            const csirtTable = document.getElementById('csirtIncidentsTable').getElementsByTagName('tbody')[0];
            
            csirtTable.innerHTML = '';
            if (mainTable.rows.length === 0 || mainTable.rows[0].cells[0].colSpan > 1) {
                csirtTable.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #95a5a6;">Nessun incidente</td></tr>';
                return;
            }

            for (let i = 0; i < mainTable.rows.length; i++) {
                const row = csirtTable.insertRow();
                row.innerHTML = `
                    <td>#${i + 1}</td>
                    ${mainTable.rows[i].innerHTML}
                `;
            }

            updateCSIRTStats();
        }

        function filterIncidents(filter) {
            const table = document.getElementById('csirtIncidentsTable').getElementsByTagName('tbody')[0];
            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'critical') {
                    const severityCell = row.cells[2];
                    row.style.display = severityCell && severityCell.textContent.includes('Critica') ? '' : 'none';
                } else if (filter === 'investigating') {
                    const statusCell = row.cells[3];
                    row.style.display = statusCell && statusCell.textContent.includes('Analisi') ? '' : 'none';
                } else if (filter === 'resolved') {
                    const statusCell = row.cells[3];
                    row.style.display = statusCell && statusCell.textContent.includes('Risolto') ? '' : 'none';
                }
            }
        }

        function updateCSIRTStats() {
            const usersTable = document.getElementById('usersTable').getElementsByTagName('tbody')[0];
            let csirtMembers = 0;
            for (let i = 0; i < usersTable.rows.length; i++) {
                const roleCell = usersTable.rows[i].cells[2];
                if (roleCell && roleCell.textContent.includes('CSIRT')) {
                    csirtMembers++;
                }
            }
            document.getElementById('csirtTeamMembers').textContent = csirtMembers;

            const incidentsTable = document.getElementById('csirtIncidentsTable').getElementsByTagName('tbody')[0];
            let activeIncidents = 0;
            for (let i = 0; i < incidentsTable.rows.length; i++) {
                const statusCell = incidentsTable.rows[i].cells[3];
                if (statusCell && (statusCell.textContent.includes('Aperto') || statusCell.textContent.includes('Analisi'))) {
                    activeIncidents++;
                }
            }
            document.getElementById('csirtActiveIncidents').textContent = activeIncidents;
            document.getElementById('csirtResolvedThisMonth').textContent = Math.floor(Math.random() * 20) + 5;
            document.getElementById('csirtResponseTime').textContent = (Math.random() * 3 + 1).toFixed(1) + 'h';
        }

        // === CSIRT TAB SWITCHING ===
        function switchCSIRTTab(tabName) {
            // Remove active from all main CSIRT tabs
            const mainTabs = document.querySelectorAll('.card > .tabs .tab');
            mainTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Hide all CSIRT tab contents
            document.getElementById('designationTab').classList.remove('active');
            document.getElementById('incidentsTabCSIRT').classList.remove('active');
            document.getElementById('networkTabCSIRT').classList.remove('active');

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // === NETWORK TAB SWITCHING ===
        function switchNetworkTab(tabName) {
            // Find only network sub-tabs
            const networkTabs = document.querySelectorAll('#networkTabCSIRT .tabs .tab');
            networkTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(tabName.toLowerCase().substring(0, 4))) {
                    tab.classList.add('active');
                }
            });

            document.getElementById('topologyTab').classList.remove('active');
            document.getElementById('securityTab').classList.remove('active');
            document.getElementById('monitoringTab').classList.remove('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // === NETWORK FORMS ===
        document.getElementById('networkTopologyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('networkName').value,
                type: document.getElementById('networkType').value,
                ip_range: document.getElementById('ipRange').value,
                subnet_mask: document.getElementById('subnetMask').value,
                gateway: document.getElementById('gateway').value,
                dns_servers: document.getElementById('dnsServers').value
            };
            localStorage.setItem('network_topology', JSON.stringify(data));
            showMessage('topologyMessage', 'success', '‚úÖ Topologia di rete salvata!');
            setTimeout(() => document.getElementById('topologyMessage').style.display = 'none', 3000);
        });

        document.getElementById('networkSecurityForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                firewall_status: document.getElementById('firewallStatus').value,
                firewall_rules: document.getElementById('firewallRules').value,
                ids_status: document.getElementById('idsStatus').value,
                vpn_enabled: document.getElementById('vpnEnabled').value,
                encryption_level: document.getElementById('encryptionLevel').value
            };
            localStorage.setItem('network_security', JSON.stringify(data));
            showMessage('securityMessage', 'success', '‚úÖ Configurazione sicurezza salvata!');
            setTimeout(() => document.getElementById('securityMessage').style.display = 'none', 3000);
        });

        document.getElementById('networkMonitoringForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                monitoring_tool: document.getElementById('monitoringTool').value,
                alert_email: document.getElementById('alertEmail').value,
                snmp_enabled: document.getElementById('snmpEnabled').value,
                log_retention: document.getElementById('logRetention').value,
                backup_frequency: document.getElementById('backupFrequency').value
            };
            localStorage.setItem('network_monitoring', JSON.stringify(data));
            showMessage('monitoringMessage', 'success', '‚úÖ Configurazione monitoraggio salvata!');
            setTimeout(() => document.getElementById('monitoringMessage').style.display = 'none', 3000);
        });

        // === INIT ===
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadCSIRTDesignation();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ab5be4135600e73',t:'MTc2NTI5NjMxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
