<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piattaforma CSIRT - Gestione Sicurezza Aziendale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    .hidden { display: none; }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .status-aperto { background-color: #fee2e2; color: #991b1b; }
    .status-in-corso { background-color: #fef3c7; color: #92400e; }
    .status-risolto { background-color: #d1fae5; color: #065f46; }
    .severity-critical { background-color: #fecaca; color: #991b1b; }
    .severity-high { background-color: #fed7aa; color: #9a3412; }
    .severity-medium { background-color: #fef08a; color: #854d0e; }
    .severity-low { background-color: #bfdbfe; color: #1e40af; }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50"><!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
      <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
     </div>
     <h1 class="text-3xl font-bold text-gray-800">Piattaforma CSIRT</h1>
     <p class="text-gray-600 mt-2">Gestione Sicurezza e Compliance NIS2</p>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-6">
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="login-email" placeholder="inserisci@email.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Profilo</label> <select id="login-role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> <option value="">Seleziona il tuo ruolo</option> <option value="admin">ğŸ‘¤ Amministratore</option> <option value="csirt">ğŸ›¡ï¸ Consulente/Referente CSIRT</option> <option value="azienda">ğŸ¢ Referente Aziendale</option> </select>
     </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"> Accedi alla Piattaforma </button>
    </form>
    <div class="mt-6 pt-6 border-t border-gray-200">
     <p class="text-center text-sm text-gray-600">Demo - Credenziali di test:</p>
     <div class="mt-2 space-y-1 text-xs text-gray-500">
      <p>ğŸ‘¤ Admin: admin@csirt.it / admin123</p>
      <p>ğŸ›¡ï¸ CSIRT: csirt@hub.it / csirt123</p>
      <p>ğŸ¢ Azienda: azienda@test.it / azienda123</p>
     </div>
    </div>
   </div>
  </div><!-- Add/Edit Device Modal -->
  <div id="device-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-xl">
     <div class="flex items-center justify-between">
      <h3 id="modal-title" class="text-2xl font-bold">â• Aggiungi Nuovo Dispositivo</h3><button onclick="closeDeviceModal()" class="text-white hover:bg-white/20 rounded-lg p-2">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
    </div>
    <form id="device-form" onsubmit="saveDevice(event)" class="p-6 space-y-4"><input type="hidden" id="device-id">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo Dispositivo *</label> <select id="device-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required> <option value="">Seleziona tipo</option> <option value="switch">ğŸ”€ Switch</option> <option value="router">ğŸŒ Router</option> <option value="firewall">ğŸ”¥ Firewall</option> <option value="ap">ğŸ“¡ Access Point</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome Dispositivo *</label> <input type="text" id="device-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Core Switch" required>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Vendor/Marca *</label> <input type="text" id="device-vendor" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Cisco, Fortinet" required>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Modello *</label> <input type="text" id="device-model" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Catalyst 9300" required>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo IP *</label> <input type="text" id="device-ip" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 192.168.1.1" required>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo MAC</label> <input type="text" id="device-mac" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 00:1A:2B:3C:4D:5E">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Versione Firmware</label> <input type="text" id="device-firmware" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 17.9.3">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Stato *</label> <select id="device-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required> <option value="online">ğŸŸ¢ Online</option> <option value="offline">ï¿½ï¿½ï¿½ï¿½ Offline</option> <option value="maintenance">ğŸŸ¡ Manutenzione</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Porte (per Switch/Router)</label> <input type="number" id="device-ports" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 48" min="0">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">LocalitÃ /Rack</label> <input type="text" id="device-location" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Server Room - Rack A3">
      </div>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Note</label> <textarea id="device-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Informazioni aggiuntive..."></textarea>
     </div>
     <div class="flex space-x-3 pt-4"><button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg"> ğŸ’¾ Salva Dispositivo </button> <button type="button" onclick="closeDeviceModal()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> Annulla </button>
     </div>
    </form>
   </div>
  </div><!-- Main App (Hidden until login) -->
  <div id="main-app" class="hidden"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
       <svg class="w-10 h-10" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
       </svg>
       <div>
        <h1 class="text-2xl font-bold">Piattaforma CSIRT</h1>
        <p class="text-blue-100 text-sm">Sistema di Gestione Sicurezza e Compliance NIS2</p>
       </div>
      </div>
      <div class="flex items-center space-x-4">
       <div class="text-right">
        <p class="text-sm font-medium" id="user-name">Admin User</p>
        <p class="text-xs text-blue-100" id="user-role">Amministratore</p>
       </div><button onclick="logout()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg><span>Esci</span> </button>
      </div>
     </div>
    </div>
   </header>
   <div class="flex" style="height: calc(100% - 80px);"><!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg overflow-y-auto">
     <nav class="p-4 space-y-2" id="sidebar-nav"><button onclick="showSection('dashboard')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
       </svg><span>Dashboard</span> </button> <button onclick="showSection('companies')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg><span>Aziende</span> </button> <button onclick="showSection('incidents')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg><span>Incidenti</span> </button> <button onclick="showSection('notifications')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
       </svg><span>Notifiche ACN</span> </button>
     </nav>
    </aside><!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8" style="height: 100%;"><!-- Dashboard Section -->
     <section id="dashboard-section" class="section-content">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Generale</h2><!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Aziende Monitorate</p>
          <p id="total-companies" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-blue-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Incidenti Aperti</p>
          <p id="open-incidents" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-red-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Notifiche Pending</p>
          <p id="pending-notifications" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-yellow-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Compliance Score</p>
          <p id="compliance-score" class="text-3xl font-bold text-gray-800 mt-2">0%</p>
         </div>
         <div class="bg-green-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
        </div>
       </div>
      </div><!-- Recent Activity -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4">AttivitÃ  Recenti</h3>
       <div id="recent-activity" class="space-y-3">
        <p class="text-gray-500 text-center py-8">Nessuna attivitÃ  recente</p>
       </div>
      </div><!-- CSIRT Dashboard Cards -->
      <div id="csirt-dashboard-cards" class="hidden">
       <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div onclick="showSection('incidents')" class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl shadow-md p-6 border-l-4 border-red-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-red-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸš¨ Registro Incidenti</h3>
         <p class="text-gray-600 text-sm">Gestisci e registra incidenti di sicurezza conformi NIS2</p>
         <div class="mt-4 text-sm font-medium text-red-700">
          Clicca per gestire â†’
         </div>
        </div>
        <div onclick="showSection('designation-detail')" class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-md p-6 border-l-4 border-purple-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-purple-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ“‹ Designazione Referente CSIRT</h3>
         <p class="text-gray-600 text-sm">Gestisci i dati del referente CSIRT, sostituti e contatto ACN</p>
         <div class="mt-4 text-sm font-medium text-purple-700">
          Clicca per compilare â†’
         </div>
        </div>
        <div onclick="showSection('network')" class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-md p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-green-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸŒ Configurazione Rete Aziendale</h3>
         <p class="text-gray-600 text-sm">Definisci topologia, sicurezza perimetrale e connettivitÃ </p>
         <div class="mt-4 text-sm font-medium text-green-700">
          Clicca per configurare â†’
         </div>
        </div>
       </div>
      </div>
     </section><!-- Incidents Section -->
     <section id="incidents-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸš¨ Registro Incidenti di Sicurezza</h2>
       <p class="text-gray-600 mb-6">Documenta e traccia tutti gli incidenti secondo i requisiti NIS2</p><!-- Tab Navigation -->
       <div class="bg-white rounded-t-xl shadow-md border-b border-gray-200">
        <div class="flex space-x-1 p-2 overflow-x-auto"><button onclick="switchIncidentTab('new')" class="incident-tab px-6 py-3 rounded-lg font-medium bg-red-100 text-red-700 whitespace-nowrap"> â• Nuovo Incidente </button> <button onclick="switchIncidentTab('identification')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 whitespace-nowrap hidden" id="tab-identification"> ğŸ“‹ Identificazione </button> <button onclick="switchIncidentTab('classification')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 whitespace-nowrap hidden" id="tab-classification"> ğŸ·ï¸ Classificazione </button> <button onclick="switchIncidentTab('response')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 whitespace-nowrap hidden" id="tab-response"> ğŸ› ï¸ Risposta </button> <button onclick="switchIncidentTab('notifications')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 whitespace-nowrap hidden" id="tab-notifications"> ğŸ“® Notifiche NIS2 </button> <button onclick="switchIncidentTab('review')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 whitespace-nowrap hidden" id="tab-review"> ğŸ“ Post-Incident Review </button> <button onclick="switchIncidentTab('list')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 whitespace-nowrap"> ğŸ“‹ Lista Incidenti </button> <button onclick="switchIncidentTab('stats')" class="incident-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100 whitespace-nowrap"> ğŸ“Š Statistiche </button>
        </div>
       </div><!-- Tab Content -->
       <div class="bg-white rounded-b-xl shadow-md p-8"><!-- New Incident Tab - Initial Creation -->
        <div id="incident-new-tab" class="incident-tab-content">
         <h3 class="text-xl font-bold text-gray-800 mb-4">â• Registra Nuovo Incidente</h3>
         <form id="new-incident-form" onsubmit="createIncidentDraft(event)" class="space-y-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Titolo Incidente *</label> <input id="incident-title" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Attacco ransomware rilevato su server produzione" required>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Descrizione Breve *</label> <textarea id="incident-brief-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Riassunto conciso dell'accaduto e dei sistemi coinvolti..." required></textarea>
          </div><button type="submit" class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg"> â¡ï¸ Continua con Identificazione </button>
         </form>
        </div><!-- Identification Tab -->
        <div id="incident-identification-tab" class="incident-tab-content hidden">
         <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ Identificazione Incidente</h3><span id="incident-id-display" class="text-sm font-mono bg-gray-100 px-3 py-1 rounded"></span>
         </div>
         <form id="identification-form" onsubmit="saveIdentification(event)" class="space-y-4"><!-- Date e Ora Section -->
          <div class="p-4 bg-blue-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ“… Data e Ora</h4>
           <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data/Ora Scoperta (Detection) *</label> <input id="incident-detection-date" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data/Ora Inizio (Start)</label> <input id="incident-start-date" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
             <p class="text-xs text-gray-500 mt-1">Se nota</p>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data/Ora Notifica</label> <input id="incident-notification-date" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
             <p class="text-xs text-gray-500 mt-1">Se significativa</p>
            </div>
           </div>
          </div><!-- Segnalatore Section -->
          <div class="p-4 bg-purple-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ‘¤ Segnalatore</h4>
           <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label> <input id="incident-reporter-name" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Mario Rossi" required>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo *</label> <input id="incident-reporter-role" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. SOC Analyst" required>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Contatto *</label> <input id="incident-reporter-contact" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. mario.rossi@azienda.it" required>
            </div>
           </div>
          </div><!-- Asset Coinvolti Section -->
          <div class="p-4 bg-orange-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ–¥ï¸ Asset Coinvolti</h4>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Sistemi, Reti, Servizi o Dati Interessati *</label> <textarea id="incident-affected-assets" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Server-Prod-01, Database-ClientiDB, Applicazione-CRM, Rete-VLAN-10" required></textarea>
            <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Elenca tutti gli asset coinvolti (server X, applicazione Y, database Z)</p>
           </div>
          </div>
          <div class="flex space-x-3"><button type="submit" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg"> â¡ï¸ Continua con Classificazione </button> <button type="button" onclick="saveDraftAndExit()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> ğŸ’¾ Salva Bozza </button>
          </div>
         </form>
        </div><!-- Classification Tab -->
        <div id="incident-classification-tab" class="incident-tab-content hidden">
         <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">ğŸ·ï¸ Classificazione e Valutazione</h3><span id="incident-id-display-class" class="text-sm font-mono bg-gray-100 px-3 py-1 rounded"></span>
         </div>
         <form id="classification-form" onsubmit="saveClassification(event)" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Categoria *</label> <select id="incident-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required> <option value="">Seleziona categoria</option> <option value="malware">ğŸ¦  Malware</option> <option value="dos">ğŸ’¥ Attacco DoS/DDoS</option> <option value="intrusion">ğŸ”“ Intrusione/Accesso Non Autorizzato</option> <option value="phishing">ğŸ£ Phishing/Social Engineering</option> <option value="data-breach">ğŸ“‚ Data Breach</option> <option value="human-error">ğŸ‘¤ Errore Umano</option> <option value="technical-failure">âš™ï¸ Guasto Tecnico</option> <option value="other">ğŸ“‹ Altro</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">GravitÃ  *</label> <select id="incident-severity" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required> <option value="">Seleziona gravitÃ </option> <option value="critico">ğŸ”´ Critico</option> <option value="alto">ğŸŸ  Alto</option> <option value="medio">ğŸŸ¡ Medio</option> <option value="basso">ğŸ”µ Basso</option> </select>
           </div>
          </div><!-- Impatto Operativo -->
          <div class="p-4 bg-red-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">â±ï¸ Impatto Operativo/Servizio (Art. 25 NIS2)</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Durata Interruzione/Degrado</label> <input id="incident-service-duration" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 3 ore">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Servizi Impattati</label> <input id="incident-impacted-services" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Sistema di pagamento, CRM">
            </div>
           </div>
          </div><!-- Impatto Finanziario -->
          <div class="p-4 bg-yellow-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ’° Impatto Finanziario</h4>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Perdite Stimate</label> <input id="incident-financial-impact" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. â‚¬50.000 stimati">
           </div>
          </div><!-- Impatto su Terzi -->
          <div class="p-4 bg-blue-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ‘¥ Impatto su Terzi</h4>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Utenti/EntitÃ  Colpite</label> <input id="incident-third-party-impact" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 5.000 utenti">
           </div>
          </div><!-- NIS2 e GDPR Flags -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div class="p-4 bg-purple-50 rounded-lg"><label class="flex items-start space-x-3"> <input id="incident-nis2-significant" type="checkbox" class="mt-1 w-5 h-5">
             <div><span class="block text-sm font-medium text-gray-700">SignificativitÃ  NIS2</span>
              <p class="text-xs text-gray-500 mt-1">Grave perturbazione operativa (Art. 23)</p>
             </div></label> <textarea id="incident-nis2-justification" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mt-2 hidden" placeholder="Giustificazione criterio di notifica..."></textarea>
           </div>
           <div class="p-4 bg-green-50 rounded-lg"><label class="flex items-start space-x-3"> <input id="incident-gdpr-personal-data" type="checkbox" class="mt-1 w-5 h-5">
             <div><span class="block text-sm font-medium text-gray-700">Dati Personali Coinvolti</span>
              <p class="text-xs text-gray-500 mt-1">Attivare procedura GDPR Data Breach (Art. 33)</p>
             </div></label>
           </div>
           <div class="p-4 bg-orange-50 rounded-lg"><label class="flex items-start space-x-3"> <input id="incident-cross-border" type="checkbox" class="mt-1 w-5 h-5">
             <div><span class="block text-sm font-medium text-gray-700">Impatto Transfrontaliero</span>
              <p class="text-xs text-gray-500 mt-1">Coinvolge altri Stati UE</p>
             </div></label>
           </div>
          </div>
          <div class="flex space-x-3"><button type="button" onclick="goToTab('identification')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> â¬…ï¸ Indietro </button> <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg"> â¡ï¸ Continua con Risposta </button> <button type="button" onclick="saveDraftAndExit()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> ğŸ’¾ Salva Bozza </button>
          </div>
         </form>
        </div><!-- Notifications Tab -->
        <div id="incident-notifications-tab" class="incident-tab-content hidden">
         <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">ğŸ“® Notifiche ACN/CSIRT Italia</h3><span id="incident-id-display-notif" class="text-sm font-mono bg-gray-100 px-3 py-1 rounded"></span>
         </div>
         <form id="notifications-form" onsubmit="saveNotifications(event)" class="space-y-4"><!-- Pre-Notifica 24h -->
          <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
           <h4 class="font-semibold text-gray-800 mb-3">â° Pre-Notifica (Entro 24 ore)</h4>
           <p class="text-xs text-gray-600 mb-3">Notifica iniziale all'ACN/CSIRT Italia per incidenti significativi</p>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data e Ora Invio</label> <input id="notif-prenotifica-date" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Stato</label> <select id="notif-prenotifica-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="non-inviata">Non Inviata</option> <option value="inviata">âœ… Inviata</option> </select>
            </div>
           </div>
          </div><!-- Notifica Dettagliata 72h -->
          <div class="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ“‹ Notifica Dettagliata (Entro 72 ore)</h4>
           <p class="text-xs text-gray-600 mb-3">Valutazione iniziale dell'incidente con dettagli tecnici</p>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data e Ora Invio</label> <input id="notif-dettagliata-date" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Stato</label> <select id="notif-dettagliata-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="non-inviata">Non Inviata</option> <option value="inviata">ï¿½ï¿½ Inviata</option> </select>
            </div>
           </div>
          </div><!-- Rapporto Finale 1 Mese -->
          <div class="p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ“„ Rapporto Finale (Entro 1 Mese)</h4>
           <p class="text-xs text-gray-600 mb-3">Rapporto conclusivo con analisi completa e misure adottate</p>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data e Ora Invio</label> <input id="notif-finale-date" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Stato</label> <select id="notif-finale-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="non-inviata">Non Inviata</option> <option value="inviata">âœ… Inviata</option> </select>
            </div>
           </div>
          </div><!-- Indicazioni ACN -->
          <div class="p-4 bg-blue-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ›ï¸ Indicazioni/Richieste ACN/CSIRT Italia</h4><textarea id="notif-acn-feedback" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Eventuali indicazioni, richieste o feedback ricevuti dall'AutoritÃ  Nazionale per la Cybersicurezza..."></textarea>
          </div>
          <div class="flex space-x-3"><button type="button" onclick="goToTab('response')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> â¬…ï¸ Indietro </button> <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg"> â¡ï¸ Continua con Review </button> <button type="button" onclick="saveDraftAndExit()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> ğŸ’¾ Salva Bozza </button>
          </div>
         </form>
        </div><!-- Review Tab -->
        <div id="incident-review-tab" class="incident-tab-content hidden">
         <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">ğŸ“ Post-Incident Review</h3><span id="incident-id-display-review" class="text-sm font-mono bg-gray-100 px-3 py-1 rounded"></span>
         </div>
         <form id="review-form" onsubmit="saveReview(event)" class="space-y-4"><!-- Causa Radice -->
          <div class="p-4 bg-red-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ” Causa Radice (Root Cause)</h4><textarea id="review-root-cause" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Analisi approfondita del perchÃ© l'incidente Ã¨ avvenuto. Identificare la causa tecnica o organizzativa principale..."></textarea>
          </div><!-- Lezioni Apprese -->
          <div class="p-4 bg-yellow-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ’¡ Lezioni Apprese (Lessons Learned)</h4><textarea id="review-lessons-learned" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Quali processi o controlli hanno fallito? Cosa ha funzionato bene? Insight per migliorare la risposta futura..."></textarea>
          </div><!-- Azioni Correttive -->
          <div class="p-4 bg-green-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">âœ… Azioni Correttive</h4><textarea id="review-corrective-actions" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Misure concrete da implementare per prevenire incidenti simili:

- Formazione: Sessioni di awareness per il personale
- Aggiornamento sistemi: Patch management migliorato
- Nuove Policy: Procedura revisione accessi trimestrale
- Tecnologia: Implementazione SIEM/XDR"></textarea>
          </div><!-- Responsabile Azioni -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ Responsabile Azioni Correttive</label> <input id="review-responsible" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Responsabile IT, CISO, Team Security">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… Data Chiusura Definitiva</label> <input id="review-closure-date" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
          </div>
          <div class="flex space-x-3"><button type="button" onclick="goToTab('notifications')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> â¬…ï¸ Indietro </button> <button type="submit" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"> âœ… Chiudi Incidente Completo </button>
          </div>
         </form>
        </div><!-- Response Tab -->
        <div id="incident-response-tab" class="incident-tab-content hidden">
         <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">ğŸ› ï¸ Risposta e Gestione</h3><span id="incident-id-display-resp" class="text-sm font-mono bg-gray-100 px-3 py-1 rounded"></span>
         </div>
         <form id="response-form" onsubmit="saveResponse(event)" class="space-y-4"><!-- Misure di Contenimento -->
          <div class="p-4 bg-yellow-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸš§ Misure di Contenimento</h4><textarea id="incident-containment" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Azioni immediate per limitare i danni (es. isolamento della rete, blocco account compromessi, disattivazione servizi...)"></textarea>
          </div><!-- Misure di Eradicazione -->
          <div class="p-4 bg-orange-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ”¥ Misure di Eradicazione</h4><textarea id="incident-eradication" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Azioni per eliminare la causa (es. rimozione malware, patch vulnerabilitÃ , cambio credenziali...)"></textarea>
          </div><!-- Misure di Ripristino -->
          <div class="p-4 bg-green-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">â™»ï¸ Misure di Ripristino</h4><textarea id="incident-recovery" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Azioni per tornare alla normalitÃ  (Restore backup, riattivazione servizi, verifica integritÃ ...)"></textarea>
          </div><!-- Timeline delle Azioni -->
          <div class="p-4 bg-blue-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-3">ğŸ“… Timeline delle Azioni</h4><textarea id="incident-timeline" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Cronologia dettagliata delle misure adottate con data, ora e responsabile:

[12/12/2024 14:30] Mario Rossi - Isolamento server compromesso
[12/12/2024 15:00] Anna Bianchi - Avvio scansione antimalware
[12/12/2024 16:45] Luigi Verdi - Ripristino da backup"></textarea>
          </div><!-- Stato Attuale -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Stato Attuale *</label> <select id="incident-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required> <option value="in-corso">ğŸ”´ In Corso</option> <option value="contenuto">ğŸŸ¡ Contenuto</option> <option value="risolto">ğŸŸ¢ Risolto</option> <option value="chiuso">âœ… Chiuso</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Chiusura</label> <input id="incident-closure-date" type="datetime-local" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
          </div><!-- Note Finali -->
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Note Finali</label> <textarea id="incident-final-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Osservazioni conclusive, lesson learned, raccomandazioni..."></textarea>
          </div>
          <div class="flex space-x-3"><button type="button" onclick="goToTab('classification')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> â¬…ï¸ Indietro </button> <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg"> â¡ï¸ Continua con Notifiche </button> <button type="button" onclick="saveDraftAndExit()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg"> ğŸ’¾ Salva Bozza </button>
          </div>
         </form>
        </div><!-- List Tab -->
        <div id="incident-list-tab" class="incident-tab-content hidden">
         <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ Tutti gli Incidenti</h3>
          <div class="flex space-x-2"><button onclick="exportIncidentsToExcel()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg><span>ğŸ“Š Esporta Excel</span> </button> <button onclick="exportIncidentsToPDF()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg><span>ğŸ“„ Esporta PDF</span> </button>
          </div>
         </div>
         <div id="incidents-list-container" class="space-y-3">
          <p class="text-gray-500 text-center py-8">Nessun incidente registrato</p>
         </div>
        </div><!-- Stats Tab -->
        <div id="incident-stats-tab" class="incident-tab-content hidden">
         <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ“Š Statistiche Incidenti</h3>
         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><!-- Grafico Stati Incidenti -->
          <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
           <h4 class="text-lg font-bold text-gray-800 mb-4">Stati degli Incidenti</h4>
           <div class="flex flex-col items-center">
            <canvas id="status-chart" width="300" height="300"></canvas>
            <div id="status-legend" class="mt-4 grid grid-cols-2 gap-3 w-full"></div>
           </div>
          </div><!-- Grafico GravitÃ  Incidenti -->
          <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
           <h4 class="text-lg font-bold text-gray-800 mb-4">GravitÃ  degli Incidenti</h4>
           <div class="flex flex-col items-center">
            <canvas id="severity-chart" width="300" height="300"></canvas>
            <div id="severity-legend" class="mt-4 grid grid-cols-2 gap-3 w-full"></div>
           </div>
          </div><!-- Grafico Categorie -->
          <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
           <h4 class="text-lg font-bold text-gray-800 mb-4">Categorie degli Incidenti</h4>
           <div class="flex flex-col items-center">
            <canvas id="category-chart" width="300" height="300"></canvas>
            <div id="category-legend" class="mt-4 grid grid-cols-2 gap-3 w-full"></div>
           </div>
          </div><!-- Statistiche Numeriche -->
          <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
           <h4 class="text-lg font-bold text-gray-800 mb-4">Riepilogo Numerico</h4>
           <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
             <div class="flex items-center space-x-3">
              <div class="w-3 h-3 bg-blue-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">Totale Incidenti</span>
             </div><span class="text-xl font-bold text-gray-800" id="stats-total">0</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
             <div class="flex items-center space-x-3">
              <div class="w-3 h-3 bg-red-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">Incidenti Critici</span>
             </div><span class="text-xl font-bold text-red-600" id="stats-critical">0</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
             <div class="flex items-center space-x-3">
              <div class="w-3 h-3 bg-yellow-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">In Gestione</span>
             </div><span class="text-xl font-bold text-yellow-600" id="stats-ongoing">0</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
             <div class="flex items-center space-x-3">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">Risolti/Chiusi</span>
             </div><span class="text-xl font-bold text-green-600" id="stats-resolved">0</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
             <div class="flex items-center space-x-3">
              <div class="w-3 h-3 bg-purple-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">Significativi NIS2</span>
             </div><span class="text-xl font-bold text-purple-600" id="stats-nis2">0</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
             <div class="flex items-center space-x-3">
              <div class="w-3 h-3 bg-blue-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">Con Dati Personali (GDPR)</span>
             </div><span class="text-xl font-bold text-blue-600" id="stats-gdpr">0</span>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </section><!-- Designation Detail Section -->
     <section id="designation-detail-section" class="section-content hidden">
      <div class="max-w-5xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“‹ Designazione Referente CSIRT</h2>
       <p class="text-gray-600 mb-6">Compila i dati del referente CSIRT, sostituti e contatto ACN secondo normativa NIS2</p><!-- Tab Navigation -->
       <div class="bg-white rounded-t-xl shadow-md border-b border-gray-200">
        <div class="flex space-x-1 p-2"><button onclick="switchDesignationTab('referente')" class="designation-tab px-6 py-3 rounded-lg font-medium bg-purple-100 text-purple-700"> ğŸ‘¤ Referente CSIRT </button> <button onclick="switchDesignationTab('acn')" class="designation-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> ğŸ›ï¸ Contatto ACN </button> <button onclick="switchDesignationTab('sostituti')" class="designation-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> ğŸ‘¥ Sostituti </button>
        </div>
       </div><!-- Tab Content -->
       <div class="bg-white rounded-b-xl shadow-md p-8"><!-- Referente CSIRT Tab -->
        <div id="designation-referente-tab" class="designation-tab-content">
         <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¤ Dati Referente CSIRT Principale</h3>
         <form id="referente-form" onsubmit="saveReferente(event)" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome e Cognome</label> <input id="ref-nome" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Mario Rossi" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label> <input id="ref-cf" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. RSSMRA80A01H501Z" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input id="ref-email" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. mario.rossi@azienda.it" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input id="ref-tel" type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 333 1234567" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo Aziendale</label> <input id="ref-ruolo" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Responsabile IT" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Nomina</label> <input id="ref-data" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
           </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Ragione Sociale Azienda</label> <input id="ref-azienda" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. ABC S.p.A." required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">P.IVA Azienda</label> <input id="ref-piva" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 12345678901" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo Sede Legale</label> <input id="ref-indirizzo" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Via Roma 1, Milano" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">PEC Aziendale</label> <input id="ref-pec" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. azienda@pec.it" required>
           </div>
          </div>
          <div class="space-y-3"><button type="submit" class="w-full px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg"> ğŸ’¾ Salva Referente </button>
          </div>
         </form>
        </div><!-- Contatto ACN Tab -->
        <div id="designation-acn-tab" class="designation-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ›ï¸ Dati Contatto ACN</h3>
         <form id="acn-form" onsubmit="saveACN(event)" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome</label> <input id="acn-nome" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Luigi" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label> <input id="acn-cognome" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Verdi" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Email Ufficiale</label> <input id="acn-email" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. luigi.verdi@acn.gov.it" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input id="acn-telefono" type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 06 1234567" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">PEC</label> <input id="acn-pec" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. acn@pec.gov.it" required>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Ufficio di Riferimento</label> <input id="acn-ufficio" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Dipartimento Cyber" required>
           </div>
          </div><button type="submit" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg"> ğŸ’¾ Salva Contatto ACN </button>
         </form>
        </div><!-- Sostituti Tab -->
        <div id="designation-sostituti-tab" class="designation-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-6">ğŸ‘¥ Sostituti del Referente CSIRT</h3>
         <form id="sostituti-form" onsubmit="saveSostituti(event)" class="space-y-6"><!-- Sostituto 1 -->
          <div class="p-6 bg-gray-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">Sostituto 1</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome</label> <input id="sost1-nome" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Anna" required>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label> <input id="sost1-cognome" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Bianchi" required>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input id="sost1-email" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. anna.bianchi@azienda.it" required>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input id="sost1-telefono" type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 333 9876543" required>
            </div>
           </div>
          </div><!-- Sostituto 2 -->
          <div class="p-6 bg-gray-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">Sostituto 2 (Opzionale)</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome</label> <input id="sost2-nome" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Paolo">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label> <input id="sost2-cognome" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Verdi">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input id="sost2-email" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. paolo.verdi@azienda.it">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input id="sost2-telefono" type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. +39 333 5556677">
            </div>
           </div>
          </div><button type="submit" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg"> ğŸ’¾ Salva Sostituti </button>
         </form>
        </div>
       </div>
      </div><!-- DOWNLOAD SECTION - Always Visible Below Tabs -->
      <div class="max-w-5xl mt-8">
       <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white shadow-xl">
        <h3 class="text-2xl font-bold flex items-center space-x-3 mb-4">
         <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg><span>ï¿½ï¿½ Genera Documento CSIRT</span></h3>
        <p class="text-white text-lg mb-6">Prima carica il template Word, poi compila i dati nei 3 tab sopra, infine scarica il documento compilato.</p><!-- Upload Template Section -->
        <div id="upload-section-top" class="mb-6 bg-white/10 backdrop-blur-sm rounded-lg p-4 border-2 border-dashed border-white/30"><label class="block cursor-pointer">
          <div class="flex flex-col items-center space-y-3">
           <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
           </svg>
           <div class="text-center">
            <p class="text-white font-semibold text-lg">ğŸ“„ Carica Template Word (.docx)</p>
            <p class="text-white/80 text-sm mt-1">Clicca per selezionare il file template</p>
           </div>
          </div><input id="template-file-input" type="file" accept=".docx" onchange="handleTemplateUpload(event)" class="hidden"> </label>
        </div><!-- Template Loaded Section -->
        <div id="template-loaded-section-top" class="hidden mb-6 bg-white/10 backdrop-blur-sm rounded-lg p-4 border-2 border-white/50">
         <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
           <svg class="w-10 h-10 text-green-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>
           <div>
            <p class="text-white font-semibold">âœ… Template Caricato</p>
            <p id="template-filename-top" class="text-white/80 text-sm"></p>
           </div>
          </div><button onclick="removeTemplate()" class="px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg font-medium"> ğŸ—‘ï¸ Rimuovi </button>
         </div>
        </div><button type="button" onclick="compileAndDownloadTemplate()" class="w-full px-8 py-4 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold text-lg rounded-lg flex items-center justify-center space-x-3 shadow-xl">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg><span>ğŸ“„ Compila e Scarica Documento Word</span> </button>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
         <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
          <p class="text-sm font-semibold text-gray-700">1ï¸âƒ£ Carica Template</p>
          <p class="text-xs text-gray-500 mt-1">File .docx sulla piattaforma</p>
         </div>
         <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
          <p class="text-sm font-semibold text-gray-700">2ï¸âƒ£ Compila Dati</p>
          <p class="text-xs text-gray-500 mt-1">Nei 3 tab qui sopra</p>
         </div>
         <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
          <p class="text-sm font-semibold text-gray-700">3ï¸âƒ£ Scarica</p>
          <p class="text-xs text-gray-500 mt-1">Documento compilato pronto</p>
         </div>
        </div>
        <p class="text-xs text-gray-600 mt-3 text-center">âœ… Il template rimane sulla piattaforma. Modifica i dati e scarica piÃ¹ volte quando serve!</p>
       </div>
      </div>
     </section><!-- Network Section -->
     <section id="network-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸŒ Configurazione Rete Aziendale</h2>
       <p class="text-gray-600 mb-6">Definisci la topologia, sicurezza perimetrale e connettivitÃ  della rete</p><!-- Tab Navigation -->
       <div class="bg-white rounded-t-xl shadow-md border-b border-gray-200">
        <div class="flex space-x-1 p-2"><button onclick="switchNetworkTab('topology')" class="network-tab px-6 py-3 rounded-lg font-medium bg-green-100 text-green-700"> ğŸŒ Topologia </button> <button onclick="switchNetworkTab('security')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> ğŸ”’ Sicurezza </button> <button onclick="switchNetworkTab('connectivity')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> ï¿½ï¿½ï¿½ ConnettivitÃ  </button> <button onclick="switchNetworkTab('diagram')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> ğŸ“Š Diagramma Rete </button> <button onclick="switchNetworkTab('devices')" class="network-tab px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-100"> ğŸ–¥ï¸ Dispositivi </button>
        </div>
       </div><!-- Tab Content -->
       <div class="bg-white rounded-b-xl shadow-md p-8"><!-- Topology Tab -->
        <div id="network-topology-tab" class="network-tab-content">
         <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸŒ Topologia di Rete</h3>
         <form id="topology-form" onsubmit="saveTopology(event)" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo Topologia</label> <select id="topology-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="stella">â­ Stella</option> <option value="mesh">ğŸ•¸ï¸ Mesh</option> <option value="ibrida">ğŸ”€ Ibrida</option> <option value="gerarchica">ğŸ“Š Gerarchica</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Dimensione Rete</label> <select id="network-size" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="piccola">Piccola (&lt; 50 dispositivi)</option> <option value="media">Media (50-200 dispositivi)</option> <option value="grande">Grande (&gt; 200 dispositivi)</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Subnet</label> <input id="subnet-count" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 5" min="1">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero VLAN</label> <input id="vlan-count" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 3" min="1">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Range IP Principale</label> <input id="ip-range" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 192.168.1.0/24">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Gateway Predefinito</label> <input id="gateway" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 192.168.1.1">
           </div>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Note sulla Topologia</label> <textarea id="topology-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Descrivi l'architettura di rete..."></textarea>
          </div><button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"> ğŸ’¾ Salva Topologia </button>
         </form>
        </div><!-- Security Tab -->
        <div id="network-security-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ”’ Sicurezza Perimetrale</h3>
         <form id="security-form" onsubmit="saveSecurity(event)" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo Firewall</label> <select id="firewall-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="ngfw">ğŸ”¥ NGFW (Next-Gen)</option> <option value="stateful">ğŸ“Š Stateful</option> <option value="utm">ğŸ›¡ï¸ UTM</option> <option value="cloud">â˜ï¸ Cloud-based</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Vendor Firewall</label> <input id="firewall-vendor" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Palo Alto, Fortinet, Cisco">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Versione Firmware</label> <input id="firewall-version" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 10.2.3">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Ultimo Aggiornamento</label> <input id="firewall-update" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg"><input id="has-ids" type="checkbox" class="w-5 h-5"> <label class="text-sm font-medium text-gray-700">IDS/IPS Attivo</label>
           </div>
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg"><input id="has-waf" type="checkbox" class="w-5 h-5"> <label class="text-sm font-medium text-gray-700">WAF (Web Application Firewall)</label>
           </div>
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg"><input id="has-antivirus" type="checkbox" class="w-5 h-5"> <label class="text-sm font-medium text-gray-700">Antivirus Gateway</label>
           </div>
           <div class="flex items-center space-x-3 p-4 bg-gray-50 rounded-lg"><input id="has-ddos" type="checkbox" class="w-5 h-5"> <label class="text-sm font-medium text-gray-700">DDoS Protection</label>
           </div>
          </div><button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"> ğŸ’¾ Salva Sicurezza </button>
         </form>
        </div><!-- Connectivity Tab -->
        <div id="network-connectivity-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“¡ ConnettivitÃ  Internet e WAN</h3>
         <form id="connectivity-form" onsubmit="saveConnectivity(event)" class="space-y-6"><!-- ISP Primario -->
          <div class="p-4 bg-blue-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">ISP Primario</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Provider</label> <input id="isp-primary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. TIM, Vodafone">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Banda Garantita</label> <input id="bandwidth-primary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 1 Gbps">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo Connessione</label> <select id="connection-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="fibra">Fibra Ottica</option> <option value="adsl">ADSL/VDSL</option> <option value="wireless">Wireless</option> <option value="lease">Lease Line</option> </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">IP Pubblico</label> <input id="public-ip" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 203.0.113.1">
            </div>
           </div>
          </div><!-- ISP Backup -->
          <div class="p-4 bg-orange-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">ISP Secondario (Backup)</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Provider</label> <input id="isp-secondary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. Fastweb, WindTre">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Banda Disponibile</label> <input id="bandwidth-secondary" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 500 Mbps">
            </div>
           </div>
          </div><!-- VPN -->
          <div class="p-4 bg-purple-50 rounded-lg">
           <h4 class="font-semibold text-gray-800 mb-4">Configurazione VPN</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex items-center space-x-3"><input id="has-vpn" type="checkbox" class="w-5 h-5"> <label class="text-sm font-medium text-gray-700">VPN Aziendale Configurata</label>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Protocollo VPN</label> <select id="vpn-protocol" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="ipsec">IPSec</option> <option value="openvpn">OpenVPN</option> <option value="wireguard">WireGuard</option> <option value="ssl">SSL VPN</option> </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Utenti VPN</label> <input id="vpn-users" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="es. 50" min="0">
            </div>
           </div>
          </div><button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"> ï¿½ï¿½ï¿½ Salva ConnettivitÃ  </button>
         </form>
        </div><!-- Network Diagram Tab -->
        <div id="network-diagram-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š Diagramma Visuale della Rete</h3>
         <div id="network-diagram-container" class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-8 border-2 border-dashed border-gray-300">
          <div class="text-center text-gray-500 py-12">
           <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg>
           <p class="text-lg font-medium">Configura prima la tua rete</p>
           <p class="text-sm mt-2">Compila i dati nei tab Topologia, Sicurezza e ConnettivitÃ  per generare il diagramma automaticamente</p>
          </div>
         </div>
         <div id="network-legend" class="hidden mt-6 grid grid-cols-1 md:grid-cols-4 gap-4"><!-- Legend will be populated dynamically -->
         </div>
         <div class="mt-4 text-center text-sm text-gray-500">
          ï¿½ï¿½ï¿½ <strong>Tip:</strong> Il diagramma si aggiorna automaticamente quando salvi le configurazioni
         </div>
        </div><!-- Devices Tab -->
        <div id="network-devices-tab" class="network-tab-content hidden">
         <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ–¥ï¸ Inventario Dispositivi di Rete</h3>
         <div class="mb-4 flex justify-between items-center">
          <div class="flex space-x-2"><button onclick="filterDevices('all')" class="device-filter px-4 py-2 rounded-lg bg-green-100 text-green-700 font-medium"> Tutti </button> <button onclick="filterDevices('switch')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Switch </button> <button onclick="filterDevices('router')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Router </button> <button onclick="filterDevices('firewall')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Firewall </button> <button onclick="filterDevices('ap')" class="device-filter px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100"> Access Point </button>
          </div><button onclick="showAddDeviceModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium"> â• Aggiungi Dispositivo </button>
         </div>
         <div id="devices-list" class="space-y-3">
          <p class="text-gray-500 text-center py-8">Nessun dispositivo registrato. Clicca "Aggiungi Dispositivo" per iniziare.</p>
         </div>
         <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-start space-x-3">
           <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>
           <div>
            <h4 class="font-semibold text-blue-900 mb-1">ğŸ’¡ Gestione Inventario</h4>
            <p class="text-sm text-blue-800">Mantieni aggiornato l'inventario di tutti i dispositivi di rete. Include informazioni su marca, modello, versione firmware, indirizzo IP/MAC e stato operativo. Questa documentazione ï¿½ï¿½ fondamentale per la conformitÃ  NIS2.</p>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div>
  </div>
  <script>
    // === GLOBAL STATE ===
    let supabase = null;
    let currentUser = null;
    let currentDeviceFilter = 'all';

    const DEMO_USERS = [
      { email: 'admin@csirt.it', password: 'admin123', role: 'admin', name: 'Admin Sistema', company: null },
      { email: 'csirt@hub.it', password: 'csirt123', role: 'csirt', name: 'Marco Rossi', company: null },
      { email: 'azienda@test.it', password: 'azienda123', role: 'azienda', name: 'Giuseppe Verdi', company: 'Azienda Test SRL' }
    ];

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
      checkExistingSession();
    });

    // === LOGIN FUNCTIONS ===
    function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const role = document.getElementById('login-role').value;
      
      const user = DEMO_USERS.find(u => 
        u.email === email && 
        u.password === password && 
        u.role === role
      );
      
      if (user) {
        currentUser = {
          email: user.email,
          role: user.role,
          name: user.name,
          company: user.company
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showMainApp();
      } else {
        const existingError = document.querySelector('#login-error-message');
        if (existingError) existingError.remove();
        
        const statusDiv = document.createElement('div');
        statusDiv.id = 'login-error-message';
        statusDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm';
        statusDiv.innerHTML = `
          <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div>
              <strong class="font-semibold">âŒ Credenziali non valide</strong>
              <div class="mt-2 text-xs">
                Verifica email, password e ruolo
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('login-form').appendChild(statusDiv);
        setTimeout(() => statusDiv.remove(), 6000);
      }
    }
    
    function checkExistingSession() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
      }
    }
    
    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
      
      document.getElementById('user-name').textContent = currentUser.name;
      
      const roleLabels = {
        'admin': 'Amministratore',
        'csirt': 'Consulente CSIRT',
        'azienda': 'Referente Aziendale'
      };
      document.getElementById('user-role').textContent = roleLabels[currentUser.role];
      
      filterSidebarByRole();
      loadDashboardData();
      loadNetworkData();
      loadDevices();
      loadReferenteData();
      loadACNData();
      loadSostitutiData();
      loadSavedTemplate();
      loadIncidentsList();
      loadIncidentStats();
      
      if (currentUser.role === 'csirt') {
        document.getElementById('csirt-dashboard-cards').classList.remove('hidden');
      }
    }
    
    function filterSidebarByRole() {
      const navItems = document.querySelectorAll('.nav-item[data-role]');
      navItems.forEach(item => {
        const allowedRoles = item.getAttribute('data-role').split(',');
        if (!allowedRoles.includes(currentUser.role)) {
          item.style.display = 'none';
        } else {
          item.style.display = 'flex';
        }
      });
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-form').reset();
    }
    
    // === NAVIGATION ===
    function showSection(sectionName) {
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
      });
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
      });
      
      const section = document.getElementById(sectionName + '-section');
      if (section) {
        section.classList.remove('hidden');
      }
      
      if (event && event.target) {
        event.target.closest('.nav-item').classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
      }
    }
    
    // === TAB SWITCHING ===
    function switchIncidentTab(tabName) {
      document.querySelectorAll('.incident-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.querySelectorAll('.incident-tab').forEach(btn => {
        btn.classList.remove('bg-red-100', 'text-red-700');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });
      
      document.getElementById('incident-' + tabName + '-tab').classList.remove('hidden');
      
      if (event && event.target) {
        event.target.classList.add('bg-red-100', 'text-red-700');
        event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
      }
    }
    
    // Add event listener for NIS2 checkbox to show/hide justification field
    document.addEventListener('DOMContentLoaded', function() {
      const nis2Checkbox = document.getElementById('incident-nis2-significant');
      const nis2Justification = document.getElementById('incident-nis2-justification');
      
      if (nis2Checkbox && nis2Justification) {
        nis2Checkbox.addEventListener('change', function() {
          if (this.checked) {
            nis2Justification.classList.remove('hidden');
          } else {
            nis2Justification.classList.add('hidden');
            nis2Justification.value = '';
          }
        });
      }
    });
    
    function switchDesignationTab(tabName) {
      document.querySelectorAll('.designation-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.querySelectorAll('.designation-tab').forEach(btn => {
        btn.classList.remove('bg-purple-100', 'text-purple-700');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });
      
      document.getElementById('designation-' + tabName + '-tab').classList.remove('hidden');
      
      event.target.classList.add('bg-purple-100', 'text-purple-700');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
    }
    
    function switchNetworkTab(tabName) {
      document.querySelectorAll('.network-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.querySelectorAll('.network-tab').forEach(btn => {
        btn.classList.remove('bg-green-100', 'text-green-700');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });
      
      document.getElementById('network-' + tabName + '-tab').classList.remove('hidden');
      
      event.target.classList.add('bg-green-100', 'text-green-700');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
    }
    
    // === DEVICE MANAGEMENT ===
    function showAddDeviceModal() {
      document.getElementById('device-modal').classList.remove('hidden');
      document.getElementById('modal-title').textContent = 'â• Aggiungi Nuovo Dispositivo';
      document.getElementById('device-form').reset();
      document.getElementById('device-id').value = '';
    }
    
    function closeDeviceModal() {
      document.getElementById('device-modal').classList.add('hidden');
      document.getElementById('device-form').reset();
    }
    
    function saveDevice(event) {
      event.preventDefault();
      
      const deviceId = document.getElementById('device-id').value;
      const deviceData = {
        id: deviceId || Date.now().toString(),
        type: document.getElementById('device-type').value,
        name: document.getElementById('device-name').value,
        vendor: document.getElementById('device-vendor').value,
        model: document.getElementById('device-model').value,
        ip: document.getElementById('device-ip').value,
        mac: document.getElementById('device-mac').value,
        firmware: document.getElementById('device-firmware').value,
        status: document.getElementById('device-status').value,
        ports: document.getElementById('device-ports').value,
        location: document.getElementById('device-location').value,
        notes: document.getElementById('device-notes').value,
        createdAt: deviceId ? undefined : new Date().toISOString()
      };
      
      let devices = JSON.parse(localStorage.getItem('networkDevices') || '[]');
      
      if (deviceId) {
        const index = devices.findIndex(d => d.id === deviceId);
        if (index !== -1) {
          devices[index] = { ...devices[index], ...deviceData };
          showSuccessMessage('âœ… Dispositivo aggiornato con successo!');
        }
      } else {
        devices.push(deviceData);
        showSuccessMessage('âœ… Dispositivo aggiunto con successo!');
      }
      
      localStorage.setItem('networkDevices', JSON.stringify(devices));
      closeDeviceModal();
      loadDevices();
    }
    
    function loadDevices() {
      const devices = JSON.parse(localStorage.getItem('networkDevices') || '[]');
      displayDevices(devices);
    }
    
    function filterDevices(filterType) {
      currentDeviceFilter = filterType;
      
      document.querySelectorAll('.device-filter').forEach(btn => {
        btn.classList.remove('bg-green-100', 'text-green-700', 'font-medium');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });
      
      event.target.classList.add('bg-green-100', 'text-green-700', 'font-medium');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
      
      const devices = JSON.parse(localStorage.getItem('networkDevices') || '[]');
      const filteredDevices = filterType === 'all' ? devices : devices.filter(d => d.type === filterType);
      displayDevices(filteredDevices);
    }
    
    function displayDevices(devices) {
      const container = document.getElementById('devices-list');
      
      if (devices.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun dispositivo trovato per questo filtro.</p>';
        return;
      }
      
      const deviceIcons = {
        'switch': 'ğŸ”€',
        'router': 'ğŸŒ',
        'firewall': 'ğŸ”¥',
        'ap': 'ğŸ“¡'
      };
      
      const deviceColors = {
        'switch': 'blue',
        'router': 'orange',
        'firewall': 'red',
        'ap': 'purple'
      };
      
      const statusColors = {
        'online': 'green',
        'offline': 'red',
        'maintenance': 'yellow'
      };
      
      const statusLabels = {
        'online': 'ğŸŸ¢ Online',
        'offline': 'ğŸ”´ Offline',
        'maintenance': 'ğŸŸ¡ Manutenzione'
      };
      
      container.innerHTML = devices.map(device => {
        const color = deviceColors[device.type] || 'gray';
        const icon = deviceIcons[device.type] || 'ğŸ–¥ï¸';
        const statusColor = statusColors[device.status] || 'gray';
        const statusLabel = statusLabels[device.status] || device.status;
        
        return `
          <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-${color}-500">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4 flex-1">
                <div class="text-3xl">${icon}</div>
                <div class="flex-1">
                  <h4 class="font-bold text-gray-800">${device.name} - ${device.vendor} ${device.model}</h4>
                  <p class="text-sm text-gray-600">IP: ${device.ip}${device.mac ? ' | MAC: ' + device.mac : ''}</p>
                  <div class="flex space-x-2 mt-1 flex-wrap">
                    <span class="text-xs bg-${statusColor}-100 text-${statusColor}-700 px-2 py-1 rounded">${statusLabel}</span>
                    ${device.firmware ? `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">FW: ${device.firmware}</span>` : ''}
                    ${device.ports ? `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${device.ports} Porte</span>` : ''}
                    ${device.location ? `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">ğŸ“ ${device.location}</span>` : ''}
                  </div>
                </div>
              </div>
              <div class="flex space-x-2 ml-4">
                <button onclick="editDevice('${device.id}')" class="p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button onclick="deleteDevice('${device.id}')" class="p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </div>
            ${device.notes ? `<p class="text-sm text-gray-500 mt-2 pl-16">ğŸ“ ${device.notes}</p>` : ''}
          </div>
        `;
      }).join('');
    }
    
    function editDevice(deviceId) {
      const devices = JSON.parse(localStorage.getItem('networkDevices') || '[]');
      const device = devices.find(d => d.id === deviceId);
      
      if (!device) return;
      
      document.getElementById('device-modal').classList.remove('hidden');
      document.getElementById('modal-title').textContent = 'âœï¸ Modifica Dispositivo';
      
      document.getElementById('device-id').value = device.id;
      document.getElementById('device-type').value = device.type;
      document.getElementById('device-name').value = device.name;
      document.getElementById('device-vendor').value = device.vendor;
      document.getElementById('device-model').value = device.model;
      document.getElementById('device-ip').value = device.ip;
      document.getElementById('device-mac').value = device.mac || '';
      document.getElementById('device-firmware').value = device.firmware || '';
      document.getElementById('device-status').value = device.status;
      document.getElementById('device-ports').value = device.ports || '';
      document.getElementById('device-location').value = device.location || '';
      document.getElementById('device-notes').value = device.notes || '';
    }
    
    function deleteDevice(deviceId) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md">
          <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
              <svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-gray-800 mb-2">Conferma Eliminazione</h3>
              <p class="text-gray-600 mb-6">Sei sicuro di voler eliminare questo dispositivo? L'operazione non puÃ² essere annullata.</p>
              <div class="flex space-x-3">
                <button onclick="confirmDeleteDevice('${deviceId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg">
                  Elimina
                </button>
                <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg">
                  Annulla
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);
    }
    
    function confirmDeleteDevice(deviceId) {
      let devices = JSON.parse(localStorage.getItem('networkDevices') || '[]');
      devices = devices.filter(d => d.id !== deviceId);
      localStorage.setItem('networkDevices', JSON.stringify(devices));
      
      document.querySelector('.modal-overlay').remove();
      showSuccessMessage('âœ… Dispositivo eliminato con successo!');
      loadDevices();
    }
    
    // === NETWORK CONFIGURATION MANAGEMENT ===
    function saveTopology(event) {
      event.preventDefault();
      
      const topologyData = {
        type: document.getElementById('topology-type').value,
        size: document.getElementById('network-size').value,
        subnetCount: document.getElementById('subnet-count').value,
        vlanCount: document.getElementById('vlan-count').value,
        ipRange: document.getElementById('ip-range').value,
        gateway: document.getElementById('gateway').value,
        notes: document.getElementById('topology-notes').value
      };
      
      localStorage.setItem('networkTopology', JSON.stringify(topologyData));
      
      showSuccessMessage('âœ… Topologia salvata con successo!');
      generateNetworkDiagram();
    }
    
    function saveSecurity(event) {
      event.preventDefault();
      
      const securityData = {
        firewallType: document.getElementById('firewall-type').value,
        firewallVendor: document.getElementById('firewall-vendor').value,
        firewallVersion: document.getElementById('firewall-version').value,
        lastUpdate: document.getElementById('firewall-update').value,
        hasIDS: document.getElementById('has-ids').checked,
        hasWAF: document.getElementById('has-waf').checked,
        hasAntivirus: document.getElementById('has-antivirus').checked,
        hasDDoS: document.getElementById('has-ddos').checked
      };
      
      localStorage.setItem('networkSecurity', JSON.stringify(securityData));
      
      showSuccessMessage('âœ… Configurazione sicurezza salvata!');
      generateNetworkDiagram();
    }
    
    function saveConnectivity(event) {
      event.preventDefault();
      
      const connectivityData = {
        ispPrimary: document.getElementById('isp-primary').value,
        bandwidthPrimary: document.getElementById('bandwidth-primary').value,
        connectionType: document.getElementById('connection-type').value,
        publicIP: document.getElementById('public-ip').value,
        ispSecondary: document.getElementById('isp-secondary').value,
        bandwidthSecondary: document.getElementById('bandwidth-secondary').value,
        hasVPN: document.getElementById('has-vpn').checked,
        vpnProtocol: document.getElementById('vpn-protocol').value,
        vpnUsers: document.getElementById('vpn-users').value
      };
      
      localStorage.setItem('networkConnectivity', JSON.stringify(connectivityData));
      
      showSuccessMessage('âœ… ConnettivitÃ  salvata con successo!');
      generateNetworkDiagram();
    }
    
    function showSuccessMessage(message) {
      const existingMsg = document.querySelector('.success-toast');
      if (existingMsg) existingMsg.remove();
      
      const toast = document.createElement('div');
      toast.className = 'success-toast fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
    
    function generateNetworkDiagram() {
      const topology = JSON.parse(localStorage.getItem('networkTopology') || '{}');
      const security = JSON.parse(localStorage.getItem('networkSecurity') || '{}');
      const connectivity = JSON.parse(localStorage.getItem('networkConnectivity') || '{}');
      
      if (!topology.type || !topology.vlanCount) {
        return;
      }
      
      const container = document.getElementById('network-diagram-container');
      const vlanCount = parseInt(topology.vlanCount) || 3;
      const hasFirewall = security.firewallType ? true : false;
      const hasBackupISP = connectivity.ispSecondary ? true : false;
      
      const vlanColors = [
        { fill: '#8b5cf6', stroke: '#7c3aed', name: 'Management' },
        { fill: '#f59e0b', stroke: '#d97706', name: 'Production' },
        { fill: '#06b6d4', stroke: '#0891b2', name: 'Guest' },
        { fill: '#ec4899', stroke: '#db2777', name: 'DMZ' },
        { fill: '#10b981', stroke: '#059669', name: 'IoT' }
      ];
      
      const baseIP = topology.ipRange ? topology.ipRange.split('.').slice(0, 3).join('.') : '192.168';
      
      const spacing = 800 / (vlanCount + 1);
      let svgContent = `<svg viewBox="0 0 800 550" class="w-full" style="max-height: 550px;">`;
      
      svgContent += `
        <g transform="translate(400, 30)">
          <ellipse cx="0" cy="0" rx="60" ry="35" fill="#3b82f6" opacity="0.2" stroke="#3b82f6" stroke-width="2"/>
          <text x="0" y="5" text-anchor="middle" font-size="14" fill="#1e40af" font-weight="bold">â˜ï¸ Internet</text>
          <text x="0" y="20" text-anchor="middle" font-size="9" fill="#2563eb">${connectivity.ispPrimary || 'ISP'}</text>
        </g>
      `;
      
      if (hasBackupISP) {
        svgContent += `
          <g transform="translate(580, 30)">
            <ellipse cx="0" cy="0" rx="50" ry="30" fill="#f97316" opacity="0.2" stroke="#f97316" stroke-width="2"/>
            <text x="0" y="5" text-anchor="middle" font-size="11" fill="#c2410c" font-weight="bold">â˜ï¸ Backup</text>
            <text x="0" y="18" text-anchor="middle" font-size="8" fill="#ea580c">${connectivity.ispSecondary}</text>
          </g>
          <line x1="530" y1="50" x2="460" y2="95" stroke="#f97316" stroke-width="2" stroke-dasharray="3,3"/>
        `;
      }
      
      svgContent += `<line x1="400" y1="65" x2="400" y2="95" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5"/>`;
      
      if (hasFirewall) {
        const firewallLabel = security.firewallVendor || 'Firewall';
        svgContent += `
          <g transform="translate(400, 120)">
            <rect x="-45" y="-28" width="90" height="56" rx="5" fill="#ef4444" opacity="0.2" stroke="#dc2626" stroke-width="2"/>
            <text x="0" y="0" text-anchor="middle" font-size="12" fill="#991b1b" font-weight="bold">ğŸ”¥ ${firewallLabel}</text>
            <text x="0" y="15" text-anchor="middle" font-size="8" fill="#b91c1c">${security.firewallType?.toUpperCase() || ''}</text>
          </g>
          <line x1="400" y1="148" x2="400" y2="190" stroke="#64748b" stroke-width="2"/>
        `;
      } else {
        svgContent += `<line x1="400" y1="95" x2="400" y2="190" stroke="#64748b" stroke-width="2"/>`;
      }
      
      svgContent += `
        <g transform="translate(400, 220)">
          <rect x="-55" y="-28" width="110" height="56" rx="5" fill="#10b981" opacity="0.2" stroke="#059669" stroke-width="2"/>
          <text x="0" y="0" text-anchor="middle" font-size="12" fill="#065f46" font-weight="bold">ğŸ”€ Core Switch</text>
          <text x="0" y="15" text-anchor="middle" font-size="8" fill="#047857">${topology.type?.toUpperCase() || ''}</text>
        </g>
      `;
      
      const legendItems = [];
      for (let i = 0; i < vlanCount && i < 5; i++) {
        const x = spacing * (i + 1);
        const color = vlanColors[i];
        const vlanId = (i + 1) * 10;
        const ipSubnet = `${baseIP}.${vlanId}.0/24`;
        
        svgContent += `<line x1="400" y1="248" x2="${x}" y2="330" stroke="#64748b" stroke-width="2"/>`;
        
        svgContent += `
          <g transform="translate(${x}, 365)">
            <rect x="-75" y="-30" width="150" height="60" rx="8" fill="${color.fill}" opacity="0.15" stroke="${color.stroke}" stroke-width="2"/>
            <text x="0" y="-8" text-anchor="middle" font-size="11" fill="${color.stroke}" font-weight="bold">VLAN ${vlanId}</text>
            <text x="0" y="8" text-anchor="middle" font-size="10" fill="${color.stroke}">${color.name}</text>
            <text x="0" y="22" text-anchor="middle" font-size="8" fill="${color.stroke}">${ipSubnet}</text>
          </g>
        `;
        
        const icons = i === 0 ? 'ğŸ–¥ï¸ ğŸ–¥ï¸ ğŸ’»' : i === 1 ? 'ğŸ’» ğŸ’» ğŸ–¨ï¸' : i === 2 ? 'ğŸ“± ğŸ“± ğŸŒ' : i === 3 ? 'ğŸŒ ğŸ”’ ğŸ“¡' : 'ï¿½ï¿½ ğŸ­ ğŸ“Ÿ';
        svgContent += `<text x="${x}" y="445" text-anchor="middle" font-size="18">${icons}</text>`;
        
        legendItems.push({ color: color.fill, name: `VLAN ${color.name}`, subnet: ipSubnet });
      }
      
      if (connectivity.hasVPN) {
        svgContent += `
          <g transform="translate(100, 220)">
            <rect x="-40" y="-20" width="80" height="40" rx="5" fill="#a855f7" opacity="0.2" stroke="#9333ea" stroke-width="2"/>
            <text x="0" y="5" text-anchor="middle" font-size="10" fill="#7e22ce" font-weight="bold">ğŸ” VPN</text>
            <text x="0" y="18" text-anchor="middle" font-size="7" fill="#9333ea">${connectivity.vpnProtocol?.toUpperCase()}</text>
          </g>
          <line x1="140" y1="220" x2="345" y2="220" stroke="#9333ea" stroke-width="2" stroke-dasharray="4,4"/>
        `;
      }
      
      svgContent += `</svg>`;
      
      container.innerHTML = svgContent;
      
      const legend = document.getElementById('network-legend');
      legend.classList.remove('hidden');
      legend.innerHTML = legendItems.map(item => `
        <div class="bg-white p-3 rounded-lg shadow-sm border-l-4" style="border-color: ${item.color}">
          <div class="flex items-center space-x-2 mb-1">
            <div class="w-3 h-3 rounded" style="background-color: ${item.color}"></div>
            <span class="font-semibold text-sm">${item.name}</span>
          </div>
          <p class="text-xs text-gray-600">${item.subnet}</p>
        </div>
      `).join('');
      
      if (security.hasIDS || security.hasWAF) {
        const secFeatures = [];
        if (security.hasIDS) secFeatures.push('IDS/IPS');
        if (security.hasWAF) secFeatures.push('WAF');
        if (security.hasDDoS) secFeatures.push('DDoS Protection');
        
        legend.innerHTML += `
          <div class="bg-red-50 p-3 rounded-lg shadow-sm border-l-4 border-red-500">
            <div class="flex items-center space-x-2 mb-1">
              <span class="font-semibold text-sm">ğŸ›¡ï¸ Protezioni Attive</span>
            </div>
            <p class="text-xs text-gray-600">${secFeatures.join(', ')}</p>
          </div>
        `;
      }
    }
    
    function loadNetworkData() {
      const topology = JSON.parse(localStorage.getItem('networkTopology') || '{}');
      const security = JSON.parse(localStorage.getItem('networkSecurity') || '{}');
      const connectivity = JSON.parse(localStorage.getItem('networkConnectivity') || '{}');
      
      if (topology.type) {
        document.getElementById('topology-type').value = topology.type;
        document.getElementById('network-size').value = topology.size || '';
        document.getElementById('subnet-count').value = topology.subnetCount || '';
        document.getElementById('vlan-count').value = topology.vlanCount || '';
        document.getElementById('ip-range').value = topology.ipRange || '';
        document.getElementById('gateway').value = topology.gateway || '';
        document.getElementById('topology-notes').value = topology.notes || '';
      }
      
      if (security.firewallType) {
        document.getElementById('firewall-type').value = security.firewallType;
        document.getElementById('firewall-vendor').value = security.firewallVendor || '';
        document.getElementById('firewall-version').value = security.firewallVersion || '';
        document.getElementById('firewall-update').value = security.lastUpdate || '';
        document.getElementById('has-ids').checked = security.hasIDS || false;
        document.getElementById('has-waf').checked = security.hasWAF || false;
        document.getElementById('has-antivirus').checked = security.hasAntivirus || false;
        document.getElementById('has-ddos').checked = security.hasDDoS || false;
      }
      
      if (connectivity.ispPrimary) {
        document.getElementById('isp-primary').value = connectivity.ispPrimary;
        document.getElementById('bandwidth-primary').value = connectivity.bandwidthPrimary || '';
        document.getElementById('connection-type').value = connectivity.connectionType || 'fibra';
        document.getElementById('public-ip').value = connectivity.publicIP || '';
        document.getElementById('isp-secondary').value = connectivity.ispSecondary || '';
        document.getElementById('bandwidth-secondary').value = connectivity.bandwidthSecondary || '';
        document.getElementById('has-vpn').checked = connectivity.hasVPN || false;
        document.getElementById('vpn-protocol').value = connectivity.vpnProtocol || 'ipsec';
        document.getElementById('vpn-users').value = connectivity.vpnUsers || '';
      }
      
      generateNetworkDiagram();
    }
    
    // === TEMPLATE MANAGEMENT ===
    let uploadedTemplateFile = null;
    
    function handleTemplateUpload(event) {
      const file = event.target.files[0];
      
      if (!file) return;
      
      if (!file.name.endsWith('.docx')) {
        showErrorMessage('âŒ Formato file non valido. Carica un file .docx');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedTemplateFile = e.target.result;
        localStorage.setItem('uploadedTemplate', uploadedTemplateFile);
        localStorage.setItem('templateFilename', file.name);
        
        document.getElementById('upload-section-top').classList.add('hidden');
        document.getElementById('template-loaded-section-top').classList.remove('hidden');
        document.getElementById('template-filename-top').textContent = `ğŸ“„ ${file.name}`;
        
        showSuccessMessage('âœ… Template caricato con successo!');
      };
      
      reader.readAsArrayBuffer(file);
    }
    
    function removeTemplate() {
      uploadedTemplateFile = null;
      localStorage.removeItem('uploadedTemplate');
      localStorage.removeItem('templateFilename');
      
      document.getElementById('upload-section-top').classList.remove('hidden');
      document.getElementById('template-loaded-section-top').classList.add('hidden');
      document.getElementById('template-file-input').value = '';
      
      showSuccessMessage('âœ… Template rimosso');
    }
    
    function loadSavedTemplate() {
      const savedTemplate = localStorage.getItem('uploadedTemplate');
      const savedFilename = localStorage.getItem('templateFilename');
      
      if (savedTemplate && savedFilename) {
        uploadedTemplateFile = savedTemplate;
        document.getElementById('upload-section-top').classList.add('hidden');
        document.getElementById('template-loaded-section-top').classList.remove('hidden');
        document.getElementById('template-filename-top').textContent = `ğŸ“„ ${savedFilename}`;
      }
    }
    
    async function compileAndDownloadTemplate() {
      if (!uploadedTemplateFile) {
        showErrorMessage('âš ï¸ Carica prima un template Word!');
        return;
      }
      
      const referente = JSON.parse(localStorage.getItem('referenteCSIRT') || '{}');
      const acn = JSON.parse(localStorage.getItem('contattoACN') || '{}');
      const sostituti = JSON.parse(localStorage.getItem('sostitutiCSIRT') || '{}');
      
      if (!referente.nome || !referente.email) {
        showErrorMessage('âš ï¸ Compila prima i dati del referente CSIRT!');
        return;
      }
      
      const dataFormattata = referente.dataNomina ? 
        new Date(referente.dataNomina).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' }) : 
        '';
      
      const dataGenerazione = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      
      const replacements = {
        '{{NOME_REFERENTE}}': referente.nome || '',
        '{{CODICE_FISCALE}}': referente.codiceFiscale || '',
        '{{EMAIL}}': referente.email || '',
        '{{TELEFONO}}': referente.telefono || '',
        '{{RUOLO}}': referente.ruolo || '',
        '{{DATA_NOMINA}}': dataFormattata,
        '{{RAGIONE_SOCIALE}}': referente.azienda || '',
        '{{PARTITA_IVA}}': referente.piva || '',
        '{{SEDE_LEGALE}}': referente.indirizzo || '',
        '{{PEC_AZIENDALE}}': referente.pec || '',
        '{{ACN_NOME}}': acn.nome && acn.cognome ? `${acn.nome} ${acn.cognome}` : '',
        '{{ACN_EMAIL}}': acn.email || '',
        '{{ACN_TELEFONO}}': acn.telefono || '',
        '{{ACN_PEC}}': acn.pec || '',
        '{{ACN_UFFICIO}}': acn.ufficio || '',
        '{{SOSTITUTO1_NOME}}': sostituti.sostituto1Nome && sostituti.sostituto1Cognome ? `${sostituti.sostituto1Nome} ${sostituti.sostituto1Cognome}` : '',
        '{{SOSTITUTO1_EMAIL}}': sostituti.sostituto1Email || '',
        '{{SOSTITUTO1_TELEFONO}}': sostituti.sostituto1Telefono || '',
        '{{SOSTITUTO2_NOME}}': sostituti.sostituto2Nome && sostituti.sostituto2Cognome ? `${sostituti.sostituto2Nome} ${sostituti.sostituto2Cognome}` : '',
        '{{SOSTITUTO2_EMAIL}}': sostituti.sostituto2Email || '',
        '{{SOSTITUTO2_TELEFONO}}': sostituti.sostituto2Telefono || '',
        '{{DATA_GENERAZIONE}}': dataGenerazione
      };
      
      try {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-compile';
        loadingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3';
        loadingDiv.innerHTML = `
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Compilazione del template in corso...</span>
        `;
        document.body.appendChild(loadingDiv);
        
        const zip = await JSZip.loadAsync(uploadedTemplateFile);
        
        let documentXml = await zip.file('word/document.xml').async('string');
        
        Object.keys(replacements).forEach(placeholder => {
          const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
          documentXml = documentXml.replace(regex, replacements[placeholder]);
        });
        
        zip.file('word/document.xml', documentXml);
        
        const compiledBlob = await zip.generateAsync({ type: 'blob' });
        
        const url = URL.createObjectURL(compiledBlob);
        const a = document.createElement('a');
        a.href = url;
        const filename = localStorage.getItem('templateFilename') || 'template.docx';
        a.download = `Compilato_${filename}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        document.getElementById('loading-compile').remove();
        showSuccessMessage('âœ… Documento compilato e scaricato con successo!');
        
      } catch (error) {
        console.error('Errore nella compilazione:', error);
        document.getElementById('loading-compile')?.remove();
        showErrorMessage('âŒ Errore nella compilazione del template. Verifica che il file sia un .docx valido.');
      }
    }
    
    // === REFERENTE CSIRT FUNCTIONS ===
    function saveReferente(event) {
      event.preventDefault();
      
      const referenteData = {
        nome: document.getElementById('ref-nome').value,
        codiceFiscale: document.getElementById('ref-cf').value,
        email: document.getElementById('ref-email').value,
        telefono: document.getElementById('ref-tel').value,
        ruolo: document.getElementById('ref-ruolo').value,
        dataNomina: document.getElementById('ref-data').value,
        azienda: document.getElementById('ref-azienda').value,
        piva: document.getElementById('ref-piva').value,
        indirizzo: document.getElementById('ref-indirizzo').value,
        pec: document.getElementById('ref-pec').value
      };
      
      localStorage.setItem('referenteCSIRT', JSON.stringify(referenteData));
      showSuccessMessage('ï¿½ï¿½ï¿½ï¿½ Dati referente salvati con successo!');
    }
    
    function loadReferenteData() {
      const referente = JSON.parse(localStorage.getItem('referenteCSIRT') || '{}');
      
      if (referente.nome) {
        document.getElementById('ref-nome').value = referente.nome;
        document.getElementById('ref-cf').value = referente.codiceFiscale || '';
        document.getElementById('ref-email').value = referente.email || '';
        document.getElementById('ref-tel').value = referente.telefono || '';
        document.getElementById('ref-ruolo').value = referente.ruolo || '';
        document.getElementById('ref-data').value = referente.dataNomina || '';
        document.getElementById('ref-azienda').value = referente.azienda || '';
        document.getElementById('ref-piva').value = referente.piva || '';
        document.getElementById('ref-indirizzo').value = referente.indirizzo || '';
        document.getElementById('ref-pec').value = referente.pec || '';
      }
    }
    
    function showErrorMessage(message) {
      const existingMsg = document.querySelector('.error-toast');
      if (existingMsg) existingMsg.remove();
      
      const toast = document.createElement('div');
      toast.className = 'error-toast fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 5000);
    }
    
    function saveACN(event) {
      event.preventDefault();
      
      const acnData = {
        nome: document.getElementById('acn-nome').value,
        cognome: document.getElementById('acn-cognome').value,
        email: document.getElementById('acn-email').value,
        telefono: document.getElementById('acn-telefono').value,
        pec: document.getElementById('acn-pec').value,
        ufficio: document.getElementById('acn-ufficio').value
      };
      
      localStorage.setItem('contattoACN', JSON.stringify(acnData));
      showSuccessMessage('âœ… Contatto ACN salvato con successo!');
    }
    
    function loadACNData() {
      const acn = JSON.parse(localStorage.getItem('contattoACN') || '{}');
      
      if (acn.nome) {
        document.getElementById('acn-nome').value = acn.nome;
        document.getElementById('acn-cognome').value = acn.cognome || '';
        document.getElementById('acn-email').value = acn.email || '';
        document.getElementById('acn-telefono').value = acn.telefono || '';
        document.getElementById('acn-pec').value = acn.pec || '';
        document.getElementById('acn-ufficio').value = acn.ufficio || '';
      }
    }
    
    function saveSostituti(event) {
      event.preventDefault();
      
      const sostitutiData = {
        sostituto1Nome: document.getElementById('sost1-nome').value,
        sostituto1Cognome: document.getElementById('sost1-cognome').value,
        sostituto1Email: document.getElementById('sost1-email').value,
        sostituto1Telefono: document.getElementById('sost1-telefono').value,
        sostituto2Nome: document.getElementById('sost2-nome').value,
        sostituto2Cognome: document.getElementById('sost2-cognome').value,
        sostituto2Email: document.getElementById('sost2-email').value,
        sostituto2Telefono: document.getElementById('sost2-telefono').value
      };
      
      localStorage.setItem('sostitutiCSIRT', JSON.stringify(sostitutiData));
      showSuccessMessage('âœ… Sostituti salvati con successo!');
    }
    
    function loadSostitutiData() {
      const sostituti = JSON.parse(localStorage.getItem('sostitutiCSIRT') || '{}');
      
      if (sostituti.sostituto1Nome) {
        document.getElementById('sost1-nome').value = sostituti.sostituto1Nome;
        document.getElementById('sost1-cognome').value = sostituti.sostituto1Cognome || '';
        document.getElementById('sost1-email').value = sostituti.sostituto1Email || '';
        document.getElementById('sost1-telefono').value = sostituti.sostituto1Telefono || '';
      }
      
      if (sostituti.sostituto2Nome) {
        document.getElementById('sost2-nome').value = sostituti.sostituto2Nome;
        document.getElementById('sost2-cognome').value = sostituti.sostituto2Cognome || '';
        document.getElementById('sost2-email').value = sostituti.sostituto2Email || '';
        document.getElementById('sost2-telefono').value = sostituti.sostituto2Telefono || '';
      }
    }
    
    // === INCIDENT MANAGEMENT ===
    let currentIncidentDraft = null;
    
    function createIncidentDraft(event) {
      event.preventDefault();
      
      const incidentId = 'INC-' + Date.now();
      
      currentIncidentDraft = {
        id: incidentId,
        title: document.getElementById('incident-title').value,
        briefDescription: document.getElementById('incident-brief-description').value,
        company: currentUser.company || 'Sistema',
        createdAt: new Date().toISOString(),
        status: 'in-corso'
      };
      
      document.getElementById('incident-id-display').textContent = incidentId;
      document.getElementById('incident-id-display-class').textContent = incidentId;
      document.getElementById('incident-id-display-resp').textContent = incidentId;
      
      document.getElementById('tab-identification').classList.remove('hidden');
      document.getElementById('tab-classification').classList.remove('hidden');
      document.getElementById('tab-response').classList.remove('hidden');
      
      switchIncidentTab('identification');
      showSuccessMessage('âœ… Incidente creato! Procedi con identificazione');
    }
    
    function saveIdentification(event) {
      event.preventDefault();
      
      currentIncidentDraft.detectionDate = document.getElementById('incident-detection-date').value;
      currentIncidentDraft.startDate = document.getElementById('incident-start-date').value;
      currentIncidentDraft.notificationDate = document.getElementById('incident-notification-date').value;
      currentIncidentDraft.reporterName = document.getElementById('incident-reporter-name').value;
      currentIncidentDraft.reporterRole = document.getElementById('incident-reporter-role').value;
      currentIncidentDraft.reporterContact = document.getElementById('incident-reporter-contact').value;
      currentIncidentDraft.affectedAssets = document.getElementById('incident-affected-assets').value;
      
      switchIncidentTab('classification');
      showSuccessMessage('âœ… Identificazione salvata! Procedi con classificazione');
    }
    
    function saveClassification(event) {
      event.preventDefault();
      
      currentIncidentDraft.category = document.getElementById('incident-category').value;
      currentIncidentDraft.severity = document.getElementById('incident-severity').value;
      currentIncidentDraft.serviceDuration = document.getElementById('incident-service-duration').value;
      currentIncidentDraft.impactedServices = document.getElementById('incident-impacted-services').value;
      currentIncidentDraft.financialImpact = document.getElementById('incident-financial-impact').value;
      currentIncidentDraft.thirdPartyImpact = document.getElementById('incident-third-party-impact').value;
      currentIncidentDraft.nis2Significant = document.getElementById('incident-nis2-significant').checked;
      currentIncidentDraft.nis2Justification = document.getElementById('incident-nis2-justification').value;
      currentIncidentDraft.gdprPersonalData = document.getElementById('incident-gdpr-personal-data').checked;
      currentIncidentDraft.crossBorder = document.getElementById('incident-cross-border').checked;
      
      switchIncidentTab('response');
      showSuccessMessage('âœ… Classificazione salvata! Procedi con risposta');
    }
    
    function saveResponse(event) {
      event.preventDefault();
      
      currentIncidentDraft.containment = document.getElementById('incident-containment').value;
      currentIncidentDraft.eradication = document.getElementById('incident-eradication').value;
      currentIncidentDraft.recovery = document.getElementById('incident-recovery').value;
      currentIncidentDraft.timeline = document.getElementById('incident-timeline').value;
      currentIncidentDraft.status = document.getElementById('incident-status').value;
      currentIncidentDraft.closureDate = document.getElementById('incident-closure-date').value;
      currentIncidentDraft.finalNotes = document.getElementById('incident-final-notes').value;
      
      document.getElementById('incident-id-display-notif').textContent = currentIncidentDraft.id;
      
      document.getElementById('tab-notifications').classList.remove('hidden');
      document.getElementById('tab-review').classList.remove('hidden');
      
      switchIncidentTab('notifications');
      showSuccessMessage('âœ… Risposta salvata! Procedi con notifiche ACN');
    }
    
    function saveNotifications(event) {
      event.preventDefault();
      
      currentIncidentDraft.preNotificationDate = document.getElementById('notif-prenotifica-date').value;
      currentIncidentDraft.preNotificationStatus = document.getElementById('notif-prenotifica-status').value;
      currentIncidentDraft.detailedNotificationDate = document.getElementById('notif-dettagliata-date').value;
      currentIncidentDraft.detailedNotificationStatus = document.getElementById('notif-dettagliata-status').value;
      currentIncidentDraft.finalReportDate = document.getElementById('notif-finale-date').value;
      currentIncidentDraft.finalReportStatus = document.getElementById('notif-finale-status').value;
      currentIncidentDraft.acnFeedback = document.getElementById('notif-acn-feedback').value;
      
      document.getElementById('incident-id-display-review').textContent = currentIncidentDraft.id;
      
      switchIncidentTab('review');
      showSuccessMessage('âœ… Notifiche salvate! Completa la review');
    }
    
    function saveReview(event) {
      event.preventDefault();
      
      currentIncidentDraft.rootCause = document.getElementById('review-root-cause').value;
      currentIncidentDraft.lessonsLearned = document.getElementById('review-lessons-learned').value;
      currentIncidentDraft.correctiveActions = document.getElementById('review-corrective-actions').value;
      currentIncidentDraft.responsiblePerson = document.getElementById('review-responsible').value;
      currentIncidentDraft.definitiveClosure = document.getElementById('review-closure-date').value;
      currentIncidentDraft.completedAt = new Date().toISOString();
      
      let incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      incidents.push(currentIncidentDraft);
      localStorage.setItem('incidents', JSON.stringify(incidents));
      
      showSuccessMessage('âœ… Incidente registrato completamente con tutte le fasi!');
      
      resetIncidentForms();
      loadIncidentsList();
      loadIncidentStats();
      loadDashboardData();
      
      switchIncidentTab('list');
    }
    
    function saveDraftAndExit() {
      let drafts = JSON.parse(localStorage.getItem('incidentDrafts') || '[]');
      
      const existingIndex = drafts.findIndex(d => d.id === currentIncidentDraft.id);
      if (existingIndex !== -1) {
        drafts[existingIndex] = currentIncidentDraft;
      } else {
        drafts.push(currentIncidentDraft);
      }
      
      localStorage.setItem('incidentDrafts', JSON.stringify(drafts));
      
      showSuccessMessage('ğŸ’¾ Bozza salvata! Puoi continuare in seguito');
      
      resetIncidentForms();
      switchIncidentTab('list');
    }
    
    function goToTab(tabName) {
      switchIncidentTab(tabName);
    }
    
    function resetIncidentForms() {
      document.getElementById('new-incident-form').reset();
      document.getElementById('identification-form').reset();
      document.getElementById('classification-form').reset();
      document.getElementById('response-form').reset();
      document.getElementById('notifications-form').reset();
      document.getElementById('review-form').reset();
      
      document.getElementById('tab-identification').classList.add('hidden');
      document.getElementById('tab-classification').classList.add('hidden');
      document.getElementById('tab-response').classList.add('hidden');
      document.getElementById('tab-notifications').classList.add('hidden');
      document.getElementById('tab-review').classList.add('hidden');
      
      currentIncidentDraft = null;
    }
    
    function loadIncidentsList() {
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      const container = document.getElementById('incidents-list-container');
      
      if (incidents.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun incidente registrato</p>';
        return;
      }
      
      const categoryLabels = {
        'malware': 'ğŸ¦  Malware',
        'dos': 'ğŸ’¥ DoS/DDoS',
        'intrusion': 'ğŸ”“ Intrusione',
        'phishing': 'ğŸ£ Phishing',
        'data-breach': 'ğŸ“‚ Data Breach',
        'human-error': 'ğŸ‘¤ Errore Umano',
        'technical-failure': 'âš™ï¸ Guasto Tecnico',
        'other': 'ğŸ“‹ Altro'
      };
      
      const severityLabels = {
        'critico': 'ğŸ”´ Critico',
        'alto': 'ğŸŸ  Alto',
        'medio': 'ğŸŸ¡ Medio',
        'basso': 'ğŸ”µ Basso'
      };
      
      const statusLabels = {
        'in-corso': 'ğŸ”´ In Corso',
        'contenuto': 'ğŸŸ¡ Contenuto',
        'risolto': 'ğŸŸ¢ Risolto',
        'chiuso': 'âœ… Chiuso'
      };
      
      container.innerHTML = incidents.slice().reverse().map(inc => {
        const detectionDate = inc.detectionDate ? new Date(inc.detectionDate).toLocaleString('it-IT') : 'Non specificata';
        
        return `
          <div class="bg-white p-5 rounded-lg shadow-md border-l-4 ${inc.severity === 'critico' ? 'border-red-600' : inc.severity === 'alto' ? 'border-orange-500' : inc.severity === 'medio' ? 'border-yellow-500' : 'border-blue-500'}">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                  <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${inc.id}</span>
                  ${inc.nis2Significant ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-medium">âš ï¸ Significativo NIS2</span>' : ''}
                  ${inc.gdprPersonalData ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">ğŸ”’ GDPR</span>' : ''}
                </div>
                <h4 class="font-bold text-gray-800 text-lg">${inc.title}</h4>
                <p class="text-sm text-gray-600 mt-1">${inc.briefDescription || ''}</p>
              </div>
              <div class="flex flex-col space-y-2 ml-4">
                <span class="text-xs px-3 py-1 rounded-full font-medium whitespace-nowrap ${inc.severity === 'critico' ? 'bg-red-100 text-red-700' : inc.severity === 'alto' ? 'bg-orange-100 text-orange-700' : inc.severity === 'medio' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'}">${severityLabels[inc.severity] || inc.severity}</span>
                <span class="text-xs px-3 py-1 rounded-full font-medium whitespace-nowrap ${inc.status === 'chiuso' ? 'bg-green-100 text-green-700' : inc.status === 'risolto' ? 'bg-green-100 text-green-700' : inc.status === 'contenuto' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${statusLabels[inc.status] || inc.status}</span>
              </div>
            </div>
            
            <!-- Identification Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
              <div class="bg-blue-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-medium mb-1">ğŸ“… Data Scoperta</p>
                <p class="text-sm text-gray-800">${detectionDate}</p>
              </div>
              <div class="bg-purple-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-medium mb-1">ğŸ‘¤ Segnalatore</p>
                <p class="text-sm font-semibold text-gray-800">${inc.reporterName || 'N/A'}</p>
                <p class="text-xs text-gray-600">${inc.reporterRole || ''}</p>
              </div>
              <div class="bg-orange-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-medium mb-1">ğŸ·ï¸ Categoria</p>
                <p class="text-sm text-gray-800">${categoryLabels[inc.category] || inc.category || 'N/A'}</p>
              </div>
            </div>
            
            <!-- Assets Section -->
            ${inc.affectedAssets ? `
            <div class="bg-orange-50 p-3 rounded-lg mb-3">
              <p class="text-xs text-gray-600 font-medium mb-1">ğŸ–¥ï¸ Asset Coinvolti</p>
              <p class="text-sm text-gray-800">${inc.affectedAssets}</p>
            </div>
            ` : ''}
            
            <!-- Impact Section -->
            ${inc.serviceDuration || inc.financialImpact || inc.thirdPartyImpact ? `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
              ${inc.serviceDuration ? `
              <div class="bg-red-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-medium mb-1">â±ï¸ Durata Impatto</p>
                <p class="text-sm text-gray-800">${inc.serviceDuration}</p>
              </div>
              ` : ''}
              ${inc.financialImpact ? `
              <div class="bg-yellow-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-medium mb-1">ğŸ’° Impatto Finanziario</p>
                <p class="text-sm text-gray-800">${inc.financialImpact}</p>
              </div>
              ` : ''}
              ${inc.thirdPartyImpact ? `
              <div class="bg-blue-50 p-3 rounded-lg">
                <p class="text-xs text-gray-600 font-medium mb-1">ğŸ‘¥ Utenti Colpiti</p>
                <p class="text-sm text-gray-800">${inc.thirdPartyImpact}</p>
              </div>
              ` : ''}
            </div>
            ` : ''}
            
            <!-- Response Actions -->
            ${inc.containment || inc.eradication || inc.recovery ? `
            <div class="bg-green-50 p-3 rounded-lg mb-3">
              <p class="text-xs text-gray-600 font-medium mb-2">ğŸ› ï¸ Azioni di Risposta</p>
              ${inc.containment ? `<p class="text-sm text-gray-800 mb-1"><strong>Contenimento:</strong> ${inc.containment}</p>` : ''}
              ${inc.eradication ? `<p class="text-sm text-gray-800 mb-1"><strong>Eradicazione:</strong> ${inc.eradication}</p>` : ''}
              ${inc.recovery ? `<p class="text-sm text-gray-800"><strong>Ripristino:</strong> ${inc.recovery}</p>` : ''}
            </div>
            ` : ''}
            
            <!-- Notifications Status -->
            ${inc.preNotificationStatus || inc.detailedNotificationStatus || inc.finalReportStatus ? `
            <div class="bg-purple-50 p-3 rounded-lg mb-3">
              <p class="text-xs text-gray-600 font-medium mb-2">ğŸ“® Stato Notifiche ACN</p>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                ${inc.preNotificationStatus ? `
                <div class="flex items-center space-x-2">
                  <span class="text-xs ${inc.preNotificationStatus === 'inviata' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'} px-2 py-1 rounded">
                    ${inc.preNotificationStatus === 'inviata' ? 'âœ…' : 'â³'} Pre-Notifica (24h)
                  </span>
                </div>
                ` : ''}
                ${inc.detailedNotificationStatus ? `
                <div class="flex items-center space-x-2">
                  <span class="text-xs ${inc.detailedNotificationStatus === 'inviata' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'} px-2 py-1 rounded">
                    ${inc.detailedNotificationStatus === 'inviata' ? 'âœ…' : 'â³'} Dettagliata (72h)
                  </span>
                </div>
                ` : ''}
                ${inc.finalReportStatus ? `
                <div class="flex items-center space-x-2">
                  <span class="text-xs ${inc.finalReportStatus === 'inviata' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'} px-2 py-1 rounded">
                    ${inc.finalReportStatus === 'inviata' ? 'âœ…' : 'â³'} Finale (1 mese)
                  </span>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}
            
            <!-- Post-Incident Review -->
            ${inc.rootCause || inc.lessonsLearned || inc.correctiveActions ? `
            <div class="bg-blue-50 p-3 rounded-lg mb-3">
              <p class="text-xs text-gray-600 font-medium mb-2">ğŸ“ Post-Incident Review</p>
              ${inc.rootCause ? `<p class="text-sm text-gray-800 mb-1"><strong>ğŸ” Root Cause:</strong> ${inc.rootCause}</p>` : ''}
              ${inc.lessonsLearned ? `<p class="text-sm text-gray-800 mb-1"><strong>ğŸ’¡ Lessons Learned:</strong> ${inc.lessonsLearned}</p>` : ''}
              ${inc.correctiveActions ? `<p class="text-sm text-gray-800 mb-1"><strong>âœ… Azioni Correttive:</strong> ${inc.correctiveActions}</p>` : ''}
              ${inc.responsiblePerson ? `<p class="text-sm text-gray-800"><strong>ğŸ‘¤ Responsabile:</strong> ${inc.responsiblePerson}</p>` : ''}
            </div>
            ` : ''}
            
            <div class="flex items-center justify-between pt-3 border-t border-gray-200">
              <p class="text-xs text-gray-500">ğŸ¢ ${inc.company}</p>
              <p class="text-xs text-gray-500">Creato: ${new Date(inc.createdAt).toLocaleString('it-IT')}</p>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function loadIncidentStats() {
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      
      const critical = incidents.filter(i => i.severity === 'critico').length;
      const ongoing = incidents.filter(i => i.status === 'in-corso' || i.status === 'contenuto').length;
      const resolved = incidents.filter(i => i.status === 'risolto' || i.status === 'chiuso').length;
      const nis2Significant = incidents.filter(i => i.nis2Significant).length;
      const gdprData = incidents.filter(i => i.gdprPersonalData).length;
      
      document.getElementById('stats-total').textContent = incidents.length;
      document.getElementById('stats-critical').textContent = critical;
      document.getElementById('stats-ongoing').textContent = ongoing;
      document.getElementById('stats-resolved').textContent = resolved;
      document.getElementById('stats-nis2').textContent = nis2Significant;
      document.getElementById('stats-gdpr').textContent = gdprData;
      
      drawStatusChart(incidents);
      drawSeverityChart(incidents);
      drawCategoryChart(incidents);
    }
    
    function drawStatusChart(incidents) {
      const statusCounts = {
        'in-corso': incidents.filter(i => i.status === 'in-corso').length,
        'contenuto': incidents.filter(i => i.status === 'contenuto').length,
        'risolto': incidents.filter(i => i.status === 'risolto').length,
        'chiuso': incidents.filter(i => i.status === 'chiuso').length
      };
      
      const statusLabels = {
        'in-corso': 'In Corso',
        'contenuto': 'Contenuto',
        'risolto': 'Risolto',
        'chiuso': 'Chiuso'
      };
      
      const statusColors = {
        'in-corso': '#ef4444',
        'contenuto': '#f59e0b',
        'risolto': '#10b981',
        'chiuso': '#6366f1'
      };
      
      const data = Object.entries(statusCounts).filter(([_, count]) => count > 0);
      
      if (data.length === 0) {
        document.getElementById('status-chart').style.display = 'none';
        document.getElementById('status-legend').innerHTML = '<p class="text-gray-500 text-center col-span-2">Nessun dato disponibile</p>';
        return;
      }
      
      document.getElementById('status-chart').style.display = 'block';
      
      const canvas = document.getElementById('status-chart');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 100;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const total = data.reduce((sum, [_, count]) => sum + count, 0);
      let currentAngle = -Math.PI / 2;
      
      data.forEach(([status, count]) => {
        const sliceAngle = (count / total) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = statusColors[status];
        ctx.fill();
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        const textAngle = currentAngle + sliceAngle / 2;
        const textX = centerX + Math.cos(textAngle) * (radius * 0.7);
        const textY = centerY + Math.sin(textAngle) * (radius * 0.7);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(count, textX, textY);
        
        currentAngle += sliceAngle;
      });
      
      const legendHTML = data.map(([status, count]) => `
        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
          <div class="w-4 h-4 rounded" style="background-color: ${statusColors[status]}"></div>
          <span class="text-sm font-medium text-gray-700">${statusLabels[status]}</span>
          <span class="text-sm font-bold text-gray-800 ml-auto">${count}</span>
        </div>
      `).join('');
      
      document.getElementById('status-legend').innerHTML = legendHTML;
    }
    
    function drawSeverityChart(incidents) {
      const severityCounts = {
        'critico': incidents.filter(i => i.severity === 'critico').length,
        'alto': incidents.filter(i => i.severity === 'alto').length,
        'medio': incidents.filter(i => i.severity === 'medio').length,
        'basso': incidents.filter(i => i.severity === 'basso').length
      };
      
      const severityLabels = {
        'critico': 'Critico',
        'alto': 'Alto',
        'medio': 'Medio',
        'basso': 'Basso'
      };
      
      const severityColors = {
        'critico': '#dc2626',
        'alto': '#f97316',
        'medio': '#eab308',
        'basso': '#3b82f6'
      };
      
      const data = Object.entries(severityCounts).filter(([_, count]) => count > 0);
      
      if (data.length === 0) {
        document.getElementById('severity-chart').style.display = 'none';
        document.getElementById('severity-legend').innerHTML = '<p class="text-gray-500 text-center col-span-2">Nessun dato disponibile</p>';
        return;
      }
      
      document.getElementById('severity-chart').style.display = 'block';
      
      const canvas = document.getElementById('severity-chart');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 100;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const total = data.reduce((sum, [_, count]) => sum + count, 0);
      let currentAngle = -Math.PI / 2;
      
      data.forEach(([severity, count]) => {
        const sliceAngle = (count / total) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = severityColors[severity];
        ctx.fill();
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        const textAngle = currentAngle + sliceAngle / 2;
        const textX = centerX + Math.cos(textAngle) * (radius * 0.7);
        const textY = centerY + Math.sin(textAngle) * (radius * 0.7);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(count, textX, textY);
        
        currentAngle += sliceAngle;
      });
      
      const legendHTML = data.map(([severity, count]) => `
        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
          <div class="w-4 h-4 rounded" style="background-color: ${severityColors[severity]}"></div>
          <span class="text-sm font-medium text-gray-700">${severityLabels[severity]}</span>
          <span class="text-sm font-bold text-gray-800 ml-auto">${count}</span>
        </div>
      `).join('');
      
      document.getElementById('severity-legend').innerHTML = legendHTML;
    }
    
    function drawCategoryChart(incidents) {
      const categoryCounts = {};
      incidents.forEach(inc => {
        if (inc.category) {
          categoryCounts[inc.category] = (categoryCounts[inc.category] || 0) + 1;
        }
      });
      
      const categoryLabels = {
        'malware': 'Malware',
        'dos': 'DoS/DDoS',
        'intrusion': 'Intrusione',
        'phishing': 'Phishing',
        'data-breach': 'Data Breach',
        'human-error': 'Errore Umano',
        'technical-failure': 'Guasto Tecnico',
        'other': 'Altro'
      };
      
      const categoryColors = [
        '#8b5cf6', '#f59e0b', '#10b981', '#ef4444',
        '#06b6d4', '#ec4899', '#6366f1', '#84cc16'
      ];
      
      const data = Object.entries(categoryCounts);
      
      if (data.length === 0) {
        document.getElementById('category-chart').style.display = 'none';
        document.getElementById('category-legend').innerHTML = '<p class="text-gray-500 text-center col-span-2">Nessun dato disponibile</p>';
        return;
      }
      
      document.getElementById('category-chart').style.display = 'block';
      
      const canvas = document.getElementById('category-chart');
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 100;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const total = data.reduce((sum, [_, count]) => sum + count, 0);
      let currentAngle = -Math.PI / 2;
      
      data.forEach(([category, count], index) => {
        const sliceAngle = (count / total) * 2 * Math.PI;
        const color = categoryColors[index % categoryColors.length];
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        const textAngle = currentAngle + sliceAngle / 2;
        const textX = centerX + Math.cos(textAngle) * (radius * 0.7);
        const textY = centerY + Math.sin(textAngle) * (radius * 0.7);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(count, textX, textY);
        
        currentAngle += sliceAngle;
      });
      
      const legendHTML = data.map(([category, count], index) => `
        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
          <div class="w-4 h-4 rounded" style="background-color: ${categoryColors[index % categoryColors.length]}"></div>
          <span class="text-sm font-medium text-gray-700">${categoryLabels[category] || category}</span>
          <span class="text-sm font-bold text-gray-800 ml-auto">${count}</span>
        </div>
      `).join('');
      
      document.getElementById('category-legend').innerHTML = legendHTML;
    }
    
    // === EXPORT FUNCTIONS ===
    function exportIncidentsToExcel() {
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      
      if (incidents.length === 0) {
        showErrorMessage('âš ï¸ Nessun incidente da esportare');
        return;
      }
      
      const categoryLabels = {
        'malware': 'Malware',
        'dos': 'DoS/DDoS',
        'intrusion': 'Intrusione',
        'phishing': 'Phishing',
        'data-breach': 'Data Breach',
        'human-error': 'Errore Umano',
        'technical-failure': 'Guasto Tecnico',
        'other': 'Altro'
      };
      
      const severityLabels = {
        'critico': 'Critico',
        'alto': 'Alto',
        'medio': 'Medio',
        'basso': 'Basso'
      };
      
      const statusLabels = {
        'in-corso': 'In Corso',
        'contenuto': 'Contenuto',
        'risolto': 'Risolto',
        'chiuso': 'Chiuso'
      };
      
      const excelData = incidents.map(inc => ({
        'ID Incidente': inc.id,
        'Titolo': inc.title,
        'Descrizione': inc.briefDescription || '',
        'Azienda': inc.company,
        'Data Scoperta': inc.detectionDate ? new Date(inc.detectionDate).toLocaleString('it-IT') : '',
        'Data Inizio': inc.startDate ? new Date(inc.startDate).toLocaleString('it-IT') : '',
        'Categoria': categoryLabels[inc.category] || inc.category || '',
        'GravitÃ ': severityLabels[inc.severity] || inc.severity || '',
        'Stato': statusLabels[inc.status] || inc.status || '',
        'Segnalatore': inc.reporterName || '',
        'Ruolo Segnalatore': inc.reporterRole || '',
        'Contatto Segnalatore': inc.reporterContact || '',
        'Asset Coinvolti': inc.affectedAssets || '',
        'Durata Interruzione': inc.serviceDuration || '',
        'Servizi Impattati': inc.impactedServices || '',
        'Impatto Finanziario': inc.financialImpact || '',
        'Utenti Colpiti': inc.thirdPartyImpact || '',
        'Significativo NIS2': inc.nis2Significant ? 'SÃ¬' : 'No',
        'Giustificazione NIS2': inc.nis2Justification || '',
        'Dati Personali GDPR': inc.gdprPersonalData ? 'SÃ¬' : 'No',
        'Impatto Transfrontaliero': inc.crossBorder ? 'SÃ¬' : 'No',
        'Misure Contenimento': inc.containment || '',
        'Misure Eradicazione': inc.eradication || '',
        'Misure Ripristino': inc.recovery || '',
        'Timeline Azioni': inc.timeline || '',
        'Data Chiusura': inc.closureDate ? new Date(inc.closureDate).toLocaleString('it-IT') : '',
        'Note Finali': inc.finalNotes || '',
        'Pre-Notifica 24h': inc.preNotificationStatus || '',
        'Data Pre-Notifica': inc.preNotificationDate ? new Date(inc.preNotificationDate).toLocaleString('it-IT') : '',
        'Notifica Dettagliata 72h': inc.detailedNotificationStatus || '',
        'Data Notifica Dettagliata': inc.detailedNotificationDate ? new Date(inc.detailedNotificationDate).toLocaleString('it-IT') : '',
        'Rapporto Finale 1 Mese': inc.finalReportStatus || '',
        'Data Rapporto Finale': inc.finalReportDate ? new Date(inc.finalReportDate).toLocaleString('it-IT') : '',
        'Indicazioni ACN': inc.acnFeedback || '',
        'Root Cause': inc.rootCause || '',
        'Lessons Learned': inc.lessonsLearned || '',
        'Azioni Correttive': inc.correctiveActions || '',
        'Responsabile Azioni': inc.responsiblePerson || '',
        'Data Chiusura Definitiva': inc.definitiveClosure || '',
        'Data Creazione': new Date(inc.createdAt).toLocaleString('it-IT'),
        'Data Completamento': inc.completedAt ? new Date(inc.completedAt).toLocaleString('it-IT') : ''
      }));
      
      const worksheet = XLSX.utils.json_to_sheet(excelData);
      
      const colWidths = [
        { wch: 15 }, // ID
        { wch: 30 }, // Titolo
        { wch: 40 }, // Descrizione
        { wch: 20 }, // Azienda
        { wch: 20 }, // Date
        { wch: 20 },
        { wch: 15 }, // Categoria
        { wch: 12 }, // GravitÃ 
        { wch: 12 }, // Stato
        { wch: 20 }, // Segnalatore
        { wch: 20 },
        { wch: 25 },
        { wch: 40 }, // Asset
        { wch: 20 },
        { wch: 30 },
        { wch: 20 },
        { wch: 20 },
        { wch: 15 },
        { wch: 40 },
        { wch: 15 },
        { wch: 15 },
        { wch: 40 },
        { wch: 40 },
        { wch: 40 },
        { wch: 40 },
        { wch: 20 },
        { wch: 30 },
        { wch: 15 },
        { wch: 20 },
        { wch: 15 },
        { wch: 20 },
        { wch: 15 },
        { wch: 20 },
        { wch: 40 },
        { wch: 40 },
        { wch: 40 },
        { wch: 40 },
        { wch: 20 },
        { wch: 20 },
        { wch: 20 },
        { wch: 20 }
      ];
      worksheet['!cols'] = colWidths;
      
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Incidenti');
      
      const timestamp = new Date().toISOString().split('T')[0];
      XLSX.writeFile(workbook, `Registro_Incidenti_NIS2_${timestamp}.xlsx`);
      
      showSuccessMessage('âœ… Excel esportato con successo!');
    }
    
    function exportIncidentsToPDF() {
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      
      if (incidents.length === 0) {
        showErrorMessage('âš ï¸ Nessun incidente da esportare');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      
      const categoryLabels = {
        'malware': 'Malware',
        'dos': 'DoS/DDoS',
        'intrusion': 'Intrusione',
        'phishing': 'Phishing',
        'data-breach': 'Data Breach',
        'human-error': 'Errore Umano',
        'technical-failure': 'Guasto Tecnico',
        'other': 'Altro'
      };
      
      const severityLabels = {
        'critico': 'Critico',
        'alto': 'Alto',
        'medio': 'Medio',
        'basso': 'Basso'
      };
      
      const statusLabels = {
        'in-corso': 'In Corso',
        'contenuto': 'Contenuto',
        'risolto': 'Risolto',
        'chiuso': 'Chiuso'
      };
      
      doc.setFontSize(18);
      doc.text('Registro Incidenti di Sicurezza NIS2', 148, 15, { align: 'center' });
      
      doc.setFontSize(10);
      const exportDate = new Date().toLocaleString('it-IT');
      doc.text(`Data Esportazione: ${exportDate}`, 148, 22, { align: 'center' });
      doc.text(`Totale Incidenti: ${incidents.length}`, 148, 28, { align: 'center' });
      
      const tableData = incidents.map(inc => [
        inc.id,
        inc.title.substring(0, 30) + (inc.title.length > 30 ? '...' : ''),
        inc.detectionDate ? new Date(inc.detectionDate).toLocaleDateString('it-IT') : '',
        categoryLabels[inc.category] || '',
        severityLabels[inc.severity] || '',
        statusLabels[inc.status] || '',
        inc.reporterName || '',
        inc.nis2Significant ? 'Si' : 'No',
        inc.gdprPersonalData ? 'Si' : 'No'
      ]);
      
      doc.autoTable({
        startY: 35,
        head: [['ID', 'Titolo', 'Data Scoperta', 'Categoria', 'Gravita', 'Stato', 'Segnalatore', 'NIS2', 'GDPR']],
        body: tableData,
        styles: { 
          fontSize: 8,
          cellPadding: 2
        },
        headStyles: { 
          fillColor: [59, 130, 246],
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 25 },
          1: { cellWidth: 50 },
          2: { cellWidth: 25 },
          3: { cellWidth: 25 },
          4: { cellWidth: 20 },
          5: { cellWidth: 20 },
          6: { cellWidth: 35 },
          7: { cellWidth: 15 },
          8: { cellWidth: 15 }
        },
        alternateRowStyles: { fillColor: [245, 247, 250] },
        margin: { top: 35, left: 10, right: 10 }
      });
      
      let currentY = doc.lastAutoTable.finalY + 15;
      
      incidents.forEach((inc, index) => {
        if (currentY > 180) {
          doc.addPage();
          currentY = 20;
        }
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`Dettaglio Incidente: ${inc.id}`, 15, currentY);
        currentY += 7;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        const details = [
          `Titolo: ${inc.title}`,
          `Descrizione: ${inc.briefDescription || 'N/A'}`,
          `Asset Coinvolti: ${inc.affectedAssets || 'N/A'}`,
          `Durata Interruzione: ${inc.serviceDuration || 'N/A'}`,
          `Impatto Finanziario: ${inc.financialImpact || 'N/A'}`,
          `Utenti Colpiti: ${inc.thirdPartyImpact || 'N/A'}`
        ];
        
        if (inc.containment) details.push(`Contenimento: ${inc.containment}`);
        if (inc.eradication) details.push(`Eradicazione: ${inc.eradication}`);
        if (inc.recovery) details.push(`Ripristino: ${inc.recovery}`);
        
        if (inc.preNotificationStatus) {
          details.push(`Pre-Notifica (24h): ${inc.preNotificationStatus === 'inviata' ? 'Inviata' : 'Non Inviata'}`);
        }
        if (inc.detailedNotificationStatus) {
          details.push(`Notifica Dettagliata (72h): ${inc.detailedNotificationStatus === 'inviata' ? 'Inviata' : 'Non Inviata'}`);
        }
        if (inc.finalReportStatus) {
          details.push(`Rapporto Finale (1 mese): ${inc.finalReportStatus === 'inviata' ? 'Inviato' : 'Non Inviato'}`);
        }
        
        if (inc.rootCause) details.push(`Root Cause: ${inc.rootCause}`);
        if (inc.lessonsLearned) details.push(`Lessons Learned: ${inc.lessonsLearned}`);
        if (inc.correctiveActions) details.push(`Azioni Correttive: ${inc.correctiveActions}`);
        if (inc.responsiblePerson) details.push(`Responsabile: ${inc.responsiblePerson}`);
        
        details.forEach(detail => {
          const splitText = doc.splitTextToSize(detail, 270);
          splitText.forEach(line => {
            if (currentY > 190) {
              doc.addPage();
              currentY = 20;
            }
            doc.text(line, 15, currentY);
            currentY += 5;
          });
        });
        
        currentY += 5;
        
        if (index < incidents.length - 1) {
          doc.setDrawColor(200, 200, 200);
          doc.line(15, currentY, 282, currentY);
          currentY += 10;
        }
      });
      
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`Pagina ${i} di ${pageCount}`, 148, 205, { align: 'center' });
      }
      
      const timestamp = new Date().toISOString().split('T')[0];
      doc.save(`Registro_Incidenti_NIS2_${timestamp}.pdf`);
      
      showSuccessMessage('âœ… PDF esportato con successo!');
    }
    
    // === DASHBOARD ===
    function loadDashboardData() {
      const companies = JSON.parse(localStorage.getItem('companies') || '[]');
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      
      document.getElementById('total-companies').textContent = companies.length;
      
      const openIncidents = incidents.filter(i => i.status === 'aperto' || i.status === 'in-corso');
      document.getElementById('open-incidents').textContent = openIncidents.length;
      
      const pendingNotifications = notifications.filter(n => n.status === 'pending');
      document.getElementById('pending-notifications').textContent = pendingNotifications.length;
      
      const complianceScore = companies.length > 0 ? 85 : 0;
      document.getElementById('compliance-score').textContent = complianceScore + '%';
      
      loadRecentActivity();
      loadIncidentsList();
    }
    
    function loadRecentActivity() {
      const activityContainer = document.getElementById('recent-activity');
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      
      if (incidents.length === 0) {
        activityContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nessuna attivitÃ  recente</p>';
        return;
      }
      
      const recentIncidents = incidents.slice(-5).reverse();
      
      activityContainer.innerHTML = recentIncidents.map(inc => `
        <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-medium text-gray-800">${inc.title}</p>
            <p class="text-sm text-gray-500">${inc.company} - ${new Date(inc.detectionDate).toLocaleDateString('it-IT')}</p>
          </div>
          <span class="status-badge status-${inc.status}">${inc.status.toUpperCase()}</span>
        </div>
      `).join('');
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9aa56a6915efbb11',t:'MTc2NTEyNTExMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
