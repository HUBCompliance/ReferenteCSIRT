<!doctype html>
<html lang="it" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piattaforma CSIRT - Gestione Sicurezza Aziendale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    .hidden { display: none; }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .status-aperto { background-color: #fee2e2; color: #991b1b; }
    .status-in-corso { background-color: #fef3c7; color: #92400e; }
    .status-risolto { background-color: #d1fae5; color: #065f46; }
    .severity-critical { background-color: #fecaca; color: #991b1b; }
    .severity-high { background-color: #fed7aa; color: #9a3412; }
    .severity-medium { background-color: #fef08a; color: #854d0e; }
    .severity-low { background-color: #bfdbfe; color: #1e40af; }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50 h-full"><!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
      <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
     </div>
     <h1 class="text-3xl font-bold text-gray-800">Piattaforma CSIRT</h1>
     <p class="text-gray-600 mt-2">Gestione Sicurezza e Compliance NIS2</p>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-6">
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="login-email" placeholder="inserisci@email.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢ï¿½ï¿½â€¢â€¢â€¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Profilo</label> <select id="login-role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> <option value="">Seleziona il tuo ruolo</option> <option value="admin">ï¿½ï¿½ï¿½ï¿½ï¿½ Amministratore</option> <option value="csirt">ğŸ›¡ï¸ Consulente/Referente CSIRT</option> <option value="azienda">ğŸ¢ Referente Aziendale</option> </select>
     </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"> Accedi alla Piattaforma </button>
    </form>
    <div class="mt-6 pt-6 border-t border-gray-200">
     <p class="text-center text-sm text-gray-600">Demo - Credenziali di test:</p>
     <div class="mt-2 space-y-1 text-xs text-gray-500">
      <p>ğŸ‘¤ Admin: admin@csirt.it / admin123</p>
      <p>ğŸ›¡ï¸ CSIRT: csirt@hub.it / csirt123</p>
      <p>ğŸ¢ Azienda: azienda@test.it / azienda123</p>
     </div>
    </div>
   </div>
  </div><!-- Main App (Hidden until login) -->
  <div id="main-app" class="hidden h-full flex flex-col"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
       <svg class="w-10 h-10" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
       </svg>
       <div>
        <h1 class="text-2xl font-bold">Piattaforma CSIRT</h1>
        <p class="text-blue-100 text-sm">Sistema di Gestione Sicurezza e Compliance NIS2</p>
       </div>
      </div>
      <div class="flex items-center space-x-4">
       <div class="text-right">
        <p class="text-sm font-medium" id="user-name">Admin User</p>
        <p class="text-xs text-blue-100" id="user-role">Amministratore</p>
       </div><button onclick="logout()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg><span>Esci</span> </button>
      </div>
     </div>
    </div>
   </header>
   <div class="flex flex-1 overflow-hidden"><!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg overflow-y-auto">
     <nav class="p-4 space-y-2" id="sidebar-nav"><button onclick="showSection('dashboard')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
       </svg><span>Dashboard</span> </button> <button onclick="showSection('companies')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg><span>Aziende</span> </button> <button onclick="showSection('users')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
       </svg><span>Utenti</span> </button> <button onclick="showSection('incidents')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg><span>Incidenti</span> </button> <button onclick="showSection('notifications')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
       </svg><span>Notifiche ACN</span> </button>
     </nav>
    </aside><!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8"><!-- Dashboard Section -->
     <section id="dashboard-section" class="section-content">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Generale</h2><!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Aziende Monitorate</p>
          <p id="total-companies" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-blue-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Incidenti Aperti</p>
          <p id="open-incidents" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-red-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Notifiche Pending</p>
          <p id="pending-notifications" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-yellow-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Compliance Score</p>
          <p id="compliance-score" class="text-3xl font-bold text-gray-800 mt-2">0%</p>
         </div>
         <div class="bg-green-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
        </div>
       </div>
      </div><!-- Recent Activity -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4">AttivitÃ  Recenti</h3>
       <div id="recent-activity" class="space-y-3">
        <p class="text-gray-500 text-center py-8">Nessuna attivitÃ  recente</p>
       </div>
      </div><!-- CSIRT Dashboard Cards -->
      <div id="csirt-dashboard-cards" class="hidden">
       <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><!-- Card 1: Registro Incidenti -->
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer border-t-4 border-red-500" onclick="openIncidentsDetail()">
         <div class="p-6">
          <div class="flex items-center justify-between mb-4">
           <div class="bg-red-100 p-3 rounded-full">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
           </div><span class="text-3xl font-bold text-red-600" id="incident-count">0</span>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸš¨ Registro Incidenti</h3>
          <p class="text-gray-600 text-sm">Gestisci e traccia gli incidenti di sicurezza secondo NIS2</p>
          <div class="mt-4 pt-4 border-t border-gray-200"><button class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium"> Apri Registro â†’ </button>
          </div>
         </div>
        </div><!-- Card 2: Designazione Referente CSIRT -->
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer border-t-4 border-purple-500" onclick="openDesignationDetail()">
         <div class="p-6">
          <div class="flex items-center justify-between mb-4">
           <div class="bg-purple-100 p-3 rounded-full">
            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
           </div><span class="text-sm font-medium text-purple-600" id="designation-status">Non compilato</span>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ“‹ Designazione CSIRT</h3>
          <p class="text-gray-600 text-sm">Compila i dati del referente CSIRT e sostituti</p>
          <div class="mt-4 pt-4 border-t border-gray-200"><button class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium"> Apri Designazione â†’ </button>
          </div>
         </div>
        </div><!-- Card 3: Configurazione Rete -->
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer border-t-4 border-blue-500" onclick="openNetworkDetail()">
         <div class="p-6">
          <div class="flex items-center justify-between mb-4">
           <div class="bg-blue-100 p-3 rounded-full">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
            </svg>
           </div><span class="text-sm font-medium text-blue-600" id="network-status">Non configurato</span>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸŒ Configurazione Rete</h3>
          <p class="text-gray-600 text-sm">Definisci architettura, sicurezza e monitoraggio rete</p>
          <div class="mt-4 pt-4 border-t border-gray-200"><button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium"> Apri Configurazione â†’ </button>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Incidents Detail Section (Hidden by default) -->
      <div id="incidents-detail-section" class="hidden">
       <div class="mb-6 flex items-center space-x-4"><button onclick="closeIncidentsDetail()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center space-x-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
         </svg><span>Torna alla Dashboard</span> </button>
        <h2 class="text-3xl font-bold text-gray-800">ğŸš¨ Registro Incidenti di Sicurezza</h2>
       </div>
       <div class="bg-white rounded-xl shadow-md">
        <div class="flex border-b border-gray-200"><button onclick="switchIncidentSubTab('list')" id="incident-subtab-list" class="incident-subtab px-6 py-4 font-medium text-blue-600 border-b-2 border-blue-600"> ğŸ“‹ Lista Incidenti </button> <button onclick="switchIncidentSubTab('new')" id="incident-subtab-new" class="incident-subtab px-6 py-4 font-medium text-gray-500 hover:text-gray-700"> â• Nuovo Incidente </button> <button onclick="switchIncidentSubTab('drafts')" id="incident-subtab-drafts" class="incident-subtab px-6 py-4 font-medium text-gray-500 hover:text-gray-700"> ğŸ’¾ Bozze </button>
        </div><!-- Tab Content: List -->
        <div id="incident-subcontent-list" class="incident-subtab-content p-6">
         <div class="flex justify-between items-center mb-6">
          <div class="flex space-x-4"><input type="text" id="search-incidents" placeholder="ğŸ” Cerca incidenti..." class="px-4 py-2 border border-gray-300 rounded-lg w-64"> <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Tutti gli stati</option> <option value="aperto">Aperto</option> <option value="in-corso">In Corso</option> <option value="risolto">Risolto</option> </select>
          </div><button onclick="exportIncidents()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center space-x-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg><span>Esporta</span> </button>
         </div>
         <div id="incidents-list" class="space-y-4">
          <p class="text-center text-gray-500 py-8">Nessun incidente registrato</p>
         </div>
        </div><!-- Tab Content: New -->
        <div id="incident-subcontent-new" class="incident-subtab-content hidden p-6">
         <form id="incident-form" onsubmit="saveIncident(event)"><!-- Include all the incident form sections here -->
          <div class="mb-8">
           <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ“‹ Dati Generali Incidente</h3>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Titolo Incidente *</label> <input type="text" id="incident-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data/Ora Rilevamento *</label> <input type="datetime-local" id="incident-datetime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">GravitÃ  *</label> <select id="incident-severity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona gravitÃ </option> <option value="critical">ğŸ”´ Critica</option> <option value="high">ğŸŸ  Alta</option> <option value="medium">ğŸŸ¡ Media</option> <option value="low">ğŸ”µ Bassa</option> </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Stato *</label> <select id="incident-status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="aperto">Aperto</option> <option value="in-corso">In Corso</option> <option value="risolto">Risolto</option> </select>
            </div>
            <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Descrizione Incidente *</label> <textarea id="incident-description" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
            </div>
           </div>
          </div>
          <div class="mb-8">
           <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ·ï¸ Categorizzazione</h3>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo Incidente *</label> <select id="incident-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona tipo</option> <option value="malware">Malware</option> <option value="phishing">Phishing</option> <option value="ddos">DDoS</option> <option value="data-breach">Data Breach</option> <option value="ransomware">Ransomware</option> <option value="accesso-non-autorizzato">Accesso Non Autorizzato</option> <option value="altro">Altro</option> </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Servizio/Asset Colpito</label> <input type="text" id="incident-asset" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
           </div>
          </div>
          <div class="mb-8">
           <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ’¥ Impatto dell'Incidente</h3>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Utenti Coinvolti</label> <input type="number" id="incident-users" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Durata Interruzione (ore)</label> <input type="number" id="incident-duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Descrizione Impatto</label> <textarea id="incident-impact" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
            </div>
            <div class="md:col-span-2"><label class="flex items-center space-x-2"> <input type="checkbox" id="incident-data-loss" class="w-4 h-4 text-blue-600"> <span class="text-sm font-medium text-gray-700">Perdita/Compromissione Dati</span> </label>
            </div>
           </div>
          </div>
          <div class="mb-8">
           <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ› ï¸ Azioni Intraprese</h3>
           <div class="space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Misure di Contenimento</label> <textarea id="incident-containment" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Descrivere le azioni immediate per contenere l'incidente"></textarea>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Azioni Correttive</label> <textarea id="incident-corrective" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Descrivere le azioni per risolvere l'incidente"></textarea>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Raccomandazioni Future</label> <textarea id="incident-recommendations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Raccomandazioni per prevenire incidenti simili"></textarea>
            </div>
           </div>
          </div>
          <div class="mb-8">
           <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ“¢ Notifica ACN</h3>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="flex items-center space-x-2 mb-4"> <input type="checkbox" id="incident-acn-required" class="w-4 h-4 text-blue-600" onchange="toggleACNFields()"> <span class="text-sm font-medium text-gray-700">Richiede Notifica ACN</span> </label>
            </div>
            <div></div>
            <div id="acn-fields" class="md:col-span-2 hidden space-y-4">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Notifica Iniziale</label> <input type="datetime-local" id="incident-acn-date-initial" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Notifica Intermedia</label> <input type="datetime-local" id="incident-acn-date-intermediate" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Notifica Finale</label> <input type="datetime-local" id="incident-acn-date-final" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Protocollo ACN</label> <input type="text" id="incident-acn-protocol" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
             </div>
             <div><label class="block text-sm font-medium text-gray-700 mb-2">Note Comunicazione ACN</label> <textarea id="incident-acn-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
             </div>
            </div>
           </div>
          </div>
          <div class="flex justify-between items-center pt-6 border-t"><button type="button" onclick="saveDraft()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg><span>Salva Bozza</span> </button>
           <div class="flex space-x-4"><button type="button" onclick="resetIncidentForm()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg"> Annulla </button> <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
             </svg><span>Salva Incidente</span> </button>
           </div>
          </div>
         </form>
        </div><!-- Incident Sub-tab Content: Drafts -->
        <div id="incident-subcontent-drafts" class="incident-subtab-content hidden">
         <div id="drafts-list" class="space-y-4">
          <p class="text-center text-gray-500 py-8">Nessuna bozza salvata</p>
         </div>
        </div>
       </div><!-- Tab Content: Drafts -->
       <div id="incident-subcontent-drafts" class="incident-subtab-content hidden p-6">
        <div id="drafts-list" class="space-y-4">
         <p class="text-center text-gray-500 py-8">Nessuna bozza salvata</p>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div><!-- Designation Detail Section (Hidden by default) -->
   <div id="designation-detail-section" class="hidden">
    <div class="mb-6 flex items-center space-x-4"><button onclick="closeDesignationDetail()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center space-x-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg><span>Torna alla Dashboard</span> </button>
     <h2 class="text-3xl font-bold text-gray-800">ğŸ“‹ Designazione Referente CSIRT</h2>
    </div>
    <div class="bg-white rounded-xl shadow-md p-6">
     <div class="mb-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“‹ Designazione Referente CSIRT</h3>
      <p class="text-gray-600">Compila i dati del referente CSIRT, sostituti e informazioni di contatto con ACN</p>
     </div>
     <form id="designation-form" onsubmit="saveDesignation(event)">
      <div class="mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ¢ Dati Azienda</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ragione Sociale *</label> <input type="text" id="des-company-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Partita IVA *</label> <input type="text" id="des-company-vat" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label> <input type="text" id="des-company-cf" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Settore AttivitÃ  *</label> <select id="des-company-sector" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona settore</option> <option value="energia">Energia</option> <option value="trasporti">Trasporti</option> <option value="bancario">Settore Bancario</option> <option value="sanitario">SanitÃ </option> <option value="ict">ICT</option> <option value="pubblica-amministrazione">Pubblica Amministrazione</option> <option value="altro">Altro</option> </select>
        </div>
        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo Sede Legale *</label> <input type="text" id="des-company-address" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
       </div>
      </div>
      <div class="mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ‘¤ Referente CSIRT Principale</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label> <input type="text" id="des-main-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome *</label> <input type="text" id="des-main-surname" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale *</label> <input type="text" id="des-main-cf" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo in Azienda *</label> <input type="text" id="des-main-role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Email *</label> <input type="email" id="des-main-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono *</label> <input type="tel" id="des-main-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">PEC</label> <input type="email" id="des-main-pec" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
       </div>
      </div>
      <div class="mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ‘¥ Sostituto 1</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome</label> <input type="text" id="des-sub1-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label> <input type="text" id="des-sub1-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label> <input type="text" id="des-sub1-cf" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo in Azienda</label> <input type="text" id="des-sub1-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="des-sub1-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input type="tel" id="des-sub1-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
       </div>
      </div>
      <div class="mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ‘¥ Sostituto 2</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome</label> <input type="text" id="des-sub2-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label> <input type="text" id="des-sub2-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label> <input type="text" id="des-sub2-cf" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo in Azienda</label> <input type="text" id="des-sub2-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="des-sub2-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input type="tel" id="des-sub2-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
       </div>
      </div>
      <div class="mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ“ Contatto con ACN</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Email Registrata ACN</label> <input type="email" id="des-acn-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">PEC Comunicazioni ACN</label> <input type="email" id="des-acn-pec" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono Emergenze</label> <input type="tel" id="des-acn-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Registrazione Portale ACN</label> <input type="date" id="des-acn-registration-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Note Aggiuntive</label> <textarea id="des-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
        </div>
       </div>
      </div>
      <div class="flex justify-between items-center pt-6 border-t"><button type="button" onclick="generateDesignationDoc()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg><span>Genera Documento Word</span> </button>
       <div class="flex space-x-4"><button type="button" onclick="resetDesignationForm()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg"> Annulla </button> <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
         </svg><span>Salva Designazione</span> </button>
       </div>
      </div>
     </form>
    </div><!-- Network Detail Section (Hidden by default) -->
    <div id="network-detail-section" class="hidden">
     <div class="mb-6 flex items-center space-x-4"><button onclick="closeNetworkDetail()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center space-x-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
       </svg><span>Torna alla Dashboard</span> </button>
      <h2 class="text-3xl font-bold text-gray-800">ğŸŒ Configurazione Rete Aziendale</h2>
     </div>
     <div class="bg-white rounded-xl shadow-md">
      <div class="flex border-b border-gray-200"><button onclick="switchNetworkTab('visualization')" id="network-tab-visualization" class="network-tab px-6 py-4 font-medium text-blue-600 border-b-2 border-blue-600"> ğŸ“Š Visualizzazione Rete </button> <button onclick="switchNetworkTab('configuration')" id="network-tab-configuration" class="network-tab px-6 py-4 font-medium text-gray-500 hover:text-gray-700"> âš™ï¸ Configurazione Wizard </button>
      </div><!-- Tab Content: Visualization -->
      <div id="network-subcontent-visualization" class="network-tab-content p-6"><!-- Network Diagram Visualization -->
       <div id="network-visualization" class="mb-8 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-8 border-2 border-gray-200">
        <h4 class="text-xl font-bold text-gray-800 mb-6 text-center">ğŸ“Š Diagramma Architettura Rete</h4><!-- SVG Network Diagram -->
        <svg id="network-diagram" viewbox="0 0 800 600" class="w-full h-auto"><!-- Internet Cloud --> <g id="internet-cloud">
          <ellipse cx="400" cy="80" rx="80" ry="50" fill="#3b82f6" opacity="0.2" stroke="#3b82f6" stroke-width="2" />
          <text x="400" y="85" text-anchor="middle" fill="#1e40af" font-weight="bold" font-size="14">
           â˜ï¸ INTERNET
          </text>
         </g> <!-- Connection Line --> <line x1="400" y1="130" x2="400" y2="180" stroke="#6b7280" stroke-width="2" stroke-dasharray="5,5" /> <!-- Firewall --> <g id="firewall">
          <rect x="350" y="180" width="100" height="60" rx="8" fill="#ef4444" opacity="0.2" stroke="#ef4444" stroke-width="2" />
          <text x="400" y="205" text-anchor="middle" fill="#991b1b" font-weight="bold" font-size="12">
           ğŸ›¡ï¸ FIREWALL
          </text>
          <text x="400" y="225" text-anchor="middle" fill="#991b1b" font-size="10" id="firewall-label">
           NGF
          </text>
         </g> <!-- Connection Lines to Internal Network --> <line x1="400" y1="240" x2="400" y2="280" stroke="#6b7280" stroke-width="2" /> <line x1="400" y1="280" x2="250" y2="350" stroke="#6b7280" stroke-width="2" /> <line x1="400" y1="280" x2="400" y2="350" stroke="#6b7280" stroke-width="2" /> <line x1="400" y1="280" x2="550" y2="350" stroke="#6b7280" stroke-width="2" /> <!-- VLAN 1 - Admin --> <g id="vlan-admin">
          <rect x="150" y="350" width="200" height="200" rx="12" fill="#8b5cf6" opacity="0.1" stroke="#8b5cf6" stroke-width="2" stroke-dasharray="8,4" />
          <text x="250" y="375" text-anchor="middle" fill="#6b21a8" font-weight="bold" font-size="12">
           VLAN 10 - Admin
          </text>
          <rect x="180" y="390" width="60" height="50" rx="4" fill="#8b5cf6" opacity="0.3" stroke="#8b5cf6" stroke-width="1" />
          <text x="210" y="420" text-anchor="middle" font-size="20">
           ğŸ’»
          </text>
          <rect x="260" y="390" width="60" height="50" rx="4" fill="#8b5cf6" opacity="0.3" stroke="#8b5cf6" stroke-width="1" />
          <text x="290" y="420" text-anchor="middle" font-size="20">
           ğŸ’»
          </text>
          <rect x="180" y="460" width="60" height="50" rx="4" fill="#8b5cf6" opacity="0.3" stroke="#8b5cf6" stroke-width="1" />
          <text x="210" y="490" text-anchor="middle" font-size="20">
           ğŸ–¥ï¸
          </text>
          <rect x="260" y="460" width="60" height="50" rx="4" fill="#8b5cf6" opacity="0.3" stroke="#8b5cf6" stroke-width="1" />
          <text x="290" y="490" text-anchor="middle" font-size="20">
           ğŸ–¥ï¸
          </text>
         </g> <!-- VLAN 2 - Production --> <g id="vlan-production">
          <rect x="450" y="350" width="200" height="200" rx="12" fill="#10b981" opacity="0.1" stroke="#10b981" stroke-width="2" stroke-dasharray="8,4" />
          <text x="550" y="375" text-anchor="middle" fill="#047857" font-weight="bold" font-size="12">
           VLAN 20 - Produzione
          </text>
          <rect x="480" y="390" width="60" height="50" rx="4" fill="#10b981" opacity="0.3" stroke="#10b981" stroke-width="1" />
          <text x="510" y="420" text-anchor="middle" font-size="20">
           ğŸ–¥ï¸
          </text>
          <rect x="560" y="390" width="60" height="50" rx="4" fill="#10b981" opacity="0.3" stroke="#10b981" stroke-width="1" />
          <text x="590" y="420" text-anchor="middle" font-size="20">
           ğŸ–¥ï¸
          </text>
          <rect x="480" y="460" width="60" height="50" rx="4" fill="#10b981" opacity="0.3" stroke="#10b981" stroke-width="1" />
          <text x="510" y="490" text-anchor="middle" font-size="20">
           ğŸ’¼
          </text>
          <rect x="560" y="460" width="60" height="50" rx="4" fill="#10b981" opacity="0.3" stroke="#10b981" stroke-width="1" />
          <text x="590" y="490" text-anchor="middle" font-size="20">
           ğŸ“Š
          </text>
         </g> <!-- DMZ --> <g id="vlan-dmz">
          <rect x="300" y="350" width="200" height="120" rx="12" fill="#f59e0b" opacity="0.1" stroke="#f59e0b" stroke-width="2" stroke-dasharray="8,4" />
          <text x="400" y="375" text-anchor="middle" fill="#b45309" font-weight="bold" font-size="12">
           DMZ - Zona Pubblica
          </text>
          <rect x="330" y="390" width="60" height="60" rx="4" fill="#f59e0b" opacity="0.3" stroke="#f59e0b" stroke-width="1" />
          <text x="360" y="425" text-anchor="middle" font-size="24">
           ğŸŒ
          </text>
          <text x="360" y="445" text-anchor="middle" font-size="8">
           Web Server
          </text>
          <rect x="410" y="390" width="60" height="60" rx="4" fill="#f59e0b" opacity="0.3" stroke="#f59e0b" stroke-width="1" />
          <text x="440" y="425" text-anchor="middle" font-size="24">
           ğŸ“§
          </text>
          <text x="440" y="445" text-anchor="middle" font-size="8">
           Mail Server
          </text>
         </g>
        </svg><!-- Network Stats -->
        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
         <div class="bg-white rounded-lg p-4 text-center shadow">
          <div class="text-2xl font-bold text-blue-600" id="stat-sites">
           -
          </div>
          <div class="text-xs text-gray-600">
           Sedi
          </div>
         </div>
         <div class="bg-white rounded-lg p-4 text-center shadow">
          <div class="text-2xl font-bold text-green-600" id="stat-users">
           -
          </div>
          <div class="text-xs text-gray-600">
           Utenti
          </div>
         </div>
         <div class="bg-white rounded-lg p-4 text-center shadow">
          <div class="text-2xl font-bold text-purple-600" id="stat-vlans">
           -
          </div>
          <div class="text-xs text-gray-600">
           VLAN
          </div>
         </div>
         <div class="bg-white rounded-lg p-4 text-center shadow">
          <div class="text-2xl font-bold text-orange-600" id="stat-security">
           -
          </div>
          <div class="text-xs text-gray-600">
           Livello Sicurezza
          </div>
         </div>
        </div>
       </div><!-- Tab Content: Configuration -->
       <div id="network-subcontent-configuration" class="network-tab-content hidden p-6">
        <p class="text-gray-600 mb-6">Utilizza il wizard per configurare l'architettura di rete aziendale in 5 step</p><button onclick="showSection('network')" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
         </svg><span>Apri Configurazione Wizard</span> </button>
       </div>
      </div>
     </div> <!-- Companies Section -->
     <section id="companies-section" class="section-content hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ¢ Gestione Aziende</h2>
      <p class="text-gray-600 mb-6">Gestisci le aziende registrate sulla piattaforma e monitora il loro stato di compliance</p>
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <div class="flex justify-between items-center mb-6">
        <div class="flex space-x-4"><input type="text" id="search-companies" placeholder="ğŸ” Cerca aziende..." class="px-4 py-2 border border-gray-300 rounded-lg w-64" oninput="filterCompanies()"> <select id="filter-company-status" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterCompanies()"> <option value="">Tutti gli stati</option> <option value="attivo">Attivo</option> <option value="sospeso">Sospeso</option> <option value="in-valutazione">In Valutazione</option> </select>
        </div><button onclick="openAddCompanyModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
         </svg><span>Nuova Azienda</span> </button>
       </div>
       <div id="companies-list" class="space-y-4"><!-- Companies will be rendered here -->
       </div>
      </div>
     </section><!-- Users Section -->
     <section id="users-section" class="section-content hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ‘¥ Gestione Utenti</h2>
      <p class="text-gray-600 mb-6">Gestisci gli utenti della piattaforma e i loro permessi</p>
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <div class="flex justify-between items-center mb-6">
        <div class="flex space-x-4"><input type="text" id="search-users" placeholder="ï¿½ï¿½ Cerca utenti..." class="px-4 py-2 border border-gray-300 rounded-lg w-64" oninput="filterUsers()"> <select id="filter-user-role" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterUsers()"> <option value="">Tutti i ruoli</option> <option value="admin">Amministratore</option> <option value="csirt">Consulente CSIRT</option> <option value="azienda">Referente Aziendale</option> </select> <select id="filter-user-status" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterUsers()"> <option value="">Tutti gli stati</option> <option value="attivo">Attivo</option> <option value="sospeso">Sospeso</option> </select>
        </div><button onclick="openAddUserModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
         </svg><span>Nuovo Utente</span> </button>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead class="bg-gray-50 border-b-2 border-gray-200">
          <tr>
           <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utente</th>
           <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
           <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ruolo</th>
           <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azienda</th>
           <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
           <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ultimo Accesso</th>
           <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
          </tr>
         </thead>
         <tbody id="users-table-body" class="bg-white divide-y divide-gray-200"><!-- Users will be rendered here -->
         </tbody>
        </table>
       </div>
      </div>
     </section><!-- Notifications Section (Placeholder) -->
     <section id="notifications-section" class="section-content hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Notifiche ACN</h2>
      <div class="bg-white rounded-xl shadow-md p-6">
       <p class="text-gray-600">Sezione notifiche in costruzione...</p>
      </div>
     </section><!-- Incidents Section -->
     <section id="incidents-section" class="section-content hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸš¨ Registro Incidenti di Sicurezza</h2>
      <p class="text-gray-600 mb-6">Documenta e traccia tutti gli incidenti secondo i requisiti NIS2</p><!-- Tabs Navigation -->
      <div class="bg-white rounded-t-xl shadow-md">
       <div class="flex border-b border-gray-200"><button onclick="switchIncidentTab('list')" id="tab-list" class="incident-tab px-6 py-4 font-medium text-blue-600 border-b-2 border-blue-600"> ğŸ“‹ Lista Incidenti </button> <button onclick="switchIncidentTab('new')" id="tab-new" class="incident-tab px-6 py-4 font-medium text-gray-500 hover:text-gray-700"> ï¿½ï¿½ï¿½ Nuovo Incidente </button> <button onclick="switchIncidentTab('drafts')" id="tab-drafts" class="incident-tab px-6 py-4 font-medium text-gray-500 hover:text-gray-700"> ğŸ’¾ Bozze </button>
       </div>
      </div><!-- Tab Content: List -->
      <div id="incident-tab-list" class="incident-tab-content bg-white rounded-b-xl shadow-md p-6">
       <div class="flex justify-between items-center mb-6">
        <div class="flex space-x-4"><input type="text" id="search-incidents" placeholder="ï¿½ï¿½ï¿½ï¿½ Cerca incidenti..." class="px-4 py-2 border border-gray-300 rounded-lg w-64"> <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Tutti gli stati</option> <option value="aperto">Aperto</option> <option value="in-corso">In Corso</option> <option value="risolto">Risolto</option> </select>
        </div><button onclick="exportIncidents()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center space-x-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg><span>Esporta</span> </button>
       </div>
       <div id="incidents-list" class="space-y-4">
        <p class="text-center text-gray-500 py-8">Nessun incidente registrato</p>
       </div>
      </div><!-- Tab Content: New Incident -->
      <div id="incident-tab-new" class="incident-tab-content hidden bg-white rounded-b-xl shadow-md p-6">
       <form id="incident-form" onsubmit="saveIncident(event)"><!-- Section 1: Dati Generali -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ“‹ Dati Generali Incidente</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Titolo Incidente *</label> <input type="text" id="incident-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Data/Ora Rilevamento *</label> <input type="datetime-local" id="incident-datetime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">GravitÃ  *</label> <select id="incident-severity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona gravitÃ </option> <option value="critical">ğŸ”´ Critica</option> <option value="high">ğŸŸ  Alta</option> <option value="medium">ğŸŸ¡ Media</option> <option value="low">ï¿½ï¿½ï¿½ Bassa</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Stato *</label> <select id="incident-status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="aperto">Aperto</option> <option value="in-corso">In Corso</option> <option value="risolto">Risolto</option> </select>
          </div>
          <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Descrizione Incidente *</label> <textarea id="incident-description" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
          </div>
         </div>
        </div><!-- Section 2: Categorizzazione -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ·ï¸ Categorizzazione</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo Incidente *</label> <select id="incident-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona tipo</option> <option value="malware">Malware</option> <option value="phishing">Phishing</option> <option value="ddos">DDoS</option> <option value="data-breach">Data Breach</option> <option value="ransomware">Ransomware</option> <option value="accesso-non-autorizzato">Accesso Non Autorizzato</option> <option value="altro">Altro</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Servizio/Asset Colpito</label> <input type="text" id="incident-asset" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
        </div><!-- Section 3: Impatto -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ’¥ Impatto dell'Incidente</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Utenti Coinvolti</label> <input type="number" id="incident-users" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Durata Interruzione (ore)</label> <input type="number" id="incident-duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Descrizione Impatto</label> <textarea id="incident-impact" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
          </div>
          <div class="md:col-span-2"><label class="flex items-center space-x-2"> <input type="checkbox" id="incident-data-loss" class="w-4 h-4 text-blue-600"> <span class="text-sm font-medium text-gray-700">Perdita/Compromissione Dati</span> </label>
          </div>
         </div>
        </div><!-- Section 4: Azioni Intraprese -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ› ï¸ Azioni Intraprese</h3>
         <div class="space-y-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Misure di Contenimento</label> <textarea id="incident-containment" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Descrivere le azioni immediate per contenere l'incidente"></textarea>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Azioni Correttive</label> <textarea id="incident-corrective" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Descrivere le azioni per risolvere l'incidente"></textarea>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Raccomandazioni Future</label> <textarea id="incident-recommendations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Raccomandazioni per prevenire incidenti simili"></textarea>
          </div>
         </div>
        </div><!-- Section 5: Notifica ACN -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">ğŸ“¢ Notifica ACN</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="flex items-center space-x-2 mb-4"> <input type="checkbox" id="incident-acn-required" class="w-4 h-4 text-blue-600" onchange="toggleACNFields()"> <span class="text-sm font-medium text-gray-700">Richiede Notifica ACN</span> </label>
          </div>
          <div></div>
          <div id="acn-fields" class="md:col-span-2 hidden space-y-4">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Notifica Iniziale</label> <input type="datetime-local" id="incident-acn-date-initial" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Notifica Intermedia</label> <input type="datetime-local" id="incident-acn-date-intermediate" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Notifica Finale</label> <input type="datetime-local" id="incident-acn-date-final" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Protocollo ACN</label> <input type="text" id="incident-acn-protocol" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Note Comunicazione ACN</label> <textarea id="incident-acn-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
           </div>
          </div>
         </div>
        </div><!-- Form Actions -->
        <div class="flex justify-between items-center pt-6 border-t"><button type="button" onclick="saveDraft()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
          </svg><span>Salva Bozza</span> </button>
         <div class="flex space-x-4"><button type="button" onclick="resetIncidentForm()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg"> Annulla </button> <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg><span>Salva Incidente</span> </button>
         </div>
        </div>
       </form>
      </div><!-- Tab Content: Drafts -->
      <div id="incident-tab-drafts" class="incident-tab-content hidden bg-white rounded-b-xl shadow-md p-6">
       <div id="drafts-list" class="space-y-4">
        <p class="text-center text-gray-500 py-8">Nessuna bozza salvata</p>
       </div>
      </div>
     </section><!-- Designation Detail Section -->
     <section id="designation-detail-section" class="section-content hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“‹ Designazione Referente CSIRT</h2>
      <p class="text-gray-600 mb-6">Compila i dati del referente CSIRT, sostituti e informazioni di contatto con ACN</p>
      <div class="bg-white rounded-xl shadow-md p-6">
       <form id="designation-form" onsubmit="saveDesignation(event)"><!-- Section 1: Dati Azienda -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ¢ Dati Azienda</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Ragione Sociale *</label> <input type="text" id="des-company-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Partita IVA *</label> <input type="text" id="des-company-vat" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label> <input type="text" id="des-company-cf" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Settore AttivitÃ  *</label> <select id="des-company-sector" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona settore</option> <option value="energia">Energia</option> <option value="trasporti">Trasporti</option> <option value="bancario">Settore Bancario</option> <option value="sanitario">SanitÃ </option> <option value="ict">ICT</option> <option value="pubblica-amministrazione">Pubblica Amministrazione</option> <option value="altro">Altro</option> </select>
          </div>
          <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo Sede Legale *</label> <input type="text" id="des-company-address" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
        </div><!-- Section 2: Referente CSIRT Principale -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ‘¤ Referente CSIRT Principale</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label> <input type="text" id="des-main-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome *</label> <input type="text" id="des-main-surname" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale *</label> <input type="text" id="des-main-cf" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo in Azienda *</label> <input type="text" id="des-main-role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Email *</label> <input type="email" id="des-main-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono *</label> <input type="tel" id="des-main-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">PEC</label> <input type="email" id="des-main-pec" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
        </div><!-- Section 3: Sostituto 1 -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ‘¥ Sostituto 1</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome</label> <input type="text" id="des-sub1-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label> <input type="text" id="des-sub1-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label> <input type="text" id="des-sub1-cf" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo in Azienda</label> <input type="text" id="des-sub1-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="des-sub1-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input type="tel" id="des-sub1-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
        </div><!-- Section 4: Sostituto 2 -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ğŸ‘¥ Sostituto 2</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome</label> <input type="text" id="des-sub2-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label> <input type="text" id="des-sub2-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label> <input type="text" id="des-sub2-cf" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Ruolo in Azienda</label> <input type="text" id="des-sub2-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="des-sub2-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label> <input type="tel" id="des-sub2-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
        </div><!-- Section 5: Contatto ACN -->
        <div class="mb-8">
         <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500">ï¿½ï¿½ Contatto con ACN</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Email Registrata ACN</label> <input type="email" id="des-acn-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">PEC Comunicazioni ACN</label> <input type="email" id="des-acn-pec" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefono Emergenze</label> <input type="tel" id="des-acn-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Data Registrazione Portale ACN</label> <input type="date" id="des-acn-registration-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Note Aggiuntive</label> <textarea id="des-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
          </div>
         </div>
        </div><!-- Form Actions -->
        <div class="flex justify-between items-center pt-6 border-t"><button type="button" onclick="generateDesignationDoc()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg><span>Genera Documento Word</span> </button>
         <div class="flex space-x-4"><button type="button" onclick="resetDesignationForm()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg"> Annulla </button> <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg><span>Salva Designazione</span> </button>
         </div>
        </div>
       </form>
      </div>
     </section><!-- Network Section -->
     <section id="network-section" class="section-content hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸŒ Configurazione Rete Aziendale</h2>
      <p class="text-gray-600 mb-6">Definisci l'architettura di rete, sicurezza perimetrale e connettivitÃ  secondo NIS2</p>
      <div class="bg-white rounded-xl shadow-md p-6"><!-- Progress Steps -->
       <div class="mb-8">
        <div class="flex items-center justify-between">
         <div class="flex-1">
          <div class="flex items-center">
           <div id="step-indicator-1" class="step-indicator active flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white font-bold">
            1
           </div>
           <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
           <div id="step-indicator-2" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
            2
           </div>
           <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
           <div id="step-indicator-3" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
            3
           </div>
           <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
           <div id="step-indicator-4" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
            4
           </div>
           <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
           <div id="step-indicator-5" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
            5
           </div>
          </div>
          <div class="flex justify-between mt-2 text-xs text-gray-600"><span>Topologia</span> <span>Sicurezza</span> <span>ConnettivitÃ </span> <span>Monitoraggio</span> <span>Riepilogo</span>
          </div>
         </div>
        </div>
       </div>
       <form id="network-form" onsubmit="saveNetworkConfig(event)"><!-- Step 1: Topologia Rete -->
        <div id="network-step-1" class="network-step">
         <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ”· Step 1: Topologia Rete</h3>
         <div class="space-y-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Tipologia Rete *</label> <select id="net-topology-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona tipologia</option> <option value="lan">LAN (Local Area Network)</option> <option value="wan">WAN (Wide Area Network)</option> <option value="hybrid">Ibrida (LAN + WAN)</option> <option value="cloud">Cloud-Based</option> <option value="sdwan">SD-WAN</option> </select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Sedi *</label> <input type="number" id="net-sites-count" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Numero Utenti Totali *</label> <input type="number" id="net-users-count" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Segmentazione Rete *</label> <select id="net-segmentation" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona livello segmentazione</option> <option value="none">Nessuna segmentazione</option> <option value="basic">Base (VLAN separate)</option> <option value="advanced">Avanzata (DMZ, Zone trusted/untrusted)</option> <option value="zero-trust">Zero Trust Architecture</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">VLAN Configurate</label> <textarea id="net-vlans" rows="3" placeholder="Es: VLAN 10 - Amministrazione, VLAN 20 - Produzione, VLAN 30 - DMZ" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Indirizzamento IP *</label>
           <div class="space-y-2"><label class="flex items-center space-x-2"> <input type="radio" name="ip-addressing" value="ipv4" required class="w-4 h-4 text-blue-600"> <span>Solo IPv4</span> </label> <label class="flex items-center space-x-2"> <input type="radio" name="ip-addressing" value="ipv6" class="w-4 h-4 text-blue-600"> <span>Solo IPv6</span> </label> <label class="flex items-center space-x-2"> <input type="radio" name="ip-addressing" value="dual-stack" class="w-4 h-4 text-blue-600"> <span>Dual Stack (IPv4 + IPv6)</span> </label>
           </div>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Range IP Principali</label> <input type="text" id="net-ip-ranges" placeholder="Es: 192.168.1.0/24, 10.0.0.0/16" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
        </div><!-- Step 2: Sicurezza Perimetrale -->
        <div id="network-step-2" class="network-step hidden">
         <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ›¡ï¸ Step 2: Sicurezza Perimetrale</h3>
         <div class="space-y-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Firewall Perimetrale *</label> <select id="net-firewall-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona tipo firewall</option> <option value="hardware">Hardware Dedicato</option> <option value="software">Software/Virtual</option> <option value="ngfw">Next-Generation Firewall (NGFW)</option> <option value="cloud">Cloud-based (FWaaS)</option> <option value="none">Nessun firewall</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Marca/Modello Firewall</label> <input type="text" id="net-firewall-model" placeholder="Es: Fortinet FortiGate 100F, Cisco ASA 5506" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-3">FunzionalitÃ  Firewall Attive</label>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-3"><label class="flex items-center space-x-2"> <input type="checkbox" id="fw-stateful" class="w-4 h-4 text-blue-600"> <span class="text-sm">Stateful Inspection</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="fw-ips" class="w-4 h-4 text-blue-600"> <span class="text-sm">IPS/IDS</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="fw-av" class="w-4 h-4 text-blue-600"> <span class="text-sm">Antivirus Gateway</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="fw-web-filter" class="w-4 h-4 text-blue-600"> <span class="text-sm">Web Filtering</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="fw-app-control" class="w-4 h-4 text-blue-600"> <span class="text-sm">Application Control</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="fw-ssl-inspect" class="w-4 h-4 text-blue-600"> <span class="text-sm">SSL/TLS Inspection</span> </label>
           </div>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Sistema WAF (Web Application Firewall) *</label> <select id="net-waf" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="yes-dedicated">SÃ¬ - WAF Dedicato</option> <option value="yes-integrated">SÃ¬ - Integrato nel Firewall</option> <option value="yes-cloud">SÃ¬ - Cloud WAF (es. Cloudflare, AWS WAF)</option> <option value="no">No - Non implementato</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Antimalware/EDR *</label> <select id="net-antimalware" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="edr">EDR (Endpoint Detection &amp; Response)</option> <option value="traditional">Antivirus Tradizionale</option> <option value="xdr">XDR (Extended Detection &amp; Response)</option> <option value="none">Nessuno</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Soluzione Antimalware Utilizzata</label> <input type="text" id="net-antimalware-product" placeholder="Es: CrowdStrike Falcon, Microsoft Defender ATP" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Email Security Gateway *</label> <select id="net-email-security" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="yes-dedicated">SÃ¬ - Gateway Dedicato</option> <option value="yes-cloud">SÃ¬ - Cloud-based (es. Proofpoint, Mimecast)</option> <option value="basic">Protezione base provider email</option> <option value="no">Nessuna protezione avanzata</option> </select>
          </div>
         </div>
        </div><!-- Step 3: ConnettivitÃ  e Accessi -->
        <div id="network-step-3" class="network-step hidden">
         <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ”Œ Step 3: ConnettivitÃ  e Accessi</h3>
         <div class="space-y-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">ConnettivitÃ  Internet *</label> <select id="net-internet-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona tipo connessione</option> <option value="fiber">Fibra Ottica</option> <option value="adsl">ADSL/VDSL</option> <option value="leased-line">Linea Dedicata</option> <option value="4g-5g">4G/5G</option> <option value="satellite">Satellite</option> <option value="redundant">Ridondante (Multipli ISP)</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Provider Internet</label> <input type="text" id="net-isp" placeholder="Es: TIM, Vodafone, Fastweb" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Banda Download (Mbps)</label> <input type="number" id="net-bandwidth-down" placeholder="Es: 1000" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-2">Banda Upload (Mbps)</label> <input type="number" id="net-bandwidth-up" placeholder="Es: 300" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           </div>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">VPN Configurata *</label> <select id="net-vpn-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="site-to-site">Site-to-Site VPN</option> <option value="remote-access">Remote Access VPN</option> <option value="both">Entrambe (Site-to-Site + Remote Access)</option> <option value="ssl-vpn">SSL VPN</option> <option value="ipsec">IPsec VPN</option> <option value="none">Nessuna VPN</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Soluzione VPN Utilizzata</label> <input type="text" id="net-vpn-solution" placeholder="Es: Cisco AnyConnect, OpenVPN, FortiClient" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Autenticazione Multifattore (MFA) *</label> <select id="net-mfa" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="yes-all">SÃ¬ - Tutti gli accessi remoti</option> <option value="yes-critical">SÃ¬ - Solo sistemi critici</option> <option value="yes-admin">SÃ¬ - Solo account amministrativi</option> <option value="no">No - Non implementata</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Soluzione MFA</label> <input type="text" id="net-mfa-solution" placeholder="Es: Microsoft Authenticator, Google Authenticator, Duo Security" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Wi-Fi Aziendale *</label> <select id="net-wifi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="yes-segmented">SÃ¬ - Reti separate (Corporate/Guest)</option> <option value="yes-single">SÃ¬ - Rete singola</option> <option value="yes-wpa3">SÃ¬ - Con WPA3</option> <option value="no">No Wi-Fi</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Autenticazione Wi-Fi Aziendale</label> <select id="net-wifi-auth" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="wpa3-enterprise">WPA3-Enterprise (802.1X)</option> <option value="wpa2-enterprise">WPA2-Enterprise (802.1X)</option> <option value="wpa2-psk">WPA2-PSK</option> <option value="captive-portal">Captive Portal</option> <option value="open">Aperta (non raccomandato)</option> </select>
          </div>
         </div>
        </div><!-- Step 4: Monitoraggio e Logging -->
        <div id="network-step-4" class="network-step hidden">
         <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“Š Step 4: Monitoraggio e Logging</h3>
         <div class="space-y-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">SIEM (Security Information &amp; Event Management) *</label> <select id="net-siem" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="yes-dedicated">SÃ¬ - SIEM Dedicato</option> <option value="yes-cloud">SÃ¬ - Cloud SIEM (es. Splunk Cloud, Azure Sentinel)</option> <option value="basic-logging">Logging centralizzato base</option> <option value="no">Nessun SIEM</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Soluzione SIEM/Log Management</label> <input type="text" id="net-siem-product" placeholder="Es: Splunk, QRadar, Elastic SIEM, Azure Sentinel" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Retention Log (giorni) *</label> <input type="number" id="net-log-retention" required min="1" placeholder="Es: 365" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
           <p class="text-xs text-gray-500 mt-1">NIS2 richiede almeno 6 mesi (180 giorni)</p>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-3">Tipologie di Log Raccolti *</label>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-3"><label class="flex items-center space-x-2"> <input type="checkbox" id="log-firewall" class="w-4 h-4 text-blue-600"> <span class="text-sm">Firewall</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="log-authentication" class="w-4 h-4 text-blue-600"> <span class="text-sm">Autenticazione</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="log-vpn" class="w-4 h-4 text-blue-600"> <span class="text-sm">VPN</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="log-email" class="w-4 h-4 text-blue-600"> <span class="text-sm">Email Gateway</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="log-web" class="w-4 h-4 text-blue-600"> <span class="text-sm">Web Proxy</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="log-dns" class="w-4 h-4 text-blue-600"> <span class="text-sm">DNS</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="log-dhcp" class="w-4 h-4 text-blue-600"> <span class="text-sm">DHCP</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="log-endpoints" class="w-4 h-4 text-blue-600"> <span class="text-sm">Endpoint (EDR)</span> </label>
           </div>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Monitoraggio Network in Tempo Reale *</label> <select id="net-monitoring" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="yes-24x7">SÃ¬ - 24x7 con SOC</option> <option value="yes-automated">SÃ¬ - Automatizzato con alerting</option> <option value="yes-business-hours">SÃ¬ - Solo orario lavorativo</option> <option value="basic">Base - Controlli periodici</option> <option value="no">Nessun monitoraggio attivo</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Tool di Network Monitoring</label> <input type="text" id="net-monitoring-tool" placeholder="Es: PRTG, Nagios, Zabbix, SolarWinds" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Vulnerability Assessment *</label> <select id="net-vulnerability-scan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleziona</option> <option value="continuous">Continuo</option> <option value="monthly">Mensile</option> <option value="quarterly">Trimestrale</option> <option value="yearly">Annuale</option> <option value="none">Mai eseguito</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Tool Vulnerability Scanning</label> <input type="text" id="net-vuln-tool" placeholder="Es: Nessus, Qualys, OpenVAS, Rapid7" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
        </div><!-- Step 5: Riepilogo -->
        <div id="network-step-5" class="network-step hidden">
         <h3 class="text-2xl font-bold text-gray-800 mb-6">âœ… Step 5: Riepilogo Configurazione</h3>
         <div id="network-summary" class="space-y-6"><!-- Summary will be generated dynamically -->
         </div>
        </div><!-- Navigation Buttons -->
        <div class="flex justify-between items-center pt-6 border-t mt-8"><button type="button" id="network-prev-btn" onclick="previousNetworkStep()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg hidden"> â† Indietro </button>
         <div class="flex space-x-4 ml-auto"><button type="button" onclick="resetNetworkForm()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"> Reset </button> <button type="button" id="network-next-btn" onclick="nextNetworkStep()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"> Avanti â†’ </button> <button type="submit" id="network-submit-btn" class="hidden px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center space-x-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg><span>Salva Configurazione</span> </button>
         </div>
        </div>
       </form>
      </div>
     </section>
    </div>
   </div>
   <script>
    // === GLOBAL STATE ===
    let currentUser = null;

    const DEMO_USERS = [
      { email: 'admin@csirt.it', password: 'admin123', role: 'admin', name: 'Admin Sistema', company: null },
      { email: 'csirt@hub.it', password: 'csirt123', role: 'csirt', name: 'Marco Rossi', company: null },
      { email: 'azienda@test.it', password: 'azienda123', role: 'azienda', name: 'Giuseppe Verdi', company: 'Azienda Test SRL' }
    ];

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
      checkExistingSession();
    });

    // === LOGIN FUNCTIONS ===
    function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const role = document.getElementById('login-role').value;
      
      const user = DEMO_USERS.find(u => 
        u.email === email && 
        u.password === password && 
        u.role === role
      );
      
      if (user) {
        currentUser = {
          email: user.email,
          role: user.role,
          name: user.name,
          company: user.company
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showMainApp();
      } else {
        const existingError = document.querySelector('#login-error-message');
        if (existingError) existingError.remove();
        
        const statusDiv = document.createElement('div');
        statusDiv.id = 'login-error-message';
        statusDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm';
        statusDiv.innerHTML = `
          <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div>
              <strong class="font-semibold">âŒ Credenziali non valide</strong>
              <div class="mt-2 text-xs">
                Verifica email, password e ruolo
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('login-form').appendChild(statusDiv);
        setTimeout(() => statusDiv.remove(), 6000);
      }
    }
    
    function checkExistingSession() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
      }
    }
    
    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
      
      document.getElementById('user-name').textContent = currentUser.name;
      
      const roleLabels = {
        'admin': 'Amministratore',
        'csirt': 'Consulente CSIRT',
        'azienda': 'Referente Aziendale'
      };
      document.getElementById('user-role').textContent = roleLabels[currentUser.role];
      
      filterSidebarByRole();
      loadDashboardData();
      
      if (currentUser.role === 'csirt') {
        document.getElementById('csirt-dashboard-cards').classList.remove('hidden');
        updateIncidentCount();
        updateDesignationStatus();
        updateNetworkStatus();
      }
      
      // Load admin sections if admin
      if (currentUser.role === 'admin') {
        renderCompaniesList();
        renderUsersTable();
      }
    }
    
    function filterSidebarByRole() {
      const navItems = document.querySelectorAll('.nav-item[data-role]');
      navItems.forEach(item => {
        const allowedRoles = item.getAttribute('data-role').split(',');
        if (!allowedRoles.includes(currentUser.role)) {
          item.style.display = 'none';
        } else {
          item.style.display = 'flex';
        }
      });
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-form').reset();
    }
    
    // === NAVIGATION ===
    function showSection(sectionName) {
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
      });
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
      });
      
      const section = document.getElementById(sectionName + '-section');
      if (section) {
        section.classList.remove('hidden');
      }
      
      if (event && event.target) {
        event.target.closest('.nav-item').classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
      }
      
      // Load section-specific data
      if (sectionName === 'companies') {
        renderCompaniesList();
      } else if (sectionName === 'users') {
        renderUsersTable();
      } else if (sectionName === 'incidents') {
        renderIncidentsList();
      }
    }
    
    function loadDashboardData() {
      document.getElementById('total-companies').textContent = '0';
      document.getElementById('open-incidents').textContent = '0';
      document.getElementById('pending-notifications').textContent = '0';
      document.getElementById('compliance-score').textContent = '85%';
    }
    
    // === UTILITY FUNCTIONS ===
    function showSuccessMessage(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    function showErrorMessage(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // === CSIRT DASHBOARD CARDS MANAGEMENT ===
    function openIncidentsDetail() {
      document.getElementById('csirt-dashboard-cards').classList.add('hidden');
      document.getElementById('incidents-detail-section').classList.remove('hidden');
      renderIncidentsList();
      updateIncidentCount();
    }
    
    function closeIncidentsDetail() {
      document.getElementById('incidents-detail-section').classList.add('hidden');
      document.getElementById('csirt-dashboard-cards').classList.remove('hidden');
    }
    
    function openDesignationDetail() {
      document.getElementById('csirt-dashboard-cards').classList.add('hidden');
      document.getElementById('designation-detail-section').classList.remove('hidden');
      updateDesignationStatus();
    }
    
    function closeDesignationDetail() {
      document.getElementById('designation-detail-section').classList.add('hidden');
      document.getElementById('csirt-dashboard-cards').classList.remove('hidden');
    }
    
    function openNetworkDetail() {
      document.getElementById('csirt-dashboard-cards').classList.add('hidden');
      document.getElementById('network-detail-section').classList.remove('hidden');
      loadNetworkVisualization();
      updateNetworkStatus();
    }
    
    function closeNetworkDetail() {
      document.getElementById('network-detail-section').classList.add('hidden');
      document.getElementById('csirt-dashboard-cards').classList.remove('hidden');
    }
    
    function updateIncidentCount() {
      const count = incidents.length;
      document.getElementById('incident-count').textContent = count;
    }
    
    function updateDesignationStatus() {
      const statusElement = document.getElementById('designation-status');
      if (designationData) {
        statusElement.textContent = 'âœ… Compilato';
        statusElement.classList.remove('text-purple-600');
        statusElement.classList.add('text-green-600');
      } else {
        statusElement.textContent = 'Non compilato';
        statusElement.classList.remove('text-green-600');
        statusElement.classList.add('text-purple-600');
      }
    }
    
    function updateNetworkStatus() {
      const statusElement = document.getElementById('network-status');
      if (networkConfig) {
        statusElement.textContent = 'âœ… Configurato';
        statusElement.classList.remove('text-blue-600');
        statusElement.classList.add('text-green-600');
      } else {
        statusElement.textContent = 'Non configurato';
        statusElement.classList.remove('text-green-600');
        statusElement.classList.add('text-blue-600');
      }
    }
    function switchIncidentSubTab(tabName) {
      document.querySelectorAll('.incident-subtab').forEach(tab => {
        tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        tab.classList.add('text-gray-500');
      });
      
      document.querySelectorAll('.incident-subtab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.getElementById('incident-subtab-' + tabName).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
      document.getElementById('incident-subtab-' + tabName).classList.remove('text-gray-500');
      document.getElementById('incident-subcontent-' + tabName).classList.remove('hidden');
      
      if (tabName === 'list') {
        renderIncidentsList();
      } else if (tabName === 'drafts') {
        renderDraftsList();
      }
    }
    
    function switchNetworkTab(tabName) {
      document.querySelectorAll('.network-tab').forEach(tab => {
        tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        tab.classList.add('text-gray-500');
      });
      
      document.querySelectorAll('.network-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.getElementById('network-tab-' + tabName).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
      document.getElementById('network-tab-' + tabName).classList.remove('text-gray-500');
      document.getElementById('network-subcontent-' + tabName).classList.remove('hidden');
      
      if (tabName === 'visualization') {
        loadNetworkVisualization();
      }
    }
    
    // === INCIDENTS MANAGEMENT ===
    let incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
    let drafts = JSON.parse(localStorage.getItem('incident_drafts') || '[]');
    
    function toggleACNFields() {
      const checkbox = document.getElementById('incident-acn-required');
      const fields = document.getElementById('acn-fields');
      if (checkbox.checked) {
        fields.classList.remove('hidden');
      } else {
        fields.classList.add('hidden');
      }
    }
    
    function loadNetworkVisualization() {
      if (networkConfig) {
        document.getElementById('stat-sites').textContent = networkConfig.topology?.sites || '-';
        document.getElementById('stat-users').textContent = networkConfig.topology?.users || '-';
        
        const vlanCount = networkConfig.topology?.vlans ? networkConfig.topology.vlans.split(',').length : 0;
        document.getElementById('stat-vlans').textContent = vlanCount || '-';
        
        let securityLevel = 'Base';
        if (networkConfig.security?.firewallType && networkConfig.security?.antimalware !== 'none' && networkConfig.monitoring?.siem !== 'no') {
          securityLevel = 'Alto';
        } else if (networkConfig.security?.firewallType) {
          securityLevel = 'Medio';
        }
        document.getElementById('stat-security').textContent = securityLevel;
        
        if (networkConfig.security?.firewallType) {
          const fwLabel = getLabelFromValue('firewall-type', networkConfig.security.firewallType);
          document.getElementById('firewall-label').textContent = fwLabel.substring(0, 15);
        }
      } else {
        document.getElementById('stat-sites').textContent = '-';
        document.getElementById('stat-users').textContent = '-';
        document.getElementById('stat-vlans').textContent = '-';
        document.getElementById('stat-security').textContent = '-';
      }
    }
    
    function saveIncident(event) {
      event.preventDefault();
      
      const incident = {
        id: 'INC-' + Date.now(),
        title: document.getElementById('incident-title').value,
        datetime: document.getElementById('incident-datetime').value,
        severity: document.getElementById('incident-severity').value,
        status: document.getElementById('incident-status').value,
        description: document.getElementById('incident-description').value,
        type: document.getElementById('incident-type').value,
        asset: document.getElementById('incident-asset').value,
        users: document.getElementById('incident-users').value,
        duration: document.getElementById('incident-duration').value,
        impact: document.getElementById('incident-impact').value,
        dataLoss: document.getElementById('incident-data-loss').checked,
        containment: document.getElementById('incident-containment').value,
        corrective: document.getElementById('incident-corrective').value,
        recommendations: document.getElementById('incident-recommendations').value,
        acnRequired: document.getElementById('incident-acn-required').checked,
        acnDateInitial: document.getElementById('incident-acn-date-initial').value,
        acnDateIntermediate: document.getElementById('incident-acn-date-intermediate').value,
        acnDateFinal: document.getElementById('incident-acn-date-final').value,
        acnProtocol: document.getElementById('incident-acn-protocol').value,
        acnNotes: document.getElementById('incident-acn-notes').value,
        createdAt: new Date().toISOString(),
        createdBy: currentUser.name
      };
      
      incidents.push(incident);
      localStorage.setItem('incidents', JSON.stringify(incidents));
      
      showSuccessMessage('âœ… Incidente salvato con successo!');
      resetIncidentForm();
      switchIncidentSubTab('list');
      updateIncidentCount();
    }
    
    function resetIncidentForm() {
      document.getElementById('incident-form').reset();
      document.getElementById('acn-fields').classList.add('hidden');
    }
    
    function renderIncidentsList() {
      const container = document.getElementById('incidents-list');
      
      if (incidents.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Nessun incidente registrato</p>';
        return;
      }
      
      container.innerHTML = incidents.map(inc => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-3 mb-2">
                <h3 class="text-lg font-bold text-gray-800">${inc.title}</h3>
                <span class="status-badge status-${inc.status}">${inc.status}</span>
                <span class="status-badge severity-${inc.severity}">${getSeverityLabel(inc.severity)}</span>
              </div>
              <p class="text-sm text-gray-600 mb-2">${inc.description}</p>
              <div class="flex items-center space-x-4 text-sm text-gray-500">
                <span>ğŸ†” ${inc.id}</span>
                <span>ğŸ“… ${new Date(inc.datetime).toLocaleString('it-IT')}</span>
                <span>ğŸ‘¤ ${inc.createdBy}</span>
                ${inc.acnRequired ? '<span class="text-red-600 font-medium">ğŸ“¢ ACN Required</span>' : ''}
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="viewIncidentDetails('${inc.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded">
                Dettagli
              </button>
              <button onclick="deleteIncident('${inc.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded">
                Elimina
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function getSeverityLabel(severity) {
      const labels = {
        'critical': 'ğŸ”´ Critica',
        'high': 'ï¿½ï¿½ï¿½ Alta',
        'medium': 'ğŸŸ¡ Media',
        'low': 'ğŸ”µ Bassa'
      };
      return labels[severity] || severity;
    }
    
    function viewIncidentDetails(incidentId) {
      const incident = incidents.find(i => i.id === incidentId);
      if (!incident) return;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-xl">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold mb-2">${incident.title}</h2>
                <div class="flex space-x-2">
                  <span class="status-badge status-${incident.status}">${incident.status}</span>
                  <span class="status-badge severity-${incident.severity}">${getSeverityLabel(incident.severity)}</span>
                </div>
              </div>
              <button onclick="this.closest('.modal-overlay').remove()" class="text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="p-6 space-y-6">
            <div>
              <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ“‹ Informazioni Generali</h3>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium">ID:</span> ${incident.id}</div>
                <div><span class="font-medium">Data/Ora:</span> ${new Date(incident.datetime).toLocaleString('it-IT')}</div>
                <div><span class="font-medium">Tipo:</span> ${incident.type}</div>
                <div><span class="font-medium">Asset:</span> ${incident.asset || 'N/A'}</div>
                <div><span class="font-medium">Creato da:</span> ${incident.createdBy}</div>
                <div><span class="font-medium">Creato il:</span> ${new Date(incident.createdAt).toLocaleString('it-IT')}</div>
              </div>
            </div>
            
            <div>
              <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ“ Descrizione</h3>
              <p class="text-gray-700">${incident.description}</p>
            </div>
            
            <div>
              <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ’¥ Impatto</h3>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium">Utenti coinvolti:</span> ${incident.users || 'N/A'}</div>
                <div><span class="font-medium">Durata interruzione:</span> ${incident.duration || 'N/A'} ore</div>
                <div class="col-span-2"><span class="font-medium">Perdita dati:</span> ${incident.dataLoss ? 'âœ… SÃ¬' : 'âŒ No'}</div>
              </div>
              ${incident.impact ? `<p class="mt-2 text-gray-700">${incident.impact}</p>` : ''}
            </div>
            
            <div>
              <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ› ï¸ Azioni</h3>
              ${incident.containment ? `<div class="mb-3"><span class="font-medium">Contenimento:</span><p class="text-gray-700">${incident.containment}</p></div>` : ''}
              ${incident.corrective ? `<div class="mb-3"><span class="font-medium">Azioni correttive:</span><p class="text-gray-700">${incident.corrective}</p></div>` : ''}
              ${incident.recommendations ? `<div><span class="font-medium">Raccomandazioni:</span><p class="text-gray-700">${incident.recommendations}</p></div>` : ''}
            </div>
            
            ${incident.acnRequired ? `
              <div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ“¢ Notifica ACN</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div><span class="font-medium">Notifica iniziale:</span> ${incident.acnDateInitial ? new Date(incident.acnDateInitial).toLocaleString('it-IT') : 'N/A'}</div>
                  <div><span class="font-medium">Notifica intermedia:</span> ${incident.acnDateIntermediate ? new Date(incident.acnDateIntermediate).toLocaleString('it-IT') : 'N/A'}</div>
                  <div><span class="font-medium">Notifica finale:</span> ${incident.acnDateFinal ? new Date(incident.acnDateFinal).toLocaleString('it-IT') : 'N/A'}</div>
                  <div><span class="font-medium">Protocollo:</span> ${incident.acnProtocol || 'N/A'}</div>
                </div>
                ${incident.acnNotes ? `<p class="mt-2 text-gray-700">${incident.acnNotes}</p>` : ''}
              </div>
            ` : ''}
          </div>
          
          <div class="bg-gray-50 p-6 rounded-b-xl flex justify-end space-x-4">
            <button onclick="exportSingleIncident('${incident.id}')" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
              Esporta PDF
            </button>
            <button onclick="this.closest('.modal-overlay').remove()" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
              Chiudi
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function deleteIncident(incidentId) {
      if (confirm('Sei sicuro di voler eliminare questo incidente?')) {
        incidents = incidents.filter(i => i.id !== incidentId);
        localStorage.setItem('incidents', JSON.stringify(incidents));
        renderIncidentsList();
        updateIncidentCount();
        showSuccessMessage('âœ… Incidente eliminato');
      }
    }
    
    function saveDraft() {
      const draft = {
        id: 'DRAFT-' + Date.now(),
        title: document.getElementById('incident-title').value,
        datetime: document.getElementById('incident-datetime').value,
        severity: document.getElementById('incident-severity').value,
        status: document.getElementById('incident-status').value,
        description: document.getElementById('incident-description').value,
        type: document.getElementById('incident-type').value,
        asset: document.getElementById('incident-asset').value,
        users: document.getElementById('incident-users').value,
        duration: document.getElementById('incident-duration').value,
        impact: document.getElementById('incident-impact').value,
        dataLoss: document.getElementById('incident-data-loss').checked,
        containment: document.getElementById('incident-containment').value,
        corrective: document.getElementById('incident-corrective').value,
        recommendations: document.getElementById('incident-recommendations').value,
        acnRequired: document.getElementById('incident-acn-required').checked,
        acnDateInitial: document.getElementById('incident-acn-date-initial').value,
        acnDateIntermediate: document.getElementById('incident-acn-date-intermediate').value,
        acnDateFinal: document.getElementById('incident-acn-date-final').value,
        acnProtocol: document.getElementById('incident-acn-protocol').value,
        acnNotes: document.getElementById('incident-acn-notes').value,
        savedAt: new Date().toISOString()
      };
      
      drafts.push(draft);
      localStorage.setItem('incident_drafts', JSON.stringify(drafts));
      showSuccessMessage('ğŸ’¾ Bozza salvata!');
      resetIncidentForm();
      switchIncidentSubTab('drafts');
    }
    
    function renderDraftsList() {
      const container = document.getElementById('drafts-list');
      
      if (drafts.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Nessuna bozza salvata</p>';
        return;
      }
      
      container.innerHTML = drafts.map(draft => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="text-lg font-bold text-gray-800 mb-2">${draft.title || 'Bozza senza titolo'}</h3>
              <p class="text-sm text-gray-600 mb-2">${draft.description || 'Nessuna descrizione'}</p>
              <div class="text-sm text-gray-500">
                ğŸ’¾ Salvata il: ${new Date(draft.savedAt).toLocaleString('it-IT')}
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="loadDraft('${draft.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded">
                Carica
              </button>
              <button onclick="deleteDraft('${draft.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded">
                Elimina
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function loadDraft(draftId) {
      const draft = drafts.find(d => d.id === draftId);
      if (!draft) return;
      
      document.getElementById('incident-title').value = draft.title || '';
      document.getElementById('incident-datetime').value = draft.datetime || '';
      document.getElementById('incident-severity').value = draft.severity || '';
      document.getElementById('incident-status').value = draft.status || '';
      document.getElementById('incident-description').value = draft.description || '';
      document.getElementById('incident-type').value = draft.type || '';
      document.getElementById('incident-asset').value = draft.asset || '';
      document.getElementById('incident-users').value = draft.users || '';
      document.getElementById('incident-duration').value = draft.duration || '';
      document.getElementById('incident-impact').value = draft.impact || '';
      document.getElementById('incident-data-loss').checked = draft.dataLoss || false;
      document.getElementById('incident-containment').value = draft.containment || '';
      document.getElementById('incident-corrective').value = draft.corrective || '';
      document.getElementById('incident-recommendations').value = draft.recommendations || '';
      document.getElementById('incident-acn-required').checked = draft.acnRequired || false;
      document.getElementById('incident-acn-date-initial').value = draft.acnDateInitial || '';
      document.getElementById('incident-acn-date-intermediate').value = draft.acnDateIntermediate || '';
      document.getElementById('incident-acn-date-final').value = draft.acnDateFinal || '';
      document.getElementById('incident-acn-protocol').value = draft.acnProtocol || '';
      document.getElementById('incident-acn-notes').value = draft.acnNotes || '';
      
      if (draft.acnRequired) {
        document.getElementById('acn-fields').classList.remove('hidden');
      }
      
      switchIncidentSubTab('new');
      showSuccessMessage('ğŸ“ Bozza caricata nel form');
    }
    
    function deleteDraft(draftId) {
      if (confirm('Eliminare questa bozza?')) {
        drafts = drafts.filter(d => d.id !== draftId);
        localStorage.setItem('incident_drafts', JSON.stringify(drafts));
        renderDraftsList();
        showSuccessMessage('âœ… Bozza eliminata');
      }
    }
    
    function exportIncidents() {
      if (incidents.length === 0) {
        showErrorMessage('Nessun incidente da esportare');
        return;
      }
      
      const wb = XLSX.utils.book_new();
      const data = incidents.map(inc => ({
        'ID': inc.id,
        'Titolo': inc.title,
        'Data/Ora': new Date(inc.datetime).toLocaleString('it-IT'),
        'GravitÃ ': getSeverityLabel(inc.severity),
        'Stato': inc.status,
        'Tipo': inc.type,
        'Descrizione': inc.description,
        'Asset Colpito': inc.asset || '',
        'Utenti Coinvolti': inc.users || '',
        'Durata (ore)': inc.duration || '',
        'Notifica ACN': inc.acnRequired ? 'SÃ¬' : 'No',
        'Creato da': inc.createdBy,
        'Creato il': new Date(inc.createdAt).toLocaleString('it-IT')
      }));
      
      const ws = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'Incidenti');
      XLSX.writeFile(wb, `Registro_Incidenti_${new Date().toISOString().split('T')[0]}.xlsx`);
      showSuccessMessage('âœ… Export Excel completato!');
    }
    
    function exportSingleIncident(incidentId) {
      const incident = incidents.find(i => i.id === incidentId);
      if (!incident) return;
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('REGISTRO INCIDENTE DI SICUREZZA', 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      let y = 40;
      
      doc.text(`ID: ${incident.id}`, 20, y);
      y += 10;
      doc.text(`Titolo: ${incident.title}`, 20, y);
      y += 10;
      doc.text(`Data/Ora: ${new Date(incident.datetime).toLocaleString('it-IT')}`, 20, y);
      y += 10;
      doc.text(`GravitÃ : ${getSeverityLabel(incident.severity)}`, 20, y);
      y += 10;
      doc.text(`Stato: ${incident.status}`, 20, y);
      y += 15;
      
      doc.text('Descrizione:', 20, y);
      y += 7;
      const descLines = doc.splitTextToSize(incident.description, 170);
      doc.text(descLines, 20, y);
      
      doc.save(`Incidente_${incident.id}.pdf`);
      showSuccessMessage('âœ… PDF generato!');
    }
    
    // === NETWORK CONFIGURATION ===
    let networkConfig = JSON.parse(localStorage.getItem('network_config') || 'null');
    let currentNetworkStep = 1;
    const totalNetworkSteps = 5;
    
    function nextNetworkStep() {
      if (currentNetworkStep < totalNetworkSteps) {
        document.getElementById(`network-step-${currentNetworkStep}`).classList.add('hidden');
        currentNetworkStep++;
        document.getElementById(`network-step-${currentNetworkStep}`).classList.remove('hidden');
        updateNetworkStepIndicators();
        updateNetworkButtons();
        
        if (currentNetworkStep === totalNetworkSteps) {
          generateNetworkSummary();
        }
      }
    }
    
    function previousNetworkStep() {
      if (currentNetworkStep > 1) {
        document.getElementById(`network-step-${currentNetworkStep}`).classList.add('hidden');
        currentNetworkStep--;
        document.getElementById(`network-step-${currentNetworkStep}`).classList.remove('hidden');
        updateNetworkStepIndicators();
        updateNetworkButtons();
      }
    }
    
    function updateNetworkStepIndicators() {
      for (let i = 1; i <= totalNetworkSteps; i++) {
        const indicator = document.getElementById(`step-indicator-${i}`);
        if (i <= currentNetworkStep) {
          indicator.classList.add('bg-blue-600', 'text-white');
          indicator.classList.remove('bg-gray-300', 'text-gray-600');
        } else {
          indicator.classList.remove('bg-blue-600', 'text-white');
          indicator.classList.add('bg-gray-300', 'text-gray-600');
        }
      }
    }
    
    function updateNetworkButtons() {
      const prevBtn = document.getElementById('network-prev-btn');
      const nextBtn = document.getElementById('network-next-btn');
      const submitBtn = document.getElementById('network-submit-btn');
      
      if (currentNetworkStep === 1) {
        prevBtn.classList.add('hidden');
      } else {
        prevBtn.classList.remove('hidden');
      }
      
      if (currentNetworkStep === totalNetworkSteps) {
        nextBtn.classList.add('hidden');
        submitBtn.classList.remove('hidden');
      } else {
        nextBtn.classList.remove('hidden');
        submitBtn.classList.add('hidden');
      }
    }
    
    function generateNetworkSummary() {
      const summary = document.getElementById('network-summary');
      
      const data = {
        topology: {
          type: document.getElementById('net-topology-type').value,
          sites: document.getElementById('net-sites-count').value,
          users: document.getElementById('net-users-count').value,
          segmentation: document.getElementById('net-segmentation').value,
          vlans: document.getElementById('net-vlans').value,
          ipAddressing: document.querySelector('input[name="ip-addressing"]:checked')?.value,
          ipRanges: document.getElementById('net-ip-ranges').value
        },
        security: {
          firewallType: document.getElementById('net-firewall-type').value,
          firewallModel: document.getElementById('net-firewall-model').value,
          fwStateful: document.getElementById('fw-stateful').checked,
          fwIps: document.getElementById('fw-ips').checked,
          fwAv: document.getElementById('fw-av').checked,
          fwWebFilter: document.getElementById('fw-web-filter').checked,
          fwAppControl: document.getElementById('fw-app-control').checked,
          fwSslInspect: document.getElementById('fw-ssl-inspect').checked,
          waf: document.getElementById('net-waf').value,
          antimalware: document.getElementById('net-antimalware').value,
          antimalwareProduct: document.getElementById('net-antimalware-product').value,
          emailSecurity: document.getElementById('net-email-security').value
        },
        connectivity: {
          internetType: document.getElementById('net-internet-type').value,
          isp: document.getElementById('net-isp').value,
          bandwidthDown: document.getElementById('net-bandwidth-down').value,
          bandwidthUp: document.getElementById('net-bandwidth-up').value,
          vpnType: document.getElementById('net-vpn-type').value,
          vpnSolution: document.getElementById('net-vpn-solution').value,
          mfa: document.getElementById('net-mfa').value,
          mfaSolution: document.getElementById('net-mfa-solution').value,
          wifi: document.getElementById('net-wifi').value,
          wifiAuth: document.getElementById('net-wifi-auth').value
        },
        monitoring: {
          siem: document.getElementById('net-siem').value,
          siemProduct: document.getElementById('net-siem-product').value,
          logRetention: document.getElementById('net-log-retention').value,
          logFirewall: document.getElementById('log-firewall').checked,
          logAuth: document.getElementById('log-authentication').checked,
          logVpn: document.getElementById('log-vpn').checked,
          logEmail: document.getElementById('log-email').checked,
          logWeb: document.getElementById('log-web').checked,
          logDns: document.getElementById('log-dns').checked,
          logDhcp: document.getElementById('log-dhcp').checked,
          logEndpoints: document.getElementById('log-endpoints').checked,
          monitoring: document.getElementById('net-monitoring').value,
          monitoringTool: document.getElementById('net-monitoring-tool').value,
          vulnScan: document.getElementById('net-vulnerability-scan').value,
          vulnTool: document.getElementById('net-vuln-tool').value
        }
      };
      
      const firewallFeatures = [];
      if (data.security.fwStateful) firewallFeatures.push('Stateful Inspection');
      if (data.security.fwIps) firewallFeatures.push('IPS/IDS');
      if (data.security.fwAv) firewallFeatures.push('Antivirus Gateway');
      if (data.security.fwWebFilter) firewallFeatures.push('Web Filtering');
      if (data.security.fwAppControl) firewallFeatures.push('Application Control');
      if (data.security.fwSslInspect) firewallFeatures.push('SSL/TLS Inspection');
      
      const logTypes = [];
      if (data.monitoring.logFirewall) logTypes.push('Firewall');
      if (data.monitoring.logAuth) logTypes.push('Autenticazione');
      if (data.monitoring.logVpn) logTypes.push('VPN');
      if (data.monitoring.logEmail) logTypes.push('Email');
      if (data.monitoring.logWeb) logTypes.push('Web Proxy');
      if (data.monitoring.logDns) logTypes.push('DNS');
      if (data.monitoring.logDhcp) logTypes.push('DHCP');
      if (data.monitoring.logEndpoints) logTypes.push('Endpoints');
      
      summary.innerHTML = `
        <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded">
          <h4 class="text-lg font-bold text-gray-800 mb-4">ğŸ”· Topologia Rete</h4>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="font-medium">Tipologia:</span> ${getLabelFromValue('topology-type', data.topology.type)}</div>
            <div><span class="font-medium">Numero Sedi:</span> ${data.topology.sites}</div>
            <div><span class="font-medium">Utenti:</span> ${data.topology.users}</div>
            <div><span class="font-medium">Segmentazione:</span> ${getLabelFromValue('segmentation', data.topology.segmentation)}</div>
            <div><span class="font-medium">Indirizzamento IP:</span> ${data.topology.ipAddressing?.toUpperCase() || 'N/A'}</div>
            ${data.topology.ipRanges ? `<div class="col-span-2"><span class="font-medium">Range IP:</span> ${data.topology.ipRanges}</div>` : ''}
            ${data.topology.vlans ? `<div class="col-span-2"><span class="font-medium">VLAN:</span> ${data.topology.vlans}</div>` : ''}
          </div>
        </div>
        
        <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded">
          <h4 class="text-lg font-bold text-gray-800 mb-4">ğŸ›¡ï¸ Sicurezza Perimetrale</h4>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="font-medium">Firewall:</span> ${getLabelFromValue('firewall-type', data.security.firewallType)}</div>
            ${data.security.firewallModel ? `<div><span class="font-medium">Modello:</span> ${data.security.firewallModel}</div>` : '<div></div>'}
            <div class="col-span-2"><span class="font-medium">FunzionalitÃ  FW:</span> ${firewallFeatures.length > 0 ? firewallFeatures.join(', ') : 'Nessuna'}</div>
            <div><span class="font-medium">WAF:</span> ${getLabelFromValue('waf', data.security.waf)}</div>
            <div><span class="font-medium">Antimalware/EDR:</span> ${getLabelFromValue('antimalware', data.security.antimalware)}</div>
            ${data.security.antimalwareProduct ? `<div class="col-span-2"><span class="font-medium">Soluzione:</span> ${data.security.antimalwareProduct}</div>` : ''}
            <div class="col-span-2"><span class="font-medium">Email Security:</span> ${getLabelFromValue('email-security', data.security.emailSecurity)}</div>
          </div>
        </div>
        
        <div class="bg-purple-50 border-l-4 border-purple-500 p-6 rounded">
          <h4 class="text-lg font-bold text-gray-800 mb-4">ğŸ”Œ ConnettivitÃ  e Accessi</h4>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="font-medium">Connessione Internet:</span> ${getLabelFromValue('internet-type', data.connectivity.internetType)}</div>
            ${data.connectivity.isp ? `<div><span class="font-medium">ISP:</span> ${data.connectivity.isp}</div>` : '<div></div>'}
            ${data.connectivity.bandwidthDown ? `<div><span class="font-medium">Banda Download:</span> ${data.connectivity.bandwidthDown} Mbps</div>` : ''}
            ${data.connectivity.bandwidthUp ? `<div><span class="font-medium">Banda Upload:</span> ${data.connectivity.bandwidthUp} Mbps</div>` : ''}
            <div><span class="font-medium">VPN:</span> ${getLabelFromValue('vpn-type', data.connectivity.vpnType)}</div>
            ${data.connectivity.vpnSolution ? `<div><span class="font-medium">Soluzione VPN:</span> ${data.connectivity.vpnSolution}</div>` : '<div></div>'}
            <div><span class="font-medium">MFA:</span> ${getLabelFromValue('mfa', data.connectivity.mfa)}</div>
            ${data.connectivity.mfaSolution ? `<div><span class="font-medium">Soluzione MFA:</span> ${data.connectivity.mfaSolution}</div>` : '<div></div>'}
            <div><span class="font-medium">Wi-Fi:</span> ${getLabelFromValue('wifi', data.connectivity.wifi)}</div>
            ${data.connectivity.wifiAuth ? `<div><span class="font-medium">Auth Wi-Fi:</span> ${getLabelFromValue('wifi-auth', data.connectivity.wifiAuth)}</div>` : '<div></div>'}
          </div>
        </div>
        
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded">
          <h4 class="text-lg font-bold text-gray-800 mb-4">ï¿½ï¿½ï¿½ï¿½ Monitoraggio e Logging</h4>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="font-medium">SIEM:</span> ${getLabelFromValue('siem', data.monitoring.siem)}</div>
            ${data.monitoring.siemProduct ? `<div><span class="font-medium">Soluzione:</span> ${data.monitoring.siemProduct}</div>` : '<div></div>'}
            <div><span class="font-medium">Retention Log:</span> ${data.monitoring.logRetention} giorni</div>
            <div><span class="font-medium">Monitoraggio:</span> ${getLabelFromValue('monitoring', data.monitoring.monitoring)}</div>
            ${data.monitoring.monitoringTool ? `<div class="col-span-2"><span class="font-medium">Tool Monitoring:</span> ${data.monitoring.monitoringTool}</div>` : ''}
            <div class="col-span-2"><span class="font-medium">Log Raccolti:</span> ${logTypes.length > 0 ? logTypes.join(', ') : 'Nessuno'}</div>
            <div><span class="font-medium">Vulnerability Scan:</span> ${getLabelFromValue('vuln-scan', data.monitoring.vulnScan)}</div>
            ${data.monitoring.vulnTool ? `<div><span class="font-medium">Tool Scanning:</span> ${data.monitoring.vulnTool}</div>` : '<div></div>'}
          </div>
        </div>
      `;
    }
    
    function getLabelFromValue(fieldType, value) {
      const labels = {
        'topology-type': {
          'lan': 'LAN',
          'wan': 'WAN',
          'hybrid': 'Ibrida (LAN + WAN)',
          'cloud': 'Cloud-Based',
          'sdwan': 'SD-WAN'
        },
        'segmentation': {
          'none': 'Nessuna segmentazione',
          'basic': 'Base (VLAN)',
          'advanced': 'Avanzata (DMZ)',
          'zero-trust': 'Zero Trust'
        },
        'firewall-type': {
          'hardware': 'Hardware Dedicato',
          'software': 'Software/Virtual',
          'ngfw': 'NGFW',
          'cloud': 'Cloud-based',
          'none': 'Nessuno'
        },
        'waf': {
          'yes-dedicated': 'SÃ¬ - WAF Dedicato',
          'yes-integrated': 'SÃ¬ - Integrato',
          'yes-cloud': 'SÃ¬ - Cloud WAF',
          'no': 'Non implementato'
        },
        'antimalware': {
          'edr': 'EDR',
          'traditional': 'Antivirus Tradizionale',
          'xdr': 'XDR',
          'none': 'Nessuno'
        },
        'email-security': {
          'yes-dedicated': 'Gateway Dedicato',
          'yes-cloud': 'Cloud-based',
          'basic': 'Protezione base',
          'no': 'Nessuna'
        },
        'internet-type': {
          'fiber': 'Fibra Ottica',
          'adsl': 'ADSL/VDSL',
          'leased-line': 'Linea Dedicata',
          '4g-5g': '4G/5G',
          'satellite': 'Satellite',
          'redundant': 'Ridondante'
        },
        'vpn-type': {
          'site-to-site': 'Site-to-Site VPN',
          'remote-access': 'Remote Access VPN',
          'both': 'Site-to-Site + Remote Access',
          'ssl-vpn': 'SSL VPN',
          'ipsec': 'IPsec VPN',
          'none': 'Nessuna VPN'
        },
        'mfa': {
          'yes-all': 'Tutti gli accessi',
          'yes-critical': 'Sistemi critici',
          'yes-admin': 'Account amministrativi',
          'no': 'Non implementata'
        },
        'wifi': {
          'yes-segmented': 'Reti separate',
          'yes-single': 'Rete singola',
          'yes-wpa3': 'Con WPA3',
          'no': 'No Wi-Fi'
        },
        'wifi-auth': {
          'wpa3-enterprise': 'WPA3-Enterprise',
          'wpa2-enterprise': 'WPA2-Enterprise',
          'wpa2-psk': 'WPA2-PSK',
          'captive-portal': 'Captive Portal',
          'open': 'Aperta'
        },
        'siem': {
          'yes-dedicated': 'SIEM Dedicato',
          'yes-cloud': 'Cloud SIEM',
          'basic-logging': 'Logging Base',
          'no': 'Nessun SIEM'
        },
        'monitoring': {
          'yes-24x7': '24x7 con SOC',
          'yes-automated': 'Automatizzato',
          'yes-business-hours': 'Orario lavorativo',
          'basic': 'Controlli periodici',
          'no': 'Nessuno'
        },
        'vuln-scan': {
          'continuous': 'Continuo',
          'monthly': 'Mensile',
          'quarterly': 'Trimestrale',
          'yearly': 'Annuale',
          'none': 'Mai eseguito'
        }
      };
      
      return labels[fieldType]?.[value] || value || 'N/A';
    }
    
    function saveNetworkConfig(event) {
      event.preventDefault();
      
      networkConfig = {
        topology: {
          type: document.getElementById('net-topology-type').value,
          sites: document.getElementById('net-sites-count').value,
          users: document.getElementById('net-users-count').value,
          segmentation: document.getElementById('net-segmentation').value,
          vlans: document.getElementById('net-vlans').value,
          ipAddressing: document.querySelector('input[name="ip-addressing"]:checked')?.value,
          ipRanges: document.getElementById('net-ip-ranges').value
        },
        security: {
          firewallType: document.getElementById('net-firewall-type').value,
          firewallModel: document.getElementById('net-firewall-model').value,
          firewallFeatures: {
            stateful: document.getElementById('fw-stateful').checked,
            ips: document.getElementById('fw-ips').checked,
            av: document.getElementById('fw-av').checked,
            webFilter: document.getElementById('fw-web-filter').checked,
            appControl: document.getElementById('fw-app-control').checked,
            sslInspect: document.getElementById('fw-ssl-inspect').checked
          },
          waf: document.getElementById('net-waf').value,
          antimalware: document.getElementById('net-antimalware').value,
          antimalwareProduct: document.getElementById('net-antimalware-product').value,
          emailSecurity: document.getElementById('net-email-security').value
        },
        connectivity: {
          internetType: document.getElementById('net-internet-type').value,
          isp: document.getElementById('net-isp').value,
          bandwidthDown: document.getElementById('net-bandwidth-down').value,
          bandwidthUp: document.getElementById('net-bandwidth-up').value,
          vpnType: document.getElementById('net-vpn-type').value,
          vpnSolution: document.getElementById('net-vpn-solution').value,
          mfa: document.getElementById('net-mfa').value,
          mfaSolution: document.getElementById('net-mfa-solution').value,
          wifi: document.getElementById('net-wifi').value,
          wifiAuth: document.getElementById('net-wifi-auth').value
        },
        monitoring: {
          siem: document.getElementById('net-siem').value,
          siemProduct: document.getElementById('net-siem-product').value,
          logRetention: document.getElementById('net-log-retention').value,
          logTypes: {
            firewall: document.getElementById('log-firewall').checked,
            authentication: document.getElementById('log-authentication').checked,
            vpn: document.getElementById('log-vpn').checked,
            email: document.getElementById('log-email').checked,
            web: document.getElementById('log-web').checked,
            dns: document.getElementById('log-dns').checked,
            dhcp: document.getElementById('log-dhcp').checked,
            endpoints: document.getElementById('log-endpoints').checked
          },
          monitoring: document.getElementById('net-monitoring').value,
          monitoringTool: document.getElementById('net-monitoring-tool').value,
          vulnerabilityScan: document.getElementById('net-vulnerability-scan').value,
          vulnTool: document.getElementById('net-vuln-tool').value
        },
        savedAt: new Date().toISOString(),
        savedBy: currentUser.name
      };
      
      localStorage.setItem('network_config', JSON.stringify(networkConfig));
      showSuccessMessage('âœ… Configurazione rete salvata con successo!');
      updateNetworkStatus();
      
      currentNetworkStep = 1;
      document.querySelectorAll('.network-step').forEach(step => step.classList.add('hidden'));
      document.getElementById('network-step-1').classList.remove('hidden');
      updateNetworkStepIndicators();
      updateNetworkButtons();
    }
    
    function resetNetworkForm() {
      if (confirm('Sei sicuro di voler resettare il form? Tutti i dati non salvati andranno persi.')) {
        document.getElementById('network-form').reset();
        currentNetworkStep = 1;
        document.querySelectorAll('.network-step').forEach(step => step.classList.add('hidden'));
        document.getElementById('network-step-1').classList.remove('hidden');
        updateNetworkStepIndicators();
        updateNetworkButtons();
      }
    }
    
    // === COMPANIES MANAGEMENT ===
    let companies = JSON.parse(localStorage.getItem('companies') || '[]');
    
    // Initialize with demo data if empty
    if (companies.length === 0) {
      companies = [
        {
          id: 'COMP-001',
          name: 'Acme Corporation SRL',
          vat: '12345678901',
          sector: 'ICT',
          status: 'attivo',
          complianceScore: 85,
          employees: 150,
          contactPerson: 'Mario Rossi',
          email: 'mario.rossi@acme.it',
          phone: '+39 02 1234567',
          registeredAt: '2024-01-15T10:00:00Z',
          lastAudit: '2024-03-10T14:30:00Z'
        },
        {
          id: 'COMP-002',
          name: 'TechnoServices SpA',
          vat: '98765432109',
          sector: 'Energia',
          status: 'attivo',
          complianceScore: 72,
          employees: 450,
          contactPerson: 'Laura Bianchi',
          email: 'l.bianchi@techno.it',
          phone: '+39 06 9876543',
          registeredAt: '2024-02-20T09:15:00Z',
          lastAudit: '2024-03-15T11:00:00Z'
        },
        {
          id: 'COMP-003',
          name: 'HealthCare Italia',
          vat: '11223344556',
          sector: 'Sanitario',
          status: 'in-valutazione',
          complianceScore: 45,
          employees: 200,
          contactPerson: 'Giuseppe Verdi',
          email: 'g.verdi@healthcare.it',
          phone: '+39 011 5556677',
          registeredAt: '2024-03-01T16:45:00Z',
          lastAudit: null
        }
      ];
      localStorage.setItem('companies', JSON.stringify(companies));
    }
    
    function renderCompaniesList() {
      const container = document.getElementById('companies-list');
      const searchTerm = document.getElementById('search-companies')?.value.toLowerCase() || '';
      const statusFilter = document.getElementById('filter-company-status')?.value || '';
      
      let filtered = companies.filter(company => {
        const matchesSearch = company.name.toLowerCase().includes(searchTerm) || 
                            company.vat.includes(searchTerm) ||
                            company.contactPerson.toLowerCase().includes(searchTerm);
        const matchesStatus = !statusFilter || company.status === statusFilter;
        return matchesSearch && matchesStatus;
      });
      
      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Nessuna azienda trovata</p>';
        return;
      }
      
      container.innerHTML = filtered.map(company => `
        <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-3 mb-3">
                <h3 class="text-xl font-bold text-gray-800">${company.name}</h3>
                <span class="status-badge ${company.status === 'attivo' ? 'bg-green-100 text-green-800' : company.status === 'sospeso' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                  ${company.status === 'attivo' ? 'âœ… Attivo' : company.status === 'sospeso' ? 'â›” Sospeso' : 'â³ In Valutazione'}
                </span>
              </div>
              
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div>
                  <p class="text-xs text-gray-500">P.IVA</p>
                  <p class="text-sm font-medium text-gray-800">${company.vat}</p>
                </div>
                <div>
                  <p class="text-xs text-gray-500">Settore</p>
                  <p class="text-sm font-medium text-gray-800">${company.sector}</p>
                </div>
                <div>
                  <p class="text-xs text-gray-500">Dipendenti</p>
                  <p class="text-sm font-medium text-gray-800">${company.employees}</p>
                </div>
                <div>
                  <p class="text-xs text-gray-500">Compliance Score</p>
                  <p class="text-sm font-medium ${company.complianceScore >= 80 ? 'text-green-600' : company.complianceScore >= 60 ? 'text-yellow-600' : 'text-red-600'}">${company.complianceScore}%</p>
                </div>
              </div>
              
              <div class="flex items-center space-x-6 text-sm text-gray-600">
                <span>ğŸ‘¤ ${company.contactPerson}</span>
                <span>ğŸ“§ ${company.email}</span>
                <span>ğŸ“ ${company.phone}</span>
              </div>
              
              <div class="mt-3 text-xs text-gray-500">
                <span>Registrata il: ${new Date(company.registeredAt).toLocaleDateString('it-IT')}</span>
                ${company.lastAudit ? ` | Ultimo audit: ${new Date(company.lastAudit).toLocaleDateString('it-IT')}` : ' | Nessun audit'}
              </div>
            </div>
            
            <div class="flex flex-col space-y-2 ml-4">
              <button onclick="viewCompanyDetails('${company.id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg">
                Dettagli
              </button>
              <button onclick="editCompany('${company.id}')" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white text-sm rounded-lg">
                Modifica
              </button>
              <button onclick="deleteCompany('${company.id}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg">
                Elimina
              </button>
            </div>
          </div>
        </div>
      `).join('');
      
      document.getElementById('total-companies').textContent = companies.length;
    }
    
    function filterCompanies() {
      renderCompaniesList();
    }
    
    function openAddCompanyModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-xl">
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold">Aggiungi Nuova Azienda</h2>
              <button onclick="this.closest('.modal-overlay').remove()" class="text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
          
          <form id="add-company-form" onsubmit="saveNewCompany(event)" class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ragione Sociale *</label>
                <input type="text" id="new-company-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Partita IVA *</label>
                <input type="text" id="new-company-vat" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Settore *</label>
                <select id="new-company-sector" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                  <option value="">Seleziona</option>
                  <option value="Energia">Energia</option>
                  <option value="Trasporti">Trasporti</option>
                  <option value="Bancario">Bancario</option>
                  <option value="Sanitario">Sanitario</option>
                  <option value="ICT">ICT</option>
                  <option value="Pubblica Amministrazione">Pubblica Amministrazione</option>
                  <option value="Altro">Altro</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Numero Dipendenti *</label>
                <input type="number" id="new-company-employees" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Referente *</label>
                <input type="text" id="new-company-contact" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" id="new-company-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Telefono *</label>
                <input type="tel" id="new-company-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                Annulla
              </button>
              <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                Salva Azienda
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function saveNewCompany(event) {
      event.preventDefault();
      
      const newCompany = {
        id: 'COMP-' + String(companies.length + 1).padStart(3, '0'),
        name: document.getElementById('new-company-name').value,
        vat: document.getElementById('new-company-vat').value,
        sector: document.getElementById('new-company-sector').value,
        employees: parseInt(document.getElementById('new-company-employees').value),
        contactPerson: document.getElementById('new-company-contact').value,
        email: document.getElementById('new-company-email').value,
        phone: document.getElementById('new-company-phone').value,
        status: 'in-valutazione',
        complianceScore: 0,
        registeredAt: new Date().toISOString(),
        lastAudit: null
      };
      
      companies.push(newCompany);
      localStorage.setItem('companies', JSON.stringify(companies));
      
      document.querySelector('.modal-overlay').remove();
      renderCompaniesList();
      showSuccessMessage('âœ… Azienda aggiunta con successo!');
    }
    
    function viewCompanyDetails(companyId) {
      const company = companies.find(c => c.id === companyId);
      if (!company) return;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-xl">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold mb-2">${company.name}</h2>
                <p class="text-blue-100">ID: ${company.id}</p>
              </div>
              <button onclick="this.closest('.modal-overlay').remove()" class="text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="p-6 space-y-6">
            <div class="grid grid-cols-2 gap-6">
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">Partita IVA</h3>
                <p class="text-lg font-semibold text-gray-800">${company.vat}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">Settore</h3>
                <p class="text-lg font-semibold text-gray-800">${company.sector}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">Dipendenti</h3>
                <p class="text-lg font-semibold text-gray-800">${company.employees}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">Stato</h3>
                <p class="text-lg font-semibold ${company.status === 'attivo' ? 'text-green-600' : company.status === 'sospeso' ? 'text-red-600' : 'text-yellow-600'}">
                  ${company.status === 'attivo' ? 'âœ… Attivo' : company.status === 'sospeso' ? 'â›” Sospeso' : 'â³ In Valutazione'}
                </p>
              </div>
            </div>
            
            <div class="border-t pt-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4">Compliance Score</h3>
              <div class="flex items-center space-x-4">
                <div class="flex-1 bg-gray-200 rounded-full h-4">
                  <div class="h-4 rounded-full ${company.complianceScore >= 80 ? 'bg-green-500' : company.complianceScore >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${company.complianceScore}%"></div>
                </div>
                <span class="text-2xl font-bold ${company.complianceScore >= 80 ? 'text-green-600' : company.complianceScore >= 60 ? 'text-yellow-600' : 'text-red-600'}">${company.complianceScore}%</span>
              </div>
            </div>
            
            <div class="border-t pt-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4">Contatti</h3>
              <div class="space-y-2">
                <p><span class="font-medium">Referente:</span> ${company.contactPerson}</p>
                <p><span class="font-medium">Email:</span> ${company.email}</p>
                <p><span class="font-medium">Telefono:</span> ${company.phone}</p>
              </div>
            </div>
            
            <div class="border-t pt-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4">Timeline</h3>
              <div class="space-y-2 text-sm text-gray-600">
                <p>ğŸ“… Registrata il: ${new Date(company.registeredAt).toLocaleString('it-IT')}</p>
                ${company.lastAudit ? `<p>ğŸ” Ultimo audit: ${new Date(company.lastAudit).toLocaleString('it-IT')}</p>` : '<p>ğŸ” Nessun audit effettuato</p>'}
              </div>
            </div>
          </div>
          
          <div class="bg-gray-50 p-6 rounded-b-xl flex justify-end">
            <button onclick="this.closest('.modal-overlay').remove()" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
              Chiudi
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function editCompany(companyId) {
      showSuccessMessage('ğŸ”§ Funzione modifica in sviluppo');
    }
    
    function deleteCompany(companyId) {
      if (confirm('Sei sicuro di voler eliminare questa azienda?')) {
        companies = companies.filter(c => c.id !== companyId);
        localStorage.setItem('companies', JSON.stringify(companies));
        renderCompaniesList();
        showSuccessMessage('âœ… Azienda eliminata');
      }
    }
    
    // === USERS MANAGEMENT ===
    let users = JSON.parse(localStorage.getItem('platform_users') || '[]');
    
    // Initialize with demo data if empty
    if (users.length === 0) {
      users = [
        {
          id: 'USR-001',
          name: 'Admin Sistema',
          email: 'admin@csirt.it',
          role: 'admin',
          company: null,
          status: 'attivo',
          lastLogin: '2024-03-20T09:30:00Z',
          createdAt: '2024-01-01T00:00:00Z'
        },
        {
          id: 'USR-002',
          name: 'Marco Rossi',
          email: 'csirt@hub.it',
          role: 'csirt',
          company: null,
          status: 'attivo',
          lastLogin: '2024-03-19T14:22:00Z',
          createdAt: '2024-01-15T10:00:00Z'
        },
        {
          id: 'USR-003',
          name: 'Giuseppe Verdi',
          email: 'azienda@test.it',
          role: 'azienda',
          company: 'Azienda Test SRL',
          status: 'attivo',
          lastLogin: '2024-03-18T16:45:00Z',
          createdAt: '2024-02-01T09:00:00Z'
        },
        {
          id: 'USR-004',
          name: 'Laura Bianchi',
          email: 'l.bianchi@techno.it',
          role: 'azienda',
          company: 'TechnoServices SpA',
          status: 'attivo',
          lastLogin: '2024-03-17T11:30:00Z',
          createdAt: '2024-02-10T14:20:00Z'
        },
        {
          id: 'USR-005',
          name: 'Paolo Neri',
          email: 'p.neri@example.it',
          role: 'csirt',
          company: null,
          status: 'sospeso',
          lastLogin: '2024-02-28T08:15:00Z',
          createdAt: '2024-01-20T12:00:00Z'
        }
      ];
      localStorage.setItem('platform_users', JSON.stringify(users));
    }
    
    function renderUsersTable() {
      const tbody = document.getElementById('users-table-body');
      const searchTerm = document.getElementById('search-users')?.value.toLowerCase() || '';
      const roleFilter = document.getElementById('filter-user-role')?.value || '';
      const statusFilter = document.getElementById('filter-user-status')?.value || '';
      
      let filtered = users.filter(user => {
        const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                            user.email.toLowerCase().includes(searchTerm) ||
                            (user.company && user.company.toLowerCase().includes(searchTerm));
        const matchesRole = !roleFilter || user.role === roleFilter;
        const matchesStatus = !statusFilter || user.status === statusFilter;
        return matchesSearch && matchesRole && matchesStatus;
      });
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nessun utente trovato</td></tr>';
        return;
      }
      
      const roleLabels = {
        'admin': 'ğŸ‘‘ Amministratore',
        'csirt': 'ğŸ›¡ï¸ CSIRT',
        'azienda': 'ğŸ¢ Aziendale'
      };
      
      tbody.innerHTML = filtered.map(user => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-4">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                ${user.name.charAt(0)}
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-900">${user.name}</p>
                <p class="text-xs text-gray-500">${user.id}</p>
              </div>
            </div>
          </td>
          <td class="px-4 py-4 text-sm text-gray-900">${user.email}</td>
          <td class="px-4 py-4">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
              user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 
              user.role === 'csirt' ? 'bg-blue-100 text-blue-800' : 
              'bg-green-100 text-green-800'
            }">
              ${roleLabels[user.role]}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-900">${user.company || '-'}</td>
          <td class="px-4 py-4">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
              user.status === 'attivo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }">
              ${user.status === 'attivo' ? 'âœ… Attivo' : 'â›” Sospeso'}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-500">${user.lastLogin ? new Date(user.lastLogin).toLocaleString('it-IT') : 'Mai'}</td>
          <td class="px-4 py-4 text-center">
            <div class="flex justify-center space-x-2">
              <button onclick="viewUserDetails('${user.id}')" class="text-blue-600 hover:text-blue-800" title="Dettagli">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
              </button>
              <button onclick="editUser('${user.id}')" class="text-yellow-600 hover:text-yellow-800" title="Modifica">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
              </button>
              <button onclick="toggleUserStatus('${user.id}')" class="text-${user.status === 'attivo' ? 'red' : 'green'}-600 hover:text-${user.status === 'attivo' ? 'red' : 'green'}-800" title="${user.status === 'attivo' ? 'Sospendi' : 'Attiva'}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${user.status === 'attivo' ? 'M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}"/></svg>
              </button>
              <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800" title="Elimina">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    function filterUsers() {
      renderUsersTable();
    }
    
    function openAddUserModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-xl">
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold">Aggiungi Nuovo Utente</h2>
              <button onclick="this.closest('.modal-overlay').remove()" class="text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
          
          <form id="add-user-form" onsubmit="saveNewUser(event)" class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
                <input type="text" id="new-user-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" id="new-user-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ruolo *</label>
                <select id="new-user-role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="toggleCompanyField()">
                  <option value="">Seleziona</option>
                  <option value="admin">Amministratore</option>
                  <option value="csirt">Consulente CSIRT</option>
                  <option value="azienda">Referente Aziendale</option>
                </select>
              </div>
              
              <div id="company-field" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Azienda</label>
                <select id="new-user-company" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                  <option value="">Seleziona azienda</option>
                  ${companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                </select>
              </div>
              
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Password Temporanea *</label>
                <input type="password" id="new-user-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500 mt-1">L'utente dovrÃ  cambiarla al primo accesso</p>
              </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                Annulla
              </button>
              <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                Crea Utente
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function toggleCompanyField() {
      const role = document.getElementById('new-user-role').value;
      const companyField = document.getElementById('company-field');
      if (role === 'azienda') {
        companyField.classList.remove('hidden');
        document.getElementById('new-user-company').required = true;
      } else {
        companyField.classList.add('hidden');
        document.getElementById('new-user-company').required = false;
      }
    }
    
    function saveNewUser(event) {
      event.preventDefault();
      
      const role = document.getElementById('new-user-role').value;
      const newUser = {
        id: 'USR-' + String(users.length + 1).padStart(3, '0'),
        name: document.getElementById('new-user-name').value,
        email: document.getElementById('new-user-email').value,
        role: role,
        company: role === 'azienda' ? document.getElementById('new-user-company').value : null,
        status: 'attivo',
        lastLogin: null,
        createdAt: new Date().toISOString()
      };
      
      users.push(newUser);
      localStorage.setItem('platform_users', JSON.stringify(users));
      
      document.querySelector('.modal-overlay').remove();
      renderUsersTable();
      showSuccessMessage('âœ… Utente creato con successo!');
    }
    
    function viewUserDetails(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;
      
      const roleLabels = {
        'admin': 'ğŸ‘‘ Amministratore',
        'csirt': 'ğŸ›¡ï¸ Consulente CSIRT',
        'azienda': 'ğŸ¢ Referente Aziendale'
      };
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4">
          <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-xl">
            <div class="flex justify-between items-start">
              <div class="flex items-center space-x-4">
                <div class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center text-3xl font-bold">
                  ${user.name.charAt(0)}
                </div>
                <div>
                  <h2 class="text-2xl font-bold">${user.name}</h2>
                  <p class="text-blue-100">${roleLabels[user.role]}</p>
                </div>
              </div>
              <button onclick="this.closest('.modal-overlay').remove()" class="text-white hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="p-6 space-y-6">
            <div class="grid grid-cols-2 gap-6">
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">ID Utente</h3>
                <p class="text-lg font-semibold text-gray-800">${user.id}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">Email</h3>
                <p class="text-lg font-semibold text-gray-800">${user.email}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">Azienda</h3>
                <p class="text-lg font-semibold text-gray-800">${user.company || 'N/A'}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-1">Stato</h3>
                <p class="text-lg font-semibold ${user.status === 'attivo' ? 'text-green-600' : 'text-red-600'}">
                  ${user.status === 'attivo' ? 'âœ… Attivo' : 'â›” Sospeso'}
                </p>
              </div>
            </div>
            
            <div class="border-t pt-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4">Cronologia Accessi</h3>
              <div class="space-y-2 text-sm text-gray-600">
                <p>ğŸ“… Account creato: ${new Date(user.createdAt).toLocaleString('it-IT')}</p>
                <p>ğŸ” Ultimo accesso: ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('it-IT') : 'Mai effettuato'}</p>
              </div>
            </div>
          </div>
          
          <div class="bg-gray-50 p-6 rounded-b-xl flex justify-end space-x-4">
            <button onclick="editUser('${user.id}')" class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">
              Modifica
            </button>
            <button onclick="this.closest('.modal-overlay').remove()" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
              Chiudi
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function editUser(userId) {
      showSuccessMessage('ğŸ”§ Funzione modifica in sviluppo');
    }
    
    function toggleUserStatus(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;
      
      user.status = user.status === 'attivo' ? 'sospeso' : 'attivo';
      localStorage.setItem('platform_users', JSON.stringify(users));
      renderUsersTable();
      showSuccessMessage(`âœ… Utente ${user.status === 'attivo' ? 'attivato' : 'sospeso'}`);
    }
    
    function deleteUser(userId) {
      if (confirm('Sei sicuro di voler eliminare questo utente?')) {
        users = users.filter(u => u.id !== userId);
        localStorage.setItem('platform_users', JSON.stringify(users));
        renderUsersTable();
        showSuccessMessage('âœ… Utente eliminato');
      }
    }
    
    // === DESIGNATION MANAGEMENT ===
    let designationData = JSON.parse(localStorage.getItem('designation_data') || 'null');
    
    function saveDesignation(event) {
      event.preventDefault();
      
      designationData = {
        company: {
          name: document.getElementById('des-company-name').value,
          vat: document.getElementById('des-company-vat').value,
          cf: document.getElementById('des-company-cf').value,
          sector: document.getElementById('des-company-sector').value,
          address: document.getElementById('des-company-address').value
        },
        mainContact: {
          name: document.getElementById('des-main-name').value,
          surname: document.getElementById('des-main-surname').value,
          cf: document.getElementById('des-main-cf').value,
          role: document.getElementById('des-main-role').value,
          email: document.getElementById('des-main-email').value,
          phone: document.getElementById('des-main-phone').value,
          pec: document.getElementById('des-main-pec').value
        },
        substitute1: {
          name: document.getElementById('des-sub1-name').value,
          surname: document.getElementById('des-sub1-surname').value,
          cf: document.getElementById('des-sub1-cf').value,
          role: document.getElementById('des-sub1-role').value,
          email: document.getElementById('des-sub1-email').value,
          phone: document.getElementById('des-sub1-phone').value
        },
        substitute2: {
          name: document.getElementById('des-sub2-name').value,
          surname: document.getElementById('des-sub2-surname').value,
          cf: document.getElementById('des-sub2-cf').value,
          role: document.getElementById('des-sub2-role').value,
          email: document.getElementById('des-sub2-email').value,
          phone: document.getElementById('des-sub2-phone').value
        },
        acn: {
          email: document.getElementById('des-acn-email').value,
          pec: document.getElementById('des-acn-pec').value,
          phone: document.getElementById('des-acn-phone').value,
          registrationDate: document.getElementById('des-acn-registration-date').value
        },
        notes: document.getElementById('des-notes').value,
        savedAt: new Date().toISOString()
      };
      
      localStorage.setItem('designation_data', JSON.stringify(designationData));
      showSuccessMessage('âœ… Designazione salvata con successo!');
      updateDesignationStatus();
    }
    
    function resetDesignationForm() {
      document.getElementById('designation-form').reset();
    }
    
    function generateDesignationDoc() {
      if (!designationData) {
        showErrorMessage('Compila e salva prima i dati della designazione');
        return;
      }
      
      showSuccessMessage('ğŸ”„ Generazione documento Word in corso...');
      
      setTimeout(() => {
        const doc = new docx.Document({
          sections: [{
            properties: {},
            children: [
              new docx.Paragraph({
                text: "DESIGNAZIONE REFERENTE CSIRT",
                heading: docx.HeadingLevel.HEADING_1,
                alignment: docx.AlignmentType.CENTER
              }),
              new docx.Paragraph({ text: "" }),
              new docx.Paragraph({
                text: "DATI AZIENDA",
                heading: docx.HeadingLevel.HEADING_2
              }),
              new docx.Paragraph({ text: `Ragione Sociale: ${designationData.company.name}` }),
              new docx.Paragraph({ text: `Partita IVA: ${designationData.company.vat}` }),
              new docx.Paragraph({ text: `Codice Fiscale: ${designationData.company.cf}` }),
              new docx.Paragraph({ text: `Settore: ${designationData.company.sector}` }),
              new docx.Paragraph({ text: `Indirizzo: ${designationData.company.address}` }),
              new docx.Paragraph({ text: "" }),
              new docx.Paragraph({
                text: "REFERENTE CSIRT PRINCIPALE",
                heading: docx.HeadingLevel.HEADING_2
              }),
              new docx.Paragraph({ text: `Nome: ${designationData.mainContact.name} ${designationData.mainContact.surname}` }),
              new docx.Paragraph({ text: `Codice Fiscale: ${designationData.mainContact.cf}` }),
              new docx.Paragraph({ text: `Ruolo: ${designationData.mainContact.role}` }),
              new docx.Paragraph({ text: `Email: ${designationData.mainContact.email}` }),
              new docx.Paragraph({ text: `Telefono: ${designationData.mainContact.phone}` }),
              new docx.Paragraph({ text: `PEC: ${designationData.mainContact.pec}` })
            ]
          }]
        });
        
        docx.Packer.toBlob(doc).then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Designazione_CSIRT_${designationData.company.name.replace(/\s+/g, '_')}.docx`;
          a.click();
          showSuccessMessage('âœ… Documento Word generato!');
        });
      }, 500);
    }
  </script>
  </div>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9aadaa185778ed97',t:'MTc2NTIxMTYwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
