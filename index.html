<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piattaforma CSIRT - Gestione Sicurezza Aziendale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Prevent 404 errors for all missing SDK resources
    window.addEventListener('error', function(e) {
      if (e.target.tagName === 'SCRIPT') {
        const src = e.target.src || '';
        if (src.includes('main.js') || src.includes('data_sdk.js') || src.includes('element_sdk.js')) {
          e.preventDefault();
          e.stopPropagation();
        }
      }
    }, true);
    
    // Suppress Tailwind CDN warning
    window.tailwind = { config: {} };
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    .hidden { display: none; }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .status-aperto { background-color: #fee2e2; color: #991b1b; }
    .status-in-corso { background-color: #fef3c7; color: #92400e; }
    .status-risolto { background-color: #d1fae5; color: #065f46; }
    .severity-critical { background-color: #fecaca; color: #991b1b; }
    .severity-high { background-color: #fed7aa; color: #9a3412; }
    .severity-medium { background-color: #fef08a; color: #854d0e; }
    .severity-low { background-color: #bfdbfe; color: #1e40af; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50"><!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
      <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
     </div>
     <h1 class="text-3xl font-bold text-gray-800">Piattaforma CSIRT</h1>
     <p class="text-gray-600 mt-2">Gestione Sicurezza e Compliance NIS2</p>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-6">
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="login-email" placeholder="inserisci@email.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Profilo</label> <select id="login-role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> <option value="">Seleziona il tuo ruolo</option> <option value="admin">ğŸ‘¤ Amministratore</option> <option value="csirt">ğŸ›¡ï¸ Consulente/Referente CSIRT</option> <option value="azienda">ğŸ¢ Referente Aziendale</option> </select>
     </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"> Accedi alla Piattaforma </button>
    </form>
    <div class="mt-6 pt-6 border-t border-gray-200">
     <p class="text-center text-sm text-gray-600">Demo - Credenziali di test:</p>
     <div class="mt-2 space-y-1 text-xs text-gray-500">
      <p>ğŸ‘¤ Admin: admin@csirt.it / admin123</p>
      <p>ğŸ›¡ï¸ CSIRT: csirt@hub.it / csirt123</p>
      <p>ğŸ¢ Azienda: azienda@test.it / azienda123</p>
     </div>
    </div>
   </div>
  </div><!-- Main App (Hidden until login) -->
  <div id="main-app" class="hidden"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
       <svg class="w-10 h-10" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
       </svg>
       <div>
        <h1 class="text-2xl font-bold">Piattaforma CSIRT</h1>
        <p class="text-blue-100 text-sm">Sistema di Gestione Sicurezza e Compliance NIS2</p>
       </div>
      </div>
      <div class="flex items-center space-x-4">
       <div class="text-right">
        <p class="text-sm font-medium" id="user-name">Admin User</p>
        <p class="text-xs text-blue-100" id="user-role">Amministratore</p>
       </div>
       <div id="api-status" class="hidden px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
        âœ“ API Connessa
       </div><button onclick="logout()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg><span>Esci</span> </button>
      </div>
     </div>
    </div>
   </header>
   <div class="flex" style="height: calc(100% - 80px);"><!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg overflow-y-auto">
     <nav class="p-4 space-y-2" id="sidebar-nav"><button onclick="showSection('dashboard')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
       </svg><span>Dashboard</span> </button> <button onclick="showSection('companies')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg><span>Aziende</span> </button> <button onclick="showSection('incidents')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg><span>Incidenti</span> </button> <button onclick="showSection('notifications')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin,csirt">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
       </svg><span>Notifiche ACN</span> </button> <button onclick="showSection('csirt-profile')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
       </svg><span>Profilo CSIRT</span> </button> <button onclick="showSection('network')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
       </svg><span>Rete Aziendale</span> </button> <button onclick="showSection('audit')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
       </svg><span>Audit e Compliance</span> </button> <button onclick="showSection('users')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
       </svg><span>Gestione Utenti</span> </button> <button onclick="showSection('api-settings')" class="nav-item flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors" data-role="admin">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
       </svg><span>Impostazioni API</span> </button>
     </nav>
    </aside><!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8" style="height: 100%;"><!-- Dashboard Section -->
     <section id="dashboard-section" class="section-content">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Generale</h2><!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Aziende Monitorate</p>
          <p id="total-companies" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-blue-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Incidenti Aperti</p>
          <p id="open-incidents" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-red-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Notifiche Pending</p>
          <p id="pending-notifications" class="text-3xl font-bold text-gray-800 mt-2">0</p>
         </div>
         <div class="bg-yellow-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm font-medium">Compliance Score</p>
          <p id="compliance-score" class="text-3xl font-bold text-gray-800 mt-2">0%</p>
         </div>
         <div class="bg-green-100 p-3 rounded-full">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
        </div>
       </div>
      </div><!-- Recent Activity -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
       <h3 class="text-xl font-bold text-gray-800 mb-4">AttivitÃ  Recenti</h3>
       <div id="recent-activity" class="space-y-3">
        <p class="text-gray-500 text-center py-8">Nessuna attivitÃ  recente</p>
       </div>
      </div><!-- CSIRT Dashboard Cards -->
      <div id="csirt-dashboard-cards" class="hidden">
       <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div onclick="showSection('incidents')" class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl shadow-md p-6 border-l-4 border-red-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-red-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸš¨ Registro Incidenti</h3>
         <p class="text-gray-600 text-sm">Gestisci e registra incidenti di sicurezza conformi NIS2</p>
         <div class="mt-4 text-sm font-medium text-red-700">
          Clicca per gestire â†’
         </div>
        </div>
        <div onclick="showSection('designation-detail')" class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-md p-6 border-l-4 border-purple-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-purple-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ“‹ Designazione Referente CSIRT</h3>
         <p class="text-gray-600 text-sm">Gestisci i dati del referente CSIRT, sostituti e contatto ACN</p>
         <div class="mt-4 text-sm font-medium text-purple-700">
          Clicca per compilare â†’
         </div>
        </div>
        <div onclick="showSection('network')" class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-md p-6 border-l-4 border-green-500 cursor-pointer hover:shadow-xl transition-all transform hover:scale-105">
         <div class="flex items-center justify-between mb-4">
          <div class="bg-green-500 p-3 rounded-full">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
           </svg>
          </div>
          <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
         </div>
         <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸŒ Configurazione Rete Aziendale</h3>
         <p class="text-gray-600 text-sm">Definisci topologia, sicurezza perimetrale e connettivitÃ </p>
         <div class="mt-4 text-sm font-medium text-green-700">
          Clicca per configurare â†’
         </div>
        </div>
       </div>
      </div>
     </section><!-- Companies Section -->
     <section id="companies-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Gestione Aziende</h2>
       <p class="text-gray-600 mb-6">Registra e monitora le aziende clienti soggette a NIS2</p>
       <div class="bg-white rounded-xl shadow-md p-8 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6"><span id="company-form-title">â• Aggiungi Nuova Azienda</span></h3>
        <form id="new-company-form" onsubmit="handleCompanySubmit(event)" class="space-y-6"><input type="hidden" id="edit-company-id" value="">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label for="company-name" class="block text-sm font-medium text-gray-700 mb-2"> Ragione Sociale <span class="text-red-500">*</span> </label> <input type="text" id="company-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. Acme SRL">
          </div>
          <div><label for="company-vat" class="block text-sm font-medium text-gray-700 mb-2"> Partita IVA <span class="text-red-500">*</span> </label> <input type="text" id="company-vat" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. IT12345678901">
          </div>
          <div><label for="company-sector" class="block text-sm font-medium text-gray-700 mb-2"> Settore <span class="text-red-500">*</span> </label> <select id="company-sector" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Seleziona settore</option> <option value="energia">Energia</option> <option value="trasporti">Trasporti</option> <option value="bancario">Bancario</option> <option value="sanitario">Sanitario</option> <option value="digitale">Servizi Digitali</option> <option value="acqua">Acqua</option> <option value="altro">Altro</option> </select>
          </div>
          <div><label for="company-category" class="block text-sm font-medium text-gray-700 mb-2"> Categoria NIS2 <span class="text-red-500">*</span> </label> <select id="company-category" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Seleziona categoria</option> <option value="essenziale">Essenziale</option> <option value="importante">Importante</option> </select>
          </div>
          <div class="md:col-span-2"><label for="company-address" class="block text-sm font-medium text-gray-700 mb-2"> Indirizzo </label> <input type="text" id="company-address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. Via Roma 123, Milano">
          </div>
          <div><label for="company-email" class="block text-sm font-medium text-gray-700 mb-2"> Email <span class="text-red-500">*</span> </label> <input type="email" id="company-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. info@acme.it">
          </div>
          <div><label for="company-phone" class="block text-sm font-medium text-gray-700 mb-2"> Telefono <span class="text-red-500">*</span> </label> <input type="tel" id="company-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. +39 02 12345678">
          </div>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" id="save-company-btn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Azienda </button> <button type="button" onclick="cancelEditCompany()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"> ğŸ”„ Annulla </button>
          <div id="company-save-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div>
       <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
         <h3 class="text-lg font-bold text-gray-800">ğŸ“‹ Aziende Registrate</h3>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azienda</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P.IVA</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Settore</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contatti</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
           </tr>
          </thead>
          <tbody id="companies-table-body" class="bg-white divide-y divide-gray-200"><!-- Companies will be loaded here -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </section><!-- Incidents Section -->
     <section id="incidents-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Registro Incidenti di Sicurezza</h2>
       <p class="text-gray-600 mb-6">Documenta e traccia tutti gli incidenti secondo i requisiti NIS2</p>
       <div class="bg-white rounded-xl shadow-md p-8 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6"><span id="incident-form-title">â• Registra Nuovo Incidente</span></h3>
        <form id="new-incident-form" onsubmit="handleIncidentSubmit(event)" class="space-y-6"><input type="hidden" id="edit-incident-id" value="">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2"><label for="incident-title" class="block text-sm font-medium text-gray-700 mb-2"> Titolo Incidente <span class="text-red-500">*</span> </label> <input type="text" id="incident-title" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="es. Attacco ransomware ai server di produzione">
          </div>
          <div><label for="incident-company" class="block text-sm font-medium text-gray-700 mb-2"> Azienda <span class="text-red-500">*</span> </label> <select id="incident-company" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"> <option value="">Seleziona azienda</option> </select>
          </div>
          <div><label for="incident-date" class="block text-sm font-medium text-gray-700 mb-2"> Data Rilevamento <span class="text-red-500">*</span> </label> <input type="datetime-local" id="incident-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
          </div>
          <div><label for="incident-category" class="block text-sm font-medium text-gray-700 mb-2"> Categoria <span class="text-red-500">*</span> </label> <select id="incident-category" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"> <option value="">Seleziona categoria</option> <option value="malware">Malware/Ransomware</option> <option value="phishing">Phishing</option> <option value="ddos">DDoS</option> <option value="data-breach">Data Breach</option> <option value="unauthorized-access">Accesso non autorizzato</option> <option value="altro">Altro</option> </select>
          </div>
          <div><label for="incident-severity" class="block text-sm font-medium text-gray-700 mb-2"> SeveritÃ  <span class="text-red-500">*</span> </label> <select id="incident-severity" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"> <option value="">Seleziona severitÃ </option> <option value="critical">ğŸ”´ Critica</option> <option value="high">ğŸŸ  Alta</option> <option value="medium">ğŸŸ¡ Media</option> <option value="low">ğŸ”µ Bassa</option> </select>
          </div>
          <div><label for="incident-status" class="block text-sm font-medium text-gray-700 mb-2"> Stato <span class="text-red-500">*</span> </label> <select id="incident-status" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"> <option value="aperto">ğŸ”´ Aperto</option> <option value="in-corso">ğŸŸ¡ In Corso</option> <option value="risolto">ğŸŸ¢ Risolto</option> </select>
          </div>
          <div class="md:col-span-2"><label for="incident-systems" class="block text-sm font-medium text-gray-700 mb-2"> Sistemi Interessati <span class="text-red-500">*</span> </label> <input type="text" id="incident-systems" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="es. Server Windows DC01, Database Produzione">
          </div>
          <div><label for="incident-users" class="block text-sm font-medium text-gray-700 mb-2"> Utenti Coinvolti </label> <input type="number" id="incident-users" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Numero utenti interessati">
          </div>
          <div><label for="incident-data-compromised" class="block text-sm font-medium text-gray-700 mb-2"> Dati Compromessi </label> <input type="text" id="incident-data-compromised" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="es. Dati personali, credenziali">
          </div>
          <div class="md:col-span-2"><label for="incident-impact" class="block text-sm font-medium text-gray-700 mb-2"> Descrizione Impatto <span class="text-red-500">*</span> </label> <textarea id="incident-impact" required rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Descrivi l'impatto dell'incidente sui servizi e sui dati"></textarea>
          </div>
          <div class="md:col-span-2"><label for="incident-technical" class="block text-sm font-medium text-gray-700 mb-2"> Dettagli Tecnici <span class="text-red-500">*</span> </label> <textarea id="incident-technical" required rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Dettagli tecnici dell'incidente, vettore di attacco, ecc."></textarea>
          </div>
          <div class="md:col-span-2"><label for="incident-containment" class="block text-sm font-medium text-gray-700 mb-2"> Azioni di Contenimento <span class="text-red-500">*</span> </label> <textarea id="incident-containment" required rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Azioni immediate per contenere l'incidente"></textarea>
          </div>
          <div class="md:col-span-2"><label for="incident-notes" class="block text-sm font-medium text-gray-700 mb-2"> Note Aggiuntive </label> <textarea id="incident-notes" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Altre informazioni rilevanti"></textarea>
          </div>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" id="save-incident-btn" class="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Incidente </button> <button type="button" onclick="cancelEditIncident()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"> ğŸ”„ Annulla </button>
          <div id="incident-save-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div>
       <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
         <h3 class="text-lg font-bold text-gray-800">ğŸ“‹ Incidenti Registrati</h3>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titolo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azienda</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SeveritÃ </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
           </tr>
          </thead>
          <tbody id="incidents-table-body" class="bg-white divide-y divide-gray-200"><!-- Incidents will be loaded here -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </section><!-- Notifications Section -->
     <section id="notifications-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Notifiche ACN</h2>
       <p class="text-gray-600 mb-6">Gestisci le notifiche all'Agenzia per la Cybersicurezza Nazionale</p>
       <div class="bg-white rounded-xl shadow-md p-8 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6">â• Crea Nuova Notifica</h3>
        <form id="new-notification-form" onsubmit="handleNotificationSubmit(event)" class="space-y-6">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label for="notification-incident" class="block text-sm font-medium text-gray-700 mb-2"> Incidente Correlato <span class="text-red-500">*</span> </label> <select id="notification-incident" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"> <option value="">Seleziona incidente</option> </select>
          </div>
          <div><label for="notification-type" class="block text-sm font-medium text-gray-700 mb-2"> Tipo Notifica <span class="text-red-500">*</span> </label> <select id="notification-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"> <option value="">Seleziona tipo</option> <option value="preallarme">Preallarme (entro 24h)</option> <option value="notifica-completa">Notifica Completa (entro 72h)</option> <option value="report-finale">Report Finale (entro 1 mese)</option> </select>
          </div>
          <div><label for="notification-date" class="block text-sm font-medium text-gray-700 mb-2"> Data Notifica <span class="text-red-500">*</span> </label> <input type="datetime-local" id="notification-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
          </div>
          <div><label for="notification-status" class="block text-sm font-medium text-gray-700 mb-2"> Stato <span class="text-red-500">*</span> </label> <select id="notification-status" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"> <option value="pending">â³ In Attesa</option> <option value="inviata">ï¿½ï¿½ï¿½ï¿½ Inviata</option> <option value="confermata">âœ… Confermata da ACN</option> </select>
          </div>
          <div class="md:col-span-2"><label for="notification-recipient" class="block text-sm font-medium text-gray-700 mb-2"> Destinatario <span class="text-red-500">*</span> </label> <input type="text" id="notification-recipient" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" value="csirt@acn.gov.it" placeholder="Email destinatario ACN">
          </div>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" id="save-notification-btn" class="px-8 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Notifica </button>
          <div id="notification-save-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div>
       <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
         <h3 class="text-lg font-bold text-gray-800">ğŸ“‹ Notifiche Registrate</h3>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Incidente</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Notifica</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destinatario</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
           </tr>
          </thead>
          <tbody id="notifications-table-body" class="bg-white divide-y divide-gray-200"><!-- Notifications will be loaded here -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </section><!-- CSIRT Profile Section -->
     <section id="csirt-profile-section" class="section-content hidden">
      <div class="max-w-4xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-6">Profilo Consulente CSIRT</h2>
       <div class="bg-white rounded-xl shadow-md p-8">
        <form id="csirt-profile-form" onsubmit="handleProfileSubmit(event)" class="space-y-6">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2"><label for="profile-name" class="block text-sm font-medium text-gray-700 mb-2"> Nome Completo <span class="text-red-500">*</span> </label> <input type="text" id="profile-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          </div>
          <div><label for="profile-email" class="block text-sm font-medium text-gray-700 mb-2"> Email <span class="text-red-500">*</span> </label> <input type="email" id="profile-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          </div>
          <div><label for="profile-phone" class="block text-sm font-medium text-gray-700 mb-2"> Telefono <span class="text-red-500">*</span> </label> <input type="tel" id="profile-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          </div>
          <div class="md:col-span-2"><label for="profile-certifications" class="block text-sm font-medium text-gray-700 mb-2"> Certificazioni </label> <input type="text" id="profile-certifications" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. CISSP, CEH, CISM">
          </div>
          <div class="md:col-span-2"><label for="profile-experience" class="block text-sm font-medium text-gray-700 mb-2"> Esperienza </label> <textarea id="profile-experience" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Descrivi la tua esperienza nel campo della cybersecurity"></textarea>
          </div>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Profilo </button>
          <div id="profile-save-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div>
      </div>
     </section><!-- Network Section -->
     <section id="network-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Configurazione Rete Aziendale</h2>
       <p class="text-gray-600 mb-6">Definisci la topologia, sicurezza perimetrale e connettivitÃ  della rete</p><!-- Tab Navigation -->
       <div class="bg-white rounded-t-xl shadow-md">
        <div class="flex border-b border-gray-200"><button id="tab-config" onclick="showNetworkTab('config')" class="network-tab px-6 py-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600"> âš™ï¸ Configurazione </button> <button id="tab-diagram" onclick="showNetworkTab('diagram')" class="network-tab px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"> ğŸ“Š Diagramma </button> <button id="tab-hierarchy" onclick="showNetworkTab('hierarchy')" class="network-tab px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"> ğŸŒ³ Gerarchia </button>
        </div>
       </div><!-- Config Tab -->
       <div id="network-tab-config" class="network-tab-content bg-white rounded-b-xl shadow-md p-8">
        <form id="network-config-form" onsubmit="handleNetworkSubmit(event)" class="space-y-6"><!-- Topologia di Rete -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸŒ Topologia di Rete</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label for="net-topology" class="block text-sm font-medium text-gray-700 mb-2"> Tipo Topologia <span class="text-red-500">*</span> </label> <select id="net-topology" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"> <option value="">Seleziona topologia</option> <option value="star">â­ Stella</option> <option value="mesh">ğŸ•¸ï¸ Mesh</option> <option value="hybrid">ğŸ”€ Ibrida</option> <option value="hierarchical">ğŸ“Š Gerarchica</option> </select>
           </div>
           <div><label for="net-size" class="block text-sm font-medium text-gray-700 mb-2"> Dimensione Rete <span class="text-red-500">*</span> </label> <select id="net-size" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"> <option value="">Seleziona dimensione</option> <option value="small">Piccola (&lt; 50 dispositivi)</option> <option value="medium">Media (50-200 dispositivi)</option> <option value="large">Grande (&gt; 200 dispositivi)</option> </select>
           </div>
           <div><label for="net-subnets" class="block text-sm font-medium text-gray-700 mb-2"> Numero Subnet <span class="text-red-500">*</span> </label> <input type="number" id="net-subnets" required min="1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. 5">
           </div>
           <div><label for="net-vlans" class="block text-sm font-medium text-gray-700 mb-2"> Numero VLAN </label> <input type="number" id="net-vlans" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. 3">
           </div>
          </div>
         </div><!-- Sicurezza Perimetrale -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ”’ Sicurezza Perimetrale</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label for="firewall-type" class="block text-sm font-medium text-gray-700 mb-2"> Tipo Firewall <span class="text-red-500">*</span> </label> <select id="firewall-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"> <option value="">Seleziona tipo</option> <option value="ngfw">ğŸ”¥ NGFW (Next-Gen)</option> <option value="stateful">ğŸ“Š Stateful</option> <option value="utm">ğŸ›¡ï¸ UTM</option> <option value="cloud">â˜ï¸ Cloud-based</option> </select>
           </div>
           <div><label for="firewall-vendor" class="block text-sm font-medium text-gray-700 mb-2"> Vendor Firewall </label> <input type="text" id="firewall-vendor" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. Palo Alto, Fortinet, Cisco">
           </div>
           <div class="flex items-center space-x-4"><input type="checkbox" id="has-ids" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500"> <label for="has-ids" class="text-sm font-medium text-gray-700"> IDS/IPS Attivo </label>
           </div>
           <div class="flex items-center space-x-4"><input type="checkbox" id="has-waf" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500"> <label for="has-waf" class="text-sm font-medium text-gray-700"> WAF (Web Application Firewall) </label>
           </div>
          </div>
         </div><!-- ConnettivitÃ  -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“¡ ConnettivitÃ </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label for="isp-primary" class="block text-sm font-medium text-gray-700 mb-2"> ISP Primario <span class="text-red-500">*</span> </label> <input type="text" id="isp-primary" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. TIM, Vodafone">
           </div>
           <div><label for="isp-secondary" class="block text-sm font-medium text-gray-700 mb-2"> ISP Secondario (Backup) </label> <input type="text" id="isp-secondary" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. Fastweb">
           </div>
           <div><label for="bandwidth" class="block text-sm font-medium text-gray-700 mb-2"> Banda Disponibile <span class="text-red-500">*</span> </label> <input type="text" id="bandwidth" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. 1 Gbps">
           </div>
           <div class="flex items-center space-x-4"><input type="checkbox" id="has-vpn" class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500"> <label for="has-vpn" class="text-sm font-medium text-gray-700"> VPN Aziendale Configurata </label>
           </div>
          </div>
         </div><!-- Note -->
         <div><label for="network-notes" class="block text-sm font-medium text-gray-700 mb-2"> Note Aggiuntive </label> <textarea id="network-notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Aggiungi dettagli sulla configurazione di rete"></textarea>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" id="save-network-btn" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Configurazione </button>
          <div id="network-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div><!-- Diagram Tab -->
       <div id="network-tab-diagram" class="network-tab-content hidden bg-white rounded-b-xl shadow-md p-8">
        <div id="network-visual-diagram" class="min-h-96">
         <div class="flex flex-col items-center justify-center py-16 text-center">
          <svg class="w-24 h-24 text-gray-300 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p class="text-xl font-semibold text-gray-600 mb-2">Nessuna configurazione salvata</p>
          <p class="text-gray-500">Compila e salva la configurazione nel tab "âš™ï¸ Configurazione" per visualizzare il diagramma</p>
         </div>
        </div>
       </div><!-- Hierarchy Tab -->
       <div id="network-tab-hierarchy" class="network-tab-content hidden bg-white rounded-b-xl shadow-md p-8">
        <div id="network-hierarchy-view" class="min-h-96">
         <div class="flex flex-col items-center justify-center py-16 text-center">
          <svg class="w-24 h-24 text-gray-300 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
          <p class="text-xl font-semibold text-gray-600 mb-2">Nessuna configurazione salvata</p>
          <p class="text-gray-500">Compila e salva la configurazione nel tab "âš™ï¸ Configurazione" per visualizzare la gerarchia</p>
         </div>
        </div>
       </div>
      </div>
     </section><!-- Audit Section -->
     <section id="audit-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Audit e Compliance NIS2</h2>
       <p class="text-gray-600 mb-6">Traccia audit e verifiche di conformitÃ  alla direttiva NIS2</p>
       <div class="bg-white rounded-xl shadow-md p-8 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6">â• Registra Nuovo Audit</h3>
        <form id="new-audit-form" onsubmit="handleAuditSubmit(event)" class="space-y-6">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2"><label for="audit-title" class="block text-sm font-medium text-gray-700 mb-2"> Titolo Audit <span class="text-red-500">*</span> </label> <input type="text" id="audit-title" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. Verifica ConformitÃ  NIS2 - Q1 2024">
          </div>
          <div><label for="audit-company" class="block text-sm font-medium text-gray-700 mb-2"> Azienda <span class="text-red-500">*</span> </label> <select id="audit-company" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"> <option value="">Seleziona azienda</option> </select>
          </div>
          <div><label for="audit-date" class="block text-sm font-medium text-gray-700 mb-2"> Data Audit <span class="text-red-500">*</span> </label> <input type="date" id="audit-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
          <div><label for="audit-score" class="block text-sm font-medium text-gray-700 mb-2"> Score Compliance (0-100) <span class="text-red-500">*</span> </label> <input type="number" id="audit-score" required min="0" max="100" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. 85">
          </div>
          <div class="md:col-span-2"><label for="audit-notes" class="block text-sm font-medium text-gray-700 mb-2"> Note e Osservazioni </label> <textarea id="audit-notes" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Dettagli dell'audit, aree di miglioramento, raccomandazioni"></textarea>
          </div>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" id="save-audit-btn" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Audit </button>
          <div id="audit-save-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div>
       <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
         <h3 class="text-lg font-bold text-gray-800">ğŸ“‹ Audit Registrati</h3>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titolo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azienda</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
           </tr>
          </thead>
          <tbody id="audits-table-body" class="bg-white divide-y divide-gray-200"><!-- Audits will be loaded here -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </section><!-- Users Management Section -->
     <section id="users-section" class="section-content hidden">
      <div class="max-w-6xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Gestione Utenti</h2>
       <p class="text-gray-600 mb-6">Crea e gestisci gli utenti della piattaforma</p>
       <div class="bg-white rounded-xl shadow-md p-8 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6"><span id="user-form-title">â• Aggiungi Nuovo Utente</span></h3>
        <form id="new-user-form" onsubmit="handleUserSubmit(event)" class="space-y-6"><input type="hidden" id="edit-user-id" value="">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label for="new-user-name" class="block text-sm font-medium text-gray-700 mb-2"> Nome Completo <span class="text-red-500">*</span> </label> <input type="text" id="new-user-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Mario Rossi">
          </div>
          <div><label for="new-user-email" class="block text-sm font-medium text-gray-700 mb-2"> Email <span class="text-red-500">*</span> </label> <input type="email" id="new-user-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. mario.rossi@email.it">
          </div>
          <div><label for="new-user-phone" class="block text-sm font-medium text-gray-700 mb-2"> Telefono <span class="text-red-500">*</span> </label> <input type="tel" id="new-user-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. +39 333 1234567">
          </div>
          <div><label for="new-user-role" class="block text-sm font-medium text-gray-700 mb-2"> Ruolo <span class="text-red-500">*</span> </label> <select id="new-user-role" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"> <option value="">Seleziona ruolo</option> <option value="admin">ğŸ‘¤ Amministratore</option> <option value="csirt">ğŸ›¡ï¸ Consulente/Referente CSIRT</option> <option value="azienda">ğŸ¢ Referente Aziendale</option> </select>
          </div>
          <div class="md:col-span-2"><label for="new-user-company" class="block text-sm font-medium text-gray-700 mb-2"> Azienda (opzionale) </label> <select id="new-user-company" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"> <option value="">Nessuna azienda associata</option> </select>
          </div>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" id="save-user-btn" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Utente </button> <button type="button" onclick="cancelEditUser()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"> ğŸ”„ Annulla </button>
          <div id="user-save-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div>
       <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
         <h3 class="text-lg font-bold text-gray-800">ğŸ“‹ Utenti Registrati</h3>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefono</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ruolo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azienda</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
           </tr>
          </thead>
          <tbody id="users-table-body" class="bg-white divide-y divide-gray-200"><!-- Users will be loaded here -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </section><!-- Designation Detail Section (NEW) -->
     <section id="designation-detail-section" class="section-content hidden">
      <div class="max-w-5xl">
       <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“‹ Designazione Referente CSIRT</h2>
       <p class="text-gray-600 mb-6">Compila i dati del referente CSIRT, sostituti e contatto ACN secondo normativa NIS2</p>
       <div class="bg-white rounded-xl shadow-md p-8">
        <form id="designation-form" onsubmit="handleDesignationSubmit(event)" class="space-y-8"><!-- Dati Generali -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“… Dati Generali</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label for="des-company" class="block text-sm font-medium text-gray-700 mb-2"> Azienda <span class="text-red-500">*</span> </label> <select id="des-company" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"> <option value="">Seleziona azienda</option> </select>
           </div>
           <div><label for="des-appointment-date" class="block text-sm font-medium text-gray-700 mb-2"> Data Nomina <span class="text-red-500">*</span> </label> <input type="date" id="des-appointment-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
           </div>
          </div>
         </div><!-- Referente CSIRT -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¤ Referente CSIRT</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label for="des-ref-fullname" class="block text-sm font-medium text-gray-700 mb-2"> Nome e Cognome <span class="text-red-500">*</span> </label> <input type="text" id="des-ref-fullname" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Mario Rossi">
           </div>
           <div><label for="des-ref-cf" class="block text-sm font-medium text-gray-700 mb-2"> Codice Fiscale <span class="text-red-500">*</span> </label> <input type="text" id="des-ref-cf" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. RSSMRA80A01H501Z">
           </div>
           <div><label for="des-ref-email" class="block text-sm font-medium text-gray-700 mb-2"> Email <span class="text-red-500">*</span> </label> <input type="email" id="des-ref-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. mario.rossi@azienda.it">
           </div>
           <div><label for="des-ref-phone" class="block text-sm font-medium text-gray-700 mb-2"> Telefono <span class="text-red-500">*</span> </label> <input type="tel" id="des-ref-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. +39 333 1234567">
           </div>
          </div>
         </div><!-- Contatto ACN -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ›ï¸ Contatto ACN</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
           <div><label for="des-acn-name" class="block text-sm font-medium text-gray-700 mb-2"> Nome <span class="text-red-500">*</span> </label> <input type="text" id="des-acn-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Luigi">
           </div>
           <div><label for="des-acn-surname" class="block text-sm font-medium text-gray-700 mb-2"> Cognome <span class="text-red-500">*</span> </label> <input type="text" id="des-acn-surname" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Verdi">
           </div>
           <div><label for="des-acn-email" class="block text-sm font-medium text-gray-700 mb-2"> Email <span class="text-red-500">*</span> </label> <input type="email" id="des-acn-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. luigi.verdi@acn.gov.it">
           </div>
          </div>
         </div><!-- Sostituto 1 -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ Sostituto 1</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label for="des-sub1-name" class="block text-sm font-medium text-gray-700 mb-2"> Nome <span class="text-red-500">*</span> </label> <input type="text" id="des-sub1-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Anna">
           </div>
           <div><label for="des-sub1-surname" class="block text-sm font-medium text-gray-700 mb-2"> Cognome <span class="text-red-500">*</span> </label> <input type="text" id="des-sub1-surname" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Bianchi">
           </div>
           <div><label for="des-sub1-email" class="block text-sm font-medium text-gray-700 mb-2"> Email <span class="text-red-500">*</span> </label> <input type="email" id="des-sub1-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. anna.bianchi@azienda.it">
           </div>
           <div><label for="des-sub1-phone" class="block text-sm font-medium text-gray-700 mb-2"> Telefono <span class="text-red-500">*</span> </label> <input type="tel" id="des-sub1-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. +39 333 9876543">
           </div>
          </div>
         </div><!-- Sostituto 2 -->
         <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ Sostituto 2</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <div><label for="des-sub2-name" class="block text-sm font-medium text-gray-700 mb-2"> Nome <span class="text-red-500">*</span> </label> <input type="text" id="des-sub2-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Luca">
           </div>
           <div><label for="des-sub2-surname" class="block text-sm font-medium text-gray-700 mb-2"> Cognome <span class="text-red-500">*</span> </label> <input type="text" id="des-sub2-surname" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. Neri">
           </div>
           <div><label for="des-sub2-email" class="block text-sm font-medium text-gray-700 mb-2"> Email <span class="text-red-500">*</span> </label> <input type="email" id="des-sub2-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. luca.neri@azienda.it">
           </div>
           <div><label for="des-sub2-phone" class="block text-sm font-medium text-gray-700 mb-2"> Telefono <span class="text-red-500">*</span> </label> <input type="tel" id="des-sub2-phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="es. +39 333 5551234">
           </div>
          </div>
         </div><!-- Note -->
         <div><label for="des-external-reason" class="block text-sm font-medium text-gray-700 mb-2"> Motivazione (se referente esterno) </label> <textarea id="des-external-reason" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Indicare le motivazioni se il referente Ã¨ esterno all'azienda"></textarea>
         </div>
         <div class="flex items-center space-x-4 pt-4 border-t border-gray-200"><button type="submit" id="save-designation-btn" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors"> ğŸ’¾ Salva Designazione </button>
          <div id="designation-save-status" class="text-sm font-medium"></div>
         </div>
        </form>
       </div>
      </div>
     </section><!-- API Settings Section -->
     <section id="api-settings-section" class="section-content hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Impostazioni API Supabase</h2>
      <div class="bg-white rounded-xl shadow-md p-8 max-w-4xl">
       <div class="mb-6">
        <div class="flex items-center space-x-3 mb-4">
         <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
         </svg>
         <h3 class="text-xl font-bold text-gray-800">Configurazione Database</h3>
        </div>
        <p class="text-gray-600">Inserisci le credenziali del tuo progetto Supabase per connettere la piattaforma al database cloud.</p>
       </div>
       <div id="api-connection-status" class="hidden mb-6 p-4 rounded-lg"></div>
       <form id="api-settings-form" onsubmit="saveAPISettings(event)" class="space-y-6 mb-8">
        <div><label class="block text-sm font-medium text-gray-700 mb-2"> Supabase URL <span class="text-red-500">*</span> </label> <input type="url" id="supabase-url" placeholder="https://xxx.supabase.co" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2"> Anon Public Key <span class="text-red-500">*</span> </label> <textarea id="supabase-key" rows="3" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm" required></textarea>
        </div>
        <div class="flex space-x-4"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"> Salva e Connetti </button> <button type="button" onclick="testAPIConnection()" class="px-6 py-3 border border-gray-300 hover:bg-gray-50 rounded-lg transition-colors"> Testa Connessione </button>
        </div>
       </form><!-- SQL Setup -->
       <div class="border-t border-gray-200 pt-8">
        <div class="mb-4">
         <h4 class="text-lg font-bold text-gray-800 mb-2">ï¿½ï¿½ï¸ Setup Database (VERSIONE 3.0)</h4>
         <p class="text-sm text-gray-600 mb-4"><strong>âš ï¸ IMPORTANTE:</strong> Script aggiornato con supporto per <strong>Configurazione Rete</strong> e <strong>Designazione CSIRT</strong>.</p>
         <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
          <div class="flex items-center justify-between mb-2"><span class="text-sm font-medium text-gray-700">Script SQL Database (VERSIONE 3.0)</span> <button onclick="copySQLScript()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors"> ğŸ“‹ Copia Script </button>
          </div>
          <pre id="sql-script" class="bg-gray-900 text-green-400 p-4 rounded text-xs overflow-x-auto" style="max-height: 400px; font-family: 'Courier New', monospace;">-- SETUP DATABASE PIATTAFORMA CSIRT - VERSIONE 3.0 CON RETE E DESIGNAZIONI
-- Esegui questo script nell'editor SQL di Supabase (SQL Editor)

-- Elimina tabelle esistenti
DROP TABLE IF EXISTS csirt_network_configs CASCADE;
DROP TABLE IF EXISTS csirt_designations CASCADE;
DROP TABLE IF EXISTS csirt_audits CASCADE;
DROP TABLE IF EXISTS csirt_notifications CASCADE;
DROP TABLE IF EXISTS csirt_incidents CASCADE;
DROP TABLE IF EXISTS csirt_users CASCADE;
DROP TABLE IF EXISTS csirt_companies CASCADE;

-- 1. Tabella Aziende
CREATE TABLE csirt_companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  vat TEXT UNIQUE NOT NULL,
  sector TEXT NOT NULL,
  category TEXT NOT NULL,
  address TEXT,
  email TEXT NOT NULL,
  phone TEXT NOT NULL,
  csirt_user_id UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Tabella Utenti
CREATE TABLE csirt_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  full_name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT NOT NULL,
  role TEXT NOT NULL,
  company_id UUID REFERENCES csirt_companies(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Tabella Incidenti
CREATE TABLE csirt_incidents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES csirt_companies(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  detection_date TIMESTAMP WITH TIME ZONE NOT NULL,
  category TEXT NOT NULL,
  severity TEXT NOT NULL,
  status TEXT NOT NULL,
  affected_systems TEXT NOT NULL,
  users_affected INTEGER DEFAULT 0,
  data_compromised TEXT,
  impact_description TEXT NOT NULL,
  technical_details TEXT NOT NULL,
  indicators TEXT,
  containment_actions TEXT NOT NULL,
  eradication_actions TEXT,
  recovery_actions TEXT,
  notified_acn BOOLEAN DEFAULT false,
  acn_notification_date TIMESTAMP WITH TIME ZONE,
  acn_protocol TEXT,
  communications TEXT,
  timeline TEXT,
  lessons_learned TEXT,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Tabella Notifiche ACN
CREATE TABLE csirt_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  incident_id UUID REFERENCES csirt_incidents(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  status TEXT NOT NULL,
  notification_date TIMESTAMP WITH TIME ZONE NOT NULL,
  recipient TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. Tabella Audit e Compliance
CREATE TABLE csirt_audits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES csirt_companies(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  audit_date TIMESTAMP WITH TIME ZONE NOT NULL,
  score INTEGER NOT NULL,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 6. Tabella Configurazione Rete Aziendale
CREATE TABLE csirt_network_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES csirt_companies(id) ON DELETE CASCADE,
  topology TEXT NOT NULL,
  size TEXT NOT NULL,
  subnets INTEGER NOT NULL,
  vlans INTEGER DEFAULT 0,
  firewall_type TEXT NOT NULL,
  firewall_vendor TEXT,
  has_ids BOOLEAN DEFAULT false,
  has_waf BOOLEAN DEFAULT false,
  isp_primary TEXT NOT NULL,
  isp_secondary TEXT,
  bandwidth TEXT NOT NULL,
  has_vpn BOOLEAN DEFAULT false,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 7. Tabella Designazione Referente CSIRT
CREATE TABLE csirt_designations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES csirt_companies(id) ON DELETE CASCADE,
  appointment_date DATE NOT NULL,
  referent_fullname TEXT NOT NULL,
  referent_cf TEXT NOT NULL,
  referent_email TEXT NOT NULL,
  referent_phone TEXT NOT NULL,
  acn_contact_name TEXT NOT NULL,
  acn_contact_surname TEXT NOT NULL,
  acn_contact_email TEXT NOT NULL,
  substitute1_name TEXT NOT NULL,
  substitute1_surname TEXT NOT NULL,
  substitute1_email TEXT NOT NULL,
  substitute1_phone TEXT NOT NULL,
  substitute2_name TEXT NOT NULL,
  substitute2_surname TEXT NOT NULL,
  substitute2_email TEXT NOT NULL,
  substitute2_phone TEXT NOT NULL,
  external_reason TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Setup completato</pre>
         </div>
         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm text-blue-800"><strong>ğŸ“ Dove eseguire lo script:</strong><br>
            1. Vai su Supabase Dashboard â†’ SQL Editor<br>
            2. Crea una "New query"<br>
            3. Incolla lo script sopra<br>
            4. Clicca "Run" (o premi Ctrl+Enter)<br>
            5. Torna qui e clicca "Salva e Connetti"</p>
         </div>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div>
  </div>
  <script>
    // === GLOBAL STATE ===
    let supabase = null;
    let currentUser = null;

    const DEMO_USERS = [
      { email: 'admin@csirt.it', password: 'admin123', role: 'admin', name: 'Admin Sistema', company: null },
      { email: 'csirt@hub.it', password: 'csirt123', role: 'csirt', name: 'Marco Rossi', company: null },
      { email: 'azienda@test.it', password: 'azienda123', role: 'azienda', name: 'Giuseppe Verdi', company: 'Azienda Test SRL' }
    ];

    // Log per debug credenziali
    console.log('ğŸ” Credenziali disponibili:', DEMO_USERS);

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
      checkExistingSession();
      loadAPISettings();
    });

    // === LOGIN FUNCTIONS ===
    function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const role = document.getElementById('login-role').value;
      
      console.log('ğŸ” Tentativo login con:', { email, password, role });
      
      const user = DEMO_USERS.find(u => 
        u.email === email && 
        u.password === password && 
        u.role === role
      );
      
      console.log('ğŸ‘¤ Utente trovato:', user);
      
      if (user) {
        currentUser = {
          email: user.email,
          role: user.role,
          name: user.name,
          company: user.company
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        console.log('âœ… Login riuscito!', currentUser);
        showMainApp();
      } else {
        console.log('âŒ Login fallito - credenziali non valide');
        console.log('ğŸ“‹ Credenziali inserite:', { email, password, role });
        console.log('ğŸ“‹ Credenziali disponibili:', DEMO_USERS);
        
        // Rimuovi messaggi precedenti
        const existingError = document.querySelector('#login-error-message');
        if (existingError) existingError.remove();
        
        // Messaggio di errore dettagliato
        const statusDiv = document.createElement('div');
        statusDiv.id = 'login-error-message';
        statusDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm';
        statusDiv.innerHTML = `
          <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div>
              <strong class="font-semibold">âŒ Credenziali non valide</strong>
              <div class="mt-2 space-y-1">
                <div>Email: ${email ? 'âœ“ Inserita' : 'âœ— Mancante'}</div>
                <div>Password: ${password ? 'âœ“ Inserita' : 'âœ— Mancante'}</div>
                <div>Ruolo: ${role ? 'âœ“ Selezionato (' + role + ')' : 'âœ— Non selezionato'}</div>
              </div>
              <div class="mt-3 text-xs">
                <strong>ğŸ’¡ Suggerimento:</strong> Verifica che email, password e ruolo corrispondano esattamente alle credenziali fornite.
              </div>
            </div>
          </div>
        `;
        
        // Aggiungi il messaggio dopo il form
        document.getElementById('login-form').appendChild(statusDiv);
        
        setTimeout(() => statusDiv.remove(), 6000);
      }
    }
    
    function checkExistingSession() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
      }
    }
    
    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
      
      document.getElementById('user-name').textContent = currentUser.name;
      
      const roleLabels = {
        'admin': 'Amministratore',
        'csirt': 'Consulente CSIRT',
        'azienda': 'Referente Aziendale'
      };
      document.getElementById('user-role').textContent = roleLabels[currentUser.role];
      
      filterSidebarByRole();
      loadDashboardData();
      
      if (currentUser.role === 'csirt') {
        document.getElementById('csirt-dashboard-cards').classList.remove('hidden');
      }
    }
    
    function filterSidebarByRole() {
      const navItems = document.querySelectorAll('.nav-item[data-role]');
      navItems.forEach(item => {
        const allowedRoles = item.getAttribute('data-role').split(',');
        if (!allowedRoles.includes(currentUser.role)) {
          item.style.display = 'none';
        } else {
          item.style.display = 'flex';
        }
      });
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-form').reset();
    }
    
    // === NAVIGATION ===
    function showSection(sectionName) {
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
      });
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
      });
      
      const section = document.getElementById(sectionName + '-section');
      if (section) {
        section.classList.remove('hidden');
      }
      
      if (event && event.target) {
        event.target.closest('.nav-item').classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
      }
      
      if (sectionName === 'companies') {
        loadCompanies();
      } else if (sectionName === 'incidents') {
        loadIncidents();
        loadCompaniesForDropdowns();
      } else if (sectionName === 'notifications') {
        loadNotifications();
        loadIncidentsForDropdown();
      } else if (sectionName === 'users') {
        loadUsers();
        loadCompaniesForDropdowns();
      } else if (sectionName === 'audit') {
        loadAudits();
        loadCompaniesForDropdowns();
      } else if (sectionName === 'designation-detail') {
        loadCompaniesForDropdowns();
      } else if (sectionName === 'csirt-profile') {
        loadCSIRTProfile();
      } else if (sectionName === 'network') {
        loadNetworkConfig();
      }
    }
    
    // === DASHBOARD ===
    function loadDashboardData() {
      const companies = JSON.parse(localStorage.getItem('companies') || '[]');
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      
      document.getElementById('total-companies').textContent = companies.length;
      
      const openIncidents = incidents.filter(i => i.status === 'aperto' || i.status === 'in-corso');
      document.getElementById('open-incidents').textContent = openIncidents.length;
      
      const pendingNotifications = notifications.filter(n => n.status === 'pending');
      document.getElementById('pending-notifications').textContent = pendingNotifications.length;
      
      const complianceScore = companies.length > 0 ? 85 : 0;
      document.getElementById('compliance-score').textContent = complianceScore + '%';
      
      loadRecentActivity();
    }
    
    function loadRecentActivity() {
      const activityContainer = document.getElementById('recent-activity');
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      
      if (incidents.length === 0) {
        activityContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nessuna attivitÃ  recente</p>';
        return;
      }
      
      const recentIncidents = incidents.slice(-5).reverse();
      
      activityContainer.innerHTML = recentIncidents.map(inc => `
        <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-medium text-gray-800">${inc.title}</p>
            <p class="text-sm text-gray-500">${inc.company} - ${new Date(inc.detectionDate).toLocaleDateString('it-IT')}</p>
          </div>
          <span class="status-badge status-${inc.status}">${inc.status.toUpperCase()}</span>
        </div>
      `).join('');
    }
    
    // === COMPANIES ===
    async function handleCompanySubmit(event) {
      event.preventDefault();
      
      const btn = document.getElementById('save-company-btn');
      const status = document.getElementById('company-save-status');
      
      btn.disabled = true;
      btn.textContent = 'â³ Salvataggio...';
      status.textContent = 'Attendere...';
      status.className = 'text-sm font-medium text-blue-600';
      
      try {
        const companyData = {
          name: document.getElementById('company-name').value.trim(),
          vat: document.getElementById('company-vat').value.trim(),
          sector: document.getElementById('company-sector').value,
          category: document.getElementById('company-category').value,
          address: document.getElementById('company-address').value.trim(),
          email: document.getElementById('company-email').value.trim(),
          phone: document.getElementById('company-phone').value.trim()
        };
        
        const editId = document.getElementById('edit-company-id').value;
        
        if (supabase) {
          if (editId) {
            const { data, error } = await supabase
              .from('csirt_companies')
              .update(companyData)
              .eq('id', editId)
              .select();
            
            if (error) throw error;
            
            const localCompanies = JSON.parse(localStorage.getItem('companies') || '[]');
            const index = localCompanies.findIndex(c => c.id === editId);
            if (index !== -1) {
              localCompanies[index] = { ...companyData, id: editId };
              localStorage.setItem('companies', JSON.stringify(localCompanies));
            }
            
            status.textContent = 'âœ… Azienda aggiornata su Supabase!';
          } else {
            const { data, error } = await supabase
              .from('csirt_companies')
              .insert([companyData])
              .select();
            
            if (error) throw error;
            
            const localCompanies = JSON.parse(localStorage.getItem('companies') || '[]');
            localCompanies.push({ ...companyData, id: data[0].id });
            localStorage.setItem('companies', JSON.stringify(localCompanies));
            
            status.textContent = 'âœ… Azienda salvata su Supabase!';
          }
        } else {
          const localCompanies = JSON.parse(localStorage.getItem('companies') || '[]');
          
          if (editId) {
            const index = localCompanies.findIndex(c => c.id === editId);
            if (index !== -1) {
              localCompanies[index] = { ...companyData, id: editId };
            }
          } else {
            companyData.id = Date.now().toString();
            localCompanies.push(companyData);
          }
          
          localStorage.setItem('companies', JSON.stringify(localCompanies));
          status.textContent = 'âœ… Azienda salvata localmente!';
        }
        
        status.className = 'text-sm font-medium text-green-600';
        
        setTimeout(() => {
          document.getElementById('new-company-form').reset();
          document.getElementById('edit-company-id').value = '';
          document.getElementById('company-form-title').textContent = 'â• Aggiungi Nuova Azienda';
          loadCompanies();
          loadDashboardData();
        }, 1500);
        
      } catch (error) {
        console.error('âŒ Errore salvataggio azienda:', error);
        status.textContent = 'âŒ ' + error.message;
        status.className = 'text-sm font-medium text-red-600';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Salva Azienda';
      }
    }
    
    async function loadCompanies() {
      let companies = [];
      
      if (supabase) {
        try {
          const { data, error } = await supabase
            .from('csirt_companies')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (!error && data) {
            companies = data;
            localStorage.setItem('companies', JSON.stringify(companies));
          }
        } catch (error) {
          console.error('âŒ Errore caricamento da Supabase:', error);
        }
      }
      
      if (companies.length === 0) {
        companies = JSON.parse(localStorage.getItem('companies') || '[]');
      }
      
      const tbody = document.getElementById('companies-table-body');
      
      if (companies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Nessuna azienda registrata</td></tr>';
        return;
      }
      
      tbody.innerHTML = companies.map(company => `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="font-medium text-gray-900">${company.name}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company.vat}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company.sector}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-medium rounded-full ${company.category === 'essenziale' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
              ${company.category}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <div>${company.email}</div>
            <div>${company.phone}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
            <button onclick="editCompany('${company.id}')" class="text-blue-600 hover:text-blue-800">âœï¸ Modifica</button>
            <button onclick="deleteCompany('${company.id}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸ Elimina</button>
          </td>
        </tr>
      `).join('');
    }
    
    function editCompany(id) {
      const companies = JSON.parse(localStorage.getItem('companies') || '[]');
      const company = companies.find(c => c.id === id);
      
      if (company) {
        document.getElementById('company-name').value = company.name;
        document.getElementById('company-vat').value = company.vat;
        document.getElementById('company-sector').value = company.sector;
        document.getElementById('company-category').value = company.category;
        document.getElementById('company-address').value = company.address || '';
        document.getElementById('company-email').value = company.email;
        document.getElementById('company-phone').value = company.phone;
        document.getElementById('edit-company-id').value = id;
        document.getElementById('company-form-title').textContent = 'âœï¸ Modifica Azienda';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    
    async function deleteCompany(id) {
      if (!confirm('Sei sicuro di voler eliminare questa azienda?')) return;
      
      try {
        if (supabase) {
          const { error } = await supabase
            .from('csirt_companies')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
        }
        
        const companies = JSON.parse(localStorage.getItem('companies') || '[]');
        const filtered = companies.filter(c => c.id !== id);
        localStorage.setItem('companies', JSON.stringify(filtered));
        
        loadCompanies();
        loadDashboardData();
      } catch (error) {
        console.error('âŒ Errore eliminazione azienda:', error);
        alert('Errore durante l\'eliminazione: ' + error.message);
      }
    }
    
    function cancelEditCompany() {
      document.getElementById('new-company-form').reset();
      document.getElementById('edit-company-id').value = '';
      document.getElementById('company-form-title').textContent = 'â• Aggiungi Nuova Azienda';
    }
    
    // === INCIDENTS ===
    async function handleIncidentSubmit(event) {
      event.preventDefault();
      
      const btn = document.getElementById('save-incident-btn');
      const status = document.getElementById('incident-save-status');
      
      btn.disabled = true;
      btn.textContent = 'â³ Salvataggio...';
      status.textContent = 'Attendere...';
      status.className = 'text-sm font-medium text-blue-600';
      
      try {
        const companies = JSON.parse(localStorage.getItem('companies') || '[]');
        const companyId = document.getElementById('incident-company').value;
        const company = companies.find(c => c.id === companyId);
        
        const incidentData = {
          title: document.getElementById('incident-title').value.trim(),
          company: company ? company.name : '',
          company_id: companyId,
          detectionDate: document.getElementById('incident-date').value,
          category: document.getElementById('incident-category').value,
          severity: document.getElementById('incident-severity').value,
          status: document.getElementById('incident-status').value,
          affectedSystems: document.getElementById('incident-systems').value.trim(),
          usersAffected: parseInt(document.getElementById('incident-users').value) || 0,
          dataCompromised: document.getElementById('incident-data-compromised').value.trim(),
          impactDescription: document.getElementById('incident-impact').value.trim(),
          technicalDetails: document.getElementById('incident-technical').value.trim(),
          containmentActions: document.getElementById('incident-containment').value.trim(),
          notes: document.getElementById('incident-notes').value.trim()
        };
        
        const editId = document.getElementById('edit-incident-id').value;
        
        if (supabase) {
          const supabaseData = {
            title: incidentData.title,
            company_id: incidentData.company_id,
            detection_date: incidentData.detectionDate,
            category: incidentData.category,
            severity: incidentData.severity,
            status: incidentData.status,
            affected_systems: incidentData.affectedSystems,
            users_affected: incidentData.usersAffected,
            data_compromised: incidentData.dataCompromised,
            impact_description: incidentData.impactDescription,
            technical_details: incidentData.technicalDetails,
            containment_actions: incidentData.containmentActions,
            notes: incidentData.notes
          };
          
          if (editId) {
            const { data, error } = await supabase
              .from('csirt_incidents')
              .update(supabaseData)
              .eq('id', editId)
              .select();
            
            if (error) throw error;
            
            const localIncidents = JSON.parse(localStorage.getItem('incidents') || '[]');
            const index = localIncidents.findIndex(i => i.id === editId);
            if (index !== -1) {
              localIncidents[index] = { ...incidentData, id: editId };
              localStorage.setItem('incidents', JSON.stringify(localIncidents));
            }
            
            status.textContent = 'âœ… Incidente aggiornato su Supabase!';
          } else {
            const { data, error } = await supabase
              .from('csirt_incidents')
              .insert([supabaseData])
              .select();
            
            if (error) throw error;
            
            const localIncidents = JSON.parse(localStorage.getItem('incidents') || '[]');
            localIncidents.push({ ...incidentData, id: data[0].id });
            localStorage.setItem('incidents', JSON.stringify(localIncidents));
            
            status.textContent = 'âœ… Incidente salvato su Supabase!';
          }
        } else {
          const localIncidents = JSON.parse(localStorage.getItem('incidents') || '[]');
          
          if (editId) {
            const index = localIncidents.findIndex(i => i.id === editId);
            if (index !== -1) {
              localIncidents[index] = { ...incidentData, id: editId };
            }
          } else {
            incidentData.id = Date.now().toString();
            localIncidents.push(incidentData);
          }
          
          localStorage.setItem('incidents', JSON.stringify(localIncidents));
          status.textContent = 'âœ… Incidente salvato localmente!';
        }
        
        status.className = 'text-sm font-medium text-green-600';
        
        setTimeout(() => {
          document.getElementById('new-incident-form').reset();
          document.getElementById('edit-incident-id').value = '';
          document.getElementById('incident-form-title').textContent = 'â• Registra Nuovo Incidente';
          loadIncidents();
          loadDashboardData();
        }, 1500);
        
      } catch (error) {
        console.error('âŒ Errore salvataggio incidente:', error);
        status.textContent = 'âŒ ' + error.message;
        status.className = 'text-sm font-medium text-red-600';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Salva Incidente';
      }
    }
    
    async function loadIncidents() {
      let incidents = [];
      
      if (supabase) {
        try {
          const { data, error } = await supabase
            .from('csirt_incidents')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (!error && data) {
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            
            incidents = data.map(inc => {
              const company = companies.find(c => c.id === inc.company_id);
              return {
                id: inc.id,
                title: inc.title,
                company: company ? company.name : 'N/D',
                company_id: inc.company_id,
                detectionDate: inc.detection_date,
                category: inc.category,
                severity: inc.severity,
                status: inc.status,
                affectedSystems: inc.affected_systems,
                usersAffected: inc.users_affected,
                dataCompromised: inc.data_compromised,
                impactDescription: inc.impact_description,
                technicalDetails: inc.technical_details,
                containmentActions: inc.containment_actions,
                notes: inc.notes
              };
            });
            
            localStorage.setItem('incidents', JSON.stringify(incidents));
          }
        } catch (error) {
          console.error('âŒ Errore caricamento da Supabase:', error);
        }
      }
      
      if (incidents.length === 0) {
        incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      }
      
      const tbody = document.getElementById('incidents-table-body');
      
      if (incidents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Nessun incidente registrato</td></tr>';
        return;
      }
      
      tbody.innerHTML = incidents.map(inc => `
        <tr>
          <td class="px-6 py-4">
            <div class="font-medium text-gray-900">${inc.title}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${inc.company}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(inc.detectionDate).toLocaleDateString('it-IT')}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="status-badge severity-${inc.severity}">${inc.severity.toUpperCase()}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="status-badge status-${inc.status}">${inc.status.toUpperCase()}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
            <button onclick="editIncident('${inc.id}')" class="text-blue-600 hover:text-blue-800">âœï¸ Modifica</button>
            <button onclick="deleteIncident('${inc.id}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸ Elimina</button>
          </td>
        </tr>
      `).join('');
    }
    
    function editIncident(id) {
      const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
      const incident = incidents.find(i => i.id === id);
      
      if (incident) {
        document.getElementById('incident-title').value = incident.title;
        document.getElementById('incident-company').value = incident.company_id;
        document.getElementById('incident-date').value = incident.detectionDate;
        document.getElementById('incident-category').value = incident.category;
        document.getElementById('incident-severity').value = incident.severity;
        document.getElementById('incident-status').value = incident.status;
        document.getElementById('incident-systems').value = incident.affectedSystems;
        document.getElementById('incident-users').value = incident.usersAffected;
        document.getElementById('incident-data-compromised').value = incident.dataCompromised || '';
        document.getElementById('incident-impact').value = incident.impactDescription;
        document.getElementById('incident-technical').value = incident.technicalDetails;
        document.getElementById('incident-containment').value = incident.containmentActions;
        document.getElementById('incident-notes').value = incident.notes || '';
        document.getElementById('edit-incident-id').value = id;
        document.getElementById('incident-form-title').textContent = 'âœï¸ Modifica Incidente';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    
    async function deleteIncident(id) {
      if (!confirm('Sei sicuro di voler eliminare questo incidente?')) return;
      
      try {
        if (supabase) {
          const { error } = await supabase
            .from('csirt_incidents')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
        }
        
        const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
        const filtered = incidents.filter(i => i.id !== id);
        localStorage.setItem('incidents', JSON.stringify(filtered));
        
        loadIncidents();
        loadDashboardData();
      } catch (error) {
        console.error('âŒ Errore eliminazione incidente:', error);
        alert('Errore durante l\'eliminazione: ' + error.message);
      }
    }
    
    function cancelEditIncident() {
      document.getElementById('new-incident-form').reset();
      document.getElementById('edit-incident-id').value = '';
      document.getElementById('incident-form-title').textContent = 'â• Registra Nuovo Incidente';
    }
    
    // === NOTIFICATIONS ===
    async function handleNotificationSubmit(event) {
      event.preventDefault();
      
      const btn = document.getElementById('save-notification-btn');
      const status = document.getElementById('notification-save-status');
      
      btn.disabled = true;
      btn.textContent = 'â³ Salvataggio...';
      status.textContent = 'Attendere...';
      status.className = 'text-sm font-medium text-blue-600';
      
      try {
        const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
        const incidentId = document.getElementById('notification-incident').value;
        const incident = incidents.find(i => i.id === incidentId);
        
        const notificationData = {
          incidentId: incidentId,
          incidentTitle: incident ? incident.title : '',
          type: document.getElementById('notification-type').value,
          status: document.getElementById('notification-status').value,
          notificationDate: document.getElementById('notification-date').value,
          recipient: document.getElementById('notification-recipient').value.trim()
        };
        
        if (supabase) {
          const supabaseData = {
            incident_id: notificationData.incidentId,
            type: notificationData.type,
            status: notificationData.status,
            notification_date: notificationData.notificationDate,
            recipient: notificationData.recipient
          };
          
          const { data, error } = await supabase
            .from('csirt_notifications')
            .insert([supabaseData])
            .select();
          
          if (error) throw error;
          
          const localNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
          localNotifications.push({ ...notificationData, id: data[0].id });
          localStorage.setItem('notifications', JSON.stringify(localNotifications));
          
          status.textContent = 'âœ… Notifica salvata su Supabase!';
        } else {
          notificationData.id = Date.now().toString();
          const localNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
          localNotifications.push(notificationData);
          localStorage.setItem('notifications', JSON.stringify(localNotifications));
          
          status.textContent = 'âœ… Notifica salvata localmente!';
        }
        
        status.className = 'text-sm font-medium text-green-600';
        
        setTimeout(() => {
          document.getElementById('new-notification-form').reset();
          loadNotifications();
          loadDashboardData();
        }, 1500);
        
      } catch (error) {
        console.error('âŒ Errore salvataggio notifica:', error);
        status.textContent = 'âŒ ' + error.message;
        status.className = 'text-sm font-medium text-red-600';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Salva Notifica';
      }
    }
    
    async function loadNotifications() {
      let notifications = [];
      
      if (supabase) {
        try {
          const { data, error } = await supabase
            .from('csirt_notifications')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (!error && data) {
            const incidents = JSON.parse(localStorage.getItem('incidents') || '[]');
            
            notifications = data.map(notif => {
              const incident = incidents.find(i => i.id === notif.incident_id);
              return {
                id: notif.id,
                incidentId: notif.incident_id,
                incidentTitle: incident ? incident.title : 'N/D',
                type: notif.type,
                status: notif.status,
                notificationDate: notif.notification_date,
                recipient: notif.recipient
              };
            });
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
          }
        } catch (error) {
          console.error('âŒ Errore caricamento da Supabase:', error);
        }
      }
      
      if (notifications.length === 0) {
        notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      }
      
      const tbody = document.getElementById('notifications-table-body');
      
      if (notifications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Nessuna notifica registrata</td></tr>';
        return;
      }
      
      tbody.innerHTML = notifications.map(notif => `
        <tr>
          <td class="px-6 py-4">
            <div class="font-medium text-gray-900">${notif.incidentTitle}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${notif.type}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(notif.notificationDate).toLocaleString('it-IT')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${notif.recipient}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-medium rounded-full ${notif.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
              ${notif.status}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="deleteNotification('${notif.id}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸ Elimina</button>
          </td>
        </tr>
      `).join('');
    }
    
    async function deleteNotification(id) {
      if (!confirm('Sei sicuro di voler eliminare questa notifica?')) return;
      
      try {
        if (supabase) {
          const { error } = await supabase
            .from('csirt_notifications')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
        }
        
        const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
        const filtered = notifications.filter(n => n.id !== id);
        localStorage.setItem('notifications', JSON.stringify(filtered));
        
        loadNotifications();
        loadDashboardData();
      } catch (error) {
        console.error('âŒ Errore eliminazione notifica:', error);
        alert('Errore durante l\'eliminazione: ' + error.message);
      }
    }
    
    // === AUDITS ===
    async function handleAuditSubmit(event) {
      event.preventDefault();
      
      const btn = document.getElementById('save-audit-btn');
      const status = document.getElementById('audit-save-status');
      
      btn.disabled = true;
      btn.textContent = 'â³ Salvataggio...';
      status.textContent = 'Attendere...';
      status.className = 'text-sm font-medium text-blue-600';
      
      try {
        const companies = JSON.parse(localStorage.getItem('companies') || '[]');
        const companyId = document.getElementById('audit-company').value;
        const company = companies.find(c => c.id === companyId);
        
        const auditData = {
          title: document.getElementById('audit-title').value.trim(),
          company: company ? company.name : '',
          company_id: companyId,
          auditDate: document.getElementById('audit-date').value,
          score: parseInt(document.getElementById('audit-score').value),
          notes: document.getElementById('audit-notes').value.trim()
        };
        
        if (supabase) {
          const supabaseData = {
            title: auditData.title,
            company_id: auditData.company_id,
            audit_date: auditData.auditDate,
            score: auditData.score,
            notes: auditData.notes
          };
          
          const { data, error } = await supabase
            .from('csirt_audits')
            .insert([supabaseData])
            .select();
          
          if (error) throw error;
          
          const localAudits = JSON.parse(localStorage.getItem('audits') || '[]');
          localAudits.push({ ...auditData, id: data[0].id });
          localStorage.setItem('audits', JSON.stringify(localAudits));
          
          status.textContent = 'âœ… Audit salvato su Supabase!';
        } else {
          auditData.id = Date.now().toString();
          const localAudits = JSON.parse(localStorage.getItem('audits') || '[]');
          localAudits.push(auditData);
          localStorage.setItem('audits', JSON.stringify(localAudits));
          
          status.textContent = 'âœ… Audit salvato localmente!';
        }
        
        status.className = 'text-sm font-medium text-green-600';
        
        setTimeout(() => {
          document.getElementById('new-audit-form').reset();
          loadAudits();
        }, 1500);
        
      } catch (error) {
        console.error('âŒ Errore salvataggio audit:', error);
        status.textContent = 'âŒ ' + error.message;
        status.className = 'text-sm font-medium text-red-600';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Salva Audit';
      }
    }
    
    async function loadAudits() {
      let audits = [];
      
      if (supabase) {
        try {
          const { data, error } = await supabase
            .from('csirt_audits')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (!error && data) {
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            
            audits = data.map(audit => {
              const company = companies.find(c => c.id === audit.company_id);
              return {
                id: audit.id,
                title: audit.title,
                company: company ? company.name : 'N/D',
                company_id: audit.company_id,
                auditDate: audit.audit_date,
                score: audit.score,
                notes: audit.notes
              };
            });
            
            localStorage.setItem('audits', JSON.stringify(audits));
          }
        } catch (error) {
          console.error('âŒ Errore caricamento da Supabase:', error);
        }
      }
      
      if (audits.length === 0) {
        audits = JSON.parse(localStorage.getItem('audits') || '[]');
      }
      
      const tbody = document.getElementById('audits-table-body');
      
      if (audits.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Nessun audit registrato</td></tr>';
        return;
      }
      
      tbody.innerHTML = audits.map(audit => `
        <tr>
          <td class="px-6 py-4">
            <div class="font-medium text-gray-900">${audit.title}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${audit.company}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(audit.auditDate).toLocaleDateString('it-IT')}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-3 py-1 text-sm font-bold rounded-full ${audit.score >= 80 ? 'bg-green-100 text-green-800' : audit.score >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
              ${audit.score}%
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="deleteAudit('${audit.id}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸ Elimina</button>
          </td>
        </tr>
      `).join('');
    }
    
    async function deleteAudit(id) {
      if (!confirm('Sei sicuro di voler eliminare questo audit?')) return;
      
      try {
        if (supabase) {
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a96a77c4279e898',t:'MTc2NDk3MDMyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
